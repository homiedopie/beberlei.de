<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="Blog of Benjamin Eberlei, covering a wide range of programming, bootstrapping and entrepreneurial topics">
        <meta name="viewport" content="width=device-width">
        <meta name="google-site-verification" content="mycr8JCbLYq9QcOyh4Ub1esAdN-awH9ut6nyTKUTgE4">
        <title>Test your Legacy PHP Application with Function Mocks! &mdash; beberlei.de</title>
            <link rel="stylesheet" href="/_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="/_static/css/bootstrap.min.css" type="text/css" />
            <link rel="stylesheet" href="/_static/blog.css" type="text/css" />
            <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" />
        <link rel="shortcut icon" href="../../../_static/tinkerer.ico" /><!-- Load modernizr and JQuery -->
        <script src="../../../_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="../../../_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="../../../_static/plugins.js"></script>
        <script src="../../../_static/main.js"></script>
        <link rel="search" title="Search" href="../../../search.html" /><link rel="next" title="Speaking about Framework Quality on the IPC Spring 09" href="../10/speaking-about-framework-quality-on-the-ipc-spring-09.html" /><link rel="prev" title="Using Zend_Soap Server and Autodiscover in a Controller" href="../11/using-zend-soap-server-and-autodiscover-in-a-controller.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.5.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        SOURCELINK_SUFFIX: '.txt',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="../../../_static/underscore.js"></script><script type="text/javascript" src="../../../_static/doctools.js"></script></head>
    <body role="document">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><nav class="navbar navbar-dark">
		  <div class="container">
			  <div class="navbar-header">
				  <a class="navbar-brand" href="https://beberlei.de">Benjamin Eberlei</a>
			  </div>

			  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				  <ul class="nav navbar-nav navbar-right">
						<li><a href="../../../index.html">Home</a></li>
						<li><a href="../../../pages/about.html">About</a></li>
						<li><a href="../../../pages/imprint.html">Imprint</a></li>
						<li><a href="/archive.html">Archive</a></li>
					  <li><a href="/rss.xml">RSS</a></li>
				  </ul>
			  </div>
		  </div>
		</nav><div class="main-container" role="main"><div class="container">
				<div class="row">
					<div class="col-md-8 col-md-offset-2 col-sm-12"><article role="article">
							<div class="blog-post">
        <div class="section" id="test-your-legacy-php-application-with-function-mocks">
<h1>Test your Legacy PHP Application with Function Mocks!</h1>
<p>Much talking is going on about Unittesting, Mocks and TDD in the PHP
world. For the most this discussions surround object-oriented PHP code,
frameworks and applications.</p>
<p>Yet I would assert that the reality for PHP developers (me included) is
dealing with PHP 4, PHP 5 migrated, or non-object oriented legacy
applications which are near to impossible to bring under test. Still
this code works, is in production and needs maintenance and possibly
extension for new features.</p>
<p>For example many applications may still use <strong>mysql_*</strong> functions at
length inside their model or have multiple nested function levels
(Example: Wordpress). <a class="reference external" href="http://pecl.php.net/package/runkit">Runkit</a> to
the rescue: A PECL extension that can hack your running PHP code, such
that method or functions are repointed to execute new implementations.
Using this extension you can actually mock out internal PHP functions,
which is great to bring legacy code under test.</p>
<p>Consider this following proof of concept, <a class="reference external" href="http://github.com/padraic/runkit/tree/master">using the Runkit extension
build by Padraic Brady</a>
(the one from pecl.php.net does not compile on PHP 5.2), which replaces
the functionality of <strong>mysql_query()</strong>. You have to set the following
option in your php.ini: <strong>runkit.internal_override = On</strong> for this to
work. By default only user-defined functions may be overwritten by
Runkit.</p>
<blockquote>
<div><div class="highlight-default"><div class="highlight"><pre><span></span>class FunctionMocker
{
    protected $_mockedFuncBehaviourMap = array();

    public function mock($funcName, $return=null)
    {
        $newFuncCode = &#39;return &quot;&#39;.$return.&#39;&quot;;&#39;;

        $renamedName = &quot;__&quot;.$funcName.&quot;_mockOriginalCopy&quot;;
        runkit_function_copy($funcName, $renamedName);
        runkit_function_redefine($funcName, &#39;&#39;, $newFuncCode);

        $this-&gt;_mockedFuncBehaviourMap[$funcName] = $renamedName;
    }

    public function reset()
    {
        foreach($this-&gt;_mockedFuncBehaviourMap AS $funcName =&gt; $renamedName) {
            runkit_function_remove($funcName);
            runkit_function_copy($renamedName, $funcName);
            runkit_function_remove($renamedName);
        }
        $this-&gt;_mockedFuncBehaviourMap = array();
    }
}

$mocker = new FunctionMocker();
$mocker-&gt;mock(&#39;mysql_query&#39;, &#39;hello world!&#39;);

echo mysql_query(); // hello world

$mocker-&gt;reset();

mysql_query(); // error
</pre></div>
</div>
<p>This example, only allows for string return values of the mock and
has no support for replacing the arguments of the mocked function.
Also chaining of different return values based on input or call
number might be interesting. Some kind of Code Generator Tool would
have to be implemented to support this functionality. Additionally
Assertions and Verifying should be implemented for the function
arguments. All in all this would allow to mock functions as you
would mock interfaces/classes, which would be a great addition for
all those legacy applications that use procedural PHP.</p>
<p>Additionally what the real killer for runkit would be: The
possibility to insert PHP callbacks instead of real PHP code into
the <strong>runkit_function_redefine</strong>.</p>
</div></blockquote>
</div>


        
        
        <div class="tags">
            More about: 
            <a href="../../../tags/testing.html">Testing</a>
            
            
        </div>
        

        <div class="metadata">
        <p>
            <small>
                Posted on March 27, 2009
                
            </small>
        </p>
    </div>
        

        
    </div></article></div> <!-- #main -->
				</div>
			</div></div> <!-- #main-container -->

        <div class="footer-container" role="contentinfo">
			<div class="container">
				<div class="col-md-8 col-md-offset-2">
					<div class="footer">
						<small>Â© Copyright 2008-2017, Benjamin Eberlei.</small>

						<script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script>
					</div>
				</div>
			</div>
        </div> <!-- footer-container -->
      </div> <!--! end of #container --><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-32146757-1', 'auto');
          ga('send', 'pageview');
        </script>

    </body>
</html>