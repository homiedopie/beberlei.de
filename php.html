<?xml version="1.0" encoding="utf-8"?>
<rss version="2.0">
    <channel>
        <title>Whitewashing</title>
        <link>http://www.whitewashing.de/</link>
        <description></description>
        <language>en-us</language>
        <pubDate>Sat, 11 Apr 2015 00:00:00 +0200</pubDate>
        
        <item>
            <link>http://www.whitewashing.de/2015/04/11/monolithic_repositories_with_php_and_composer.html</link>
            <guid>http://www.whitewashing.de/2015/04/11/monolithic_repositories_with_php_and_composer.html</guid>
            <title><![CDATA[Monolithic Repositories with PHP and Composer]]></title>
            <description><![CDATA[
<h1>Monolithic Repositories with PHP and Composer</h1>
<blockquote>
<div>tl;dr Monolithic repositories can bring a lot of benefits. I prototyped
<a class="reference external" href="https://github.com/beberlei/fiddler">Fiddler</a> that complements Composer
to add dependency management for monolithic repositories to PHP.</div></blockquote>
<p>Thanks to <a class="reference external" href="https://twitter.com/iam_asm89">Alexander</a> for discussing this
topic with me as well as reviewing the draft of this post.</p>
<p>As Git and Composer are more ubiquitous in open-source projects and within
companies, monolithic repositories containing multiple projects have become a
bit of a bad practice. This is a similar trend to how monolithic applications
are out of fashion and the recent focus on microservices and Docker.</p>
<p>Composer has made it possible to create many small packages and distribute them
easily through Packagist. This has massively improved the PHP ecosystem by
increasing re-usability and sharing.</p>
<p>But it is important to consider package distribution and development seperate
from each other. The current progress in package manager tooling comes at a
cost for version control productivity, because Composer, NPM, Bower force you
to have exactly one repository for one package to benefit from the
reusability/distribution.</p>
<p>This blog post compares monolithic repositories with one repository per package
approach. It focuses on internal projects and repositories in organizations and
companies. I will discuss open source projects in a follow-up post.</p>
<div class="section" id="workflow-at-facebook-google-twitter">
<h2>Workflow at Facebook, Google, Twitter</h2>
<p>The move towards smaller repositories is called into question by three extremely
productive organizations that work at incredible scale.</p>
<ul class="simple">
<li>Facebook <a class="reference external" href="https://developers.facebooklive.com/videos/561/big-code-developer-infrastructure-at-facebook-s-scale">mentioned in their talk “Big Code: Developer Infrastructure at
Facebook’s Scale”</a>
that they are going to merge their three big code repositories Server, iOS
and Android into a single big repository over the course of 2015.</li>
<li>Google open-sourced <a class="reference external" href="http://bazel.io">Bazel</a>, the build tool behind a huge
chunk of their codebase managed in a single Perforce repository with over 20 million
commits (<a class="reference external" href="http://www.perforce.com/sites/default/files/still-all-one-server-perforce-scale-google-wp.pdf">Reference</a>).</li>
<li>Twitter, Foursquare and Square are working on their clone of Google’s Bazel
build system called <a class="reference external" href="https://pantsbuild.github.io/">Pants</a>. It is also
designed for monolithic repositories.</li>
</ul>
<p>All three companies cite huge developer productivity benefits,
code-reusability, large-scale refactorings and development at scale for
choosing this approach. The Facebook talk even mentions how all their
development infrastructure efforts focus on keeping this workflow because of
the benefits it brings.</p>
</div>
<div class="section" id="downsides-of-having-many-repositories">
<h2>Downsides of having many Repositories</h2>
<p>In contrast working with ever smaller repositories can be a huge burden for
developer mental models: I have seen this in open-source projects such as
Doctrine and several customer projects:</p>
<ol class="arabic simple">
<li>Cross repository changes require certain pull-requests on Github/Gitlab to
be merged in order or in combination yet the tools don’t provide visibility
into these dependencies. They are purely informal, leading to high error
rates.</li>
<li>Version pinning through NPM and Composer package managers is great for
managing third party dependencies as long its not too many of them and they
don’t change too often. For internal dependencies its a lot of work to
update dependencies between repositories all the time. Time gets lost by
developers that don’t have the correct dependencies or because of mistakes
in the merge process.</li>
<li>Changing code in core libraries can break dependencies without the developer
even realizing this because tests don’t run together. This introduces a
longer feedback cycle between code that depends on each other, with all the
downsides.</li>
</ol>
<p>One important remark about monolithic repositories: It does not automatically
lead to a monolithic code-base. Especially Symfony2 and ZF2 are a very
good example of how you can build individual components with a clean dependency
graph in a single big repository.</p>
<p>At <a class="reference external" href="http://qafoo.com">Qafoo</a> we have always preferred monolithic project
repositories containing several components over many small independent ones. We
advised many customers to choose this approach except in some special cases
where going small was economically more efficient.</p>
</div>
<div class="section" id="benefits-of-monolithic-repositories">
<h2>Benefits of Monolithic Repositories</h2>
<p>Even if you are not at the scale of Facebook or Google, a single repository
still provides the mentioned benefits:</p>
<ul class="simple">
<li>Adjusting to constant change by factoring out libraries, merging libraries
and introducing new dependencies for multiple projects is much easier when
done in a single, atomic VCS commit.</li>
<li>Discoverability of code is much higher, if you have all the code in a single
place. Github and Gitlab don’t offer powerful tools like find, grep, sed over
more than one repository. Hunting down dependencies, in specific versions can
cost alot of time.</li>
<li>Reusability increases as it is much easier to just use code from the same
repository than from another repository. Composer and NPM simplify combining
repositories at specific versions, however one problem is actually knowing
that the code exists in the first place.</li>
<li>From an operational perspective it is much easier to get a new developer
up to speed setting up projects from a single repository. Just practically
its easier to add his public key to only one Team/Repository/Directory than
to hundreds. On top of that setting up many small repositories and
familiarizing with each of them costs a lot of time.</li>
</ul>
<p>This is why I have been struggling with how Packagist and Satis force the move
to smaller repositories through the technical constraint “one repository equals
one composer.json file”. For reusable open source projects this is perfectly
fine, but for company projects I have seen it hurt developer productivity more
often than is acceptable.</p>
</div>
<div class="section" id="introducing-fiddler">
<h2>Introducing Fiddler</h2>
<p>So today I prototyped a build system that complements Composer to manage
multiple separate projects/packages in a single repository. I call it <a class="reference external" href="https://github.com/beberlei/fiddler">Fiddler</a>. Fiddler introduces a maintainable
approach to managing dependencies for multiple projects in a single repository,
without losing the benefits of having explicit dependencies for each separate
project.</p>
<p>In practice Fiddler allows you to manage all your third-party dependencies using a
<span class="docutils literal"><span class="pre">composer.json</span></span> file, while adding a new way of managing your internal
dependencies. It combines both external and internal packages to a single
pool and allows you to pick them as dependencies for your projects.</p>
<p>For each project you add a <span class="docutils literal"><span class="pre">fiddler.json</span></span> file where you specify both your
third-party and internal dependencies. Fiddler will take care of generating a
specific autoloader for each project, containing only the dependencies of the
project.  This allows you to have one repository, while still having <em>explicit</em>
dependencies per project.</p>
<p>Keeping explicit dependencies for each project means it’s still easy to find
out which components are affected by changes in internal or third-party
dependencies.</p>
</div>
<div class="section" id="example-project">
<h2>Example Project</h2>
<p>Say you have three packages in your application, Library_1, Project_A
and Project_B and both projects depend on the library which in turn depends
on <span class="docutils literal"><span class="pre">symfony/dependency-injection</span></span>. The repository has the following file structure:</p>
<div class="highlight-python"><div class="highlight"><pre>projects
├── components
│   ├── Project_A
│   │   └── fiddler.json
│   ├── Project_B
│   │   └── fiddler.json
│   └── Library_1
│       └── fiddler.json
├── composer.json
</pre></div>
</div>
<p>The <span class="docutils literal"><span class="pre">fiddler.json</span></span> of Library_1 looks like this::</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">"autoload"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"psr-0"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"Library1</span><span class="se">\\</span><span class="s2">"</span><span class="p">:</span> <span class="s2">"src/"</span><span class="p">}},</span>
    <span class="s2">"deps"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"vendor/symfony/dependency-injection"</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <span class="docutils literal"><span class="pre">fiddler.json</span></span> of Project_A and Project_B look similar (except the autoload)::</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">"autoload"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"psr-0"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"ProjectA</span><span class="se">\\</span><span class="s2">"</span><span class="p">:</span> <span class="s2">"src/"</span><span class="p">}},</span>
    <span class="s2">"deps"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"components/Library_1"</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The global <span class="docutils literal"><span class="pre">composer.json</span></span> as you would expect::</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">"require"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"symfony/dependency-injection"</span><span class="p">:</span> <span class="s2">"~2.6"</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As you can see dependencies are specified without version constraints and as
directory paths relative to the project root. Since everything is in one
repository, all internal code is always versioned, tested and deployed
together. Dropping the need for explicit versions when specifying internal
dependencies.</p>
<p>With this setup you can now generate the autoloading files for each package
exactly like Composer would by calling:</p>
<div class="highlight-python"><div class="highlight"><pre>$ php fiddler.phar build
Building fiddler.json projects.
 [Build] components/Library_1
 [Build] components/Project_A
 [Build] components/Project_B
</pre></div>
</div>
<p>Now in each package you can <span class="docutils literal"><span class="pre">require</span> <span class="pre">"vendor/autoload.php";</span></span> and it loads an
autoloader with all the dependencies specified for each component, for example
in <span class="docutils literal"><span class="pre">components/Library_1/index.php</span></span></p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">require_once</span> <span class="s2">"vendor/autoload.php"</span><span class="p">;</span>

<span class="nv">$container</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Symfony\Component\DependencyInjection\ContainerBuilder</span><span class="p">;</span>
</pre></div>
</div>
<p>This is an early access preview, please test this, provide feedback if you see
this as a valuable or not and about possible extensions. See the <a class="reference external" href="https://github.com/beberlei/fiddler">README</a> for more details about functionality
and implementation details.</p>
<p>The code is very rough and simple right now, you will probably stumble accross
some bugs, please <a class="reference external" href="https://github.com/beberlei/fiddler/issues">report them</a>.
It is stable enough so that we could actually port <a class="reference external" href="https://tideways.io">Tideways</a> to it already which is a multi package repository.</p>
</div>
]]></description>
            <category><![CDATA[ PHP ]]></category>
             <pubDate>Sat, 11 Apr 2015 00:00:00 +0200</pubDate>
        </item>
    
        <item>
            <link>http://www.whitewashing.de/2015/02/10/a_case_for_weak_type_hints_only_in_php7.html</link>
            <guid>http://www.whitewashing.de/2015/02/10/a_case_for_weak_type_hints_only_in_php7.html</guid>
            <title><![CDATA[A case for weak type hints only in PHP7]]></title>
            <description><![CDATA[
<h1>A case for weak type hints only in PHP7</h1>
<p>TL;DR: I was one voice for having strict type hints until I tried the current
patch. From both a library and application developer POV they don’t bring much
to the table. I think PHP would be more consistent with weak type hints only.</p>
<p>These last weeks there have been tons of discussions about <a class="reference external" href="https://wiki.php.net/rfc/scalar_type_hints">scalar type
hints</a>
in PHP following <a class="reference external" href="https://twitter.com/andreafaulds">Andrea Faulds</a> RFC
that is currently in voting. Most of them were limited to PHP Internals
mailinglist but since the voting started some days ago much has also been said
on Twitter and blogs.</p>
<p>This post is my completly subjective opinion on the issue.</p>
<p>I would have preferred strict type hints, however after trying the patch, I
think that strict type hints</p>
<ul class="simple">
<li>will cause considerable problems for application developers, forcing them to
“replicate weak type hinting” by manually casting everywhere.</li>
<li>are useless for library developers, because they have to assume the user
is in weak type mode.</li>
<li>are useless within a library because I already know the types at the public
API, weak mode would suffice for all the lower layers of my library.</li>
</ul>
<p>Neither group of developers gets a considerable benefit from the current RFCs strict mode.</p>
<p>The simple reason for this, request, console inputs and many databases provide
us with strings, casting has to happen somewhere. Having strict type hints
would not save us from this, type juggling and casting has to happen and
PHP’s current approach is one of the main benefits of the language.</p>
<div class="section" id="real-world-weak-vs-strict-code-example">
<h2>Real World Weak vs Strict Code Example</h2>
<p>Lets look at an example of everyday framework code <a class="reference external" href="https://gist.github.com/beberlei/8b23160dd0b4466fe1c5">Full
Code</a> to
support my case:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">UserController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">listAction</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'status'</span><span class="p">);</span> <span class="c1">// this is a string</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">'users'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="o">-&gt;</span><span class="na">fetchUsers</span><span class="p">(</span><span class="nv">$status</span><span class="p">),</span>
            <span class="s1">'total'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="o">-&gt;</span><span class="na">fetchTotalCount</span><span class="p">(</span><span class="nv">$status</span><span class="p">)</span>
        <span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">UserService</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">STATUS_INACTIVE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">STATUS_WAITING</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">STATUS_APPROVED</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

    <span class="k">private</span> <span class="nv">$connection</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">fetchUsers</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$status</span><span class="p">)</span><span class="o">:</span> <span class="k">array</span>
    <span class="p">{</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">'SELECT u.id, u.username FROM users u WHERE u.status = ? LIMIT 10'</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connection</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="p">[</span><span class="nv">$status</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">fetchTotalCount</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$status</span><span class="p">)</span><span class="o">:</span> <span class="nx">int</span>
    <span class="p">{</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">'SELECT count(*) FROM users u WHERE u.status = ?'</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connection</span><span class="o">-&gt;</span><span class="na">fetchColumn</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="p">[</span><span class="nv">$status</span><span class="p">]);</span> <span class="c1">// returns a string</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>See how the code on <span class="docutils literal"><span class="pre">UserService</span></span> is guarded by scalar typehints to enforce
having the right types inside the service:</p>
<ul class="simple">
<li><span class="docutils literal"><span class="pre">$status</span></span> is a flag to filter the result by and it is one of the integer constants, the type hint coerces an integer from the request string.</li>
<li><span class="docutils literal"><span class="pre">fetchTotalCount()</span></span> returns an integer of total number of users matching the query, the type hint coerces an integer from the database string.</li>
</ul>
<p>This code example <em>only</em> works with weak typehinting mode as described in the RFC.</p>
<p>Now lets enable strict type hinting to see how the code fails:</p>
<ul class="simple">
<li>Passing the string status from the request to UserSerice methods is rejected, we need to cast status to integer.</li>
<li>Returning the integer from <span class="docutils literal"><span class="pre">fetchTotalCount</span></span> fails because the database returns a string number. We need to cast to integer.</li>
</ul>
<div class="highlight-python"><div class="highlight"><pre>Catchable fatal error: Argument 1 passed to UserService::fetchUsers() must
be of the type integer, string given, called in /tmp/hints.php on line 22
and defined in /tmp/hints.php on line 37

Catchable fatal error: Return value of UserService::fetchTotalCount() must
be of the type integer, string returned in /tmp/hints.php on line 48
</pre></div>
</div>
<p>The fix everybody would go for is casting to <span class="docutils literal"><span class="pre">(int)</span></span> manually:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">public function listAction(Request $request)</span>
<span class="x">{</span>
<span class="x">    $status = (int)$request-&gt;get('status'); // this is a string</span>

<span class="x">    return [</span>
<span class="x">        'users' =&gt; $this-&gt;service-&gt;fetchUsers($status),</span>
<span class="x">        'total' =&gt; $this-&gt;service-&gt;fetchTotalCount($status)</span>
<span class="x">    ];</span>
<span class="x">}</span>
</pre></div>
</div>
<p>and:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">public function fetchTotalCount(int $status): int</span>
<span class="x">{</span>
<span class="x">    $sql = 'SELECT count(*) FROM users u WHERE u.status = ?';</span>

<span class="x">    return (int)$this-&gt;connection-&gt;fetchColumn($sql, [$status]);</span>
<span class="x">}</span>
</pre></div>
</div>
<p>It feels to me that enabling strict mode completly defeats the purpose, because
now we are forced to convert manually, reimplementing weak type hinting in our
own code.</p>
<p>More important: We write code with casts already, the scalar type hints patch
is not necessary for that! Only a superficial level of additional safety is
gained, one additional check of something we already know is true!</p>
<p>Strict mode is useless for library developers, because I always have to assume
weak mode anyways.</p>
<p><strong>EDIT:</strong> I argued before that you have to check for casting strings to 0 when
using weak typehints. That is not necessary. Passing <span class="docutils literal"><span class="pre">fetchTotalCount("foo")</span></span>
will throw a catchable fatal error in weak mode already!</p>
</div>
<div class="section" id="do-we-need-strict-mode">
<h2>Do we need strict mode?</h2>
<p>In a well designed application or library, the developer can already trust the
types of his variables today, 95% of the time, without even having type hints,
using carefully designed abstractions (example Symfony Forms and Doctrine ORM): No
substantial win for her from having strict type hints.</p>
<p>In a badly designed application, the developer is uncertain about the types of
variables. Using strict mode in this scenario she needs to start casting
everywhere just to be sure. I cannot imagine the resulting code to look
anything but bad. Strict would actually be counterproductive here.</p>
<p>I also see a danger here, that writing “strict mode” code will become a best
practice and this might lead developers working on badly desigend applications
to write even crappier code just to follow best practices.</p>
<p>As a pro strict mode developer I could argue:</p>
<ul class="simple">
<li>that libraries such as Doctrine ORM and Symfony Forms already
abstract all the nitty gritty casting from request or database today. But I
don’t think that is valid: They are two of the most sophisticated PHP libraries
out there, maybe used by 1-5% of the userbase. I don’t want to force this
level of abstraction on all users. I can’t use this level myself all the
time. Also if libraries already abstract this for us, why need to duplicate
the checks again if we can trust the variables types?</li>
<li>that I might have complex (mathematical) algorithms that benefit from strict
type hinting. But that is not really true: Once the variables have passed
through the public API of my fully typehinted library I know the types and can rely
on them on all lower levels. Weak or strict type hinting doesn’t make a
difference anymore. Well designed libraries written in PHP5 already provide
this kind of trust using carefully designed value objects and guard clauses.</li>
<li>that using strict type in my library reduce the likelihood of bugs, but that
is not guaranteed.  Users of my library can always decide not to use strict
type hints and that requires me as a library author to consider this use-case
and prevent possible problems. Again using strict mode doesn’t provide a
benefit here.</li>
<li>to write parts of the code in strict and parts in weak mode. But how to
decide this? Projects usually pick only one paradigm for good reason:
<span class="docutils literal"><span class="pre">E_STRICT</span></span> compatible code yes or no for example. Switching is arbitrary
and dangerously inconsistent. As a team lead I would reject such kind of
convention because it is impractible. Code that follows this paradigm in
strict languages such as Java and C# has an aweful lot of converting methods
such as <span class="docutils literal"><span class="pre">$connection-&gt;fetchColumnAsInteger()</span></span>. I do not want to go down
that road.</li>
</ul>
</div>
<div class="section" id="would-we-benefit-from-only-strict-mode">
<h2>Would we benefit from only strict mode?</h2>
<p>Supporters of strict mode only: Make sure to understand why this will never happen!</p>
<p>Say the current RFC gets rejected, would we benefit from a strict type hinting
RFC? No, and the current RFC details the exact reasons why. Most notably
for BC reasons all the PHP API will not use the new strict type hinting.</p>
<p>This current RFC is the only chance to get any kind of strict hinting into PHP.
Yet with the limited usefullness as described before, we can agree that just
having weak mode would be more consistent and therefore better for everyone.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>I as PHP developer using frameworks and libraries that help me write type safe
code today, strict typing appeals to me. But put to a test in real code it
proves to be impractical for many cases, and not actually much more useful
than weak type hinting in many other cases.</p>
<p>Weak types provide me with much of the type safety I need: In any given method,
using only typehinted parameters and return values, I am safe from type
juggling. As a library developer I have to assume caller uses weak mode all the
time.</p>
<p>Having strict type hints suggests that we can somehow get rid of type juggling
all together. But that is not true, because we still have to work with user
input and databases.</p>
<p>The current RFC only introduced the extra strict mode because developers had a
very negative reactions towards weak type hints. Strike me from this list, weak
type hints are everything that PHP should have. I will go as far that others
strict-typers would probably agree when actually working with the patch.</p>
<p>I would rather prefer just having weak types for now, this is already
a big change for the language and would prove to be valuable for everyone.</p>
<p>I fear Strict mode will have no greater benefit than gamification of the
language, the winner is the one with the highest percentage of strict mode
code.</p>
</div>
]]></description>
            <category><![CDATA[ PHP ]]></category>
             <pubDate>Tue, 10 Feb 2015 00:00:00 +0100</pubDate>
        </item>
    
        <item>
            <link>http://www.whitewashing.de/2014/01/31/soap_and_php_in_2014.html</link>
            <guid>http://www.whitewashing.de/2014/01/31/soap_and_php_in_2014.html</guid>
            <title><![CDATA[SOAP and PHP in 2014]]></title>
            <description><![CDATA[
<h1>SOAP and PHP in 2014</h1>
<blockquote>
<div>“The SOAP stack is generally regarded as an embarrassing failure these days.”
– Tim Bray</div></blockquote>
<p>While the quote by Tim Bray is still true to some degree, the toolstack and
possiblities behind SOAP are still superior to REST in my opinion. REST still
requires alot of manual coding, where RPC with SOAP allows much automation with
tools.</p>
<p>These last years REST has gotten all the buzz, everybody seems to be using it
and there are lots of talks about REST on conferences. SOAP used to be big for
building APIs, but everybody seems to hate it for various reasons. I have used
SOAP in several projects over the last 10 years and this blog post is a random
collection of information about the state of SOAP in PHP 2014, as a reminder
to myself and to others as well.</p>
<p>Why care about SOAP in 2014? For server to server (RPC) communication it still
has massive time to market and stability benefits over REST. The REST toolchain
is just not well developed enough, it lacks:</p>
<ul class="simple">
<li>a standard to describe the input/output formats of endpoints</li>
<li>a way to “just do it”</li>
<li>ways to automatically generate clients in any language</li>
</ul>
<p>While solutions exist for these problems in the REST space, they are often not
standardized and don’t serve the full stack and different languages.</p>
<p>WSDLs for SOAP however allow you to generate servers and clients from
datastructures by the click of a button or execution of a script. I can get two
servers communicating over SOAP, exposing all service methods in literally
minutes.</p>
<div class="section" id="basics">
<h2>Basics</h2>
<p>SOAP is a protocol for Remote-Procedure Calls. HTTP is used as mechanism
to talk between client and servers by sending POST requests with XML request
and response bodies.</p>
<p>The <span class="docutils literal"><span class="pre">SOAPServer</span></span> and <span class="docutils literal"><span class="pre">SOAPClient</span></span> objects ship with PHP core by default.</p>
<p>You can expose functions, classes or objects as server by registering
service callbacks with
<span class="docutils literal"><span class="pre">SOAPServer#addFunction</span></span>, <span class="docutils literal"><span class="pre">SOAPServer#setClass</span></span> or
<span class="docutils literal"><span class="pre">SOAPServer#setObject</span></span> and then calling the <span class="docutils literal"><span class="pre">handle()</span></span> method, which
handles request and response generation and sending in one step. You can
normally exit the request directly after handle.</p>
<p>The client is even simpler, it overwrites the <span class="docutils literal"><span class="pre">__call</span></span> magic method.
Any call to the client therefore looks exactly like the same call
on the server in your code.</p>
</div>
<div class="section" id="phps-non-wsdl-mode">
<h2>PHPs Non-WSDL mode</h2>
<p>One argument against SOAP is the requirement to define WSDL documents for
both server and client to allow communication. This is not true for Clients and
Servers both written in PHP. You can use the non-WSDL mode to expose an object
from the server and use a non-wsdl client to talk to it. The PHP <span class="docutils literal"><span class="pre">SOAPClient</span></span>
and <span class="docutils literal"><span class="pre">SOAPServer</span></span> have a common exchange format that is used in this case
and replaces WSDL entirely.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// server.php</span>
<span class="k">class</span> <span class="nc">MyService</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">add</span><span class="p">(</span><span class="nv">$x</span><span class="p">,</span> <span class="nv">$y</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$x</span> <span class="o">+</span> <span class="nv">$y</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'uri'</span> <span class="o">=&gt;</span> <span class="s1">'http://server/namespace'</span><span class="p">,</span>
    <span class="s1">'location'</span> <span class="o">=&gt;</span> <span class="s1">'http://server/location'</span><span class="p">,</span>
<span class="p">);</span>

<span class="nv">$server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SOAPServer</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
<span class="nv">$server</span><span class="o">-&gt;</span><span class="na">setObject</span><span class="p">(</span><span class="k">new</span> <span class="nx">MyService</span><span class="p">());</span>
<span class="nv">$server</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">();</span>
</pre></div>
</div>
<p>The client is as simple as the following lines of code:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// client.php</span>
<span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'uri'</span> <span class="o">=&gt;</span> <span class="s1">'http://server/namespace'</span><span class="p">,</span>
    <span class="s1">'location'</span> <span class="o">=&gt;</span> <span class="s1">'http://server/location'</span><span class="p">,</span>
<span class="p">);</span>
<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SOAPClient</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
<span class="k">echo</span> <span class="nv">$client</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</pre></div>
</div>
<p>This kind of services work with flawlessly all datatypes except with objects,
which get converted to <span class="docutils literal"><span class="pre">stdClass</span></span> with public properties on the Client.</p>
<p>If you are developing internal APIs between components in your own system,
then using SOAP in non-WSDL mode is a massive time saver. You can expose
remote services for Remote procedure calls this way very easily.</p>
<p>The only downside is that you have no documentation what methods exist on the
client and <strong>ALL</strong> public methods of the server object can be called, so make sure
they only have those methods you want to be called remotely.</p>
</div>
<div class="section" id="debugging-soap">
<h2>Debugging SOAP</h2>
<p>When something goes wrong in either the client or server, it sucks to debug
these problems. In general there are several mechanisms to debug SOAP in PHP:</p>
<ol class="arabic simple">
<li>Enable <span class="docutils literal"><span class="pre">'trace'</span> <span class="pre">=&gt;</span> <span class="pre">true</span></span> option on the SOAPClient. This allows you
to call the methods <span class="docutils literal"><span class="pre">$client-&gt;__getLastResponse()</span></span> and
<span class="docutils literal"><span class="pre">$client-&gt;__getLastRequest()</span></span> to take a look at the interaction between
server and client.</li>
<li>When failures happen, <span class="docutils literal"><span class="pre">SOAPClient</span></span> throws a <span class="docutils literal"><span class="pre">SOAPFault</span></span> exception.
You can even throw this exception yourself from the SOAPServer code,
and the client can then read this failure. However you must know
that the <span class="docutils literal"><span class="pre">$faultcode</span></span> variable in the constructor of <span class="docutils literal"><span class="pre">new</span>
<span class="pre">SOAPFault($faultcode,</span> <span class="pre">$faultmsg)</span></span> is <strong>NOT</strong> an integer error code
like in normal Exceptions. Instead its either a value <span class="docutils literal"><span class="pre">SERVER</span></span> or <span class="docutils literal"><span class="pre">CLIENT</span></span>,
with the component of the interaction that failed.</li>
<li>If you throw non <span class="docutils literal"><span class="pre">SOAPFault</span></span> exceptions from the server, then you
need to catch them and recast them to <span class="docutils literal"><span class="pre">SOAPFault</span></span>, otherwise
the client only sees “Internal Server Error” messages.</li>
</ol>
<p>You can easily solve the <span class="docutils literal"><span class="pre">SOAPFault</span></span> problem by decorating your service with an exception handler,
and also logging the errors yourself.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">SoapExceptionHandler</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$exposeExceptionMessages</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'MyProject\DomainException'</span><span class="p">,</span>
    <span class="p">);</span>

    <span class="k">private</span> <span class="nv">$service</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$service</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span> <span class="o">=</span> <span class="nv">$service</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__call</span><span class="p">(</span><span class="nv">$method</span><span class="p">,</span> <span class="nv">$args</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">try</span> <span class="p">{</span>
            <span class="k">return</span> <span class="nb">call_user_func_array</span><span class="p">(</span>
                <span class="k">array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="p">,</span> <span class="nv">$method</span><span class="p">),</span>
                <span class="nv">$args</span>
            <span class="p">);</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="c1">// log errors here as well!</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$e</span><span class="p">),</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">exposeExceptionMessages</span><span class="p">))</span> <span class="p">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nx">SOAPFAult</span><span class="p">(</span><span class="s1">'SERVER'</span><span class="p">,</span> <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">());</span>
            <span class="p">}</span>

            <span class="k">throw</span> <span class="k">new</span> <span class="nx">SOAPFault</span><span class="p">(</span><span class="s1">'SERVER'</span><span class="p">,</span> <span class="s1">'Application Error'</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SOAPServer</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
<span class="nv">$server</span><span class="o">-&gt;</span><span class="na">setObject</span><span class="p">(</span><span class="k">new</span> <span class="nx">SoapExceptionHandler</span><span class="p">(</span><span class="k">new</span> <span class="nx">MyService</span><span class="p">()));</span>
<span class="nv">$server</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="section" id="generating-wsdls">
<h2>Generating WSDLs</h2>
<p>SOAP uses a service description format called WSDL to describe the input and
output of the server and what methods exist. WSDL are formatted with XML
and use XMLSchema to describe the input/output messages. The format is very
complex, however tools for any languages allow you to autogenerate WSDLs
from code.</p>
<p>There are several reasons to introduce WSDLs for your SOAP service:</p>
<ul class="simple">
<li>Your SOAP clients will not be written in PHP, which prevents use of the non-WSDL mode.</li>
<li>Clients of the service are used and  written by other teams or companies.</li>
<li>You want to use the WSDL as a validation mechanism for input from clients.</li>
</ul>
<p>While you should have some understanding of how a WSDL looks like,
you should never write it manually. I use <a class="reference external" href="http://framework.zend.com/manual/2.0/en/modules/zend.soap.auto-discovery.html">Zend Frameworks SOAP Autodiscovery</a> for this.
By default it uses the docblocks <span class="docutils literal"><span class="pre">@param</span></span> and <span class="docutils literal"><span class="pre">@return</span></span> to generate
the correct WSDL for a service:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$autodiscover</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Zend\Soap\AutoDiscover</span><span class="p">();</span>
<span class="nv">$autodiscover</span><span class="o">-&gt;</span><span class="na">setClass</span><span class="p">(</span><span class="s1">'MyService'</span><span class="p">)</span>
             <span class="o">-&gt;</span><span class="na">setUri</span><span class="p">(</span><span class="s1">'http://server/namespace'</span><span class="p">)</span> <span class="c1">// same as server 'uri'</span>
             <span class="o">-&gt;</span><span class="na">setLocation</span><span class="p">(</span><span class="s1">'http://server/soap.php'</span><span class="p">)</span> <span class="c1">// same as server 'location'</span>
             <span class="o">-&gt;</span><span class="na">setServiceName</span><span class="p">(</span><span class="s1">'MyService'</span><span class="p">);</span>
<span class="nv">$wsdl</span> <span class="o">=</span> <span class="nv">$autodiscover</span><span class="o">-&gt;</span><span class="na">generate</span><span class="p">();</span>
<span class="nv">$wsdl</span><span class="o">-&gt;</span><span class="na">dump</span><span class="p">(</span><span class="s2">"/path/to/file.wsdl"</span><span class="p">);</span>
</pre></div>
</div>
<p>You can now place that WSDL file in any public location and then point both
<span class="docutils literal"><span class="pre">SOAPServer</span></span> and <span class="docutils literal"><span class="pre">SOAPClient</span></span> at the file using the first constructor
argument:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SOAPServer</span><span class="p">(</span><span class="s1">'http://server/path/wsdl'</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SOAPClient</span><span class="p">(</span><span class="s1">'http://server/path/wsdl'</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
</pre></div>
</div>
<p>To make the WSDL generation work with objects and object graphs, you have
to use objects in your service API that have only public properties. If
you dont do it this way, you will need to convert the objects in a seperate
step, something to avoid.</p>
<p>Sometimes you want to use other metadata than docblocks. When using
tools like Doctrine you already now much better what datatypes an object has.
You can write your own <cite>ComplexTypeStrategy</cite> to generate the metadata
for your WSDL files. This is more advanced topic, but can be understood and
automated in a reasonable amount of time.</p>
</div>
<div class="section" id="generating-objects-from-wsdl">
<h2>Generating Objects from WSDL</h2>
<p>If you implement a client, you want to generate objects for the datastructures
of a WSDL file. You can use those objects instead of the <span class="docutils literal"><span class="pre">stdClass</span></span> objects
which are used by default.</p>
<p>For this task I use the <a class="reference external" href="https://github.com/moyarada/XSD-to-PHP">XSD-TO-PHP library</a>.  I normally hack around in the code
a little to adjust for correct namespace generation and code-style adjustments,
but it works quite well by default. Here is an example of a generated class
for the DHL Intraship SOAP API:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">DHL\Intraship</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Person</span> <span class="k">extends</span> <span class="nx">ComplexType</span>
<span class="p">{</span>
  <span class="sd">/**</span>
<span class="sd">   *</span>
<span class="sd">   * @var salutation $salutation</span>
<span class="sd">   * @access public</span>
<span class="sd">   */</span>
  <span class="k">public</span> <span class="nv">$salutation</span><span class="p">;</span>

  <span class="sd">/**</span>
<span class="sd">   *</span>
<span class="sd">   * @var title $title</span>
<span class="sd">   * @access public</span>
<span class="sd">   */</span>
  <span class="k">public</span> <span class="nv">$title</span><span class="p">;</span>

  <span class="sd">/**</span>
<span class="sd">   *</span>
<span class="sd">   * @var firstname $firstname</span>
<span class="sd">   * @access public</span>
<span class="sd">   */</span>
  <span class="k">public</span> <span class="nv">$firstname</span><span class="p">;</span>

  <span class="sd">/**</span>
<span class="sd">   *</span>
<span class="sd">   * @var middlename $middlename</span>
<span class="sd">   * @access public</span>
<span class="sd">   */</span>
  <span class="k">public</span> <span class="nv">$middlename</span><span class="p">;</span>

  <span class="sd">/**</span>
<span class="sd">   *</span>
<span class="sd">   * @var lastname $lastname</span>
<span class="sd">   * @access public</span>
<span class="sd">   */</span>
  <span class="k">public</span> <span class="nv">$lastname</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The next thing you can generate is a classmap, that maps every WSDL Type to
your newly generated code, in the above example:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SOAPClient</span><span class="p">(</span><span class="nv">$wsdl</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span>
    <span class="s1">'classmap'</span> <span class="o">=&gt;</span> <span class="k">array</span><span class="p">(</span>
        <span class="s1">'Person'</span> <span class="o">=&gt;</span> <span class="s1">'DHL\Intraship\Person'</span><span class="p">,</span>
        <span class="c1">// all the other types</span>
    <span class="p">)</span>
<span class="p">));</span>
</pre></div>
</div>
</div>
<div class="section" id="soap-with-different-languages">
<h2>SOAP with different Languages</h2>
<p>As long as you stay within the PHP world, SOAP is rather easy with both WSDL
and non-WSDL modes. Once you want to talk to Java or C# you need solve some
more problems.</p>
<p>The first thing to understand is that SOAP can actually talk in 4 different
modes. You can use ‘document’ or ‘rpc’ style, ‘literal’ or ‘encoded’  use.
This post on the <a class="reference external" href="http://www.ibm.com/developerworks/library/ws-whichwsdl/">IBM website</a> describes all the
different modes in much detail and I recommend everybody having to work with
SOAP to read it.</p>
<p>The essence from that article is, that you will always want to use
<cite>document/literal</cite> for your SOAP services, to be compliant with all languages,
wrapping each method call and response in its own Message Document.</p>
<p>However using this style is rather complicated in PHP itself, because
for every input and output message you need to create a wrapper object (or
array) with a specific structure.</p>
<p>You can fix this problem on the Server by using this <a class="reference external" href="https://github.com/zendframework/zf2/blob/master/library/Zend/Soap/Server/DocumentLiteralWrapper.php">DocumentLiteralWrapper</a>
class in Zend Framework 2. It has no external dependencies, so you can just
copy it into your project if you want.</p>
<p>To generate a WSDL for document/literal mode, use the following methods
on Zend Autodiscovery:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$autodiscover</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Zend\Soap\AutoDiscover</span><span class="p">();</span>
<span class="nv">$autodiscover</span><span class="o">-&gt;</span><span class="na">setBindingStyle</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'style'</span> <span class="o">=&gt;</span> <span class="s1">'document'</span><span class="p">))</span>
             <span class="o">-&gt;</span><span class="na">setOperationStyle</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'use'</span> <span class="o">=&gt;</span> <span class="s1">'literal'</span><span class="p">));</span>
</pre></div>
</div>
<p>Then use the wrapper like such:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SOAPServer</span><span class="p">(</span><span class="nv">$wsdl</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
<span class="nv">$server</span><span class="o">-&gt;</span><span class="na">setObject</span><span class="p">(</span>
    <span class="k">new</span> <span class="nx">\Zend\Soap\Server\DocumentLiteralWrapper</span><span class="p">(</span>
        <span class="k">new</span> <span class="nx">SoapExceptionHandler</span><span class="p">(</span>
            <span class="k">new</span> <span class="nx">MyService</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">);</span>
<span class="nv">$server</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">();</span>
</pre></div>
</div>
<p>SOAP Servers generated this way can be converted into a C# SOAP Client with a
bunch of button clicks from Visual Studio. It will generate both the Client
object and all the data transfer objects for you. Truely amazing.</p>
</div>
<div class="section" id="testing-soap-interaction">
<h2>Testing SOAP Interaction</h2>
<p>Because SOAP is very painful about the exact format of messages and rejects
invalid messages in the client already when they do not match the WSDL you
certainly want to Integration test your clients and servers.</p>
<p>You can do that in PHPUnit by using a client, that wraps a Server directly
and doesn’t require a Webserver. Zend Framework 2 already has such an object,
named <cite>ZendSoapClientLocal</cite>. Its usage is simple:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$server</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">SOAPServer</span><span class="p">(</span><span class="nv">$wsdl</span><span class="p">,</span> <span class="nv">$options</span><span class="p">);</span>
<span class="nv">$server</span><span class="o">-&gt;</span><span class="na">setObject</span><span class="p">(</span>
    <span class="k">new</span> <span class="nx">\Zend\Soap\Server\DocumentLiteralWrapper</span><span class="p">(</span>
        <span class="k">new</span> <span class="nx">SoapExceptionHandler</span><span class="p">(</span>
            <span class="k">new</span> <span class="nx">MyService</span><span class="p">()</span>
        <span class="p">)</span>
    <span class="p">)</span>
<span class="p">);</span>
<span class="nv">$client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\Zend\Soap\Client\Local</span><span class="p">(</span><span class="nv">$server</span><span class="p">,</span> <span class="nv">$wsdl</span><span class="p">);</span>
<span class="nv">$client</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
</pre></div>
</div>
<p>This will pass through the complete SOAP marshalling and unmarshalling
process and allow you test SOAP interaction.</p>
<p>If you want to take a look at the code of the Local client, <a class="reference external" href="https://github.com/zendframework/zf2/blob/master/library/Zend/Soap/Client/Local.php">its very easy to
achieve this</a>.</p>
</div>
<div class="section" id="versioning-with-soap-wsdl">
<h2>Versioning with SOAP/WSDL</h2>
<p>If you want to version your SOAP Service, you will need to provide versioned
WSDL files on different URLs. You should never change the WSDL at a location,
because languages like C# statically create clients from the WSDL, never
talking to the WSDL again.</p>
<p>If you take care of your Service objects, then you can design them in a way
that you can use the same PHP service object for many different versions of the
WSDL file in a backwards compatible way. If your API changes alot, you might
need to implement different PHP service classes to allow for versioned APIs.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>While the full extent of SOAP and WSDL can be scary, they allow you to write
servers and clients for RPC communication between servers and languages very
easily. If you don’t need to expose your API to the webbrowser via REST/JSON,
then using SOAP is a very good alternative to most of the handcrafting that is
necessary for REST APIs.</p>
</div>
]]></description>
            <category><![CDATA[ PHP ]]></category>
             <pubDate>Fri, 31 Jan 2014 00:00:00 +0100</pubDate>
        </item>
    
        <item>
            <link>http://www.whitewashing.de/2014/01/26/assert_v2_0__fluent_api_and_lazy_assertions.html</link>
            <guid>http://www.whitewashing.de/2014/01/26/assert_v2_0__fluent_api_and_lazy_assertions.html</guid>
            <title><![CDATA[Assert v2.0: Fluent API and Lazy Assertions]]></title>
            <description><![CDATA[
<h1>Assert v2.0: Fluent API and Lazy Assertions</h1>
<p>Almost two years ago I started developing a small library <a class="reference external" href="https://github.com/beberlei/assert">Assert</a> (<a class="reference external" href="http://www.whitewashing.de/2012/09/04/using_assertions_for_validation.html">blog post</a>)
which contained a set of assertion methods to use in production code. With
18.000 installations from Packagist this is my most successful piece of open
source software outside of the Doctrine universe. There is a fair number
of contributors and I know several companies using the library in production.</p>
<p>The API however didn’t make me too happy, using the static method calls
made it impossible to collect multiple errors and also made the code
more verbose than necessary when validating the same value with multiple
assertions.</p>
<p>Several weeks ago I stumbled across the Java library <a class="reference external" href="http://joel-costigliola.github.io/assertj/">AssertJ</a> that gave me the idea how to fix
these problems. The last two days I had some time to implement those new
functionalities and I am releasing a new version 2.0 of Assert today.</p>
<div class="section" id="fluent-api">
<h2>Fluent API</h2>
<p>Instead of having to use the static assertion methods, there is now
a new fluent API, invoked by calling the function <span class="docutils literal"><span class="pre">Assert\that($value)</span></span>
and then all the assertions you want to call on that value.</p>
<p>Here are some examples:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nx">\Assert\that</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">notBlank</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">integer</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
<span class="nx">\Assert\that</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'foo'</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">))</span><span class="o">-&gt;</span><span class="na">isArray</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">all</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">();</span>
<span class="nx">\Assert\that</span><span class="p">(</span><span class="k">null</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">nullOr</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">boolean</span><span class="p">();</span>
</pre></div>
</div>
<p>This new API allows for much shorter and compact assertions.</p>
</div>
<div class="section" id="lazy-assertions">
<h2>Lazy Assertions</h2>
<p>Using Assert with webforms was never possible unless you wanted to show
the user only exactly one error message. Because every assertion fails
with an Exception, there was no way to execute multiple assertions and
collect the errors. This has changed with the new lazy assertion API,
that is similar to the Fluent API:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nx">\Assert\lazy</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">that</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="s1">'foo'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">string</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">that</span><span class="p">(</span><span class="k">null</span><span class="p">,</span> <span class="s1">'bar'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">notEmpty</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">that</span><span class="p">(</span><span class="s1">'string'</span><span class="p">,</span> <span class="s1">'baz'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">isArray</span><span class="p">()</span>
    <span class="o">-&gt;</span><span class="na">verifyNow</span><span class="p">();</span>
</pre></div>
</div>
<p>The method <span class="docutils literal"><span class="pre">that($value,</span> <span class="pre">$propertyPath)</span></span> requires a property path (name), so
that you know how to differentiate the errors afterwards.</p>
<p>On failure <span class="docutils literal"><span class="pre">verifyNow()</span></span> will throw an exception
<span class="docutils literal"><span class="pre">Assert\\LazyAssertionException</span></span> (this does not extend
<span class="docutils literal"><span class="pre">AssertionFailedException</span></span>) with a combined message:</p>
<div class="highlight-python"><div class="highlight"><pre>The following 3 assertions failed:
1) foo: Value "10" expected to be string, type integer given.
2) bar: Value "&lt;NULL&gt;" is empty, but non empty value was expected.
3) baz: Value "string" is not an array.
</pre></div>
</div>
<p>You can also call the method <span class="docutils literal"><span class="pre">getErrorExceptions()</span></span> to retrieve all the
underyling <span class="docutils literal"><span class="pre">AssertionFailedException</span></span> objects and convert them something
useable for the frontend.</p>
</div>
<div class="section" id="error-messages-values-and-constraints">
<h2>Error Messages, Values and Constraints</h2>
<p>In version 1.0 Assert did not have default error messages when failures
occured. This has changed and now every assertion has a default failure
message, as well as access to the value and constraints of an exception:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">use</span> <span class="nx">Assert\AssertionFailedException</span><span class="p">;</span>

<span class="k">try</span> <span class="p">{</span>
    <span class="nx">\Assert\that</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">range</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>
<span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">AssertionFailedException</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getMessage</span><span class="p">();</span> <span class="c1">// Value "10" is not between 100 and 1000.</span>
    <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getValue</span><span class="p">();</span> <span class="c1">// 10</span>
    <span class="nv">$e</span><span class="o">-&gt;</span><span class="na">getConstraints</span><span class="p">();</span> <span class="c1">// array('min' =&gt; 100, 'max' =&gt; 1000)</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This helps during development when the assertion exceptions occur and also
allows to provide error messages to the user, by using the exception code and
the value and constraint data for translating into human readable messages.</p>
<p>You can find more information in the <a class="reference external" href="https://github.com/beberlei/assert#assert">README of Assert</a>.</p>
</div>
]]></description>
            <category><![CDATA[ PHP ]]></category>
             <pubDate>Sun, 26 Jan 2014 00:00:00 +0100</pubDate>
        </item>
    
        <item>
            <link>http://www.whitewashing.de/2013/12/05/feature_flags_and_doctrine_entities.html</link>
            <guid>http://www.whitewashing.de/2013/12/05/feature_flags_and_doctrine_entities.html</guid>
            <title><![CDATA[Feature Flags and Doctrine Entities]]></title>
            <description><![CDATA[
<h1>Feature Flags and Doctrine Entities</h1>
<p>I was in a discussion with some of the <a class="reference external" href="http://drafts.easybib.com/">EasyBib developers</a> this week about how to use feature flags with
Doctrine Entities, Metadata Mapping and their database.</p>
<p>The problem of feature flags with Doctrine is easily explained: If you add
properties for a new feature that is disabled in the Doctrine metadata, then you
need to upgrade the database before deployment, even when the feature is not
being rolled out for some days/weeks. Doctrine requires the database to look
exactly like the metadata specifies it.</p>
<p>You can get around this problem by using the <cite>loadClassMetadata</cite> event quite
easily:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyProject\Listener</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">MyProject\Config\FeatureFlagConfiguration</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\Event\LoadClassMetadataEventArgs</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">FeatureFlagMetadataListener</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$featureFlagConfiguration</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">FeatureFlagConfiguration</span> <span class="nv">$config</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">featureFlagConfiguration</span> <span class="o">=</span> <span class="nv">$config</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">loadClassMetadata</span><span class="p">(</span><span class="nx">LoadClassMetadataEventArgs</span> <span class="nv">$eventArgs</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$classMetadata</span> <span class="o">=</span> <span class="nv">$eventArgs</span><span class="o">-&gt;</span><span class="na">getClassMetadata</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">featureFlagConfiguration</span><span class="o">-&gt;</span><span class="na">isEnabled</span><span class="p">(</span><span class="s1">'super_feature2'</span><span class="p">))</span> <span class="p">{</span>

            <span class="k">if</span> <span class="p">(</span><span class="nv">$classMetadata</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">===</span> <span class="s2">"MyProject</span><span class="se">\\</span><span class="s2">Entity</span><span class="se">\\</span><span class="s2">User"</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$classMetadata</span><span class="o">-&gt;</span><span class="na">mapField</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
                    <span class="s1">'fieldName'</span> <span class="o">=&gt;</span> <span class="s1">'superFeatureProperty'</span><span class="p">,</span>
                    <span class="s1">'type'</span> <span class="o">=&gt;</span> <span class="s1">'string'</span>
                <span class="p">));</span>
            <span class="p">}</span>

            <span class="k">if</span> <span class="p">(</span><span class="nv">$classMetadata</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">===</span> <span class="s2">"MyProject</span><span class="se">\\</span><span class="s2">Entity</span><span class="se">\\</span><span class="s2">Something"</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// more mapping</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can find documentation on the ClassMetadata in the <a class="reference external" href="http://docs.doctrine-project.org/en/latest/reference/php-mapping.html">documentation</a> or
<a class="reference external" href="http://www.doctrine-project.org/api/orm/2.4/class-Doctrine.ORM.Mapping.ClassMetadataInfo.html#methods">API</a>.</p>
<p>Then if the feature is enabled fore some time and accepted into the pool of
permanent features, you can remove the listener and move the mapping onto the
Entities metadata.</p>
]]></description>
            <category><![CDATA[ PHP ]]></category>
             <pubDate>Thu, 05 Dec 2013 00:00:00 +0100</pubDate>
        </item>
    
        <item>
            <link>http://www.whitewashing.de/2013/09/04/decoupling_from_symfony_security_and_fosuserbundle.html</link>
            <guid>http://www.whitewashing.de/2013/09/04/decoupling_from_symfony_security_and_fosuserbundle.html</guid>
            <title><![CDATA[Decoupling from Symfony Security and FOSUserBundle]]></title>
            <description><![CDATA[
<h1>Decoupling from Symfony Security and FOSUserBundle</h1>
<p>In this blog post I will show how to decouple your core application
from the Symfony Security component and User bundles such as the FOSUserBundle.</p>
<p>In my opinion a framework has to be evaluated by how much it allows you to hide
it from your actual application. This blog post will add another perspective on
how to achieve decoupling from Symfony user and security with a very simple
approach. With this puzzle piece and others I wrote about before (<a class="reference external" href="http://whitewashing.de/2013/06/27/extending_symfony2__controller_utilities.html">Controllers
as Service</a>,
<a class="reference external" href="http://whitewashing.de/2013/02/19/extending_symfony2__paramconverter.html">Param Converters</a>)
and other pieces I still need to write about, I would classify Symfony2 as a
good framework.</p>
<p>A number of other authors have written blog posts on decoupling Symfony and your model
code as well, such as William Durand <a class="reference external" href="http://williamdurand.fr/2013/08/07/ddd-with-symfony2-folder-structure-and-code-first/">on project structure</a>
, Matthias Verraes <a class="reference external" href="http://verraes.net/2011/10/code-folder-structure/">on project structure as well</a>
and on <a class="reference external" href="http://verraes.net/2013/04/decoupling-symfony2-forms-from-entities/">Decoupling Forms from Entities</a>.</p>
<p>User management breaks the isolation of your business model open,
by introducing the <span class="docutils literal"><span class="pre">UserInterface</span></span> from the Security component into your
code base. In combination with the <em>FOSUserBundle</em> this can cause a dependency
on quite a bit of code already because I wouldn’t call the <span class="docutils literal"><span class="pre">FOS\UserBundle\Model\User</span></span> object
leightweight. However this and other FriendsOfSymfony bundles
are very helpful to get annoying features of your application done in a matter
of hours.</p>
<p>You can decouple the <em>FOSUserBundle</em> from our own entities and code by
introducing a second object that representes the user concept in our model.
The <span class="docutils literal"><span class="pre">UserInterface</span></span> entities need fields for username, password, enabled and
some more. Except the username and email, the business model rarely needs other
properties.</p>
<p>Take an ecommerce system as example, where customers can register as users.
In this example we could create two entities <span class="docutils literal"><span class="pre">MyProject\UserBundle\Entity\User</span></span> and
<span class="docutils literal"><span class="pre">MyProject\ShopBundle\Entity\Customer</span></span>. Two strategies exist now:</p>
<ol class="arabic simple">
<li>Use the same table for both entities with some shared and other exclusive columns</li>
<li>Use different tables in the database</li>
</ol>
<p>I haven’t tried the first option yet, so I cannot say much about the feasibility.</p>
<p>For case two, the <span class="docutils literal"><span class="pre">User</span></span> entity looks like this:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/MyProject/UserBundle/Entity/User.php;</span>

<span class="k">namespace</span> <span class="nx">MyProject\UserBundle\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">FOS\UserBundle\Model\User</span> <span class="k">as</span> <span class="nx">BaseUser</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @ORM\Entity</span>
<span class="sd"> * @ORM\Table(name="fos_user")</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">BaseUser</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @ORM\Id</span>
<span class="sd">     * @ORM\Column(type="integer")</span>
<span class="sd">     * @ORM\GeneratedValue(strategy="AUTO")</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <span class="docutils literal"><span class="pre">Customer</span></span> entity is a completly new object, not depending
on the <span class="docutils literal"><span class="pre">UserInterface</span></span> and containing some duplicated properties.</p>
<p>You can either use exactly the same ID or plant the <span class="docutils literal"><span class="pre">$userId</span></span> as
correlation ID in the <span class="docutils literal"><span class="pre">Customer</span></span> object.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/MyProject/ShopBundle/Entity/Customer.php</span>

<span class="k">namespace</span> <span class="nx">MyProject\ShopBundle\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @ORM\Entity</span>
<span class="sd"> * @ORM\Table(name="customer")</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">Customer</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @ORM\Id</span>
<span class="sd">     * @ORM\Column(type="integer")</span>
<span class="sd">     * @ORM\GeneratedValue(strategy="NONE")</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type="string")</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$username</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now you need to extend the application to synchronize all changes from the
<span class="docutils literal"><span class="pre">User</span></span> entity to the <span class="docutils literal"><span class="pre">Customer</span></span> entity. You can
achieve this relatively easy by overwriting the <span class="docutils literal"><span class="pre">ModelManager</span></span> or when finally
supported by <em>FOSUserBundle</em> listening to events.  Your own code can
exclusively work with <span class="docutils literal"><span class="pre">Customer</span></span> objects now, void of any reference to
the Symfony Security component or the huge FOSUserBundle dependency.</p>
]]></description>
            <category><![CDATA[ PHP ]]></category>
            <category><![CDATA[ Symfony2 ]]></category>
             <pubDate>Wed, 04 Sep 2013 00:00:00 +0200</pubDate>
        </item>
    
        <item>
            <link>http://www.whitewashing.de/2013/08/19/speedup_symfony2_on_vagrant_boxes.html</link>
            <guid>http://www.whitewashing.de/2013/08/19/speedup_symfony2_on_vagrant_boxes.html</guid>
            <title><![CDATA[Speedup Symfony2 on Vagrant boxes]]></title>
            <description><![CDATA[
<h1>Speedup Symfony2 on Vagrant boxes</h1>
<ul class="simple">
<li><strong>Update:</strong> Added requirements to configure Vagrant and Virtualbox before
trying my change.</li>
<li><strong>Update 2:</strong> Added link to Virtualbox Guest Additions plugin for Vagrant,
thanks Peter Kruithof for the hint.</li>
</ul>
<p>Using Symfony2 inside a Vagrant box is considered to be very slow (<a class="reference external" href="http://stackoverflow.com/questions/12161425/why-is-my-symfony-2-0-site-running-slowly-on-vagrant-with-linux-host">here</a>,
<a class="reference external" href="https://twitter.com/spicy_sake/status/183135528567320576">here</a>), even when
using NFS. I can confirm the experience and know many others that reported the
same.</p>
<p>Before doing this changes make sure:</p>
<ul class="simple">
<li>You are using Vagrant 1.2 (not sure that makes a difference though)</li>
<li>You are using NFS with Vagrant (<a class="reference external" href="http://docs.vagrantup.com/v2/synced-folders/nfs.html">More</a>). If you are on
Windows then this can already be the problem (Virtualbox FS is slow with
Symfony, because of the large number of files.)</li>
<li>You have the Vbox Guest Additions on the guest that match your system (<a class="reference external" href="https://github.com/dotless-de/vagrant-vbguest">Vagrant Plugin</a>, <a class="reference external" href="https://gist.github.com/fernandoaleman/5083680">Manual Update</a>)</li>
<li>You have an opcode cache installed, either <cite>apc</cite> or <cite>opcache</cite>.</li>
<li>You disable <cite>xdebug</cite> or <cite>xhprof</cite>.</li>
</ul>
<p>Without looking at an actual benchmark (mistake!) I always considered the problem to be
related to the huge number of files that a Symfony project normally ships with
and the I/O that is generated from <span class="docutils literal"><span class="pre">filemtime</span></span> calls to check if the
configuration files have changed.</p>
<p>This is just a small part, there are other bottlenecks that I have found after
finally doing some benchmarking with <a class="reference external" href="https://github.com/facebook/xhprof">XHProf</a>, leading to a simple fix:</p>
<ol class="arabic simple">
<li>Monolog logs to the NFS share and the huge number <span class="docutils literal"><span class="pre">fwrite</span></span> take their toll.</li>
<li>Writing compiled Twig templates to the NFS share using <span class="docutils literal"><span class="pre">file_put_contents</span></span>.</li>
<li>Assetic: Scanning for stylesheets and javascripts within templates is very
slow, causing lots of I/O on the NFS share and CPU and changing it to using
explicit bundling in the <span class="docutils literal"><span class="pre">app/config/config.yml</span></span> helps alot. You can use a
cronjob deployed by Puppet/Chef that invokes the <cite>assetic:dump</cite> command with
a <cite>–watch</cite> flag in the background.</li>
<li>JMSDiExtraBundle scans for Services to check for changes on service objects.</li>
<li><span class="docutils literal"><span class="pre">ReplaceAliasWithActualDefinitionPass</span></span> in Symfony DIC uses a set of
recursive algorithms to replace aliases with the real services. That takes a
huge amount of time in bigger applications including amounting calls to methods
inside the pass over 100.000 times.</li>
</ol>
<p>The slowest bottlenecks listed (1-4) are I/O bound, directly related to NFS.
To fix this just change the cache <strong>AND</strong> the log directory to
<span class="docutils literal"><span class="pre">sys_get_temp_dir()</span></span> or shared memory (/dev/shm) instead of writing to the
NFS share. I actually tried this before, but since I forgot the log directory,
this felt equally slow and I reverted the change.</p>
<p>Here is the code you should add to your <span class="docutils literal"><span class="pre">AppKernel</span></span> to give you a
considerable performance boost on a Vagrant box:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">AppKernel</span> <span class="k">extends</span> <span class="nx">Kernel</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getCacheDir</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">environment</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'dev'</span><span class="p">,</span> <span class="s1">'test'</span><span class="p">)))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s1">'/dev/shm/appname/cache/'</span> <span class="o">.</span>  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">environment</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">getCacheDir</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getLogDir</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">environment</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'dev'</span><span class="p">,</span> <span class="s1">'test'</span><span class="p">)))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s1">'/dev/shm/appname/logs'</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">getLogDir</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This brings the page rendering speeds down to between 0.5 and 1.5 seconds, which
is quite normal for the development environment even outside a virtual machine.</p>
<p>This tip obviously works for any kind of application that has a I/O intensive
development environment: Don’t perform this operations on the NFS share unless
you wan’t to suffer.</p>
]]></description>
            <category><![CDATA[ PHP ]]></category>
            <category><![CDATA[ Symfony ]]></category>
             <pubDate>Mon, 19 Aug 2013 00:00:00 +0200</pubDate>
        </item>
    
        <item>
            <link>http://www.whitewashing.de/2013/07/24/doctrine_and_domainevents.html</link>
            <guid>http://www.whitewashing.de/2013/07/24/doctrine_and_domainevents.html</guid>
            <title><![CDATA[Doctrine and Domain Events]]></title>
            <description><![CDATA[
<h1>Doctrine and Domain Events</h1>
<p>I have written about the <a class="reference external" href="/2012/08/25/decoupling_applications_with_domain_events.html">Domain Event Pattern</a> before and want
to focus on this pattern again by explaining its integration into the Doctrine
ORM on a very technical level.</p>
<p>The Domain Event Pattern allows to attach events to entities and dispatch them
to event listeners only when the transaction of the entity was successfully
executed. This has several benefits over traditional event dispatching
approaches:</p>
<ul class="simple">
<li>Puts focus on the behavior in the domain and what changes the domain
triggers.</li>
<li>Promotes decoupling in a very simple way</li>
<li>No reference to the event dispatcher and all the listeners required except in
the Doctrine UnitOfWork.</li>
<li>No need to use unexplicit Doctrine Lifecycle events that are triggered on all
update operations.</li>
</ul>
<p>This blog post will introduce a very simple implementation for Domain Events
with Doctrine2. You should be able to easily extend it to be more flexible,
reliable or optionally even asynchronuous. I skip some of the glue code in this blog post,
but you can try the full code by checking out <a class="reference external" href="https://gist.github.com/beberlei/53cd6580d87b1f5cd9ca">this Gist</a> and running
<span class="docutils literal"><span class="pre">composer</span> <span class="pre">install</span></span> and then <span class="docutils literal"><span class="pre">php</span> <span class="pre">domain_events.php</span></span>.</p>
<p>Lets look at the following entity, an <span class="docutils literal"><span class="pre">InventoryItem</span></span> tracking the number
we have this item in stock:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyProject\Domain</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">MyProject\DomainSuperTypes\AggregateRoot</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @Entity</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">InventoryItem</span> <span class="k">extends</span> <span class="nx">AggregateRoot</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Id @GeneratedValue @Column(type="integer")</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column(type="integer")</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">raise</span><span class="p">(</span><span class="s1">'InventoryItemCreated'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">checkIn</span><span class="p">(</span><span class="nv">$count</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">counter</span> <span class="o">+=</span> <span class="nv">$count</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">raise</span><span class="p">(</span><span class="s1">'ItemsCheckedIntoInventory'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'count'</span> <span class="o">=&gt;</span> <span class="nv">$count</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We want this entity to raise two domain events using the <span class="docutils literal"><span class="pre">raise($eventName,</span>
<span class="pre">array</span> <span class="pre">$properties)</span></span> method.  Our preferred use case for this code looks like this:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$item</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InventoryItem</span><span class="p">(</span><span class="s1">'Cookies'</span><span class="p">);</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">checkIn</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$item</span><span class="p">);</span>
<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span> <span class="c1">// fire events here</span>
</pre></div>
</div>
<p>One or many listeners should react to the events being fired, for example print their contents to the screen:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">EchoInventoryListener</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">onInventoryItemCreated</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nb">printf</span><span class="p">(</span><span class="s2">"New item created with name %s</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">onItemsCheckedIntoInventory</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nb">printf</span><span class="p">(</span><span class="s2">"There were %d new items checked into inventory</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As the first building block, we need a <a class="reference external" href="http://martinfowler.com/eaaCatalog/layerSupertype.html">Layer Supertype</a> for our entities,
called <span class="docutils literal"><span class="pre">AggregateRoot</span></span> adding the event raising capabilities to all entities that need it:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyProject\DomainSuperTypes</span><span class="p">;</span>

<span class="k">abstract</span> <span class="k">class</span> <span class="nc">AggregateRoot</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$events</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">popEvents</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$events</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">events</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">events</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

        <span class="k">return</span> <span class="nv">$events</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">raise</span><span class="p">(</span><span class="nv">$eventName</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$properties</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">events</span><span class="p">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DomainEvent</span><span class="p">(</span><span class="nv">$eventName</span><span class="p">,</span> <span class="nv">$properties</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This class allows us to add events to an entity using <span class="docutils literal"><span class="pre">raise()</span></span> as we have
seen in the <span class="docutils literal"><span class="pre">InventoryItem</span></span> entity before.</p>
<p>Now we need Doctrine to process the events during a transaction (<span class="docutils literal"><span class="pre">flush()</span></span>).
We do this by keeping all entities with domain events, and then triggering
the domain events after the transaction has completed. This is a vital part
of the domain events pattern, because it guarantees every listener that the
state leading to the event is already in the database.</p>
<p>Technically we implement this with a Doctrine EventListener that listeners for
the <span class="docutils literal"><span class="pre">postFlush</span></span>, <span class="docutils literal"><span class="pre">postPersist</span></span>, <span class="docutils literal"><span class="pre">postUpdate</span></span> and <span class="docutils literal"><span class="pre">postRemove</span></span> events:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyProject\DomainEvents</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityManager</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">MyProject\DomainSuperTypes\AggregateRoot</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">DomainEventListener</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$entities</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">postPersist</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">keepAggregateRoots</span><span class="p">(</span><span class="nv">$event</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">postUpdate</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">keepAggregateRoots</span><span class="p">(</span><span class="nv">$event</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">postRemove</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">keepAggregateRoots</span><span class="p">(</span><span class="nv">$event</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">postFlush</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$entityManager</span> <span class="o">=</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getEntityManager</span><span class="p">();</span>
        <span class="nv">$evm</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">getEventManager</span><span class="p">();</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entities</span> <span class="k">as</span> <span class="nv">$entity</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$class</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">getClassMetadata</span><span class="p">(</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$entity</span><span class="p">));</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$entity</span><span class="o">-&gt;</span><span class="na">popEvents</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$event</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">setAggregate</span><span class="p">(</span><span class="nv">$class</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">,</span> <span class="nv">$class</span><span class="o">-&gt;</span><span class="na">getSingleIdReflectionProperty</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getValue</span><span class="p">(</span><span class="nv">$entity</span><span class="p">));</span>
                <span class="nv">$evm</span><span class="o">-&gt;</span><span class="na">dispatchEvent</span><span class="p">(</span><span class="s2">"on"</span> <span class="o">.</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">(),</span> <span class="nv">$event</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entities</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">keepAggregateRoots</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$entity</span> <span class="o">=</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getEntity</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$entity</span> <span class="nx">instanceof</span> <span class="nx">AggregateRoot</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entities</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$entity</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now we only need to put this code together with Doctrine to get it working:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$evm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventManager</span><span class="p">();</span>
<span class="nv">$evm</span><span class="o">-&gt;</span><span class="na">addEventListener</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">'postInsert'</span><span class="p">,</span> <span class="s1">'postUpdate'</span><span class="p">,</span> <span class="s1">'postRemove'</span><span class="p">,</span> <span class="s1">'postFlush'</span><span class="p">),</span>
    <span class="k">new</span> <span class="nx">DomainEventListener</span><span class="p">()</span>
<span class="p">);</span>
<span class="nv">$evm</span><span class="o">-&gt;</span><span class="na">addEventListener</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">'onInventoryItemCreated'</span><span class="p">,</span> <span class="s1">'onItemsCheckedIntoInventory'</span><span class="p">),</span>
    <span class="k">new</span> <span class="nx">EchoInventoryListener</span>
<span class="p">);</span>
<span class="nv">$conn</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="cm">/* data */</span><span class="p">);</span>
<span class="nv">$config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Configuration</span><span class="p">();</span>
<span class="nv">$entityManager</span> <span class="o">=</span> <span class="nx">EntityManager</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="nv">$conn</span><span class="p">,</span> <span class="nv">$config</span><span class="p">,</span> <span class="nv">$evm</span><span class="p">);</span>
</pre></div>
</div>
<p>Now the example from above, creating and checking in inventory items
will trigger the <span class="docutils literal"><span class="pre">EchoInventoryListener</span></span> and print the data to the screen.</p>
<p>This example is very simple but shows how you can incorporate Domain Events into
your Doctrine projects. The following improvements can be made if necessary:</p>
<ul class="simple">
<li>Use a base EventSubscriber for the Domain Listeners, that automatically
registers all the domain event listener methods. This way you don’t have
to manually list them when calling <span class="docutils literal"><span class="pre">$evm-&gt;addListener()</span></span>.</li>
<li>Implement one class for every domain event, allowing to typehint the events
in listeners, with much more helpful information about the contained data.</li>
<li>If you prefer asynchroneous processing, serialize the events into a
<cite>domain_events</cite> table instead of triggering the events directly.
Add a daemon to your project that tails the table and triggers the events
in the background.</li>
</ul>
<p>I hope this blog post helps you when considering to use Domain Events Pattern with
Doctrine. Again, <a class="reference external" href="https://gist.github.com/beberlei/53cd6580d87b1f5cd9ca">see the code on this Gist</a> for a working example.</p>
]]></description>
            <category><![CDATA[ PHP ]]></category>
             <pubDate>Wed, 24 Jul 2013 00:00:00 +0200</pubDate>
        </item>
    
        <item>
            <link>http://www.whitewashing.de/2013/05/23/symfony2_on_windows_azure_websites.html</link>
            <guid>http://www.whitewashing.de/2013/05/23/symfony2_on_windows_azure_websites.html</guid>
            <title><![CDATA[Symfony2 on Windows Azure Websites]]></title>
            <description><![CDATA[
<h1>Symfony2 on Windows Azure Websites</h1>
<p>With the Windows Azure Websites platform-as-a-service (PaaS), which was
released as a preview to a general audiance in June last year, PHP applications
can be deployed to Azure with as much as a Git push to a remote repository. At
the same time Microsoft released a new and much improved <a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-php">PHP SDK</a>, which
integrates with all the Azure webservices.</p>
<p>I blogged about deployment with Composer on Azure Websites last November and
since then I have been working with Microsoft to improve Symfony2 support on
Windows Azure by developing and releasing the <a class="reference external" href="https://github.com/beberlei/AzureDistributionBundle">AzureDistributionBundle</a>. This is a new version
of the bundle and contains the following improvements:</p>
<ul class="simple">
<li>Full support for the PHP SDK through the DependencyInjection container</li>
<li>Installation of project dependendencies using Composer during deployment.
I will blog about the Composer support in much more detail in the next
days, because this information is not only valuable for Symfony2 projects.</li>
<li>a <a class="reference external" href="https://github.com/beberlei/symfony-azure-edition">full demo application</a> (derived from
symfony-standard) to show PHP, Symfony &amp; Azure integration</li>
<li>documentation of the Windows Azure Websites deployment process and
possiblities for PHP configuration</li>
<li>a Stream Wrapper for Azure Blob Storage, currently being reviewed for
inclusion into the Azure PHP SDK itself.</li>
</ul>
<p>You can install both the Bundle or the Demo application via Composer.
For the Demo application call:</p>
<div class="highlight-python"><div class="highlight"><pre>$ php composer.phar create-project beberlei/symfony-azure-edition
</pre></div>
</div>
<p>The README includes more information about how to deploy the demo
to your Azure websites account.</p>
<p>The bundle can be installed using the following <span class="docutils literal"><span class="pre">composer.json</span></span>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">"require"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"beberlei/azure-distribution-bundle"</span><span class="p">:</span> <span class="s2">"*"</span>
    <span class="p">},</span>
    <span class="s2">"repositories"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"pear"</span><span class="p">,</span>
            <span class="s2">"url"</span><span class="p">:</span> <span class="s2">"http://pear.php.net"</span>
        <span class="p">}</span>
    <span class="p">],</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Registering PEAR is necessary, because the Azure PHP SDK depends on some PEAR
components.</p>
]]></description>
            <category><![CDATA[ PHP ]]></category>
             <pubDate>Thu, 23 May 2013 00:00:00 +0200</pubDate>
        </item>
    
        <item>
            <link>http://www.whitewashing.de/2013/04/12/traits_are_static_access.html</link>
            <guid>http://www.whitewashing.de/2013/04/12/traits_are_static_access.html</guid>
            <title><![CDATA[Traits are Static Access]]></title>
            <description><![CDATA[
<h1>Traits are Static Access</h1>
<p>In a Twitter discussion yesterday I formulated my negative opinion
about traits and Matthew asked me to clarify it:</p>
<img alt="http://www.whitewashing.de/_static/traits_are_static_access.png" src="http://www.whitewashing.de/_static/traits_are_static_access.png"/>
<p>I used to look forward to traits as a feature in PHP 5.4, but after discussions
with <a class="reference external" href="http://twitter.com/koredn">Kore</a> I came to the conclusion that traits
are nothing else than static access in disguise. They actually lead to the
exact same code smells. Familiar with the outcome of too much static use,
we should reject traits as just another way of statically coupling your code
to other classes.</p>
<p>Let’s step back and take a look at the code smells that Static code produces:</p>
<ul class="simple">
<li>Tight coupling, no way to exchange at runtime</li>
<li>Not mockable</li>
<li>Static code cannot be overwritten through inheritance</li>
<li>Global state (increases likelihood of unwanted side effects)</li>
</ul>
<p>This blog post shows that Traits actually have the first three problems
themselves and exhibit the same code smells. But they even have some additional
problems on their own:</p>
<ul class="simple">
<li>Not testable in isolation</li>
<li>Theoretically stateless, but not enforced in PHP</li>
<li>Very high impact on the code base (Code-Rank)</li>
</ul>
<p>Take the following code, which tries to implement reusable
controller code through traits:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MyController</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">Redirector</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$container</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">someAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="s2">"route_xyz"</span><span class="p">,</span> <span class="k">array</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">trait</span> <span class="nx">Redirector</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">redirect</span><span class="p">(</span><span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">RedirectResponse</span><span class="p">(</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span><span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">generateUrl</span><span class="p">(</span><span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'router'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span>
            <span class="nv">$routeName</span><span class="p">,</span>
            <span class="nv">$parameters</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Lets spot the problems:</p>
<ol class="arabic">
<li><p class="first"><span class="docutils literal"><span class="pre">Redirector</span></span> is tightly coupled to <span class="docutils literal"><span class="pre">MyController</span></span>. There is no way to
change this during runtime, by using a different type of redirector, it has
to be exactly the trait used at compile time. This is exactly what static
access enforces as well.</p>
</li>
<li><p class="first">The trait accesses <span class="docutils literal"><span class="pre">$this-&gt;container</span></span> without defining it and couples itself against
the implementing classes. We can actually refactor this to include an
abstract method <span class="docutils literal"><span class="pre">getContainer()</span></span> in the trait. But if we have multiple
traits now, all having a <span class="docutils literal"><span class="pre">getContainer()</span></span> method then we run into method
class problems that cannot be solved. We could pass the container as an
argument to the method, but that actually defeats the purpose of the
abstraction here.</p>
<p>Traits using state of their “parents” usually create bidirectional
coupling between classes, something which should be avoided for good
software design.</p>
</li>
<li><p class="first">No way to overwrite subset of functionality. If I want to use only one
method of a trait and a second one slighty different, then I cannot
overwrite this function of <span class="docutils literal"><span class="pre">Redirector</span></span> for example in <span class="docutils literal"><span class="pre">MyController</span></span>.</p>
</li>
<li><p class="first">I cannot mock the traits functionality, therefore I cannot test
<span class="docutils literal"><span class="pre">MyController</span></span> as a unit only in combination with a trait.</p>
</li>
<li><p class="first">I cannot test the trait as a unit, I always have to create a class
that uses the trait to be able to write a test for it.
This prevents me from testing traits in isolation.</p>
</li>
<li><p class="first">Once you start using <span class="docutils literal"><span class="pre">Redirector</span></span> in many controllers, its impact
on your code base (see <a class="reference external" href="http://pdepend.org/documentation/software-metrics/index.html">Code Rank</a>) increases
a lot. Traits are concrete implementations and therefore violate the
Dependency Inversion SOLID principle: Changes in the trait require adoptions
in all the implementing classes.</p>
<p>With aggregation you could depend on an abstraction <span class="docutils literal"><span class="pre">Redirector</span></span> or
turn it into an abstraction in the moment that you need different
functionality.</p>
</li>
</ol>
<p>The discovery of this properties of traits me to the conclusion that traits are
just static access in disguise.</p>
<p>To see this argument a bit more drastically, you can “rewrite” a PHP 5.4 trait
into “pseudo” static code:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MyController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$container</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">someAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Redirector</span><span class="o">::</span><span class="na">redirect</span><span class="p">(</span><span class="s2">"route_xyz"</span><span class="p">,</span> <span class="k">array</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Redirector</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">redirect</span><span class="p">(</span><span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">RedirectResponse</span><span class="p">(</span>
            <span class="nx">self</span><span class="o">::</span><span class="na">generateUrl</span><span class="p">(</span><span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">generateUrl</span><span class="p">(</span><span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'router'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span>
            <span class="nv">$routeName</span><span class="p">,</span>
            <span class="nv">$parameters</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Calling dynamic methods statically actually works right now (and access to
<span class="docutils literal"><span class="pre">$this</span></span> of the parent class will luckily be removed in PHP 5.5). Let’s
reformulate it into something that is actually using static methods and
will work on 5.5, requires changes to the visibility of properties though:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MyController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$container</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">someAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Redirector</span><span class="o">::</span><span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s2">"route_xyz"</span><span class="p">,</span> <span class="k">array</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Redirector</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">redirect</span><span class="p">(</span><span class="nv">$thiz</span><span class="p">,</span> <span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">RedirectResponse</span><span class="p">(</span>
            <span class="nx">self</span><span class="o">::</span><span class="na">generateUrl</span><span class="p">(</span><span class="nv">$thiz</span><span class="p">,</span> <span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">generateUrl</span><span class="p">(</span><span class="nv">$thiz</span><span class="p">,</span> <span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$thiz</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'router'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span>
            <span class="nv">$routeName</span><span class="p">,</span>
            <span class="nv">$parameters</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Can you see the familiarity? If Traits can be rewritten as calls to static methods,
how can they be any better than static methods? They exhibit the exact same
problems and produce the same code smells.</p>
<p>Conclusion: Traits should be avoided at all costs, just like static methods.</p>
<p>Rule of Thumb: If you want to use a trait, try to think how to solve the
problem with aggregation.</p>
<p>If you want to read more about problems with traits,
<a class="reference external" href="http://blog.ircmaxell.com/2011/07/are-traits-new-eval.html">Anthony</a> wrote
about them quite a while ago.</p>
]]></description>
            <category><![CDATA[ PHP ]]></category>
             <pubDate>Fri, 12 Apr 2013 00:00:00 +0200</pubDate>
        </item>
    
        <item>
            <link>http://www.whitewashing.de/2013/03/04/doctrine_repositories.html</link>
            <guid>http://www.whitewashing.de/2013/03/04/doctrine_repositories.html</guid>
            <title><![CDATA[On Taming Repository Classes in Doctrine]]></title>
            <description><![CDATA[
<h1>On Taming Repository Classes in Doctrine</h1>
<p>Over at the <a class="reference external" href="http://drafts.easybib.com/post/44139111915/taiming-repository-classes-in-doctrine-with-the">easybib/dev</a>
Blog Anne posted an entry about their usage of Doctrine Repositories with a
growing amount of query responsibilities. I want to respond to this blog post
with two alternative approaches, because I have seen the easybib approach multiple
times in different projects by different teams and think it can be approved upon a lot.</p>
<p>The problems with the approach outlined are:</p>
<ul>
<li><p class="first">The Repository API does not hide implementation details of the ORM,
the QueryBuilder API is returned to the client code. This might seen
like nitpicking, however it leads to bloated client code doing the
query builder work over and over again. For example the
<span class="docutils literal"><span class="pre">-&gt;getQuery()-&gt;getSingleResult(AbstractQuery::HYDRATE_ARRAY)</span></span> call.</p>
</li>
<li><p class="first">Different parts of the QueryBuilder filtering cannot be composed together,
because of the way the API is created. Assume we have the
<span class="docutils literal"><span class="pre">filterGroupsForApi()</span></span> call, there is no way to combine it with another
call <span class="docutils literal"><span class="pre">filterGroupsForPermissions()</span></span>.  Instead reusing this code will lead
to a third method <span class="docutils literal"><span class="pre">filterGroupsForApiAndPermissions()</span></span>.</p>
<p>This can lead to combinatorial explosion of methods that the developer using
the repository needs to know.  And wading through a list of 100 methods to
find the right one is never fun, most importantly when the naming of methods
is imprecise.</p>
</li>
</ul>
<p>Generally introducing a new object such as a repository should pass the
“<a class="reference external" href="http://www.growing-object-oriented-software.com/toc.html">Composite is simpler than the sum of its parts</a>” rule. However the
approach also clearly demonstrates a bad abstraction. In OOP the primary goal is avoiding
changes to affect the whole system.</p>
<div class="section" id="introduce-criteria-objects">
<h2>Introduce Criteria Objects</h2>
<p>Instead of using the <span class="docutils literal"><span class="pre">QueryBuilder</span></span> outside of the Repository, lets start with an
alternative refactoring. I will introduce a <span class="docutils literal"><span class="pre">Criteria</span></span> class for the <span class="docutils literal"><span class="pre">User</span></span>:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">UserCriteria</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$groupId</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$hydrateMode</span> <span class="o">=</span> <span class="nx">Query</span><span class="o">::</span><span class="na">HYDRATE_OBJECT</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It is important not to introduce a constructor here, because when we add
more and more criterions, the constructor will get bloated. Static
factory methods that create a criteria do make sense however.</p>
<p>Now we can introduce a <span class="docutils literal"><span class="pre">match</span></span> method on the <span class="docutils literal"><span class="pre">UserRepository</span></span>. Lets see
that on an interface level first, to see how simple usage is for the client
side of the repository:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">interface</span> <span class="nx">UserRepository</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @param UserCriteria $criteria</span>
<span class="sd">     * @return array&lt;User&gt;|array&lt;array&gt;</span>
<span class="sd">     ***/</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">match</span><span class="p">(</span><span class="nx">UserCriteria</span> <span class="nv">$criteria</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Put in a <span class="docutils literal"><span class="pre">$criteria</span></span> get back users or array data. Very nice and simple!
The implementation would look like this:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="sd">/**</span>
<span class="sd"> * @param UserCriteria $criteria</span>
<span class="sd"> * @return array&lt;User&gt;</span>
<span class="sd"> ***/</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">match</span><span class="p">(</span><span class="nx">UserCriteria</span> <span class="nv">$criteria</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$qb</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">(</span><span class="s1">'u'</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="nv">$criteria</span><span class="o">-&gt;</span><span class="na">groupId</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">matchGroup</span><span class="p">(</span><span class="nv">$qb</span><span class="p">,</span> <span class="nv">$criteria</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getResult</span><span class="p">(</span><span class="nv">$criteria</span><span class="o">-&gt;</span><span class="na">hydrateMode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">private</span> <span class="k">function</span> <span class="nf">matchGroup</span><span class="p">(</span><span class="nv">$qb</span><span class="p">,</span> <span class="nv">$criteria</span><span class="p">)</span>
<span class="p">{</span>
    <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="s1">'u.group = :group'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">'group'</span><span class="p">,</span> <span class="nv">$criteria</span><span class="o">-&gt;</span><span class="na">groupId</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The benefit here is, that we can add additional conditions and processing
by only adding a new property on the <span class="docutils literal"><span class="pre">UserCriteria</span></span> and then handling
this inside <span class="docutils literal"><span class="pre">UserRepository#match()</span></span>. Additionally you can save the <span class="docutils literal"><span class="pre">UserCriteria</span></span>
in the session, or even in the database to that users can “save filter” or return
to a search overview, with the previous criteria still known.</p>
<p>The client code now looks like:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$criteria</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserCriteria</span><span class="p">();</span>
<span class="nv">$criteria</span><span class="o">-&gt;</span><span class="na">groupId</span> <span class="o">=</span> <span class="nv">$groupId</span><span class="p">;</span>
<span class="nv">$criteria</span><span class="o">-&gt;</span><span class="na">hydrateMode</span> <span class="o">=</span> <span class="nx">Query</span><span class="o">::</span><span class="na">HYDRATE_ARRAY</span><span class="p">;</span>

<span class="nv">$groups</span> <span class="o">=</span> <span class="nv">$app</span><span class="p">[</span><span class="s1">'orm.ems'</span><span class="p">][</span><span class="s1">'api'</span><span class="p">]</span>
    <span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">'EasyBib\Api\Entity\User'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">match</span><span class="p">(</span><span class="nv">$criteria</span><span class="p">);</span>
</pre></div>
</div>
<p>What we achieved in this step, is a simple API for the developer using the
Repository and a simple way to compose conditions by setting new properties
in the criteria.</p>
<p>If you complain that the solution has the same amount of lines, than the
original EasyBib solution, then you are missing the point.  We have factored
away a violation of the Law Of Demeter and calls on an API (Doctrine)
that should be implementation detail of the repository.</p>
<p>Lets try this by adding a new filter criteria, for example permissions I mentioned before:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">UserCriteria</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">PERMISSION_READ</span> <span class="o">=</span> <span class="s1">'read'</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">PERMISSION_WRITE</span> <span class="o">=</span> <span class="s1">'write'</span><span class="p">;</span>
    <span class="c1">//...</span>
    <span class="k">public</span> <span class="nv">$permissions</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">class</span> <span class="nc">UserRepository</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">match</span><span class="p">(</span><span class="nx">UserCriteria</span> <span class="nv">$criteria</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">$criteria</span><span class="o">-&gt;</span><span class="na">permissions</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">matchPermissions</span><span class="p">(</span><span class="nv">$criteria</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Simple enough, now we can use it everywhere we want by adding
for example <span class="docutils literal"><span class="pre">$criteria-&gt;permissions</span> <span class="pre">=</span> <span class="pre">UserCriteria::PERMISSION_WRITE</span></span>
in our client code.</p>
</div>
<div class="section" id="specification-pattern">
<h2>Specification Pattern</h2>
<p>The Criteria object gets us very far in abstracting lots of query building
behind a very simple API, but it fails short when:</p>
<ul class="simple">
<li>Composing Conditions using combinations of Not/And/Or is not possible
without a tree structure, however <span class="docutils literal"><span class="pre">Criteria</span></span> is just a single object.</li>
<li>Removing duplication of code between different repositories. If you
have similar conditions, limit or ordering requirements then you can
only solve this by having all repositories extend a base repository.
But <a class="reference external" href="http://c2.com/cgi/wiki?ImplementationInheritanceIsEvil">Inheritance is evil</a>.</li>
</ul>
<p>The <a class="reference external" href="http://en.wikipedia.org/wiki/Specification_pattern">Specification pattern</a> solves
this issue. There are several ways to implement it, in the spirit of refactoring I will
approach it from our existing Criteria.</p>
<p>Lets move the QueryBuilder code from the repository, into the Criteria object and
rename it <span class="docutils literal"><span class="pre">UserSpecification</span></span>. Its important here to change the query builder
code to use expressions that can be composed.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">UserSpecification</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$groupId</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$hydrateMode</span> <span class="o">=</span> <span class="nx">Query</span><span class="o">::</span><span class="na">HYDRATE_OBJECT</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$permissions</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">match</span><span class="p">(</span><span class="nx">QueryBuilder</span> <span class="nv">$qb</span><span class="p">,</span> <span class="nv">$dqlAlias</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$expr</span> <span class="o">=</span> <span class="s2">"1=1"</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">groupId</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$expr</span> <span class="o">=</span> <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">expr</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">and</span><span class="p">(</span><span class="nv">$expr</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">matchGroup</span><span class="p">(</span><span class="nv">$qb</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">permissions</span> <span class="o">!==</span> <span class="k">null</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$expr</span> <span class="o">=</span> <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">expr</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">and</span><span class="p">(</span><span class="nv">$expr</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">matchPermissions</span><span class="p">(</span><span class="nv">$qb</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$expr</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">modifyQuery</span><span class="p">(</span><span class="nx">Query</span> <span class="nv">$query</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">setHydrationMode</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">hydrateMode</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">matchGroup</span><span class="p">(</span><span class="nv">$qb</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">'group'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">groupId</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">expr</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">eq</span><span class="p">(</span><span class="s1">'u.group'</span><span class="p">,</span> <span class="s1">':group'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">matchPermissions</span><span class="p">(</span><span class="nv">$qb</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The repository is then delegating the expression generation
and puts the result into the <span class="docutils literal"><span class="pre">where()</span></span> method of the builder</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">UserRepository</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">match</span><span class="p">(</span><span class="nx">UserSpecification</span> <span class="nv">$specification</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$qb</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">(</span><span class="s1">'u'</span><span class="p">);</span>
        <span class="nv">$expr</span> <span class="o">=</span> <span class="nv">$specification</span><span class="o">-&gt;</span><span class="na">match</span><span class="p">(</span><span class="nv">$qb</span><span class="p">,</span> <span class="s1">'u'</span><span class="p">);</span>

        <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="nv">$expr</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">();</span>

        <span class="nv">$specification</span><span class="o">-&gt;</span><span class="na">modifyQuery</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Strictly speaking, the <span class="docutils literal"><span class="pre">UserSpecification</span></span> violates the single responsibility
principle, which prevents the composability of specifications and reuse in
different repositories. This is apparent by the <span class="docutils literal"><span class="pre">$expr</span> <span class="pre">=</span> <span class="pre">"1=1";</span></span> line that is
required to make the combination of conditions possible.
Lets factor away the violation of the single
responsibility principle by introducing three specifications:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">interface</span> <span class="nx">Specification</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @param \Doctrine\ORM\QueryBuilder $qb</span>
<span class="sd">     * @param string $dqlAlias</span>
<span class="sd">     *</span>
<span class="sd">     * @return \Doctrine\ORM\Query\Expr</span>
<span class="sd">     ***/</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">match</span><span class="p">(</span><span class="nx">QueryBuilder</span> <span class="nv">$qb</span><span class="p">,</span> <span class="nv">$dqlAlias</span><span class="p">);</span>

    <span class="sd">/**</span>
<span class="sd">     * @param \Doctrine\ORM\Query $query</span>
<span class="sd">     ***/</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">modifyQuery</span><span class="p">(</span><span class="nx">Query</span> <span class="nv">$query</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">AsArray</span> <span class="k">implements</span> <span class="nx">Specification</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$parent</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nx">Specification</span> <span class="nv">$parent</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parent</span> <span class="o">=</span> <span class="nv">$parent</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">modifyQuery</span><span class="p">(</span><span class="nx">Query</span> <span class="nv">$query</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">setHydrationMode</span><span class="p">(</span><span class="nx">Query</span><span class="o">::</span><span class="na">HYDRATE_ARRAY</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">match</span><span class="p">(</span><span class="nx">QueryBuilder</span> <span class="nv">$qb</span><span class="p">,</span> <span class="nv">$dqlAlias</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">parent</span><span class="o">-&gt;</span><span class="na">match</span><span class="p">(</span><span class="nv">$qb</span><span class="p">,</span> <span class="nv">$dqlAlias</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">FilterGroup</span> <span class="k">implements</span> <span class="nx">Specification</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$group</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$group</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">group</span> <span class="o">=</span> <span class="nv">$group</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">match</span><span class="p">(</span><span class="nx">QueryBuilder</span> <span class="nv">$qb</span><span class="p">,</span> <span class="nv">$dqlAlias</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">setParameter</span><span class="p">(</span><span class="s1">'group'</span><span class="p">,</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">group</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">expr</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">eq</span><span class="p">(</span><span class="nv">$dqlAlias</span> <span class="o">.</span> <span class="s1">'.group'</span><span class="p">,</span> <span class="s1">':group'</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">modifyQuery</span><span class="p">(</span><span class="nx">Query</span> <span class="nv">$query</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* empty ***/</span> <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">FilterPermission</span> <span class="k">implements</span> <span class="nx">Specification</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$permissions</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$permissions</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">permissions</span> <span class="o">=</span> <span class="nv">$permissions</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">match</span><span class="p">(</span><span class="nx">QueryBuilder</span> <span class="nv">$qb</span><span class="p">,</span> <span class="nv">$dqlAlias</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ...</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">modifyQuery</span><span class="p">(</span><span class="nx">Query</span> <span class="nv">$query</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* empty ***/</span> <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now we need a new And-Specification to combine this in our code. This
looks rather abstract and complex on the inside, but for clients
of this object, the usage is simple and obvious.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">AndX</span> <span class="k">implements</span> <span class="nx">Specification</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$children</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">children</span> <span class="o">=</span> <span class="nb">func_get_args</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">match</span><span class="p">(</span><span class="nx">QueryBuilder</span> <span class="nv">$qb</span><span class="p">,</span> <span class="nv">$dqlAlias</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nb">call_user_func_array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">expr</span><span class="p">(),</span> <span class="s1">'andX'</span><span class="p">),</span>
            <span class="nb">array_map</span><span class="p">(</span><span class="k">function</span> <span class="p">(</span><span class="nv">$specification</span><span class="p">)</span> <span class="k">use</span> <span class="p">(</span><span class="nv">$qb</span><span class="p">,</span> <span class="nv">$dqlAlias</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">return</span> <span class="nv">$specification</span><span class="o">-&gt;</span><span class="na">match</span><span class="p">(</span><span class="nv">$qb</span><span class="p">,</span> <span class="nv">$dqlAlias</span><span class="p">);</span>
            <span class="p">},</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">children</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">modifyQuery</span><span class="p">(</span><span class="nx">Query</span> <span class="nv">$query</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">children</span> <span class="k">as</span> <span class="nv">$child</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$child</span><span class="o">-&gt;</span><span class="na">modifyQuery</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Assuming we import all specifications
from a common namespace <span class="docutils literal"><span class="pre">Spec</span></span>, our client code will look
like this:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$specification</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Spec\AsArray</span><span class="p">(</span><span class="k">new</span> <span class="nx">Spec\AndX</span><span class="p">(</span>
    <span class="k">new</span> <span class="nx">Spec\FilterGroup</span><span class="p">(</span><span class="nv">$groupId</span><span class="p">),</span>
    <span class="k">new</span> <span class="nx">Spec\FilterPermission</span><span class="p">(</span><span class="nv">$permission</span><span class="p">)</span>
<span class="p">));</span>

<span class="nv">$groups</span> <span class="o">=</span> <span class="nv">$app</span><span class="p">[</span><span class="s1">'orm.ems'</span><span class="p">][</span><span class="s1">'api'</span><span class="p">]</span>
    <span class="o">-&gt;</span><span class="na">getRepository</span><span class="p">(</span><span class="s1">'\EasyBib\Api\Entity\Group'</span><span class="p">)</span>
    <span class="o">-&gt;</span><span class="na">match</span><span class="p">(</span><span class="nv">$specification</span><span class="p">);</span>
</pre></div>
</div>
<p>In contrast to the criteria, we could now implement
or and not specifications to enhance query capabilities.</p>
</div>
<div class="section" id="improving-specifications">
<h2>Improving Specifications</h2>
<p>You can now introduce reusability across different repositories by adding
functionality to check if a specification supports a given entity.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">interface</span> <span class="nx">Specification</span>
<span class="p">{</span>
    <span class="c1">// ..</span>
    <span class="sd">/**</span>
<span class="sd">     * @param string $className</span>
<span class="sd">     * @return bool</span>
<span class="sd">     ***/</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">supports</span><span class="p">(</span><span class="nv">$className</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Every composite can delegate this operation to its children, and every leaf of
the tree can return true or false. The Repository can then check for a valid
specification in its match method:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">abstract</span> <span class="k">class</span> <span class="nc">EntitySpecificationRepository</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">match</span><span class="p">(</span><span class="nx">Specification</span> <span class="nv">$specification</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nv">$specification</span><span class="o">-&gt;</span><span class="na">supports</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getEntityName</span><span class="p">()))</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\InvalidArgumentException</span><span class="p">(</span><span class="s2">"Specification not supported by this repository."</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$qb</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createQueryBuilder</span><span class="p">(</span><span class="s1">'r'</span><span class="p">);</span>
        <span class="nv">$expr</span> <span class="o">=</span> <span class="nv">$specification</span><span class="o">-&gt;</span><span class="na">match</span><span class="p">(</span><span class="nv">$qb</span><span class="p">,</span> <span class="s1">'r'</span><span class="p">);</span>

        <span class="nv">$query</span> <span class="o">=</span> <span class="nv">$qb</span><span class="o">-&gt;</span><span class="na">where</span><span class="p">(</span><span class="nv">$expr</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">getQuery</span><span class="p">();</span>

        <span class="nv">$specification</span><span class="o">-&gt;</span><span class="na">modifyQuery</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$query</span><span class="o">-&gt;</span><span class="na">getResult</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now we can introduce very generic specifications, such as <cite>OnlyPage($page, Specification $spec)`</cite>
for limit queries, or <span class="docutils literal"><span class="pre">Equals($field,</span> <span class="pre">$value)</span></span>. For more readable code, you can then create
a domain language for your specifications that is composed of more simple specifications:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">PowerUsers</span> <span class="k">implements</span> <span class="nx">Specification</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$spec</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">spec</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">OnlyPage</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="k">new</span> <span class="nx">AndX</span><span class="p">(</span>
            <span class="k">new</span> <span class="nx">UsersWithInteraction</span><span class="p">(),</span>
            <span class="k">new</span> <span class="nx">EnabledUsers</span><span class="p">(),</span>
        <span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">match</span><span class="p">(</span><span class="nx">QueryBuilder</span> <span class="nv">$qb</span><span class="p">,</span> <span class="nv">$dqlAlias</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">spec</span><span class="o">-&gt;</span><span class="na">match</span><span class="p">(</span><span class="nv">$qb</span><span class="p">,</span> <span class="nv">$dqlAlias</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">modifyQuery</span><span class="p">(</span><span class="nx">Query</span> <span class="nv">$query</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">spec</span><span class="o">-&gt;</span><span class="na">modifyQuery</span><span class="p">(</span><span class="nv">$query</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">supports</span><span class="p">(</span><span class="nv">$className</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="nv">$className</span> <span class="o">===</span> <span class="s1">'EasyBib\Api\Entity\User'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nv">$top20powerUsers</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Spec\PowerUsers</span><span class="p">();</span>
</pre></div>
</div>
<p>Hiding this kind of composition inside another specification allows
you to reuse query logic in different places in the application
easily and in terms of the domain language.</p>
</div>
<div class="section" id="testability-of-doctrine-repositories">
<h2>Testability of Doctrine Repositories</h2>
<p>One reasons outlined by Anne for this design is testability: Because the
Repository returns the QueryBuilder you have access to the generated SQL.
However testing Doctrine Repositories should never be verifying the generated
SQL. I see a lot of people doing this and it is very fragile and dangerous.
Doctrine is a third party library and as such a rather complex one. Possible
changes that break the test are:</p>
<ul class="simple">
<li>Doctrine adds/removes whitespaces to SQL in a next version</li>
<li>Doctrine performs SQL optimizations in certain cases, the result is the same though.</li>
<li>You add a field/column to any of the tables involved that does not affect the result.</li>
<li>You change something in the Doctrine mapping files, that leads to a reordering of SQL.</li>
</ul>
<p>These are 4 changes that have absolutely nothing to do with the feature you are
actually testing, making the test code very fragile. In terms of abstraction
SQL generation is an implementation detail of the Doctrine ORM and you as
developer are only interested in the public API, which the SQL generation is
not part of.</p>
<p>The code should really be tested against Doctrine itself. Since you are using
Doctrine to get rid of SQL query generation for some use-cases, why should you
use them as measure of quality in your testing efforts.</p>
<p>Testing repositories with the Specification pattern is testing the different
specifications in isolation against a real Doctrine database backend. This will
not be super simple to setup, but the isolation of specifications and their
reusability across repositories actually allows us to keep the number of
tests very small. The pattern avoids the problem of combinatorial explosion of
test-cases very neatly.</p>
<p>The real benefit of testability is achieved in tests of repository client code.
Before we were not able to unit-test this code, because of the Doctrine
EntityManager, Query + QueryBuilder dependencies.  Now We can inject the
repositories into our controllers and services and then use mock objects in the
tests.</p>
</div>
]]></description>
            <category><![CDATA[ PHP ]]></category>
             <pubDate>Mon, 04 Mar 2013 00:00:00 +0100</pubDate>
        </item>
    
        <item>
            <link>http://www.whitewashing.de/2013/02/04/doctrine_and_solid.html</link>
            <guid>http://www.whitewashing.de/2013/02/04/doctrine_and_solid.html</guid>
            <title><![CDATA[Doctrine and SOLID]]></title>
            <description><![CDATA[
<h1>Doctrine and SOLID</h1>
<p>I often get asked how you can use <a class="reference external" href="http://www.doctrine-project.org">Doctrine2</a> and implement <a class="reference external" href="http://en.wikipedia.org/wiki/SOLID_(object-oriented_design)">the SOLID principles</a> at the same
time. It bugs me having to reply: It is not really possible.  Because Doctrine2
does not support value-objects (or embedded-objects), it is very hard to pull
the <a class="reference external" href="http://en.wikipedia.org/wiki/Single_responsibility_principle">Single Responsibility Principle</a> off.</p>
<p>These problems are related to the inability to share behavioral code through
aggregation and the complexity of state transformations. Combining both, your
average entity with 5-15 fields can end up with hundreds or thousands lines of
code. The solutions to both problems boil down to <a class="reference external" href="http://www.jbrains.ca/permalink/the-four-elements-of-simple-design">minimizing duplication and
maximizing clarity</a>.</p>
<div class="section" id="extracting-value-objects-minimize-duplication">
<h2>Extracting Value Objects: Minimize Duplication</h2>
<p>Entity classes responsibility are the state transformations of their internal
fields.  This can simply be done by using setter methods or <a class="reference external" href="http://whitewashing.de/2012/08/22/building_an_object_model__no_setters_allowed.html">when avoiding
setters</a>,
with use-case driven methods.  These state transformations can be part of
different responsibilities, specifically when properties belong to different
groups of concepts.</p>
<p>Take a very simple entity that contains updated/created at logic:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @ORM\Entity</span>
<span class="sd"> * @ORM\HasLifecycleCallbacks</span>
<span class="sd"> **/</span>
<span class="k">class</span> <span class="nc">Person</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type="datetime")</span>
<span class="sd">     **/</span>
    <span class="k">private</span> <span class="nv">$createdAt</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type="datetime")</span>
<span class="sd">     **/</span>
    <span class="k">private</span> <span class="nv">$updatedAt</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createdAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">"now"</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">updatedAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">"now"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\PreUpdate</span>
<span class="sd">     **/</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">updatedAt</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">updatedAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">"now"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>If you want to duplicate this logic to another second entity, then in Doctrine
the solution for this is using traits. <a class="reference external" href="http://kore-nordmann.de/blog.html">Kore</a> will dismiss this solution, because
traits create a hard dependency. Even if we accept the static dependency,
traits are not perfect even for this very simple example, because its very
likely that you cannot override the constructor of every entity.</p>
<p>The solution is to extract a value object <span class="docutils literal"><span class="pre">Timestamped</span></span> that contains
all the logic:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">Timestamped</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$createdAt</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$updatedAt</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createdAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">"now"</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">updatedAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">"now"</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">updatedAt</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">updatedAt</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">"now"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Person</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$timestamped</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">timestamped</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Timestamped</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>See how all the code could be moved into <span class="docutils literal"><span class="pre">Timestamped</span></span> and is now reusable
in other entities.</p>
<p>Doctrine has no support for embedded objects, which is very sad. I am working
very hard to get this feature into Doctrine as soon as possible. You can use
the “object” type as a workaround and <span class="docutils literal"><span class="pre">serialize()</span></span> the value object into
the database. However this is beyond ugly in my opinion.</p>
</div>
<div class="section" id="extract-method-objects-maximizing-clarity">
<h2>Extract Method Objects: Maximizing clarity</h2>
<p>Once you have identified groups of fields that are modified, then the
complexity of the state transformations can attract lots of code.</p>
<p>Take an <span class="docutils literal"><span class="pre">Order</span></span> object that has a method for calculating the shipping costs,
depending all the order items and products.
To separate calculations from state transformations you can extract
method objects instead of inlining the code into the <span class="docutils literal"><span class="pre">Order</span></span> object.</p>
<p>For this kind of extraction I create a folder <span class="docutils literal"><span class="pre">Order</span></span> and put all
the extracted method objects in the <span class="docutils literal"><span class="pre">Order</span></span> subnamespace.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyProject\Entity</span> <span class="p">{</span>

    <span class="k">class</span> <span class="nc">Order</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">function</span> <span class="nf">calculateShippingCosts</span><span class="p">()</span>
        <span class="p">{</span>
            <span class="nv">$calculator</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">ShippingCostCalculator</span><span class="p">();</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shippingCosts</span> <span class="o">=</span> <span class="nv">$calculator</span><span class="o">-&gt;</span><span class="na">calculate</span><span class="p">(</span><span class="nv">$this</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">namespace</span> <span class="nx">MyProject\Entity\Order</span> <span class="p">{</span>

    <span class="k">class</span> <span class="nc">ShippingCostCalculator</span>
    <span class="p">{</span>
        <span class="k">public</span> <span class="k">function</span> <span class="nf">calculate</span><span class="p">(</span><span class="nx">Order</span> <span class="nv">$order</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>From this step its easy to make the code reusable by passing the shipping cost
calculator:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">Order</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">calculateShippingCosts</span><span class="p">(</span><span class="nx">ShippingCostCalculator</span> <span class="nv">$calculator</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">shippingCosts</span> <span class="o">=</span> <span class="nv">$calculator</span><span class="o">-&gt;</span><span class="na">calculate</span><span class="p">(</span><span class="nv">$this</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Another benefit is that you can test the shipping cost calculator directly in a
unit-test and avoid checking for the correctness indirectly through a getter
method for the shipping costs.</p>
<p>Extracting every method of an entity into a method object is obviously
overkill. You should exercise caution and common sense when performing this
refactoring.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Not all the techniques to implement SOLID code can be exploited when using Doctrine
for technical reasons. In the future I hope to support value objects in
Doctrine to make this possible.</p>
</div>
]]></description>
            <category><![CDATA[ PHP ]]></category>
             <pubDate>Mon, 04 Feb 2013 00:00:00 +0100</pubDate>
        </item>
    
        <item>
            <link>http://www.whitewashing.de/2012/11/19/composer_and_azure_websites_git_deployment.html</link>
            <guid>http://www.whitewashing.de/2012/11/19/composer_and_azure_websites_git_deployment.html</guid>
            <title><![CDATA[Composer and Azure Websites Git Deployment]]></title>
            <description><![CDATA[
<h1>Composer and Azure Websites Git Deployment</h1>
<p>Continuing my series on PHP PaaS Clouds (<a class="reference external" href="http://fortrabbit.com/">Fortrabbit</a>), I turn to Microsoft Azure today. After some
research I found out Azure supports post deployment hooks to run
Composer and allows you to configure environment variables from the Management
console.</p>
<p>Microsoft launched <a class="reference external" href="https://www.windowsazure.com/en-us/home/scenarios/web-sites/">Azure Websites</a> in June this
year.  It is a platform as a service solution where you can deploy your
websites via FTP or Git. With Azure Websites you can avoid having to deal with
the complex deployment automation that is necessary for <a class="reference external" href="https://www.windowsazure.com/en-us/home/features/cloud-services/">Azure Hosted Cloud
Services</a>.
As long as your website only requires an SQLServer, MySQL or external APIs you
can actually achieve quite a lot already.</p>
<p>For a <a class="reference external" href="http://www.symfony.com">Symfony2</a>, <a class="reference external" href="http://www.silex-project.org">Silex</a> or any other modern project however you want
<a class="reference external" href="http://www.getcomposer.org">Composer</a> support during the deployment as
long as failures with Composer don’t break your site.</p>
<p>It turns out that Azure Websites - to support other platforms that require
compiling - actually has an extremely robust deployment system (as far as I
understood its internals). The Git repository is separated from the actual code
that is served from the webserver and a number of old checkouts is kept to
allow rollbacks through the Web interface. Once a Git push was recognized,
Azure websites will execute a build step, and then copy all the files over to a
directory with the name of the Git SHA hash. This directory is then symlinked
to the document root.</p>
<p>If Composer fails during this step, the website will still be served from the
currently running version and you don’t have to face unexpected downtime.</p>
<p>To actually run Composer as a post-deployment tool you have to do some manual
work. Create a <span class="docutils literal"><span class="pre">.deployment</span></span> file in your project root folder:</p>
<div class="highlight-ini"><div class="highlight"><pre><span class="k">[config]</span>
<span class="na">command</span> <span class="o">=</span> <span class="s">"D:\Program Files (x86)\PHP\v5.3\php.exe" build_azure.php</span>
</pre></div>
</div>
<p>If you are using PHP 5.4, then you probably have to change the command version
name to “v5.4”, but I haven’t tested this.</p>
<p>Then you need to create the <span class="docutils literal"><span class="pre">build_azure.php</span></span> file that is referenced in the
deployment command. The actual implementation is up to you, my version is
the most simple one:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="s2">"composer.phar"</span><span class="p">))</span> <span class="p">{</span>
    <span class="nv">$url</span> <span class="o">=</span> <span class="s1">'https://getcomposer.org/composer.phar'</span><span class="p">;</span>
    <span class="nb">file_put_contents</span><span class="p">(</span><span class="s2">"composer.phar"</span><span class="p">,</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$url</span><span class="p">));</span>
<span class="p">}</span>

<span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'argv'</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"update"</span><span class="p">;</span>
<span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'argv'</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"--prefer-dist"</span><span class="p">;</span>
<span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'argv'</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="s2">"-v"</span><span class="p">;</span>
<span class="k">require</span> <span class="s2">"composer.phar"</span><span class="p">;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">This currently only works with a Composer version, where
<a class="reference external" href="https://github.com/composer/composer/pull/1341">PR-1341</a> is applied.
You can check out <a class="reference external" href="https://github.com/beberlei/composer/tree/GH-1339">my Composer fork</a> and run
<span class="docutils literal"><span class="pre">./bin/compile</span></span> to generate a composer.phar that works.</p>
</div>
<p>Instead of using this approach, you could ship <span class="docutils literal"><span class="pre">composer.phar</span></span> with your repository for example.
You can of course execute additional steps in the <span class="docutils literal"><span class="pre">build_azure.php</span></span>, for example warmup caches.</p>
]]></description>
            <category><![CDATA[ PHP ]]></category>
             <pubDate>Mon, 19 Nov 2012 00:00:00 +0100</pubDate>
        </item>
    
        <item>
            <link>http://www.whitewashing.de/2012/09/04/using_assertions_for_validation.html</link>
            <guid>http://www.whitewashing.de/2012/09/04/using_assertions_for_validation.html</guid>
            <title><![CDATA[Using Assertions for validation]]></title>
            <description><![CDATA[
<h1>Using Assertions for validation</h1>
<p>We all know PHP is weakly typed and has some weird type-conversion rules.
This can often complicate our code checking for invalid or illegal data.
Using if/else clauses we can do all sorts of validation, but with standard
coding styles (PSR, Zend, PEAR) we end up with at least 3 lines per check,
cluttering the whole code-base.</p>
<p>Take <a class="reference external" href="http://phpazure.codeplex.com/SourceControl/changeset/view/67037#840935">this example</a> from
the old deprecated Windows Azure SDK, a method for putting a binary file into
Azures blob storage:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">putBlob</span><span class="p">(</span><span class="nv">$containerName</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$blobName</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$localFileName</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$metadata</span> <span class="o">=</span> <span class="k">array</span><span class="p">(),</span> <span class="nv">$leaseId</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$additionalHeaders</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$containerName</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Microsoft_WindowsAzure_Exception</span><span class="p">(</span><span class="s1">'Container name is not specified.'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">self</span><span class="o">::</span><span class="na">isValidContainerName</span><span class="p">(</span><span class="nv">$containerName</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Microsoft_WindowsAzure_Exception</span><span class="p">(</span><span class="s1">'Container name does not adhere to container naming conventions. See http://msdn.microsoft.com/en-us/library/dd135715.aspx for more information.'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$blobName</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Microsoft_WindowsAzure_Exception</span><span class="p">(</span><span class="s1">'Blob name is not specified.'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$localFileName</span> <span class="o">===</span> <span class="s1">''</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Microsoft_WindowsAzure_Exception</span><span class="p">(</span><span class="s1">'Local file name is not specified.'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$localFileName</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Microsoft_WindowsAzure_Exception</span><span class="p">(</span><span class="s1">'Local file not found.'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="nv">$containerName</span> <span class="o">===</span> <span class="s1">'$root'</span> <span class="o">&amp;&amp;</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$blobName</span><span class="p">,</span> <span class="s1">'/'</span><span class="p">)</span> <span class="o">!==</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">Microsoft_WindowsAzure_Exception</span><span class="p">(</span><span class="s1">'Blobs stored in the root container can not have a name containing a forward slash (/).'</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="c1">// rest of the code here</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The rest of this components public API methods look about the same. It is a
very complete validation of the input data, however its not very readable.
Instead you have 6 if branches, which increase the complexity of the method
and almost take up half the screen without even getting to the actual code.</p>
<p>The assertion pattern is really helpful here to reduce the complexity of this
code and hide the <span class="docutils literal"><span class="pre">if/throw</span></span> conditions into little helper methods. Have a
look at a refactored method using my <a class="reference external" href="https://github.com/beberlei/assert">Assert</a> micro-library.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">public</span> <span class="k">function</span> <span class="nf">putBlob</span><span class="p">(</span><span class="nv">$containerName</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$blobName</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$localFileName</span> <span class="o">=</span> <span class="s1">''</span><span class="p">,</span> <span class="nv">$metadata</span> <span class="o">=</span> <span class="k">array</span><span class="p">(),</span> <span class="nv">$leaseId</span> <span class="o">=</span> <span class="k">null</span><span class="p">,</span> <span class="nv">$additionalHeaders</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
<span class="p">{</span>
    <span class="nx">Assertion</span><span class="o">::</span><span class="na">notEmpty</span><span class="p">(</span><span class="nv">$containerName</span><span class="p">,</span> <span class="s1">'Container name is not specified'</span><span class="p">);</span>
    <span class="nx">self</span><span class="o">::</span><span class="na">assertValidContainerName</span><span class="p">(</span><span class="nv">$containerName</span><span class="p">);</span>
    <span class="nx">Assertion</span><span class="o">::</span><span class="na">notEmpty</span><span class="p">(</span><span class="nv">$blobName</span><span class="p">,</span> <span class="s1">'Blob name is not specified.'</span><span class="p">);</span>
    <span class="nx">Assertion</span><span class="o">::</span><span class="na">notEmpty</span><span class="p">(</span><span class="nv">$localFileName</span><span class="p">,</span> <span class="s1">'Local file name is not specified.'</span><span class="p">);</span>
    <span class="nx">Assertion</span><span class="o">::</span><span class="na">file</span><span class="p">(</span><span class="nv">$localFileName</span><span class="p">,</span> <span class="s1">'Local file name is not specified.'</span><span class="p">);</span>
    <span class="nx">self</span><span class="o">::</span><span class="na">assertValidRootContainerBlobName</span><span class="p">(</span><span class="nv">$containerName</span><span class="p">,</span> <span class="nv">$blobName</span><span class="p">);</span>

    <span class="c1">// rest of the code</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is much more readable, using two custom assertions and some general
assertions.</p>
<p>There is one risk here though, you introduce additional coupling to another
library/namespace. Especially when you start using this pattern on a large
scale, you have to make sure this assertions are <strong>VERY</strong> stable and
unit-tested.</p>
<p>That is why you should extend from <span class="docutils literal"><span class="pre">Assertion</span></span> and use your own class when
using the Assert library. This returns some control in your hands and even
allows you to overwrite the exception class:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyProject\Util</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Assert\Assertion</span> <span class="k">as</span> <span class="nx">BaseAssertion</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">Assertion</span> <span class="k">extends</span> <span class="nx">BaseAssertion</span>
<span class="p">{</span>
    <span class="k">static</span> <span class="k">protected</span> <span class="nv">$exceptionClass</span> <span class="o">=</span> <span class="s1">'MyProject\Util\AssertionFailedException'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
]]></description>
            <category><![CDATA[ PHP ]]></category>
             <pubDate>Tue, 04 Sep 2012 00:00:00 +0200</pubDate>
        </item>
    
        <item>
            <link>http://www.whitewashing.de/2012/08/22/building_an_object_model__no_setters_allowed.html</link>
            <guid>http://www.whitewashing.de/2012/08/22/building_an_object_model__no_setters_allowed.html</guid>
            <title><![CDATA[Building an Object Model: No setters allowed]]></title>
            <description><![CDATA[
<h1>Building an Object Model: No setters allowed</h1>
<p>If you are using an object relational mapper or any other database
abstraction technology that converts rows to objects, then you will probably
use getter/setter methods or properties (C#) to encapsulate object properties.</p>
<p>Take <a class="reference external" href="https://github.com/FriendsOfSymfony/FOSUserBundle/blob/master/Model/User.php">a look</a>
at the default <span class="docutils literal"><span class="pre">User</span></span> entity from the Symfony2 FOSUserBundle plugin for
example: A colossus of getter/setter methods with nearly no real business
logic. This is how most of our persistence related objects look like in PHP.
A Rails ActiveRecord such as <a class="reference external" href="https://github.com/redmine/redmine/blob/master/app/models/issue.rb">Redmines “Issue”</a> avoids
the explicit getter/setters, however generates accessors magically for you.
Nevertheless you have to add considerable amount of code to configure all the
properties. And code using these active records becomes ambiguous as well.</p>
<p>Why do we use getters/setters so much?</p>
<ul class="simple">
<li>Tools generate objects from a database, adding getters and setters
automatically.</li>
<li>Frameworks make them automatically available for database records/rows.</li>
<li>IDEs can magically create getter/setter pairs for fields.</li>
<li>We want the flexibility to change every field whenever we want.</li>
<li>It became natural in OOP to have write access to every field.</li>
</ul>
<p>However Getters/setters <a class="reference external" href="http://en.wikipedia.org/wiki/Open/closed_principle">violate the open/closed principle</a>, prevent information
hiding and <a class="reference external" href="http://stackoverflow.com/questions/565095/are-getters-and-setters-evil">should be considered evil</a>
(<a class="reference external" href="http://www.javaworld.com/javaworld/jw-09-2003/jw-0905-toolbox.html">Long version</a>). Using
getters and setters allows to <em>decouples</em> the business logic for setting values from the
actual storage. Something that object-orientation was suppose to avoid.</p>
<div class="section" id="getting-rid-of-setters">
<h2>Getting rid of setters</h2>
<p>Avoiding setters is much simpler than getters, so lets start with them.</p>
<p>One way to avoid writing setters is a task based approach to the model. Think
of every task that is performed in an application and add a method that
changes all the affected fields at once, to perform this task. In the famous
blog example the <span class="docutils literal"><span class="pre">Post</span></span> object may look like:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">Post</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">compose</span><span class="p">(</span><span class="nv">$headline</span><span class="p">,</span> <span class="nv">$text</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$tags</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// check invariants, business logic, filters</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">headline</span> <span class="o">=</span> <span class="nv">$headline</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">text</span>     <span class="o">=</span> <span class="nv">$text</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tags</span>     <span class="o">=</span> <span class="nv">$tags</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">publish</span><span class="p">(</span><span class="nx">\DateTime</span> <span class="nv">$onDate</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// check invariants, business logic, filters</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">state</span>       <span class="o">=</span> <span class="s2">"published"</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">publishDate</span> <span class="o">=</span> <span class="nv">$onDate</span> <span class="o">?:</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">"now"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <span class="docutils literal"><span class="pre">Post</span></span> class is now much more protected from the outside and
is actually much better to read and understand. You can clearly see
the behaviors that exist on this object. In the future you might even
be able to change the state of this object without breaking client code.</p>
<p>You could even call this code domain driven, but actually its just applying
the SOLID principles to entities.</p>
</div>
<div class="section" id="tackling-getters">
<h2>Tackling getters</h2>
<p>Avoiding getters is a bit more cumbersome and given no setters, maybe
not worth the trouble anymore.</p>
<p>You still need getters to access the object state, either if you display
models directly in the view or for testing purposes. There is another way
to get rid of all the getters that you don’t need explicitly in a domain
model, using the visitor pattern in combination with view models:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">Post</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">render</span><span class="p">(</span><span class="nx">PostView</span> <span class="nv">$view</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$view</span><span class="o">-&gt;</span><span class="na">id</span>          <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
        <span class="nv">$view</span><span class="o">-&gt;</span><span class="na">publishDate</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">publishDate</span><span class="p">;</span>
        <span class="nv">$view</span><span class="o">-&gt;</span><span class="na">headline</span>    <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">headline</span><span class="p">;</span>
        <span class="nv">$view</span><span class="o">-&gt;</span><span class="na">text</span>        <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">text</span><span class="p">;</span>
        <span class="nv">$view</span><span class="o">-&gt;</span><span class="na">author</span>      <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">author</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="k">new</span> <span class="nx">AuthorView</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$view</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">PostView</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="c1">//... more public properties</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There are drawbacks with this approach though:</p>
<ul class="simple">
<li>Why use the Post model in memory, when you are only passing <span class="docutils literal"><span class="pre">PostView</span></span>
instances to the controllers and views only anyways? Its much more efficient
to have the database map to the view objects directly. This is what CQRS
postulates as separation of read- and write model.</li>
<li>You have to write additional classes for every entity (Data transfer objects)
instead of passing the entities directly to the view. But if you want to
cleanly separate the model from the application/framework, you don’t get
around view model/data transfer objects anyways.</li>
<li>It looks awkward in tests at first, but you can write some custom assertions
to get your sanity back for this task.</li>
</ul>
</div>
<div class="section" id="what-about-the-automagic-form-mapping">
<h2>What about the automagic form mapping?</h2>
<p>Some form frameworks like the <a class="reference external" href="http://www.symfony.com">Symfony2</a> or <a class="reference external" href="http://framework.zend.com">Zend
Framework 2</a> ones map forms directly to objects
and back. Without getters/setters this is obviously not possible anymore.
However if you are decoupling the model from the framework, then using this
kind of form framework on entities is a huge no go anyways.</p>
<p>Think back to the tasks we are performing on our <span class="docutils literal"><span class="pre">Post</span></span> entity:</p>
<ul class="simple">
<li>Edit (title, body, tags)</li>
<li>Publish (publishDate)</li>
</ul>
<p>Both tasks allow only a subset of the properties to be modified. For each of
these tasks we need a custom form “model”. Think of these models as command
objects:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">EditPostCommand</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$headline</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$text</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$tags</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In our application we could attach these form models to our form framework and
then pass these as commands into our “real model” through a service layer,
<a class="reference external" href="http://www.eaipatterns.com/MessageBus.html">message bus</a> or something equivalent:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">PostController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">editAction</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$post</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">findPostViewModel</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'id'</span><span class="p">));</span>

        <span class="c1">// This could need some more automation/generic code</span>
        <span class="nv">$editPostCommand</span>           <span class="o">=</span> <span class="k">new</span> <span class="nx">EditPostCommand</span><span class="p">();</span>
        <span class="nv">$editPostCommand</span><span class="o">-&gt;</span><span class="na">id</span>       <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'id'</span><span class="p">);</span>
        <span class="nv">$editPostCommand</span><span class="o">-&gt;</span><span class="na">headline</span> <span class="o">=</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">headline</span><span class="p">;</span>
        <span class="nv">$editPostCommand</span><span class="o">-&gt;</span><span class="na">text</span>     <span class="o">=</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">text</span><span class="p">;</span>
        <span class="nv">$editPostCommand</span><span class="o">-&gt;</span><span class="na">tags</span>     <span class="o">=</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">tags</span><span class="p">;</span>

        <span class="c1">// here be the form framework handling...</span>
        <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createForm</span><span class="p">(</span><span class="k">new</span> <span class="nx">EditPostType</span><span class="p">(),</span> <span class="nv">$editPostCommand</span><span class="p">);</span>
        <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">bind</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isValid</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// invalid, show errors</span>
        <span class="p">}</span>

        <span class="c1">// here we invoke the model, finally, through the service layer</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">postService</span><span class="o">-&gt;</span><span class="na">edit</span><span class="p">(</span><span class="nv">$editPostCommand</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">PostService</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">edit</span><span class="p">(</span><span class="nx">EditPostCommand</span> <span class="nv">$command</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$post</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">postRepository</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
        <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">compose</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="na">headline</span><span class="p">,</span> <span class="nv">$command</span><span class="o">-&gt;</span><span class="na">text</span><span class="p">,</span> <span class="nv">$command</span><span class="o">-&gt;</span><span class="na">tags</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This way we separated the business model from the application framework.</p>
</div>
<div class="section" id="a-word-about-rad">
<h2>A word about RAD</h2>
<p>Rapid-application development or rapid prototyping is a wide-spread approach in web
development. My explicit approach seems to be completely against this kind of
development and much slower as well. But I think you don’t loose much time
in the long run:</p>
<ul class="simple">
<li>Simple command objects can be code-generated or generated by IDEs
in a matter of seconds. Or you could even extend ORMs code generation
capabilities to generate these dummy objects for you. Since you don’t need
ORM mapping information for these objects or think about performance
implications in context with the ORM, you don’t need to spend much
thinking about their creation.</li>
<li>Explicit models are much simpler to unit-test and those tests run much faster
than tests through the UI that RAD prototypes need.</li>
<li>Generated Rapid prototypes can get hard to maintain quickly. That does not mean they
are unmaintainable, but they seem to favour reimplementation instead of
refactoring, something that leads to problems given the low code coverage
that these prototypes normally have.</li>
</ul>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>If we take a step back from all our tools suggesting to generate getter/setters
we find that there is a simple way to avoid using setters when focusing on the
tasks that objects perform. This actually makes our code much more readable and
is one building block towards clean object oriented code and domain driven design.</p>
<p>I am very interested in your opinions on this topic and my attempt to avoid them,
please leave comments when leaving this website :-)</p>
</div>
]]></description>
            <category><![CDATA[ PHP ]]></category>
             <pubDate>Wed, 22 Aug 2012 00:00:00 +0200</pubDate>
        </item>
    
        <item>
            <link>http://www.whitewashing.de/2012/08/18/oop_business_applications__command_query_responsibility_seggregation.html</link>
            <guid>http://www.whitewashing.de/2012/08/18/oop_business_applications__command_query_responsibility_seggregation.html</guid>
            <title><![CDATA[OOP Business Applications: Command-Query-Responsibility-Segregation (CQRS)]]></title>
            <description><![CDATA[
<h1>OOP Business Applications: Command-Query-Responsibility-Segregation (CQRS)</h1>
<p>Other posts in this series about OOP Business Applications:</p>
<ul class="simple">
<li><a class="reference external" href="http://whitewashing.de/2012/08/11/oop_business_applications__trying_to_escape_the_mess.html">Trying to escape the
mess</a></li>
<li><a class="reference external" href="http://whitewashing.de/2012/08/13/oop_business_applications_entity_boundary_interactor.html">Entity, Boundary, Interactor</a></li>
<li><a class="reference external" href="http://whitewashing.de/2012/08/16/oop_business_applications__data__context__interaction.html">Data, Context, Interaction</a></li>
</ul>
<p>The last pattern for designing your business logic is called
“Command-Query-Responsibility-Segregation” or short CQRS. It has its roots in
the <a class="reference external" href="http://en.wikipedia.org/wiki/Command-query_separation">“Command Query Separation”</a> principle that was
put forward by Bertrand Meyer.</p>
<p>Wikipedia has a very good summary about what this principle is about:</p>
<div class="highlight-python"><div class="highlight"><pre>Command-Query-Separation states that every method should either be a
command that performs an action, or a query that returns data to the
caller, but not both. In other words, asking a question should not change
the answer. More formally, methods should return a value only if they are
referentially transparent and hence possess no side effects.
</pre></div>
</div>
<p>CQRS is an OOP architecture design pattern building on that imperative
principle.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There are many different variations of the CQRS pattern that
all have their place. This post describes a simple variant that does
<strong>not</strong>
use Messaging, DomainEvent or EventSourcing patterns, which are commonly mentioned
with CQRS.</p>
</div>
<p>At its heart is the separation of Read and Write methods. This can be easily
achieved by just having two different service layer classes instead of one.
This insight alone is not really helpful, its just moving methods around.
Coupled to this change however is the notion, that read and write models don’t
necessarily have to be the same:</p>
<ul class="simple">
<li>Getter/Setters: We don’t need setters in the write model, instead we use
explicit methods for each write operation. Entities are also much simpler
without bi-directional relationships that read/write models often need.
Read-only models (ViewModel) don’t need getters/setters. They could just use
public properties or even be arrays.</li>
<li>ORM Performance, Lazy Loading and Query Restrictions: In a write scenario we
mostly need queries by primary key, changing only some objects. In
read scenarios we need complex queries, joins and aggregations. A separation
prevents both from affecting each other negatively.</li>
<li>Mapping Data-Transfer objects becomes simple. Instead of sending the whole
model back and forth, for the write scenario you define use-case specific
tasks and updates. This is much simpler than generic mapping of Data Transfer
objects to complex object graphs.</li>
<li>Transforming SQL directly to a view model in a highly optimized way.
Simple concept, but it has huge implications: A pure read-only model is simple to
maintain and refactor for any performance requirements that come up.</li>
</ul>
<p>Furthermore with CQRS our write service methods are not allowed to return data
anymore (With the exceptions to the rule of course). This may increase the
complexity at first, but it has benefits for scalability and decoupling.
Following this principle allows us to turn every command from synchronous to
asynchronous processing later without much problems. Services are allowed to
throw exceptions and refuse the execution. Proper validation of input data
should happen before executing write operations though.</p>
<p>One drawback of CQRS: A naive implementation doubles the amount of classes and
services to write. But there are simple shortcuts to avoid having to write a
full blown read-model if you don’t apply CQRS religiously:</p>
<ul class="simple">
<li>Don’t use different data-stores for both models.</li>
<li>Mapping SQL to PHP arrays and stdClass objects through a simple gateway is
very simple. You can easily generalize this to a simple object that gives
efficient access to all your data.</li>
<li>Share parts of the write and read models if you don’t have to compromise
much.</li>
</ul>
<p>The important thing to take away from this separation is, that the read part of
your application is seldom the part where business value lies in. Moving this
code into a different part of your applications allows you to work with the
underlying data-source much more directly, without need for much abstractions.</p>
<p>One thing that CQRS puts forward is the concept of Commands, Command Handlers
and Command Bus and how they interact. Commands are simple objects that
contain all the data necessary to execute an operation. Each command is
processed by exactly one command handler. The Command Bus is responsible to
route a command to its appropriate command handler.</p>
<div class="section" id="example">
<h2>Example</h2>
<p>Here is the most simple implementation of the Command Bus, just holds a hash map
mapping command class names to command handlers:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">interface</span> <span class="nx">Handler</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">$command</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">class</span> <span class="nc">CommandBus</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$handlers</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">register</span><span class="p">(</span><span class="nv">$commandClassName</span><span class="p">,</span> <span class="nx">Handler</span> <span class="nv">$handler</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handlers</span><span class="p">[</span><span class="nv">$commandClassName</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$handler</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">$command</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handlers</span><span class="p">[</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$command</span><span class="p">)]</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$command</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In your code you would always pass Commands to the bus. That way the command
bus is a central entry point to any write operation. With this we can rewrite the
TransferMoney service:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">TransferMoneyCommand</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$sourceId</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$destinationId</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$money</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">MoneyTransfer</span> <span class="k">implements</span> <span class="nx">Handler</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$accountDao</span><span class="p">;</span> <span class="c1">// ctor omitted</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">$command</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$source</span>      <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">accountDao</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="na">sourceId</span><span class="p">);</span>
        <span class="nv">$destination</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">accountDao</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="na">destinationId</span><span class="p">);</span>
        <span class="nv">$money</span>       <span class="o">=</span> <span class="k">new</span> <span class="nx">Money</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="na">amount</span><span class="p">);</span>

        <span class="nv">$source</span><span class="o">-&gt;</span><span class="na">withdraw</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
        <span class="nv">$destination</span><span class="o">-&gt;</span><span class="na">deposit</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There is also a benefit from the mental model of commands compared to the
“generic” term of model requests in EBI. Your write model gets task
oriented.</p>
<p>Routing everything through the command bus has several benefits as well:</p>
<ul class="simple">
<li>Nesting handlers that take care of transactions, logging, 2 phase commits</li>
<li>Order nested command calls sequentially instead of deep into each other.</li>
<li>Asynchronous processing with message queue become an option</li>
</ul>
<p>The command bus acts as the application boundary as described in the
Entity-Boundary-Interactor pattern, usage is simple:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MoneyController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">transferAction</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$commandBus</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'command_bus'</span><span class="p">);</span>
        <span class="nv">$commandBus</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="k">new</span> <span class="nx">TransferMoneyCommand</span><span class="p">(</span>
            <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'sourceId'</span><span class="p">),</span>
            <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'destinationId'</span><span class="p">),</span>
            <span class="k">new</span> <span class="nx">Money</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'amount'</span><span class="p">)</span>
        <span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="pros-and-cons">
<h2>Pros and Cons</h2>
<p>I really like CQRS for multiple reasons. It offers explicit guidance how solve
tasks by making use of a range of different design patterns. This is very
helpful, because the code-base is based on conventions that are simple to
understand by everyone on the team. This structure liberates you from the curse
of choice and gives you a cookbook of best-practices how to solve problems.
You want this structure for all your applications, regardless of what
architectural pattern you have chosen.</p>
<p>Embracing the difference between read and write models is another plus of CQRS.
It is very helpful, not to try fitting both read and write into one model.  You
also don’t run into so many read-related problems with an ORM any more. You
design the entities to be optimized for the write model only, loose the
bidirectional associations and avoid all the optimizations here and there for
read performance.</p>
<p>Compared to EBI, where we had to maintain a mapping between DTOs and entities,
CQRS explicitly uses the command based approach to avoid the complexity of
these mappings. You will still have to map between command and entity, however
doing so in the context of a use-case simplifies the code considerably compared
to a generic mapping solution.</p>
<p>One negative point: Its difficult to work with commands not returning any data
in some cases. You need to find simple ways to return messages to the
user. For that you also need to validate commands on the “client” or
controller side, using the read model, so that you can prevent invalid/illegal
commands from being sent as often as possible.</p>
<p>Without return values from your models, you are left to using mocks as means of
testing. This might be more difficult for developers to use and understand.
This problem goes away however, if you combine CQRS with Event Sourcing. A
topic that I will discuss in the next blog post.</p>
</div>
]]></description>
            <category><![CDATA[ PHP ]]></category>
             <pubDate>Sat, 18 Aug 2012 00:00:00 +0200</pubDate>
        </item>
    
        <item>
            <link>http://www.whitewashing.de/2012/08/16/oop_business_applications__data__context__interaction.html</link>
            <guid>http://www.whitewashing.de/2012/08/16/oop_business_applications__data__context__interaction.html</guid>
            <title><![CDATA[OOP Business Applications: Data, Context, Interaction]]></title>
            <description><![CDATA[
<h1>OOP Business Applications: Data, Context, Interaction</h1>
<p>Other posts in this series:</p>
<ul class="simple">
<li><a class="reference external" href="http://whitewashing.de/2012/08/11/oop_business_applications__trying_to_escape_the_mess.html">OOP Business Applications: Trying to escape the
mess</a></li>
<li><a class="reference external" href="http://whitewashing.de/2012/08/13/oop_business_applications_entity_boundary_interactor.html">OOP Business Applications: Entity, Boundary, Interactor</a></li>
</ul>
<p>The next design pattern for technical system design is called “Data, Context,
Interaction”. It’s inventors Trygve Reenskaug and James Coplien call it a new
paradigm, in the context of PHPs language constraints it can be classified as
architectural design pattern. I came across this pattern through <a class="reference external" href="https://twitter.com/go_oh">Gordon Oheim</a>. He has also invested quite some time going
through the book on DCI and trying to understand this pattern with me.</p>
<p>As in the EBI pattern, DCI separates data objects (Data) from behavior implemented
in use-cases (Context). Data objects are never directly involved in these
use-cases, but are “casted” to their respective roles that they are taking in
the use-case. This can be implemented with aggregation or traits in PHP.</p>
<p>One goal of DCI is to get object-oriented programming to a place, where you
can look at a use-case and its roles and be very sure that the program is
running correctly, because you can guarantee that there are no unexpected side
effects. It also aims at keeping the amount of code required to keep in mind
for a given use-case as small as possible, allowing developers to reason about
the code with more confidence.</p>
<div class="section" id="terminology">
<h2>Terminology</h2>
<p>In DCI, <strong>data</strong> are objects that encapsulate the state of the application.
As in EBI, they only contain logic that is true for all the possible use-cases.
These classes represent <em>what the system is</em>.</p>
<p><strong>Roles</strong> and <strong>Context</strong> represent <em>what the system does</em> and are supposed to
capture the End User’s Mental Model as close as possible.</p>
<p><strong>Roles</strong> add behavior to the data objects by either wrapping them or
acting as traits for the data objects.</p>
<p><strong>Context</strong> is the use-case and fulfils its role by making roles <strong>interact</strong> with
each other. These roles then modify the underlying data.</p>
</div>
<div class="section" id="example">
<h2>Example</h2>
<p>Starting from the bank account example of the EBI post, we can introduce DCI
quite easily by adding the missing concept of roles. In the use case of
transferring money that would be:</p>
<ul class="simple">
<li>TransferMoneySource</li>
<li>TransferMoneySink (Destination)</li>
</ul>
<p>We can do this by either introducing two interfaces and two concrete
implementations that accept the <span class="docutils literal"><span class="pre">BankAccount</span></span> as object to work on
or by building two traits. I will go down the route with traits, to show
one possible use-case for this new PHP 5.4 feature. The idea here is to
implement all the behavior necessary on a trait and then have simple dummy
objects using them in the tests for this use-case.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">trait</span> <span class="nx">TransferMoneySource</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">transferTo</span><span class="p">(</span><span class="nv">$destination</span><span class="p">,</span> <span class="nx">Money</span> <span class="nv">$money</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$destination</span><span class="o">-&gt;</span><span class="na">transferFrom</span><span class="p">(</span><span class="nv">$destination</span><span class="p">,</span> <span class="nv">$money</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">abstract</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">withdraw</span><span class="p">(</span><span class="nx">Money</span> <span class="nv">$money</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">trait</span> <span class="nx">TransferMoneySink</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">transferFrom</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="nx">Money</span> <span class="nv">$money</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$source</span><span class="o">-&gt;</span><span class="na">withdraw</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">deposit</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">abstract</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">deposit</span><span class="p">(</span><span class="nx">Money</span> <span class="nv">$money</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Any checks for balances, credit limits or other things would also happen
here. The <span class="docutils literal"><span class="pre">withdraw</span></span> and <span class="docutils literal"><span class="pre">deposit</span></span>  on the data objects should be as
dumb as possible, so that their implementation does not cause any side-effects
on the execution of this use-case.</p>
<p>The bank account would then be modified to look:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">BankAccount</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">TransferMoneySource</span><span class="p">,</span> <span class="nx">TransferMoneySink</span><span class="p">;</span>

    <span class="k">private</span> <span class="nv">$balance</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Money</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">withdraw</span><span class="p">(</span><span class="nx">Money</span> <span class="nv">$money</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span><span class="o">-&gt;</span><span class="na">subtract</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">deposit</span><span class="p">(</span><span class="nx">Money</span> <span class="nv">$money</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The use-case <span class="docutils literal"><span class="pre">TransferMoney</span></span> would then be modified to create Roles instead
of Data objects from the DAO. This can be a bit tricky when you have multiple
data objects implementing the same role and you have no way of knowing which
underlying data object to pick. The binding of data objects to roles happens
in the use-case. The use-case needs a means to retrieve objects with certain
roles, which then access underlying data sources. To avoid that your use-cases
have to know about how to bind roles to data, you could use GUIDs in your
application and fetch all objects from one data store. Another way would be to
implement data access objects for roles, that then know how to retrieve their
corresponding data.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MoneyTransfer</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$source</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$destination</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$moneySource</span><span class="p">,</span> <span class="nv">$moneySink</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">source</span> <span class="o">=</span> <span class="nv">$moneySource</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">destination</span> <span class="o">=</span> <span class="nv">$moneySink</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">transferMoney</span><span class="p">(</span><span class="nx">Money</span> <span class="nv">$money</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">source</span><span class="o">-&gt;</span><span class="na">transferTo</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">destination</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The simplicity of this is appealing, however don’t forget that we have
abstracted I/O completely here. There has to be code that deals with that part
of the system somewhere. However this again is not at the heart of all the DCI
examples out there, making it difficult to reason about the actual practical
implications.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">One drawback with this example is, that PHP does not support typehinting for
traits.</p>
</div>
<p>Here is an example of how the bank application service could look like:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">BankApplicationService</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">transferMoney</span><span class="p">(</span><span class="nv">$sourceId</span><span class="p">,</span> <span class="nv">$destinationId</span><span class="p">,</span> <span class="nx">Money</span> <span class="nv">$amount</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$source</span>      <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">objectStorage</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$sourceId</span><span class="p">);</span>
        <span class="nv">$destination</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">objectStorage</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$destinationId</span><span class="p">);</span>

        <span class="nv">$useCase</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MoneyTransfer</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="nv">$destination</span><span class="p">);</span>

        <span class="nv">$conn</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">conn</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$useCase</span><span class="o">-&gt;</span><span class="na">transferMoney</span><span class="p">(</span><span class="nv">$amount</span><span class="p">);</span>
            <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>

            <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">rollback</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <span class="docutils literal"><span class="pre">ObjectStorage</span></span> here is a service (repository) that can find any
persistent data object by a global ID. This is necessary, because it
doesn’t actually matter what data object uses the necessary traits
for this use-case.</p>
<p>Again as in EBI, in a bigger system you would need to find some abstraction
layer that does this in a more generic way.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>When Gordon started showing me this pattern we were both puzzled as how
to actually implement this in the real world. Especially the concept
of binding roles to data objects still confuses us. Most notably why the use
of traits or aggregates should actually constitute a new programming paradigm
instead of just another way to do OOP.</p>
<p>In Scala casting data objects to roles is actually possible by binding traits
to objects at runtime. This is not possible in PHP however and has to be done
statically.</p>
<p>Compared to EBI, DCI focuses drastically on transaction script domain logic, by
suggesting to implement roles for every use-case for the sake of avoiding
side-effects. This is actually is very valuable lesson from this pattern.
Finding means to decrease the complexity of software is always a good thing.
And the explicit definition of this concept as <strong>roles</strong> is actually easy to
explain to other programmers.</p>
<p>One thing that is lacking in DCI is that there is no concrete mechanism to deal
with the boundary to other parts of the system. This is actually a step back
from EBI and I suggest using EBI pattern in combination with DCI to solve this.</p>
<p>The largest benefit from DCI (and its self proclaimed goal) is the mapping from
the users/customers mental model directly into the code by using Use-Cases and
Roles. The communication with the customer about behavior can exclusively focus
on the current context and its use-case. Mapping this behavior to actual data
can then be done in a different step.</p>
<p>This simplification of use-cases and reduction of side-effects between
different parts of the system has other benefits: It can lead to easier to test
code and makes it much easier for developers to develop on small and isolated
parts of the system.</p>
</div>
]]></description>
            <category><![CDATA[ PHP ]]></category>
             <pubDate>Thu, 16 Aug 2012 00:00:00 +0200</pubDate>
        </item>
    
        <item>
            <link>http://www.whitewashing.de/2012/08/13/oop_business_applications_entity_boundary_interactor.html</link>
            <guid>http://www.whitewashing.de/2012/08/13/oop_business_applications_entity_boundary_interactor.html</guid>
            <title><![CDATA[OOP Business Applications: Entity, Boundary, Interactor]]></title>
            <description><![CDATA[
<h1>OOP Business Applications: Entity, Boundary, Interactor</h1>
<p>Other posts in this series:</p>
<ul class="simple">
<li><a class="reference external" href="http://whitewashing.de/2012/08/11/oop_business_applications__trying_to_escape_the_mess.html">OOP Business Applications: Trying to escape the
mess</a></li>
</ul>
<p>Continuing the series, I will talk about Entity, Boundary and Interactor (EBI)
an architectural design pattern. I first heard about it in a keynote video of
<a class="reference external" href="https://sites.google.com/site/unclebobconsultingllc/">Uncle Bob</a> on Ruby
Midwest called <a class="reference external" href="http://www.confreaks.com/videos/759-rubymidwest2011-keynote-architecture-the-lost-years">“The lost years of architecture”</a>.
This is also described as <a class="reference external" href="http://alistair.cockburn.us/Hexagonal+architecture">Hexagonal architecture</a> or “Ports and Adapters”
by Alistair Cockburn.</p>
<p>In this pattern any client of the system talks to the model using a model
request object and receives data from the model in form of model responses objects.
Additionally when your model talks to any kind of persistence or subsystem it
should go through an adapter that is replaceable. For a model architecture
designed this way, you can replace any part of the UI oder lower layers by
writing new adapters and plug them in.</p>
<div class="section" id="terminology">
<h2>Terminology</h2>
<p>To iterate the terminology:</p>
<p><strong>Entities</strong> are objects that represent the system data of the application. They don’t contain
much logic except rules that are set in stone and are never going to change
(based on physic or mathematical laws or something).</p>
<p><strong>Interactors</strong> are use-case objects, they contain the business logic that is valid
in the current use-case and works with entities to fulfil their task.</p>
<p>The <strong>boundary</strong> is responsible for translating model request/response into a
format that the UI or actor can understand. They also mediate between model
and lower levels, for example to manage database transactions.</p>
</div>
<div class="section" id="an-example">
<h2>An example</h2>
<p>Lets start with an example in PHP code. We will keep using a common example
throughout all blog posts, the usual Bank Account/Money Transfer. The use case
is the money transfer from one bank account (source) to another one
(destination).</p>
<p>We start by implementing the entity <span class="docutils literal"><span class="pre">BankAccount</span></span>:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">BankAccount</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$balance</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Money</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">withdraw</span><span class="p">(</span><span class="nx">Money</span> <span class="nv">$money</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span><span class="o">-&gt;</span><span class="na">subtract</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">deposit</span><span class="p">(</span><span class="nx">Money</span> <span class="nv">$money</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It is straightforward to implement the <span class="docutils literal"><span class="pre">withdraw</span></span> and <span class="docutils literal"><span class="pre">deposit</span></span>
functionality. The Money object implementation is omitted here.</p>
<p>The Interactor handles the use-case of transferring money from the
source to the destination account:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MoneyTransferRequest</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$sourceId</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$destinationId</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$amount</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">class</span> <span class="nc">MoneyTransferResponse</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">MoneyTransfer</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$accountDao</span><span class="p">;</span> <span class="c1">// ctor omitted</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">transferMoney</span><span class="p">(</span><span class="nx">MoneyTransferRequest</span> <span class="nv">$transfer</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$source</span>      <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">accountDao</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$transfer</span><span class="o">-&gt;</span><span class="na">sourceId</span><span class="p">);</span>
        <span class="nv">$destination</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">accountDao</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$transfer</span><span class="o">-&gt;</span><span class="na">destinationId</span><span class="p">);</span>
        <span class="nv">$money</span>       <span class="o">=</span> <span class="k">new</span> <span class="nx">Money</span><span class="p">(</span><span class="nv">$transfer</span><span class="o">-&gt;</span><span class="na">amount</span><span class="p">);</span>

        <span class="nv">$source</span><span class="o">-&gt;</span><span class="na">withdraw</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
        <span class="nv">$destination</span><span class="o">-&gt;</span><span class="na">deposit</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nx">MoneyTransferResponse</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <span class="docutils literal"><span class="pre">MoneyTransferRequest</span></span> and <span class="docutils literal"><span class="pre">MoneyTransferResponse</span></span> objects are dumb
php objects (so called data-transfer objects, DTO).</p>
<p>You can see in the example that we use a Data Access object to retrieve the
source and destination account entities from some storage subsystem. To follow the EBI
design pattern, we have to decouple this data access object from the model,
by offering a port (Interface):</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">interface</span> <span class="nx">AccountDaoInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$accountId</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This way our business logic is storage independent.</p>
<p>An example for a boundary would be the requirement for a transaction in
the bank account sample. We need to wrap the whole MoneyTransfer use-case in
a transaction. Lets say the invocation of our Use-Case is controlled through
some kind of application boundary object:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">BankApplicationBoundary</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$applicationFactory</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">transferMoney</span><span class="p">(</span><span class="nx">MoneyTransferRequest</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$connection</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">applicationFactory</span><span class="o">-&gt;</span><span class="na">createConnection</span><span class="p">();</span>
        <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$useCase</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MoneyTransfer</span><span class="p">(</span><span class="nv">$factory</span><span class="o">-&gt;</span><span class="na">createAccountDao</span><span class="p">());</span>
            <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$useCase</span><span class="o">-&gt;</span><span class="na">transferMoney</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>

            <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">rollback</span><span class="p">();</span>
            <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is a very elaborate way to describe that calling the transfer money
use-case is wrapped in a Transaction, another port for the storage system to
manage transactions in this case. The code here is very explicit about
the actual task. In a real application you would probably find a more
generic approach to getting this job done.</p>
</div>
<div class="section" id="boundary-abstraction">
<h2>Boundary Abstraction</h2>
<p>Thinking about the boundaries I came up with a library several month ago called
<a class="reference external" href="https://github.com/beberlei/context">Context</a>, which I deprecated already
(Reason below).  It allows you to wrap calls to the model by some sort of proxy
that transforms the request and response and also handles transactions and
such. Loosely spoken this was actually some kind of AOP library, using the
limited ways that PHP provides to implement AOP (magic <span class="docutils literal"><span class="pre">__call</span></span> proxies).</p>
<p>With context you would do something like:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$context</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getContext</span><span class="p">();</span>

<span class="c1">// 1. direct invocation</span>
<span class="nv">$myService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyService</span><span class="p">();</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'service'</span> <span class="o">=&gt;</span> <span class="nv">$myService</span><span class="p">,</span> <span class="s1">'method'</span> <span class="o">=&gt;</span> <span class="s1">'doSomething'</span><span class="p">,</span> <span class="s1">'arguments'</span> <span class="o">=&gt;</span> <span class="nv">$args</span><span class="p">));</span>

<span class="c1">// 2. proxy wrapping</span>
<span class="nv">$myService</span> <span class="o">=</span> <span class="nv">$context</span><span class="o">-&gt;</span><span class="na">wrap</span><span class="p">(</span><span class="k">new</span> <span class="nx">MyService</span><span class="p">());</span>
<span class="nv">$myService</span><span class="o">-&gt;</span><span class="na">doSomething</span><span class="p">(</span><span class="nv">$args</span><span class="p">);</span>
</pre></div>
</div>
<p>The second way is obviously way more readable, but its also rather magic.</p>
<p>I deprecated this library because in the end it wasn’t really helpful that
much. Implementing an application specific proxy for services is done in
almost no time and then it solves all your specific needs. My main problem with
the library is that it tries to magically take away the need to design the
boundary of your application yourself - in a way that is not really coherent to
other developers.</p>
<p>In my own current greenfield applications I quickly went away from using it,
since a custom application proxy as shown in this
<a class="reference external" href="https://gist.github.com/3272909">Gist</a> is really much simpler to implement and
use.</p>
</div>
<div class="section" id="using-with-symfony2">
<h2>Using with Symfony2</h2>
<p>As I am currently exclusively developing Symfony2/Silex applications, applying
EBI to Symfony2 framework based applications is very important to me. The
biggest difficulty here is the Form layer, especially the request data-mapping and
validation concerns, which are normally part of the model. There are two
approaches I came up with to solve this:</p>
<ul class="simple">
<li>Build Forms for arrays or DTOs and send them through to the boundary to the model.
You have to validate the data again on the model, which is annoying, but in
this case the clean way. This is not so easy to do with complex forms though
as you need to map the request objects to your entities.</li>
<li>Create a Model Request that wraps and hides the form behind a simple data
mapping API. This way you can make it look as if you would map a DTO onto
an object, but in this case you are using the Form API as the mapper.</li>
</ul>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MyService</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">edit</span><span class="p">(</span><span class="nx">EditRequest</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$entity</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dao</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dataMapper</span><span class="o">-&gt;</span><span class="na">transform</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The problem with this approach is, that you cant really unit-test these methods
anymore, because the complexity of the form layer mapping cannot be mocked with
this API. Instead your tests always need the full form layer (with validation,
depending services etc.) to allow for real-world testing. Additionally you have
to make the DataMapper throw an exception that you can catch in the controller,
rendering the appropriate response. Using exceptions for controlling executions
paths is not a very good practice though.</p>
<p>Another thing that actually helped was the SensioFrameworkExtraBundle and
ParamConverters. In my project I now have the framework building the Model
Request objects by convention from the HTTP Request, so that I only need to
pass them on and can skip the actual mapping of HTTP Request to Model Request.</p>
</div>
<div class="section" id="pros-and-cons">
<h2>Pros and Cons</h2>
<p>This design pattern very closely resembles what Fowler calls <strong>Service Layer</strong>
pattern in PoEAA. EBI is going a bit more into detail by naming individual
parts of the pattern more explicit. Without more restrictions however using
this pattern will drive you towards many of the problems described in my
previous post.</p>
<p>Clean separation from frameworks is achieved, depending on the actual usage
however only at a significant cost.  Never forget stepping back and thinking
about further abstractions, otherwise applying EBI is leading to lots of code
being manually written.</p>
<p>This already shows one particular annoyance are the data-transfer objects. You
need to invest quite some work to get a mapping working from entities to
transfer objects and back. In the process you will loose the convenience of
“Open Entity Manager in the View”, where you can lazy load any
data you want to access in the view. This is quite a painful step, because you
are loosing lots of flexibility. Much more annoying is the need to update
entities from data-transfer objects, requiring sophisticated code for merging
of partial object graphs.</p>
<p>What this design pattern improves is the testability of code and also the
execution of tests is MUCH better, when you don’t have to go through the whole
application stack to test something.</p>
<p>Implementing behavior into the use-cases also avoids lots of lasagna code
compared to a messy domain driven design. You get a very good overview of
what is actually happening just by looking at the Model Request and Interactor
classes. However depending on the use-case the classes can get very big
and might need lots of collaborators, which make the problem complex again.</p>
<p>It is important to note that aggregating the domain logic in the use-cases
actually means going to some sort of transaction script processing, away from
domain driven design. I am pretty sure that this is not necessarily the
intention of this design pattern from a POV of Uncle Bob. However depending on
the sophistication of the applications domain logic, transaction script is
actually a very good pattern for simple to medium complex use-cases and
I like to have this as a general rule for developers (“Put behavior on the
use-case”).</p>
<p>In conclusion I can partially recommend using the EBI pattern. You have to be
careful to find abstraction layers that keep your code DRY and SOLID however,
something which does not come naturally with this pattern. If you are not
careful you end up with all the “messy points” that I mentioned in my previous
blog post.</p>
<p>You should be especially careful to avoid lots of DTO &lt;-&gt; Entity Mapping code
by using some code-generation for example to do parts of this job for you. The
worst outcome with this pattern is, when you manually code layers for HTTP
Request/Form =&gt; DTO =&gt; Entity mapping and the other way around.</p>
</div>
]]></description>
            <category><![CDATA[ PHP ]]></category>
             <pubDate>Mon, 13 Aug 2012 00:00:00 +0200</pubDate>
        </item>
    
        <item>
            <link>http://www.whitewashing.de/2012/08/11/oop_business_applications__trying_to_escape_the_mess.html</link>
            <guid>http://www.whitewashing.de/2012/08/11/oop_business_applications__trying_to_escape_the_mess.html</guid>
            <title><![CDATA[OOP Business Applications: Trying to escape the mess]]></title>
            <description><![CDATA[
<h1>OOP Business Applications: Trying to escape the mess</h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">tl;dr Version: I present a list of problems with OOP business applications from
my personal experience and then introduce 3 approaches that I was put in
contact with over the last year, DCI, EBI and CQRS. This post is an
introduction to a series about this approaches.</p>
</div>
<p>I mentally divide the world of programming into two large parts:</p>
<ol class="arabic simple">
<li>Library and system programming</li>
<li>business applications</li>
</ol>
<p>The first produces code solving technical problems, often in a beautiful and
dedicated way. The second regularly produces mess, hopefully still
serving customers by optimizing their business. This differentiation is an
exaggeration, but from my experience its far easier to run a greenfield business
project into the ground than a new library.</p>
<p>There has to be a reason why so many programmers dedicate much free time to
open source projects. It might be empirical prove, that all our business
projects don’t make us happy at the end of the day and we have to show
ourselves that we can do better.</p>
<p>I enjoy writing business applications more than libraries, but they are also
much more difficult to get right in both social and technical dimensions.  One
motivational driver of <a class="reference external" href="https://github.com/beberlei">my open source activities</a> always was to simplify the technical dimension
of OOP business applications.</p>
<div class="section" id="my-personal-list-of-annoyances">
<h2>My Personal List of Annoyances</h2>
<p>This blog post is not about blaming customers (as the usual suspect), its about
finding the problems in usual OOP code of business systems from my experience
with PHP projects. To keep things short, I will list my <em>personal</em> list of
technical annoyances in business projects in no particular order. These are
highly subjective points.</p>
<ul class="simple">
<li>Getter/Setter Madness of Objects that are used to store data into
databases. Leading to huge objects that are essentially just meaningless
stores of data.</li>
<li>Updating complex object graphs from user input.</li>
<li>Separation of model, controller and views, especially when dealing with
forms. This is very complicated to achieve.</li>
<li>Lazy Loading and Query performance problems when using an ORM. Additionally
replacing parts of the views with hand-crafted SQL is often difficult and/or
time intensive, when already using an ORM.</li>
<li>Inability to decouple code that was written with CRUD (generators and
utilities) in mind towards more domain driven code, when the requirements
change.</li>
<li>Dependency mess leading to hard to test code, generally leading to untested
applications. Too often frameworks create huge dependencies that
make your domain model messy and complex to mock in tests.</li>
<li>Focus on synchronous request/response handling makes later usage of message
queues very complicated and expensive to refactor towards.</li>
<li>Tight coupling of model against the framework code.</li>
<li>Junior developers have too much freedom, when there is not much structure in
the code, but rather just a big ball of mud. Additionally with the tight
coupling of so many components, junior developers get easily lost in the code
and produce unexpected side-effects.</li>
<li>Use-cases easily span more than 5 classes. To grasp the interaction you have
to keep lots of code in your head, especially complicated for junior
developers again. As they cannot really work on a problem in isolation.</li>
<li>Constant violations of <a class="reference external" href="http://en.wikipedia.org/wiki/SOLID_%28object-oriented_design%29">SOLID</a> principles
due to framework or persistence requirements.</li>
<li>Compared to library development, user-facing applications often have much
higher coupling between classes and namespaces. In libraries its often easy
to find different concerns, but in applications they seem hard to divide for
developers.</li>
<li>In combination with a rich javascript client, requirements to update objects
through their CRUD API produces concurrency and lost-update hell, that
dynamic server-side applications could mostly avoid before.</li>
</ul>
<p>Essentially if you work in a tight schedule, project based environment where
the decision makers sell rapid application development and prototyping, then you
often have only one, maybe one and a half attempts to get the big picture
right. From that moment on you have to build on that decision and hope for the
best.</p>
<p>We have tried not to go the RAD+CRUD tools ways in several projects, to escape
the problems listed above. But without changes in your mindest you end up with
hand written mess, compared to getting there with tools.</p>
<p>Specifically <a class="reference external" href="http://en.wikipedia.org/wiki/Domain-driven_design">Domain Driven Design</a> applied naively can make
the problem even worse. It easily leads to lasagna code, where you have layers
of layers that are very hard to understand. Personally I prefer spaghetti code
over lasagna code, because its comparatively simpler to understand.</p>
</div>
<div class="section" id="finding-new-approaches">
<h2>Finding new Approaches</h2>
<p>Rather than to embrace the suck and dive deeper into CRUD architectures, I felt
there has to be some solution to organize business models structurally to avoid
all (or most) of these problems. In the PHP world with <a class="reference external" href="http://www.symfony.com">Symfony2</a> and <a class="reference external" href="http://www.doctrine-project.org">Doctrine2</a>
you have a powerful toolbox to avoid many of the problems above, but it is
still not simple to write clean object oriented applications.</p>
<p>After years of participation in both open source projects I still feel there is
a missing puzzle piece, to reach a clean separation of all the model concerns
from framework and persistence.</p>
<p>At some point I would really like to close the gap between desired technical
state of a project and the state it is actually in. I know there is no size
fits all solution, but I fell a checklist of architectural patterns with pro
and con arguments allows me to adjust the expectations about how a system looks
in the end.</p>
<p>Thanks to <a class="reference external" href="https://twitter.com/go_oh">Gordon</a>, <a class="reference external" href="https://twitter.com/spriebsch">Stefan</a> and <a class="reference external" href="https://twitter.com/tom_noise">Thomas</a>
I was introduced to several approaches to OO application design that I
started to explore in the past last months:</p>
<ul class="simple">
<li><a class="reference external" href="http://en.wikipedia.org/wiki/Data,_context_and_interaction">Data, Context, Interaction (DCI)</a> - which Gordon
studied a lot</li>
<li><a class="reference external" href="http://alistair.cockburn.us/Hexagonal+architecture">Entity, Boundary, Interactor (EBI)</a>, also called Hexagonal
architecture or “Ports and adapters”. Gained popularity after <a class="reference external" href="http://www.confreaks.com/videos/759-rubymidwest2011-keynote-architecture-the-lost-years">Uncle Bobs talk
at Ruby Midwest</a>
last year.</li>
<li><a class="reference external" href="http://en.wikipedia.org/wiki/Command-query_separation">Command-Query-Responsibility-Segregation (CQRS)</a> well described in a
<a class="reference external" href="http://www.udidahan.com/2009/12/09/clarified-cqrs/">blog post by Udi Dahan</a> and in a hands on <a class="reference external" href="http://www.viddler.com/v/dc528842">one
day video class</a> by Greg Young.</li>
</ul>
<p>They are not new and have all been around for several years already. I would
describe all three of them as architectural design patterns, though some people
might probably disagree with this classification. All three approaches make
you think about application development beyond just “service layers” in
radically new ways. All three have helped me rethink business applications in
different ways.</p>
<p>In the next weeks I will talk about each of these approaches individually, show
some examples and then wrap up my thoughts about all of them.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Gordon and I will talk about this topic on the <a class="reference external" href="http://www.froscon.de/en/home/">Free and Open Source
Conference</a> in Sankt Augustin Germany on
25th/26th August of 2012. Feel free to drop by and discuss this topic!</p>
</div>
</div>
]]></description>
            <category><![CDATA[ PHP ]]></category>
             <pubDate>Sat, 11 Aug 2012 00:00:00 +0200</pubDate>
        </item>
    
    </channel>
</rss>