<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="Blog of Benjamin Eberlei, covering a wide range of programming, bootstrapping and entrepreneurial topics">
        <meta name="viewport" content="width=device-width">
        <meta name="google-site-verification" content="mycr8JCbLYq9QcOyh4Ub1esAdN-awH9ut6nyTKUTgE4">
        <title>Page 9 &mdash; beberlei.de</title>
            <link rel="stylesheet" href="/_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="/_static/css/bootstrap.min.css" type="text/css" />
            <link rel="stylesheet" href="/_static/blog.css" type="text/css" />
            <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" />
        <link rel="shortcut icon" href="_static/tinkerer.ico" /><!-- Load modernizr and JQuery -->
        <script src="_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="_static/plugins.js"></script>
        <script src="_static/main.js"></script>
        <link rel="search" title="Search" href="search.html" /><link rel="next" title="Older" href="page10.html" /><link rel="prev" title="Newer" href="page8.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.5.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        SOURCELINK_SUFFIX: '.txt',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="_static/underscore.js"></script><script type="text/javascript" src="_static/doctools.js"></script><script type="text/javascript" src="_static/disqus.js"></script></head>
    <body role="document">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><nav class="navbar navbar-dark">
		  <div class="container">
			  <div class="navbar-header">
				  <a class="navbar-brand" href="https://beberlei.de">Benjamin Eberlei</a>
			  </div>

			  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				  <ul class="nav navbar-nav navbar-right">
						<li><a href="index.html">Home</a></li>
						<li><a href="pages/about.html">About</a></li>
						<li><a href="pages/debugging_php.html">Debugging</a></li>
						<li><a href="/archive.html">Archive</a></li>
					  <li><a href="/rss.xml">RSS</a></li>
				  </ul>
			  </div>
		  </div>
		</nav><div class="main-container" role="main"><div class="container">
				<div class="row">
					<div class="col-md-8 col-md-offset-2 col-sm-12"><article role="article">
							<div class="section">
            <h1><a href="2012/08/26/symfony__monolog_and_different_log_types.html">Symfony, Monolog and different log types</a></h1>
<p>Symfony uses the excellent Monolog library for logging everything related
to the symfony application stack. But sometimes you need a different logger
that responds differently to the log error levels. Ideally you don’t want
to reuse the application log mechanism to avoid messing with the
fingers crossed listener of Monolog, that keeps the application log files small
in case no errors occur.</p>
<p>This can be easily done with Symfonys MonologBundle with a feature called
channel. Every log handler, such as file, syslog, mail or
fingers crossed is attached to the default logger called “app”. This is
referenced by the dependency injection service called <span class="docutils literal"><span class="pre">monolog.logger</span></span>.</p>
<p>If you want to create a different logger service that is responsible for a
different type of your application stack, just define it using the <span class="docutils literal"><span class="pre">channels</span></span>
option:</p>
<div class="highlight-yaml"><div class="highlight"><pre><span/>monolog:
    handlers:
        myfile:
            type: stream
            path: %kernel.logs_dir%/myfile.log
            channels: mychannel
</pre></div>
</div>
<p>To actually write to <span class="docutils literal"><span class="pre">mychannel</span></span> you have to tag all the services that use
<span class="docutils literal"><span class="pre">mychannel</span></span> with the following tag:</p>
<div class="highlight-xml"><div class="highlight"><pre><span/><span class="nt">&lt;service</span> <span class="na">id=</span><span class="s">"my_service"</span> <span class="na">class=</span><span class="s">"MyService"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;tag</span> <span class="na">name=</span><span class="s">"monolog.logger"</span> <span class="na">channel=</span><span class="s">"mychannel"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;argument</span> <span class="na">type=</span><span class="s">"service"</span> <span class="na">id=</span><span class="s">"logger"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/service&gt;</span>
</pre></div>
</div>
<p>With this approach you are now as flexible as with the default channel <span class="docutils literal"><span class="pre">app</span></span>
regarding to logging in development, testing and production environments for
example. Once there is a channel created through the DIC tag, you can actually
fetch it from the DIC with <span class="docutils literal"><span class="pre">monolog.logger.mychannel</span></span> in our example.
I don’t like this approach too much, because it misuses tags for modifying
arguments, where tags are actually for the services themselves. However it is
usable and works.</p>
<p>This feature is included starting with Symfony 2.1. It is <a class="reference external" href="http://symfony.com/doc/master/cookbook/logging/channels_handlers.html">documented in a
cookbook entry</a>,
however some insights of this blog post are still inside a pending Pull
Request.</p>


            
            <div class="tags">
                More about: 
                <a href="tags/symfony.html">Symfony</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on August 26, 2012
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2012/08/26/froscon_2012.html">FrOSCon 2012</a></h1>
<p>This years <a class="reference external" href="http://www.froscon.org">Free and Open Source Conference (FrOSCon)</a> took place this weekend in Bonn, St.  Augustin.
Because I live in Bonn, visiting the conference is a given for very many years
now. This year I also did a talk on “Architecture Design Patterns” with <a class="reference external" href="http://twitter.com/go_oh">Gordon</a> so there was an incentive to show up besides
meeting friends, all the Club Mate and <a class="reference external" href="http://www.quijote-kaffee.de">good open source coffee</a>.</p>
<p>The most interesting topic in this years conference for me has been the <a class="reference external" href="http://graylog2.org/">Graylog2</a> talk by Lennart Koopmann. Graylog is a logging server
that uses Elastic Search for persistence and searching. It is sponsored by
Xing, a pretty big german based Linkedin clone.</p>
<p>The talk <a class="reference external" href="http://programm.froscon.de/2012/events/954.html">The State of PHPUnit</a> by <a class="reference external" href="http://twitter.com/__edorian/">Volker</a> was interesting to see all the new stuff in
PHPUnit 3.7 and that it fixes a bunch of annoyances that I stumbled on myself.
I actually realized that they are so deeply rooted in my brain already, that
they constitute features for me, not something that could actually be
optimized. Well done to Volker and Sebastian to the new version.</p>
<p>Igors talk about building an HTTP server in PHP was interesting to see the
stream/socket server APIs of PHP at work. Ever since I took part in <a class="reference external" href="https://github.com/conradmueller/maexchen">the
SoCraTes 2012 Conference Maexchen UDP Bot</a> challenge I think network
programming is an interesting topic for learning about languages and
programming itself.</p>
<p>Volker did a second talk on sunday about Clean Code that was both entertaining
and interesting. He was reminding the audience that shipping the code is what
actually creates the value in our profession. Hence clean code is not about
the beauty of code itself, but its ability to be shippable, changeable and
adaptable to the business.</p>
<p>Again FrOSCon 2012 was awesome. Thank you very much especially to all the
volunteers that organized this event. It really good event to bring together
people from many different open-source communities and I already look forward
to the next FrOSCon 2013.</p>


            
            <div class="tags">
                More about: 
                <a href="tags/conferences.html">Conferences</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on August 26, 2012
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2012/08/25/decoupling_applications_with_domain_events.html">Decoupling applications with Domains Events</a></h1>
<p>In the <a class="reference external" href="http://whitewashing.de/2012/08/18/oop_business_applications__command_query_responsibility_seggregation.html">previous posts</a>
I have described 3 architectural patterns for business applications. Applying
them to your software helps you decouple the business logic from the
application/framework/UI. However given sufficient complexity, you will want to
decouple different parts of your business model from each other as well.</p>
<p>As an example, lets think of a batch process in your application that updates
orders from a CRM or logistics system:</p>
<ul class="simple">
<li>You receive an XML with full users and order representations</li>
<li>You need to update certain user fields</li>
<li>You need to update certain order fields</li>
<li>Some orders require creating accounts in different remote systems</li>
<li>If the user has not confirmed his email yet he should receive an opt-in
mail instead.</li>
<li>If the user confirms his opt-in mail, all outstanding remote accounts are
created.</li>
</ul>
<p>You can build all the steps into a single batch processing service. This will
be a particularly huge service and in violation of the <a class="reference external" href="http://en.wikipedia.org/wiki/Single_responsibility_principle">Single Responsibility
principle</a>.</p>
<p>the part with updating of users and fields has nothing to with the sending of
mails and creation of remote accounts.  We want to decouple them from each
other.</p>
<p>The first obvious choice is to decouple them into distinct services:</p>
<ul class="simple">
<li>Import Service</li>
<li>Authentication Service</li>
<li>Account Generation Service</li>
</ul>
<p>All these services have dependencies on infrastructure objects, database,
mailer and so on. We could inject the authentication and account generation
services into the Import Service, but with rising complexity this will lead to
a lasagna of services and the execution path will dig deep into this and this
is not nearly as tasty as eating real lasagna.</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="n">ImportService</span>
<span class="o">|</span><span class="n">_AuthenticationService</span>
<span class="o">|</span> <span class="o">|</span><span class="n">_Mailer</span>
<span class="o">|</span> <span class="o">|</span><span class="n">_Database</span>
<span class="o">|</span><span class="n">_AccountGenerationService</span>
<span class="o">|</span> <span class="o">|</span><span class="n">_Database</span>
<span class="o">|</span> \<span class="n">_RemoteFacade</span>
\<span class="n">_Database</span>
</pre></div>
</div>
<p>This becomes more complicated when transaction semantics need to be taken care
of. For example dependencies between mailer and database services. Also you
have to take into account that the code in entities and value objects
participating in this use-case.</p>
<p>What we want instead is a sequential execution of those nested services, but
only if the parent service executed successfully:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="n">ImportService</span>
\<span class="n">_Database</span>

<span class="n">AuthenticationService</span>
<span class="o">|</span><span class="n">_Mailer</span>
\<span class="n">_Database</span>

<span class="n">AccountGenerationService</span>
<span class="o">|</span><span class="n">_Database</span>
\<span class="n">_RemoteFacade</span>
</pre></div>
</div>
<p>We could use an event dispatcher in all of the services to notify each other,
but the <a class="reference external" href="http://martinfowler.com/eaaDev/DomainEvent.html">DomainEvent pattern</a> does this more in a much
cleaner way:</p>
<p>Every entity is an event provider and can emit events. Whenever a transaction
is committed and an hence an operation is completed successfully, we take all
the events emitted from all entities (looking at the identity map for example)
and trigger observing event handlers. However if the operation fails, we do not
trigger these event handlers.</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">Order</span> <span class="k">implements</span> <span class="nx">EventProviderInterface</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">EventProvider</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">importData</span><span class="p">(</span><span class="k">array</span> <span class="nv">$data</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// 1. do something with $data</span>

        <span class="c1">// 2. raise event</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">raise</span><span class="p">(</span><span class="k">new</span> <span class="nx">OrderImportCompleted</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="s2">"id"</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">,</span>
            <span class="s2">"data"</span> <span class="o">=&gt;</span> <span class="nv">$data</span>
        <span class="p">)));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">interface</span> <span class="nx">EventProviderInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">dequeueEmittedEvents</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The Event provider trait aggregates all the events, and offers
and API for external services to pull them from the entity:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">trait</span> <span class="nx">EventProvider</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$emittedEvents</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">raise</span><span class="p">(</span><span class="nx">DomainEvent</span> <span class="nx">Event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getMessageHeader</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">setEntity</span><span class="p">(</span><span class="nv">$this</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">emittedEvents</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$event</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">dequeueEmittedEvents</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$events</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">emittedEvents</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">emittedEvents</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
        <span class="k">return</span> <span class="nv">$events</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Our infrastructure must then trigger event handlers, based
on the event names. It will use <span class="docutils literal"><span class="pre">dequeueEmittedEvents</span></span> and making
sure the events are not emitted multiple times.</p>
<p>For reasons described below, we want the following command/event chain to happen in our system:</p>
<ul class="simple">
<li>Command executes</li>
<li>Entities emit events</li>
<li>Command transaction succeeds</li>
<li>Events trigger event handlers</li>
<li>Event handlers execute more commands</li>
<li>Restart from 1.</li>
</ul>
<p>With this approach we can decouple all services from each other and avoid
deep nesting in each other. Yet we still have transactional dependencies,
by dropping all events when the parent command fails. Transactions over
multiple commands will not have ACID properties though, instead you will have
to look into <a class="reference external" href="http://queue.acm.org/detail.cfm?id=1394128">BASE transactions</a>
that are important in systems with eventual consistency. This is one downside
that you need to take into account.</p>
<p>The Domain Event pattern is a prerequisite for full blown <a class="reference external" href="http://queue.acm.org/detail.cfm?id=1394128">CQRS</a>. My <a class="reference external" href="https://github.com/beberlei/litecqrs-php">LiteCQRS</a> library includes a simple
implementation of DomainEvent and EventProvider classes and integration into
Symfony and Doctrine ORM. Generally this pattern is very easy to implement
though, so that you can just have a look at the implementation and take the
best parts for your own.</p>


            
            <div class="tags">
                More about: 
                <a href="tags/applicationdesign.html">ApplicationDesign</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on August 25, 2012
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2012/08/22/building_an_object_model__no_setters_allowed.html">Building an Object Model: No setters allowed</a></h1>
<p>If you are using an object relational mapper or any other database
abstraction technology that converts rows to objects, then you will probably
use getter/setter methods or properties (C#) to encapsulate object properties.</p>
<p>Take <a class="reference external" href="https://github.com/FriendsOfSymfony/FOSUserBundle/blob/master/Model/User.php">a look</a>
at the default <span class="docutils literal"><span class="pre">User</span></span> entity from the Symfony2 FOSUserBundle plugin for
example: A colossus of getter/setter methods with nearly no real business
logic. This is how most of our persistence related objects look like in PHP.
A Rails ActiveRecord such as <a class="reference external" href="https://github.com/redmine/redmine/blob/master/app/models/issue.rb">Redmines “Issue”</a> avoids
the explicit getter/setters, however generates accessors magically for you.
Nevertheless you have to add considerable amount of code to configure all the
properties. And code using these active records becomes ambiguous as well.</p>
<p>Why do we use getters/setters so much?</p>
<ul class="simple">
<li>Tools generate objects from a database, adding getters and setters
automatically.</li>
<li>Frameworks make them automatically available for database records/rows.</li>
<li>IDEs can magically create getter/setter pairs for fields.</li>
<li>We want the flexibility to change every field whenever we want.</li>
<li>It became natural in OOP to have write access to every field.</li>
</ul>
<p>However Getters/setters <a class="reference external" href="http://en.wikipedia.org/wiki/Open/closed_principle">violate the open/closed principle</a>, prevent information
hiding and <a class="reference external" href="http://stackoverflow.com/questions/565095/are-getters-and-setters-evil">should be considered evil</a>
(<a class="reference external" href="http://www.javaworld.com/javaworld/jw-09-2003/jw-0905-toolbox.html">Long version</a>). Using
getters and setters allows to <em>decouples</em> the business logic for setting values from the
actual storage. Something that object-orientation was suppose to avoid.</p>
<div class="section" id="getting-rid-of-setters">
<h2>Getting rid of setters</h2>
<p>Avoiding setters is much simpler than getters, so lets start with them.</p>
<p>One way to avoid writing setters is a task based approach to the model. Think
of every task that is performed in an application and add a method that
changes all the affected fields at once, to perform this task. In the famous
blog example the <span class="docutils literal"><span class="pre">Post</span></span> object may look like:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">Post</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">compose</span><span class="p">(</span><span class="nv">$headline</span><span class="p">,</span> <span class="nv">$text</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$tags</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// check invariants, business logic, filters</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">headline</span> <span class="o">=</span> <span class="nv">$headline</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">text</span>     <span class="o">=</span> <span class="nv">$text</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">tags</span>     <span class="o">=</span> <span class="nv">$tags</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">publish</span><span class="p">(</span><span class="nx">\DateTime</span> <span class="nv">$onDate</span> <span class="o">=</span> <span class="k">null</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// check invariants, business logic, filters</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">state</span>       <span class="o">=</span> <span class="s2">"published"</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">publishDate</span> <span class="o">=</span> <span class="nv">$onDate</span> <span class="o">?:</span> <span class="k">new</span> <span class="nx">\DateTime</span><span class="p">(</span><span class="s2">"now"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <span class="docutils literal"><span class="pre">Post</span></span> class is now much more protected from the outside and
is actually much better to read and understand. You can clearly see
the behaviors that exist on this object. In the future you might even
be able to change the state of this object without breaking client code.</p>
<p>You could even call this code domain driven, but actually its just applying
the SOLID principles to entities.</p>
</div>
<div class="section" id="tackling-getters">
<h2>Tackling getters</h2>
<p>Avoiding getters is a bit more cumbersome and given no setters, maybe
not worth the trouble anymore.</p>
<p>You still need getters to access the object state, either if you display
models directly in the view or for testing purposes. There is another way
to get rid of all the getters that you don’t need explicitly in a domain
model, using the visitor pattern in combination with view models:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">Post</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">render</span><span class="p">(</span><span class="nx">PostView</span> <span class="nv">$view</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$view</span><span class="o">-&gt;</span><span class="na">id</span>          <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">;</span>
        <span class="nv">$view</span><span class="o">-&gt;</span><span class="na">publishDate</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">publishDate</span><span class="p">;</span>
        <span class="nv">$view</span><span class="o">-&gt;</span><span class="na">headline</span>    <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">headline</span><span class="p">;</span>
        <span class="nv">$view</span><span class="o">-&gt;</span><span class="na">text</span>        <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">text</span><span class="p">;</span>
        <span class="nv">$view</span><span class="o">-&gt;</span><span class="na">author</span>      <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">author</span><span class="o">-&gt;</span><span class="na">render</span><span class="p">(</span><span class="k">new</span> <span class="nx">AuthorView</span><span class="p">);</span>

        <span class="k">return</span> <span class="nv">$view</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">PostView</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="c1">//... more public properties</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There are drawbacks with this approach though:</p>
<ul class="simple">
<li>Why use the Post model in memory, when you are only passing <span class="docutils literal"><span class="pre">PostView</span></span>
instances to the controllers and views only anyways? Its much more efficient
to have the database map to the view objects directly. This is what CQRS
postulates as separation of read- and write model.</li>
<li>You have to write additional classes for every entity (Data transfer objects)
instead of passing the entities directly to the view. But if you want to
cleanly separate the model from the application/framework, you don’t get
around view model/data transfer objects anyways.</li>
<li>It looks awkward in tests at first, but you can write some custom assertions
to get your sanity back for this task.</li>
</ul>
</div>
<div class="section" id="what-about-the-automagic-form-mapping">
<h2>What about the automagic form mapping?</h2>
<p>Some form frameworks like the <a class="reference external" href="http://www.symfony.com">Symfony2</a> or <a class="reference external" href="http://framework.zend.com">Zend
Framework 2</a> ones map forms directly to objects
and back. Without getters/setters this is obviously not possible anymore.
However if you are decoupling the model from the framework, then using this
kind of form framework on entities is a huge no go anyways.</p>
<p>Think back to the tasks we are performing on our <span class="docutils literal"><span class="pre">Post</span></span> entity:</p>
<ul class="simple">
<li>Edit (title, body, tags)</li>
<li>Publish (publishDate)</li>
</ul>
<p>Both tasks allow only a subset of the properties to be modified. For each of
these tasks we need a custom form “model”. Think of these models as command
objects:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">EditPostCommand</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$headline</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$text</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$tags</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In our application we could attach these form models to our form framework and
then pass these as commands into our “real model” through a service layer,
<a class="reference external" href="http://www.eaipatterns.com/MessageBus.html">message bus</a> or something equivalent:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">PostController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">editAction</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$post</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">findPostViewModel</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'id'</span><span class="p">));</span>

        <span class="c1">// This could need some more automation/generic code</span>
        <span class="nv">$editPostCommand</span>           <span class="o">=</span> <span class="k">new</span> <span class="nx">EditPostCommand</span><span class="p">();</span>
        <span class="nv">$editPostCommand</span><span class="o">-&gt;</span><span class="na">id</span>       <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'id'</span><span class="p">);</span>
        <span class="nv">$editPostCommand</span><span class="o">-&gt;</span><span class="na">headline</span> <span class="o">=</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">headline</span><span class="p">;</span>
        <span class="nv">$editPostCommand</span><span class="o">-&gt;</span><span class="na">text</span>     <span class="o">=</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">text</span><span class="p">;</span>
        <span class="nv">$editPostCommand</span><span class="o">-&gt;</span><span class="na">tags</span>     <span class="o">=</span> <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">tags</span><span class="p">;</span>

        <span class="c1">// here be the form framework handling...</span>
        <span class="nv">$form</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createForm</span><span class="p">(</span><span class="k">new</span> <span class="nx">EditPostType</span><span class="p">(),</span> <span class="nv">$editPostCommand</span><span class="p">);</span>
        <span class="nv">$form</span><span class="o">-&gt;</span><span class="na">bind</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$form</span><span class="o">-&gt;</span><span class="na">isValid</span><span class="p">())</span> <span class="p">{</span>
            <span class="c1">// invalid, show errors</span>
        <span class="p">}</span>

        <span class="c1">// here we invoke the model, finally, through the service layer</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">postService</span><span class="o">-&gt;</span><span class="na">edit</span><span class="p">(</span><span class="nv">$editPostCommand</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">PostService</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">edit</span><span class="p">(</span><span class="nx">EditPostCommand</span> <span class="nv">$command</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$post</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">postRepository</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
        <span class="nv">$post</span><span class="o">-&gt;</span><span class="na">compose</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="na">headline</span><span class="p">,</span> <span class="nv">$command</span><span class="o">-&gt;</span><span class="na">text</span><span class="p">,</span> <span class="nv">$command</span><span class="o">-&gt;</span><span class="na">tags</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This way we separated the business model from the application framework.</p>
</div>
<div class="section" id="a-word-about-rad">
<h2>A word about RAD</h2>
<p>Rapid-application development or rapid prototyping is a wide-spread approach in web
development. My explicit approach seems to be completely against this kind of
development and much slower as well. But I think you don’t loose much time
in the long run:</p>
<ul class="simple">
<li>Simple command objects can be code-generated or generated by IDEs
in a matter of seconds. Or you could even extend ORMs code generation
capabilities to generate these dummy objects for you. Since you don’t need
ORM mapping information for these objects or think about performance
implications in context with the ORM, you don’t need to spend much
thinking about their creation.</li>
<li>Explicit models are much simpler to unit-test and those tests run much faster
than tests through the UI that RAD prototypes need.</li>
<li>Generated Rapid prototypes can get hard to maintain quickly. That does not mean they
are unmaintainable, but they seem to favour reimplementation instead of
refactoring, something that leads to problems given the low code coverage
that these prototypes normally have.</li>
</ul>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>If we take a step back from all our tools suggesting to generate getter/setters
we find that there is a simple way to avoid using setters when focusing on the
tasks that objects perform. This actually makes our code much more readable and
is one building block towards clean object oriented code and domain driven design.</p>
<p>I am very interested in your opinions on this topic and my attempt to avoid them,
please leave comments when leaving this website :-)</p>
</div>


            
            <div class="tags">
                More about: 
                <a href="tags/applicationdesign.html">ApplicationDesign</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on August 22, 2012
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2012/08/18/oop_business_applications__command_query_responsibility_seggregation.html">OOP Business Applications: Command-Query-Responsibility-Segregation (CQRS)</a></h1>
<p>Other posts in this series about OOP Business Applications:</p>
<ul class="simple">
<li><a class="reference external" href="http://whitewashing.de/2012/08/11/oop_business_applications__trying_to_escape_the_mess.html">Trying to escape the
mess</a></li>
<li><a class="reference external" href="http://whitewashing.de/2012/08/13/oop_business_applications_entity_boundary_interactor.html">Entity, Boundary, Interactor</a></li>
<li><a class="reference external" href="http://whitewashing.de/2012/08/16/oop_business_applications__data__context__interaction.html">Data, Context, Interaction</a></li>
</ul>
<p>The last pattern for designing your business logic is called
“Command-Query-Responsibility-Segregation” or short CQRS. It has its roots in
the <a class="reference external" href="http://en.wikipedia.org/wiki/Command-query_separation">“Command Query Separation”</a> principle that was
put forward by Bertrand Meyer.</p>
<p>Wikipedia has a very good summary about what this principle is about:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="n">Command</span><span class="o">-</span><span class="n">Query</span><span class="o">-</span><span class="n">Separation</span> <span class="n">states</span> <span class="n">that</span> <span class="n">every</span> <span class="n">method</span> <span class="n">should</span> <span class="n">either</span> <span class="n">be</span> <span class="n">a</span>
<span class="n">command</span> <span class="n">that</span> <span class="n">performs</span> <span class="n">an</span> <span class="n">action</span><span class="p">,</span> <span class="ow">or</span> <span class="n">a</span> <span class="n">query</span> <span class="n">that</span> <span class="n">returns</span> <span class="n">data</span> <span class="n">to</span> <span class="n">the</span>
<span class="n">caller</span><span class="p">,</span> <span class="n">but</span> <span class="ow">not</span> <span class="n">both</span><span class="o">.</span> <span class="n">In</span> <span class="n">other</span> <span class="n">words</span><span class="p">,</span> <span class="n">asking</span> <span class="n">a</span> <span class="n">question</span> <span class="n">should</span> <span class="ow">not</span> <span class="n">change</span>
<span class="n">the</span> <span class="n">answer</span><span class="o">.</span> <span class="n">More</span> <span class="n">formally</span><span class="p">,</span> <span class="n">methods</span> <span class="n">should</span> <span class="k">return</span> <span class="n">a</span> <span class="n">value</span> <span class="n">only</span> <span class="k">if</span> <span class="n">they</span> <span class="n">are</span>
<span class="n">referentially</span> <span class="n">transparent</span> <span class="ow">and</span> <span class="n">hence</span> <span class="n">possess</span> <span class="n">no</span> <span class="n">side</span> <span class="n">effects</span><span class="o">.</span>
</pre></div>
</div>
<p>CQRS is an OOP architecture design pattern building on that imperative
principle.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There are many different variations of the CQRS pattern that
all have their place. This post describes a simple variant that does
<strong>not</strong>
use Messaging, DomainEvent or EventSourcing patterns, which are commonly mentioned
with CQRS.</p>
</div>
<p>At its heart is the separation of Read and Write methods. This can be easily
achieved by just having two different service layer classes instead of one.
This insight alone is not really helpful, its just moving methods around.
Coupled to this change however is the notion, that read and write models don’t
necessarily have to be the same:</p>
<ul class="simple">
<li>Getter/Setters: We don’t need setters in the write model, instead we use
explicit methods for each write operation. Entities are also much simpler
without bi-directional relationships that read/write models often need.
Read-only models (ViewModel) don’t need getters/setters. They could just use
public properties or even be arrays.</li>
<li>ORM Performance, Lazy Loading and Query Restrictions: In a write scenario we
mostly need queries by primary key, changing only some objects. In
read scenarios we need complex queries, joins and aggregations. A separation
prevents both from affecting each other negatively.</li>
<li>Mapping Data-Transfer objects becomes simple. Instead of sending the whole
model back and forth, for the write scenario you define use-case specific
tasks and updates. This is much simpler than generic mapping of Data Transfer
objects to complex object graphs.</li>
<li>Transforming SQL directly to a view model in a highly optimized way.
Simple concept, but it has huge implications: A pure read-only model is simple to
maintain and refactor for any performance requirements that come up.</li>
</ul>
<p>Furthermore with CQRS our write service methods are not allowed to return data
anymore (With the exceptions to the rule of course). This may increase the
complexity at first, but it has benefits for scalability and decoupling.
Following this principle allows us to turn every command from synchronous to
asynchronous processing later without much problems. Services are allowed to
throw exceptions and refuse the execution. Proper validation of input data
should happen before executing write operations though.</p>
<p>One drawback of CQRS: A naive implementation doubles the amount of classes and
services to write. But there are simple shortcuts to avoid having to write a
full blown read-model if you don’t apply CQRS religiously:</p>
<ul class="simple">
<li>Don’t use different data-stores for both models.</li>
<li>Mapping SQL to PHP arrays and stdClass objects through a simple gateway is
very simple. You can easily generalize this to a simple object that gives
efficient access to all your data.</li>
<li>Share parts of the write and read models if you don’t have to compromise
much.</li>
</ul>
<p>The important thing to take away from this separation is, that the read part of
your application is seldom the part where business value lies in. Moving this
code into a different part of your applications allows you to work with the
underlying data-source much more directly, without need for much abstractions.</p>
<p>One thing that CQRS puts forward is the concept of Commands, Command Handlers
and Command Bus and how they interact. Commands are simple objects that
contain all the data necessary to execute an operation. Each command is
processed by exactly one command handler. The Command Bus is responsible to
route a command to its appropriate command handler.</p>
<div class="section" id="example">
<h2>Example</h2>
<p>Here is the most simple implementation of the Command Bus, just holds a hash map
mapping command class names to command handlers:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">interface</span> <span class="nx">Handler</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">$command</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">class</span> <span class="nc">CommandBus</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$handlers</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">register</span><span class="p">(</span><span class="nv">$commandClassName</span><span class="p">,</span> <span class="nx">Handler</span> <span class="nv">$handler</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handlers</span><span class="p">[</span><span class="nv">$commandClassName</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$handler</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">$command</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handlers</span><span class="p">[</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$command</span><span class="p">)]</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$command</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In your code you would always pass Commands to the bus. That way the command
bus is a central entry point to any write operation. With this we can rewrite the
TransferMoney service:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">TransferMoneyCommand</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$sourceId</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$destinationId</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$money</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">MoneyTransfer</span> <span class="k">implements</span> <span class="nx">Handler</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$accountDao</span><span class="p">;</span> <span class="c1">// ctor omitted</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">$command</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$source</span>      <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">accountDao</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="na">sourceId</span><span class="p">);</span>
        <span class="nv">$destination</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">accountDao</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="na">destinationId</span><span class="p">);</span>
        <span class="nv">$money</span>       <span class="o">=</span> <span class="k">new</span> <span class="nx">Money</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="na">amount</span><span class="p">);</span>

        <span class="nv">$source</span><span class="o">-&gt;</span><span class="na">withdraw</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
        <span class="nv">$destination</span><span class="o">-&gt;</span><span class="na">deposit</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There is also a benefit from the mental model of commands compared to the
“generic” term of model requests in EBI. Your write model gets task
oriented.</p>
<p>Routing everything through the command bus has several benefits as well:</p>
<ul class="simple">
<li>Nesting handlers that take care of transactions, logging, 2 phase commits</li>
<li>Order nested command calls sequentially instead of deep into each other.</li>
<li>Asynchronous processing with message queue become an option</li>
</ul>
<p>The command bus acts as the application boundary as described in the
Entity-Boundary-Interactor pattern, usage is simple:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MoneyController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">transferAction</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$commandBus</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'command_bus'</span><span class="p">);</span>
        <span class="nv">$commandBus</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="k">new</span> <span class="nx">TransferMoneyCommand</span><span class="p">(</span>
            <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'sourceId'</span><span class="p">),</span>
            <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'destinationId'</span><span class="p">),</span>
            <span class="k">new</span> <span class="nx">Money</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'amount'</span><span class="p">)</span>
        <span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="pros-and-cons">
<h2>Pros and Cons</h2>
<p>I really like CQRS for multiple reasons. It offers explicit guidance how solve
tasks by making use of a range of different design patterns. This is very
helpful, because the code-base is based on conventions that are simple to
understand by everyone on the team. This structure liberates you from the curse
of choice and gives you a cookbook of best-practices how to solve problems.
You want this structure for all your applications, regardless of what
architectural pattern you have chosen.</p>
<p>Embracing the difference between read and write models is another plus of CQRS.
It is very helpful, not to try fitting both read and write into one model.  You
also don’t run into so many read-related problems with an ORM any more. You
design the entities to be optimized for the write model only, loose the
bidirectional associations and avoid all the optimizations here and there for
read performance.</p>
<p>Compared to EBI, where we had to maintain a mapping between DTOs and entities,
CQRS explicitly uses the command based approach to avoid the complexity of
these mappings. You will still have to map between command and entity, however
doing so in the context of a use-case simplifies the code considerably compared
to a generic mapping solution.</p>
<p>One negative point: Its difficult to work with commands not returning any data
in some cases. You need to find simple ways to return messages to the
user. For that you also need to validate commands on the “client” or
controller side, using the read model, so that you can prevent invalid/illegal
commands from being sent as often as possible.</p>
<p>Without return values from your models, you are left to using mocks as means of
testing. This might be more difficult for developers to use and understand.
This problem goes away however, if you combine CQRS with Event Sourcing. A
topic that I will discuss in the next blog post.</p>
</div>


            
            <div class="tags">
                More about: 
                <a href="tags/applicationdesign.html">ApplicationDesign</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on August 18, 2012
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="archive_link">
        <a href="archive.html">Archive</a>
    </div></article></div> <!-- #main -->
				</div>
			</div></div> <!-- #main-container -->

        <div class="footer-container" role="contentinfo">
			<div class="container">
				<div class="col-md-8 col-md-offset-2">
					<div class="footer">
						<small>© Copyright 2008-2017, Benjamin Eberlei.</small>

						<script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script>
					</div>
				</div>
			</div>
        </div> <!-- footer-container -->
      </div> <!--! end of #container --><script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-32146757-1', 'auto');
          ga('send', 'pageview');
        </script>

    </body>
</html>