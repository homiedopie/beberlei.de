<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="My blog">
        <meta name="viewport" content="width=device-width">
        <title>OOP Business Applications: Command-Query-Responsibility-Segregation (CQRS) &mdash; Whitewashing</title>
            <link rel="stylesheet" href="../../../_static/normalize.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/sphinx.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/main.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/default.css" type="text/css">
            <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="../../../_static/webfont.css" type="text/css">
        <link rel="shortcut icon" href="../../../_static/tinkerer.ico" /><!-- Load modernizr and JQuery -->
        <script src="../../../_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="../../../_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="../../../_static/plugins.js"></script>
        <script src="../../../_static/main.js"></script>
        <link rel="next" title="OOP Business Applications: Data, Context, Interaction" href="../16/oop_business_applications__data__context__interaction.html" /><link rel="prev" title="Building an Object Model: No setters allowed" href="../22/building_an_object_model__no_setters_allowed.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.3.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="../../../_static/underscore.js"></script><script type="text/javascript" src="../../../_static/doctools.js"></script><script type="text/javascript" src="../../../_static/disqus.js"></script><script type="text/javascript" src="../../../_static/ga.js"></script></head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container">
<div class="container">
    <div id="header" class="span-8">
        <a href="../../../index.html"><img src="../../../_static/logo.jpg" alt="Whitewashing.de" /></a>
    </div>
    <div class="span-11" id="about">
        <p>
            Whitewashing is the blog of Benjamin Eberlei and covers topics in software development. Benjamin works
            for <a href="http://qafoo.com/" target="_blank">Qafoo</a> and you can book him for consulting and trainings.
        </p>
    </div>
    <div class="span-5 last">
        <p class="buttons" style="text-align: right">
            <a href="https://twitter.com/beberlei"><img src="../../../_static/twitter-logo.png" alt="Follow me on twitter" height="50" /></a>
            <a href="http://www.whitewashing.de/rss.xml"><img src="../../../_static/rss2.png" alt="Subscribe to RSS" height="50" /></a>
            <a href="https://github.com/beberlei"><img src="../../../_static/github-logo.png" alt="My Github Profile" height="50" /></a>
        </p>
    </div>
</div>

<div class="main-container">
<div class="container">
    <div class="span-24 content">
      <div>
        <div>
          <div id="2012-08-18-oop_business_applications__command_query_responsibility_seggregation">
            
            
    <div class="timestamp postmeta">
            <span>August 18, 2012</span>
        </div>

    <div class="section" id="oop-business-applications-command-query-responsibility-segregation-cqrs">
<h1>OOP Business Applications: Command-Query-Responsibility-Segregation (CQRS)</h1>
<p>Other posts in this series about OOP Business Applications:</p>
<ul class="simple">
<li><a class="reference external" href="http://whitewashing.de/2012/08/11/oop_business_applications__trying_to_escape_the_mess.html">Trying to escape the
mess</a></li>
<li><a class="reference external" href="http://whitewashing.de/2012/08/13/oop_business_applications_entity_boundary_interactor.html">Entity, Boundary, Interactor</a></li>
<li><a class="reference external" href="http://whitewashing.de/2012/08/16/oop_business_applications__data__context__interaction.html">Data, Context, Interaction</a></li>
</ul>
<p>The last pattern for designing your business logic is called
&#8220;Command-Query-Responsibility-Segregation&#8221; or short CQRS. It has its roots in
the <a class="reference external" href="http://en.wikipedia.org/wiki/Command-query_separation">&#8220;Command Query Separation&#8221;</a> principle that was
put forward by Bertrand Meyer.</p>
<p>Wikipedia has a very good summary about what this principle is about:</p>
<div class="highlight-python"><div class="highlight"><pre>Command-Query-Separation states that every method should either be a
command that performs an action, or a query that returns data to the
caller, but not both. In other words, asking a question should not change
the answer. More formally, methods should return a value only if they are
referentially transparent and hence possess no side effects.
</pre></div>
</div>
<p>CQRS is an OOP architecture design pattern building on that imperative
principle.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There are many different variations of the CQRS pattern that
all have their place. This post describes a simple variant that does
<strong>not</strong>
use Messaging, DomainEvent or EventSourcing patterns, which are commonly mentioned
with CQRS.</p>
</div>
<p>At its heart is the separation of Read and Write methods. This can be easily
achieved by just having two different service layer classes instead of one.
This insight alone is not really helpful, its just moving methods around.
Coupled to this change however is the notion, that read and write models don&#8217;t
necessarily have to be the same:</p>
<ul class="simple">
<li>Getter/Setters: We don&#8217;t need setters in the write model, instead we use
explicit methods for each write operation. Entities are also much simpler
without bi-directional relationships that read/write models often need.
Read-only models (ViewModel) don&#8217;t need getters/setters. They could just use
public properties or even be arrays.</li>
<li>ORM Performance, Lazy Loading and Query Restrictions: In a write scenario we
mostly need queries by primary key, changing only some objects. In
read scenarios we need complex queries, joins and aggregations. A separation
prevents both from affecting each other negatively.</li>
<li>Mapping Data-Transfer objects becomes simple. Instead of sending the whole
model back and forth, for the write scenario you define use-case specific
tasks and updates. This is much simpler than generic mapping of Data Transfer
objects to complex object graphs.</li>
<li>Transforming SQL directly to a view model in a highly optimized way.
Simple concept, but it has huge implications: A pure read-only model is simple to
maintain and refactor for any performance requirements that come up.</li>
</ul>
<p>Furthermore with CQRS our write service methods are not allowed to return data
anymore (With the exceptions to the rule of course). This may increase the
complexity at first, but it has benefits for scalability and decoupling.
Following this principle allows us to turn every command from synchronous to
asynchronous processing later without much problems. Services are allowed to
throw exceptions and refuse the execution. Proper validation of input data
should happen before executing write operations though.</p>
<p>One drawback of CQRS: A naive implementation doubles the amount of classes and
services to write. But there are simple shortcuts to avoid having to write a
full blown read-model if you don&#8217;t apply CQRS religiously:</p>
<ul class="simple">
<li>Don&#8217;t use different data-stores for both models.</li>
<li>Mapping SQL to PHP arrays and stdClass objects through a simple gateway is
very simple. You can easily generalize this to a simple object that gives
efficient access to all your data.</li>
<li>Share parts of the write and read models if you don&#8217;t have to compromise
much.</li>
</ul>
<p>The important thing to take away from this separation is, that the read part of
your application is seldom the part where business value lies in. Moving this
code into a different part of your applications allows you to work with the
underlying data-source much more directly, without need for much abstractions.</p>
<p>One thing that CQRS puts forward is the concept of Commands, Command Handlers
and Command Bus and how they interact. Commands are simple objects that
contain all the data necessary to execute an operation. Each command is
processed by exactly one command handler. The Command Bus is responsible to
route a command to its appropriate command handler.</p>
<div class="section" id="example">
<h2>Example</h2>
<p>Here is the most simple implementation of the Command Bus, just holds a hash map
mapping command class names to command handlers:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">interface</span> <span class="nx">Handler</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">$command</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">class</span> <span class="nc">CommandBus</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$handlers</span><span class="p">;</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">register</span><span class="p">(</span><span class="nv">$commandClassName</span><span class="p">,</span> <span class="nx">Handler</span> <span class="nv">$handler</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handlers</span><span class="p">[</span><span class="nv">$commandClassName</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$handler</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">$command</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">handlers</span><span class="p">[</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$command</span><span class="p">)]</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="nv">$command</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>In your code you would always pass Commands to the bus. That way the command
bus is a central entry point to any write operation. With this we can rewrite the
TransferMoney service:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">TransferMoneyCommand</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$sourceId</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$destinationId</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$money</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">MoneyTransfer</span> <span class="k">implements</span> <span class="nx">Handler</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$accountDao</span><span class="p">;</span> <span class="c1">// ctor omitted</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">handle</span><span class="p">(</span><span class="nv">$command</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$source</span>      <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">accountDao</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="na">sourceId</span><span class="p">);</span>
        <span class="nv">$destination</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">accountDao</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="na">destinationId</span><span class="p">);</span>
        <span class="nv">$money</span>       <span class="o">=</span> <span class="k">new</span> <span class="nx">Money</span><span class="p">(</span><span class="nv">$command</span><span class="o">-&gt;</span><span class="na">amount</span><span class="p">);</span>

        <span class="nv">$source</span><span class="o">-&gt;</span><span class="na">withdraw</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
        <span class="nv">$destination</span><span class="o">-&gt;</span><span class="na">deposit</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There is also a benefit from the mental model of commands compared to the
&#8220;generic&#8221; term of model requests in EBI. Your write model gets task
oriented.</p>
<p>Routing everything through the command bus has several benefits as well:</p>
<ul class="simple">
<li>Nesting handlers that take care of transactions, logging, 2 phase commits</li>
<li>Order nested command calls sequentially instead of deep into each other.</li>
<li>Asynchronous processing with message queue become an option</li>
</ul>
<p>The command bus acts as the application boundary as described in the
Entity-Boundary-Interactor pattern, usage is simple:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MoneyController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">transferAction</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$commandBus</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;command_bus&#39;</span><span class="p">);</span>
        <span class="nv">$commandBus</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="k">new</span> <span class="nx">TransferMoneyCommand</span><span class="p">(</span>
            <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;sourceId&#39;</span><span class="p">),</span>
            <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;destinationId&#39;</span><span class="p">),</span>
            <span class="k">new</span> <span class="nx">Money</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">&#39;amount&#39;</span><span class="p">)</span>
        <span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="pros-and-cons">
<h2>Pros and Cons</h2>
<p>I really like CQRS for multiple reasons. It offers explicit guidance how solve
tasks by making use of a range of different design patterns. This is very
helpful, because the code-base is based on conventions that are simple to
understand by everyone on the team. This structure liberates you from the curse
of choice and gives you a cookbook of best-practices how to solve problems.
You want this structure for all your applications, regardless of what
architectural pattern you have chosen.</p>
<p>Embracing the difference between read and write models is another plus of CQRS.
It is very helpful, not to try fitting both read and write into one model.  You
also don&#8217;t run into so many read-related problems with an ORM any more. You
design the entities to be optimized for the write model only, loose the
bidirectional associations and avoid all the optimizations here and there for
read performance.</p>
<p>Compared to EBI, where we had to maintain a mapping between DTOs and entities,
CQRS explicitly uses the command based approach to avoid the complexity of
these mappings. You will still have to map between command and entity, however
doing so in the context of a use-case simplifies the code considerably compared
to a generic mapping solution.</p>
<p>One negative point: Its difficult to work with commands not returning any data
in some cases. You need to find simple ways to return messages to the
user. For that you also need to validate commands on the &#8220;client&#8221; or
controller side, using the read model, so that you can prevent invalid/illegal
commands from being sent as often as possible.</p>
<p>Without return values from your models, you are left to using mocks as means of
testing. This might be more difficult for developers to use and understand.
This problem goes away however, if you combine CQRS with Event Sourcing. A
topic that I will discuss in the next blog post.</p>
</div>
</div>


    <div id="donation">
        <script data-gittip-username="beberlei" data-gittip-widget="button" src="//gttp.co/v1.js"></script>
        <script id='fbe2w33'>(function(i){var f,s=document.getElementById(i);f=document.createElement('iframe');f.src='//api.flattr.com/button/view/?uid=beberlei&button=compact&url='+encodeURIComponent(document.URL);f.title='Flattr';f.height=20;f.width=110;f.style.borderWidth=0;s.parentNode.insertBefore(f,s);})('fbe2w33');</script>
    </div>

    <div id="disqus_thread"></div><script type="text/javascript">    var disqus_shortname = "whitewashing";    var disqus_identifier = "2012/08/18/oop_business_applications__command_query_responsibility_seggregation";    disqus_thread();</script><noscript>Please enable JavaScript to view the    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'whitewashing';
                var disqus_url = 'http://www.whitewashing.de/2012/08/18/oop_business_applications__command_query_responsibility_seggregation.html';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>         
        </div>
      </div>
    </div>

    <div class="span-24 last" style="margin-top: 20px"><aside class="yui-b" id="sidebar" class="sidebar"><section><div class="widget">
    <h1>Recent Posts</h1>
    <ul><li>
            <a href="../../../2014/10/26/symfony_all_the_things_web.html">Symfony All The Things (Web)</a>
        </li><li>
            <a href="../../../2014/10/14/lightweight_symfony2_controllers.html">Lightweight Symfony2 Controllers</a>
        </li><li>
            <a href="../../../2014/08/11/spotting_featureenvy_and_refactoring.html">Spotting Feature Envy and Refactoring</a>
        </li><li>
            <a href="../../../2014/04/24/symfony_hello_world.html">Symfony2: A Simple Hello World</a>
        </li><li>
            <a href="../../../2014/01/31/soap_and_php_in_2014.html">SOAP and PHP in 2014</a>
        </li><li>
            <a href="../../../2014/01/26/assert_v2_0__fluent_api_and_lazy_assertions.html">Assert v2.0: Fluent API and Lazy Assertions</a>
        </li><li>
            <a href="../../../2013/12/31/2013_and_2014.html">2013 and 2014</a>
        </li><li>
            <a href="../../../2013/12/05/feature_flags_and_doctrine_entities.html">Feature Flags and Doctrine Entities</a>
        </li><li>
            <a href="../../../2013/11/19/setting_up_development_machines_ansible_edition.html">Setting up development machines: Ansible edition</a>
        </li><li>
            <a href="../../../2013/09/04/decoupling_from_symfony_security_and_fosuserbundle.html">Decoupling from Symfony Security and FOSUserBundle</a>
        </li></ul>
</div>
</section>
          </aside></div>
</div>
</div> <!-- #main-container -->

        <div class="footer-container">
<div class="container">
    <div class="span-24 content">
        <div class="footer">
            &copy; Copyright 2008-2012, Benjamin Eberlei.
            Powered by <a href="http://www.tinkerer.me/">Tinkerer</a> and <a href="http://sphinx.pocoo.org/">Sphinx</a>.

        
        </div>
    </div>
</div>
</div> <!-- footer-container -->

      </div> <!--! end of #container --><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->
    </body>
</html>