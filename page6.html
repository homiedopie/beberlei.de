<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="Blog of Benjamin Eberlei, covering a wide range of programming, bootstrapping and entrepreneurial topics">
        <meta name="viewport" content="width=device-width">
        <meta name="google-site-verification" content="mycr8JCbLYq9QcOyh4Ub1esAdN-awH9ut6nyTKUTgE4">
        <title>Page 6 &mdash; beberlei.de</title>
            <link rel="stylesheet" href="/_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="/_static/css/bootstrap.min.css" type="text/css" />
            <link rel="stylesheet" href="/_static/blog.css" type="text/css" />
            <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" />
        <link rel="shortcut icon" href="_static/tinkerer.ico" /><!-- Load modernizr and JQuery -->
        <script src="_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="_static/plugins.js"></script>
        <script src="_static/main.js"></script>
        <link rel="search" title="Search" href="search.html" /><link rel="next" title="Older" href="page7.html" /><link rel="prev" title="Newer" href="page5.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.5.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        SOURCELINK_SUFFIX: '.txt',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="_static/underscore.js"></script><script type="text/javascript" src="_static/doctools.js"></script><script type="text/javascript" src="_static/disqus.js"></script></head>
    <body role="document">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><nav class="navbar navbar-dark">
		  <div class="container">
			  <div class="navbar-header">
				  <a class="navbar-brand" href="https://beberlei.de">Benjamin Eberlei</a>
			  </div>

			  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				  <ul class="nav navbar-nav navbar-right">
						<li><a href="index.html">Home</a></li>
						<li><a href="pages/about.html">About</a></li>
						<li><a href="/archive.html">Archive</a></li>
					  <li><a href="/rss.xml">RSS</a></li>
				  </ul>
			  </div>
		  </div>
		</nav><div class="main-container" role="main"><div class="container">
				<div class="row">
					<div class="col-md-8 col-md-offset-2 col-sm-12"><article role="article">
							<div class="section">
            <h1><a href="2013/07/24/doctrine_and_domainevents.html">Doctrine and Domain Events</a></h1>
<p>I have written about the <a class="reference external" href="/2012/08/25/decoupling_applications_with_domain_events.html">Domain Event Pattern</a> before and want
to focus on this pattern again by explaining its integration into the Doctrine
ORM on a very technical level.</p>
<p>The Domain Event Pattern allows to attach events to entities and dispatch them
to event listeners only when the transaction of the entity was successfully
executed. This has several benefits over traditional event dispatching
approaches:</p>
<ul class="simple">
<li>Puts focus on the behavior in the domain and what changes the domain
triggers.</li>
<li>Promotes decoupling in a very simple way</li>
<li>No reference to the event dispatcher and all the listeners required except in
the Doctrine UnitOfWork.</li>
<li>No need to use unexplicit Doctrine Lifecycle events that are triggered on all
update operations.</li>
</ul>
<p>This blog post will introduce a very simple implementation for Domain Events
with Doctrine2. You should be able to easily extend it to be more flexible,
reliable or optionally even asynchronuous. I skip some of the glue code in this blog post,
but you can try the full code by checking out <a class="reference external" href="https://gist.github.com/beberlei/53cd6580d87b1f5cd9ca">this Gist</a> and running
<span class="docutils literal"><span class="pre">composer</span> <span class="pre">install</span></span> and then <span class="docutils literal"><span class="pre">php</span> <span class="pre">domain_events.php</span></span>.</p>
<p>Lets look at the following entity, an <span class="docutils literal"><span class="pre">InventoryItem</span></span> tracking the number
we have this item in stock:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyProject\Domain</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">MyProject\DomainSuperTypes\AggregateRoot</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @Entity</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">InventoryItem</span> <span class="k">extends</span> <span class="nx">AggregateRoot</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Id @GeneratedValue @Column(type="integer")</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column(type="integer")</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">raise</span><span class="p">(</span><span class="s1">'InventoryItemCreated'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">checkIn</span><span class="p">(</span><span class="nv">$count</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">counter</span> <span class="o">+=</span> <span class="nv">$count</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">raise</span><span class="p">(</span><span class="s1">'ItemsCheckedIntoInventory'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'count'</span> <span class="o">=&gt;</span> <span class="nv">$count</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We want this entity to raise two domain events using the <span class="docutils literal"><span class="pre">raise($eventName,</span>
<span class="pre">array</span> <span class="pre">$properties)</span></span> method.  Our preferred use case for this code looks like this:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="nv">$item</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InventoryItem</span><span class="p">(</span><span class="s1">'Cookies'</span><span class="p">);</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">checkIn</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$item</span><span class="p">);</span>
<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span> <span class="c1">// fire events here</span>
</pre></div>
</div>
<p>One or many listeners should react to the events being fired, for example print their contents to the screen:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">EchoInventoryListener</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">onInventoryItemCreated</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nb">printf</span><span class="p">(</span><span class="s2">"New item created with name %s</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">onItemsCheckedIntoInventory</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nb">printf</span><span class="p">(</span><span class="s2">"There were %d new items checked into inventory</span><span class="se">\n</span><span class="s2">"</span><span class="p">,</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As the first building block, we need a <a class="reference external" href="http://martinfowler.com/eaaCatalog/layerSupertype.html">Layer Supertype</a> for our entities,
called <span class="docutils literal"><span class="pre">AggregateRoot</span></span> adding the event raising capabilities to all entities that need it:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyProject\DomainSuperTypes</span><span class="p">;</span>

<span class="k">abstract</span> <span class="k">class</span> <span class="nc">AggregateRoot</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$events</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">popEvents</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$events</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">events</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">events</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

        <span class="k">return</span> <span class="nv">$events</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">raise</span><span class="p">(</span><span class="nv">$eventName</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$properties</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">events</span><span class="p">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DomainEvent</span><span class="p">(</span><span class="nv">$eventName</span><span class="p">,</span> <span class="nv">$properties</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This class allows us to add events to an entity using <span class="docutils literal"><span class="pre">raise()</span></span> as we have
seen in the <span class="docutils literal"><span class="pre">InventoryItem</span></span> entity before.</p>
<p>Now we need Doctrine to process the events during a transaction (<span class="docutils literal"><span class="pre">flush()</span></span>).
We do this by keeping all entities with domain events, and then triggering
the domain events after the transaction has completed. This is a vital part
of the domain events pattern, because it guarantees every listener that the
state leading to the event is already in the database.</p>
<p>Technically we implement this with a Doctrine EventListener that listeners for
the <span class="docutils literal"><span class="pre">postFlush</span></span>, <span class="docutils literal"><span class="pre">postPersist</span></span>, <span class="docutils literal"><span class="pre">postUpdate</span></span> and <span class="docutils literal"><span class="pre">postRemove</span></span> events:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyProject\DomainEvents</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityManager</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">MyProject\DomainSuperTypes\AggregateRoot</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">DomainEventListener</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$entities</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">postPersist</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">keepAggregateRoots</span><span class="p">(</span><span class="nv">$event</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">postUpdate</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">keepAggregateRoots</span><span class="p">(</span><span class="nv">$event</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">postRemove</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">keepAggregateRoots</span><span class="p">(</span><span class="nv">$event</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">postFlush</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$entityManager</span> <span class="o">=</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getEntityManager</span><span class="p">();</span>
        <span class="nv">$evm</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">getEventManager</span><span class="p">();</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entities</span> <span class="k">as</span> <span class="nv">$entity</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$class</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">getClassMetadata</span><span class="p">(</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$entity</span><span class="p">));</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$entity</span><span class="o">-&gt;</span><span class="na">popEvents</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$event</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">setAggregate</span><span class="p">(</span><span class="nv">$class</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">,</span> <span class="nv">$class</span><span class="o">-&gt;</span><span class="na">getSingleIdReflectionProperty</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getValue</span><span class="p">(</span><span class="nv">$entity</span><span class="p">));</span>
                <span class="nv">$evm</span><span class="o">-&gt;</span><span class="na">dispatchEvent</span><span class="p">(</span><span class="s2">"on"</span> <span class="o">.</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">(),</span> <span class="nv">$event</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entities</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">keepAggregateRoots</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$entity</span> <span class="o">=</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getEntity</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$entity</span> <span class="nx">instanceof</span> <span class="nx">AggregateRoot</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entities</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$entity</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now we only need to put this code together with Doctrine to get it working:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="nv">$evm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventManager</span><span class="p">();</span>
<span class="nv">$evm</span><span class="o">-&gt;</span><span class="na">addEventListener</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">'postInsert'</span><span class="p">,</span> <span class="s1">'postUpdate'</span><span class="p">,</span> <span class="s1">'postRemove'</span><span class="p">,</span> <span class="s1">'postFlush'</span><span class="p">),</span>
    <span class="k">new</span> <span class="nx">DomainEventListener</span><span class="p">()</span>
<span class="p">);</span>
<span class="nv">$evm</span><span class="o">-&gt;</span><span class="na">addEventListener</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">'onInventoryItemCreated'</span><span class="p">,</span> <span class="s1">'onItemsCheckedIntoInventory'</span><span class="p">),</span>
    <span class="k">new</span> <span class="nx">EchoInventoryListener</span>
<span class="p">);</span>
<span class="nv">$conn</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="cm">/* data */</span><span class="p">);</span>
<span class="nv">$config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Configuration</span><span class="p">();</span>
<span class="nv">$entityManager</span> <span class="o">=</span> <span class="nx">EntityManager</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="nv">$conn</span><span class="p">,</span> <span class="nv">$config</span><span class="p">,</span> <span class="nv">$evm</span><span class="p">);</span>
</pre></div>
</div>
<p>Now the example from above, creating and checking in inventory items
will trigger the <span class="docutils literal"><span class="pre">EchoInventoryListener</span></span> and print the data to the screen.</p>
<p>This example is very simple but shows how you can incorporate Domain Events into
your Doctrine projects. The following improvements can be made if necessary:</p>
<ul class="simple">
<li>Use a base EventSubscriber for the Domain Listeners, that automatically
registers all the domain event listener methods. This way you don’t have
to manually list them when calling <span class="docutils literal"><span class="pre">$evm-&gt;addListener()</span></span>.</li>
<li>Implement one class for every domain event, allowing to typehint the events
in listeners, with much more helpful information about the contained data.</li>
<li>If you prefer asynchroneous processing, serialize the events into a
<cite>domain_events</cite> table instead of triggering the events directly.
Add a daemon to your project that tails the table and triggers the events
in the background.</li>
</ul>
<p>I hope this blog post helps you when considering to use Domain Events Pattern with
Doctrine. Again, <a class="reference external" href="https://gist.github.com/beberlei/53cd6580d87b1f5cd9ca">see the code on this Gist</a> for a working example.</p>


            
            <div class="tags">
                More about: 
                <a href="tags/doctrine.html">Doctrine</a>
                 / 
                <a href="tags/designpatterns.html">DesignPatterns</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on July 24, 2013
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2013/06/27/extending_symfony2__controller_utilities.html">Extending Symfony2: Controller Utilities</a></h1>
<p>Controllers as a service are a heated topic in the Symfony world. Developers
mainly choose to extend the base class, because its much simpler to use and
less to write. But less to write is not necessarily true.</p>
<div class="section" id="the-problem-injecting-tons-of-services">
<h2>The problem: Injecting tons of services</h2>
<p>The Symfony controller base class uses quite a lot of services, if
you need them in your controller as a service, you have to inject them:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">UserController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">_construct</span><span class="p">(</span>
        <span class="nx">RouterInterface</span> <span class="nv">$router</span><span class="p">,</span>
        <span class="nx">EngineInterface</span> <span class="nv">$engine</span><span class="p">,</span>
        <span class="nx">HttpKernel</span> <span class="nv">$kernel</span><span class="p">,</span>
        <span class="nx">FormFactoryInterface</span> <span class="nv">$formFactory</span><span class="p">,</span>
        <span class="nx">SecurityContextInterface</span> <span class="nv">$security</span>
    <span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">router</span> <span class="o">=</span> <span class="nv">$router</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">engine</span> <span class="o">=</span> <span class="nv">$engine</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">kernel</span> <span class="o">=</span> <span class="nv">$kernel</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">formFactory</span> <span class="o">=</span> <span class="nv">$formFactory</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">security</span> <span class="o">=</span> <span class="nv">$security</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There are some problems here:</p>
<ul class="simple">
<li>The services are not loaded lazily, we probably end up with a resource overuse here.</li>
<li>The constructor is MUCH too big, this doesn’t even include your own
application, database or mailer services.</li>
</ul>
</div>
<div class="section" id="the-quick-and-dirty-solution">
<h2>The quick and dirty solution</h2>
<p>You could as a first solution, inject the container into your controller.
But this is actually the same as just using the base controller from Symfony
or just use the <span class="docutils literal"><span class="pre">ContainerAware</span></span> interface in a controller of your own.</p>
</div>
<div class="section" id="the-solution-introduce-a-utilities-service">
<h2>The solution: Introduce a Utilities Service</h2>
<p>To avoid the mentioned problems with controller as a service, introduce a
controller utilities service and register it as <span class="docutils literal"><span class="pre">controller_utils</span></span> service:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">ControllerUtils</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$container</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">createForm</span><span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ..</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">render</span><span class="p">(</span><span class="nv">$template</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ..</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can implement this by just copying the over from
<span class="docutils literal"><span class="pre">Symfony\Bundle\FrameworkBundle\Controller\Controller</span></span> all the methods you
need.</p>
<p>Then you can simplify the controller as a service:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">UserController</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$utils</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">_construct</span><span class="p">(</span><span class="nx">ControllerUtils</span> <span class="nv">$utils</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">utils</span> <span class="o">=</span> <span class="nv">$utils</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You don’t have to stop here. You can introduce lots of helper objects
and inject them into your controller, depending on your use-cases.
Generic handling of file uploads comes to mind for example.</p>
<p>From medium to large applications this can lead to much smaller
controllers, because they can much more easily reuse code between
each other than in the case of inheritance.</p>
</div>


            
            <div class="tags">
                More about: 
                <a href="tags/symfony.html">Symfony</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on June 27, 2013
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2013/06/24/bounded_contexts.html">Bounded Contexts</a></h1>
<p>I regularly fall into the same trap when building applications: Trying to find
the one model that unifies all the use-cases and allows to solve every problem.
From discussions with other developers I know not to be the only one making this
mistake.</p>
<p>It is propably a human trait trying to find the one line that connects
every dot. However in software design there is a case to be made for the
separation of contexts to tackle complexity. Eric Evans described this in detail with the
<a class="reference external" href="http://dddcommunity.org/uncategorized/bounded-context/">“Bounded Context”</a> pattern in his
“Domain-Driven Design” book. According to an interview with Evans I read
somewhere, he considers it one of the most important patterns in the whole book.</p>
<p>The essence of this strategic pattern is to embrance the separation of
different parts of an application and develop different models as different
domain contexts. Consistency and constraints are enforced within one context,
but don’t necessarily hold in another context.</p>
<p>The goal is simplication and freeing us from the burden of finding that one
model that fits all use cases. It is much less awkward to have some parts of
the model reimplemented for different purposes than creating God objects that
try to unify everything, and failing at this task.</p>
<p>Evans goes even further and introduces a significant amount of patterns
that describe the relationship between different bounded contexts.</p>
<div class="section" id="an-experiment">
<h2>An Experiment</h2>
<p>At the <a class="reference external" href="http://www.socrates-conference.de/">SoCraTes conference</a> in August
last year, I participated in a DDD architecture game by <a class="reference external" href="https://twitter.com/cyriux">Cyrille Martraire</a> that focused on distilling bounded contexts. We
were given a very simple domain concept “Customer” and assigned different roles
in the business.</p>
<p>Everyone described their perfect customer very differently, imagining the
Customer object that fits all these requirements was quite an eye opener. Even
if there is no such single software that operates a business, going to the
extreme and defining 10 different angles for a single concept made me clear,
that sometimes different overlapping implementations are not such a bad thing.</p>
</div>
<div class="section" id="problems-and-solutions">
<h2>Problems and Solutions</h2>
<p>One problem when applying bounded contexts is data synchronization.
Synchronization between contexts can be reached in many different ways,
three of which are:</p>
<ol class="arabic simple">
<li>The <a class="reference external" href="http://martinfowler.com/eaaDev/DomainEvent.html">Domain Event</a> pattern that integrates
nicelly into Domain-Driven Design and simplifies the synchronization with
other parts of an application.</li>
<li>Correlation Ids of the same entity into the different contexts and a clean
seperation of the data (no shared data necessary).</li>
<li>Another way are immutable read models (value objects) of the data managed in
another context (entity).</li>
</ol>
<p>In any way relying on <a class="reference external" href="http://en.wikipedia.org/wiki/Eventual_consistency">Eventual
Consistency</a> helps
solving the synchronization problem.</p>
<p>Depending on how your bounded contexts seperate from each other, duplication of
classes is necessary as well. This is something that has to be accounted for
and you should make sure that only one context is responsible for changing the
same data. Different contexts can have different behaviors on the same data.
This is actually a point where Domain-Driven Design and <a class="reference external" href="http://www.whitewashing.de/2012/08/16/oop_business_applications__data__context__interaction.html">Data, Context and
Interaction (DCI)</a>
intersect.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Applying bounded contexts to an application or a cluster of applications helps
developers and domain experts to focus on problems in their specific context.
Sometimes each context even has its own domain-expert. The benefit for
developers is a simplified abstraction of different parts of the modelled
problem.</p>
</div>


            
            <div class="tags">
                More about: 
                <a href="tags/applicationdesign.html">ApplicationDesign</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on June 24, 2013
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2013/05/23/symfony2_on_windows_azure_websites.html">Symfony2 on Windows Azure Websites</a></h1>
<p>With the Windows Azure Websites platform-as-a-service (PaaS), which was
released as a preview to a general audiance in June last year, PHP applications
can be deployed to Azure with as much as a Git push to a remote repository. At
the same time Microsoft released a new and much improved <a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-php">PHP SDK</a>, which
integrates with all the Azure webservices.</p>
<p>I blogged about deployment with Composer on Azure Websites last November and
since then I have been working with Microsoft to improve Symfony2 support on
Windows Azure by developing and releasing the <a class="reference external" href="https://github.com/beberlei/AzureDistributionBundle">AzureDistributionBundle</a>. This is a new version
of the bundle and contains the following improvements:</p>
<ul class="simple">
<li>Full support for the PHP SDK through the DependencyInjection container</li>
<li>Installation of project dependendencies using Composer during deployment.
I will blog about the Composer support in much more detail in the next
days, because this information is not only valuable for Symfony2 projects.</li>
<li>a <a class="reference external" href="https://github.com/beberlei/symfony-azure-edition">full demo application</a> (derived from
symfony-standard) to show PHP, Symfony &amp; Azure integration</li>
<li>documentation of the Windows Azure Websites deployment process and
possiblities for PHP configuration</li>
<li>a Stream Wrapper for Azure Blob Storage, currently being reviewed for
inclusion into the Azure PHP SDK itself.</li>
</ul>
<p>You can install both the Bundle or the Demo application via Composer.
For the Demo application call:</p>
<div class="highlight-default"><div class="highlight"><pre><span/>$ php composer.phar create-project beberlei/symfony-azure-edition
</pre></div>
</div>
<p>The README includes more information about how to deploy the demo
to your Azure websites account.</p>
<p>The bundle can be installed using the following <span class="docutils literal"><span class="pre">composer.json</span></span>:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="p">{</span>
    <span class="s2">"require"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"beberlei/azure-distribution-bundle"</span><span class="p">:</span> <span class="s2">"*"</span>
    <span class="p">},</span>
    <span class="s2">"repositories"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"pear"</span><span class="p">,</span>
            <span class="s2">"url"</span><span class="p">:</span> <span class="s2">"http://pear.php.net"</span>
        <span class="p">}</span>
    <span class="p">],</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Registering PEAR is necessary, because the Azure PHP SDK depends on some PEAR
components.</p>


            
            <div class="tags">
                More about: 
                <a href="tags/azure.html">Azure</a>
                 / 
                <a href="tags/symfony.html">Symfony</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on May 23, 2013
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2013/04/12/traits_are_static_access.html">Traits are Static Access</a></h1>
<p>In a Twitter discussion yesterday I formulated my negative opinion
about traits and Matthew asked me to clarify it:</p>
<img alt="http://www.whitewashing.de/_static/traits_are_static_access.png" src="http://www.whitewashing.de/_static/traits_are_static_access.png"/>
<p>I used to look forward to traits as a feature in PHP 5.4, but after discussions
with <a class="reference external" href="http://twitter.com/koredn">Kore</a> I came to the conclusion that traits
are nothing else than static access in disguise. They actually lead to the
exact same code smells. Familiar with the outcome of too much static use,
we should reject traits as just another way of statically coupling your code
to other classes.</p>
<p>Let’s step back and take a look at the code smells that Static code produces:</p>
<ul class="simple">
<li>Tight coupling, no way to exchange at runtime</li>
<li>Not mockable</li>
<li>Static code cannot be overwritten through inheritance</li>
<li>Global state (increases likelihood of unwanted side effects)</li>
</ul>
<p>This blog post shows that Traits actually have the first three problems
themselves and exhibit the same code smells. But they even have some additional
problems on their own:</p>
<ul class="simple">
<li>Not testable in isolation</li>
<li>Theoretically stateless, but not enforced in PHP</li>
<li>Very high impact on the code base (Code-Rank)</li>
</ul>
<p>Take the following code, which tries to implement reusable
controller code through traits:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MyController</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">Redirector</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$container</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">someAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="s2">"route_xyz"</span><span class="p">,</span> <span class="k">array</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">trait</span> <span class="nx">Redirector</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">redirect</span><span class="p">(</span><span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">RedirectResponse</span><span class="p">(</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span><span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">generateUrl</span><span class="p">(</span><span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'router'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span>
            <span class="nv">$routeName</span><span class="p">,</span>
            <span class="nv">$parameters</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Lets spot the problems:</p>
<ol class="arabic">
<li><p class="first"><span class="docutils literal"><span class="pre">Redirector</span></span> is tightly coupled to <span class="docutils literal"><span class="pre">MyController</span></span>. There is no way to
change this during runtime, by using a different type of redirector, it has
to be exactly the trait used at compile time. This is exactly what static
access enforces as well.</p>
</li>
<li><p class="first">The trait accesses <span class="docutils literal"><span class="pre">$this-&gt;container</span></span> without defining it and couples itself against
the implementing classes. We can actually refactor this to include an
abstract method <span class="docutils literal"><span class="pre">getContainer()</span></span> in the trait. But if we have multiple
traits now, all having a <span class="docutils literal"><span class="pre">getContainer()</span></span> method then we run into method
class problems that cannot be solved. We could pass the container as an
argument to the method, but that actually defeats the purpose of the
abstraction here.</p>
<p>Traits using state of their “parents” usually create bidirectional
coupling between classes, something which should be avoided for good
software design.</p>
</li>
<li><p class="first">No way to overwrite subset of functionality. If I want to use only one
method of a trait and a second one slighty different, then I cannot
overwrite this function of <span class="docutils literal"><span class="pre">Redirector</span></span> for example in <span class="docutils literal"><span class="pre">MyController</span></span>.</p>
</li>
<li><p class="first">I cannot mock the traits functionality, therefore I cannot test
<span class="docutils literal"><span class="pre">MyController</span></span> as a unit only in combination with a trait.</p>
</li>
<li><p class="first">I cannot test the trait as a unit, I always have to create a class
that uses the trait to be able to write a test for it.
This prevents me from testing traits in isolation.</p>
</li>
<li><p class="first">Once you start using <span class="docutils literal"><span class="pre">Redirector</span></span> in many controllers, its impact
on your code base (see <a class="reference external" href="http://pdepend.org/documentation/software-metrics/index.html">Code Rank</a>) increases
a lot. Traits are concrete implementations and therefore violate the
Dependency Inversion SOLID principle: Changes in the trait require adoptions
in all the implementing classes.</p>
<p>With aggregation you could depend on an abstraction <span class="docutils literal"><span class="pre">Redirector</span></span> or
turn it into an abstraction in the moment that you need different
functionality.</p>
</li>
</ol>
<p>The discovery of this properties of traits me to the conclusion that traits are
just static access in disguise.</p>
<p>To see this argument a bit more drastically, you can “rewrite” a PHP 5.4 trait
into “pseudo” static code:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MyController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$container</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">someAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Redirector</span><span class="o">::</span><span class="na">redirect</span><span class="p">(</span><span class="s2">"route_xyz"</span><span class="p">,</span> <span class="k">array</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Redirector</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">redirect</span><span class="p">(</span><span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">RedirectResponse</span><span class="p">(</span>
            <span class="nx">self</span><span class="o">::</span><span class="na">generateUrl</span><span class="p">(</span><span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">generateUrl</span><span class="p">(</span><span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'router'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span>
            <span class="nv">$routeName</span><span class="p">,</span>
            <span class="nv">$parameters</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Calling dynamic methods statically actually works right now (and access to
<span class="docutils literal"><span class="pre">$this</span></span> of the parent class will luckily be removed in PHP 5.5). Let’s
reformulate it into something that is actually using static methods and
will work on 5.5, requires changes to the visibility of properties though:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MyController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$container</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">someAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Redirector</span><span class="o">::</span><span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s2">"route_xyz"</span><span class="p">,</span> <span class="k">array</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Redirector</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">redirect</span><span class="p">(</span><span class="nv">$thiz</span><span class="p">,</span> <span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">RedirectResponse</span><span class="p">(</span>
            <span class="nx">self</span><span class="o">::</span><span class="na">generateUrl</span><span class="p">(</span><span class="nv">$thiz</span><span class="p">,</span> <span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">generateUrl</span><span class="p">(</span><span class="nv">$thiz</span><span class="p">,</span> <span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$thiz</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'router'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span>
            <span class="nv">$routeName</span><span class="p">,</span>
            <span class="nv">$parameters</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Can you see the familiarity? If Traits can be rewritten as calls to static methods,
how can they be any better than static methods? They exhibit the exact same
problems and produce the same code smells.</p>
<p>Conclusion: Traits should be avoided at all costs, just like static methods.</p>
<p>Rule of Thumb: If you want to use a trait, try to think how to solve the
problem with aggregation.</p>
<p>If you want to read more about problems with traits,
<a class="reference external" href="http://blog.ircmaxell.com/2011/07/are-traits-new-eval.html">Anthony</a> wrote
about them quite a while ago.</p>


            
            <div class="tags">
                More about: 
                <a href="tags/codequality.html">CodeQuality</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on April 12, 2013
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="archive_link">
        <a href="archive.html">Archive</a>
    </div></article></div> <!-- #main -->
				</div>
			</div></div> <!-- #main-container -->

        <div class="footer-container" role="contentinfo">
			<div class="container">
				<div class="col-md-8 col-md-offset-2">
					<div class="footer">
						<small>© Copyright 2008-2017, Benjamin Eberlei.</small>

						<script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script>
					</div>
				</div>
			</div>
        </div> <!-- footer-container -->
      </div> <!--! end of #container --><script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-32146757-1', 'auto');
          ga('send', 'pageview');
        </script>

    </body>
</html>