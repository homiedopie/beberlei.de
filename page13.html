<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="Blog of Benjamin Eberlei, covering a wide range of programming, bootstrapping and entrepreneurial topics">
        <meta name="viewport" content="width=device-width">
        <meta name="google-site-verification" content="mycr8JCbLYq9QcOyh4Ub1esAdN-awH9ut6nyTKUTgE4">
        <title>Page 13 &mdash; beberlei.de</title>
            <link rel="stylesheet" href="/_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="/_static/css/bootstrap.min.css" type="text/css" />
            <link rel="stylesheet" href="/_static/blog.css" type="text/css" />
            <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" />
        <link rel="shortcut icon" href="_static/tinkerer.ico" /><!-- Load modernizr and JQuery -->
        <script src="_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="_static/plugins.js"></script>
        <script src="_static/main.js"></script>
        <link rel="next" title="Older" href="page14.html" /><link rel="prev" title="Newer" href="page12.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        SOURCELINK_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="_static/underscore.js"></script><script type="text/javascript" src="_static/doctools.js"></script><script type="text/javascript" src="_static/disqus.js"></script></head>
    <body role="document">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><nav class="navbar navbar-dark">
		  <div class="container">
			  <div class="navbar-header">
				  <a class="navbar-brand" href="https://beberlei.de">Benjamin Eberlei</a>
			  </div>

			  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				  <ul class="nav navbar-nav navbar-right">
						<li><a href="index.html">Home</a></li>
						<li><a href="pages/about.html">About</a></li>
						<li><a href="/archive.html">Archive</a></li>
					  <li><a href="/rss.xml">RSS</a></li>
				  </ul>
			  </div>
		  </div>
		</nav><div class="main-container" role="main"><div class="container">
				<div class="row">
					<div class="col-md-8 col-md-offset-2 col-sm-12"><article role="article">
							<div class="section">
            <h1><a href="2009/05/01/explicit-code-requires-no-comments-only-bad-code-does.html">Explicit Code requires no comments - Only bad code does</a></h1>
<p>Following the recent discussion on commenting source code by <a class="reference external" href="http://www.brandonsavage.net/on-code-commenting-and-technical-debt/">Brandon
Savage</a>
and <a class="reference external" href="http://mtabini.blogspot.com/2009/04/myth-of-myth-of-self-commenting-code.html">Marco
Tabini</a>,
I wanted to add upon Marcos code example to show that it not even needs
any inline comments and can be greatly enhanced in readability with
taking 2-5 minutes of time and refactoring the code. The original code
sample was:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre>function __construct(array $pathInfo) {
    $section = $pathInfo[0];
    $file = $pathInfo[1];

    // Assume that the location of this file is inside the main trunk, and that pathInfo has already been filtered.

    $path = dirname(__FILE__) . '/../../' . $section . '/xml/static/' . $file . '.xml';

    if (!file_exists($path)) {
        Controller::singleton()-&gt;doError(404);
    }

    parent::__construct('main/xsl/template.xsl', $path);
}
</pre></div>
</div>
</div></blockquote>
<p>This sample is somehow related to the response and view rendering of an
application and its pretty understandable. For me there are some squirks
though that would make me have to scroll to other classes to see how
they interact. For example the path information falls from heaven. Why
is it an array of 2 values and are these sections set the same all the
time? And what exactly happens when the front controller does the 404
error? Is there a die() or exit in the <strong>doError()</strong></p>
<p>The Agile movement postulates the phase of refactoring for a finished
piece of code. Rebuilding the hacked solutions that did it to make them
more understandable. I applied this to Marcos code snippet. The
refactoring produces about double the code, but its done entirely by
using NetBeans nice Rename variable and copy paste on extracting
methods, which takes not more than 5 minutes.</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre>class StaticXmlXsltRendererImpl extends AbstractXsltView
{
    function render(array $filteredPathInfo) {
        $templateValuesXmlPath = $this-&gt;getTemplateValuesXmlFile($filteredPathInfo);

        if(!$this-&gt;templateExists($templateValuesXmlPath)) {
            Controller::singleton()-&gt;doError(404);
        } else {
            parent::render('main/xsl/template.xsl', $templateValuesXmlPath);
        }
    }

    private function getTemplateValuesXmlFile($filteredPathInfo) {
        $section = $this-&gt;getSection($filteredPathInfo);
        $file = $this-&gt;getFile($filteredPathInfo);

        // Assume that the location of this file is inside the main trunk
        return dirname(__FILE__) . '/../../' . $section . '/xml/static/' . $file . '.xml';
    }


    private function getSection($pathInfo) {
        return $pathInfo[0];
    }

    private function getFile($pathInfo) {
        return $pathInfo[1];
    }

    private function templateExists($path) {
        return file_exists($path);
    }
}
</pre></div>
</div>
</div></blockquote>
<p>In this code snippet the class name, variable names and methods clearly
communicate what is done, which wasn’t the case in the previous example.
The only change for the clients is the change of using the constructor
to using the <strong>render()</strong> method, which communicates the intend more.
Also the render method now clearly communicates that either the error or
the parent rendering is executed and leaves no doubt about it.</p>
<p>The <strong>getTemplateValuesXmlFile()</strong> method still uses the comment to show
the assumption about relative paths, but this is only the case because
application configuration is made implicit into the code. This has to be
extracted to be an explicit configuration constant and the comment can
go.</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre>private function getTemplateValuesXmlFile($filteredPathInfo) {
    $section = $this-&gt;getSection($filteredPathInfo);
    $file = $this-&gt;getFile($filteredPathInfo);

    return APPLICATION_ROOT . '/' . $section . '/xml/static/' . $file . '.xml';
}
</pre></div>
</div>
<p>In my opinion commenting code is necessary only for non-refactored
code that has been hacked into existence and is hard to understand.
Either the programmer has to get it done and has no chance to
clearly communicate the intend. Or what is even worse the to be
changed legacy code is hard to understand but you can’t take the
chances to refactor it because its also already in production and
has no tests. Now from the second point it is obvious that upon ugly
code you put only more and more ugly code to fix the problems. This
is what leads to the legacy maintenance problems that pretty much
every programmer faces. And then commenting comes into play: You
have to add a new feature X and it has to be done fast. You don’t
really understand the code or how it works together but you know you
can put the new code for the feature into existence but its really
unintuitive. So you begin to comment it excessively, because its the
only way to clearly show its intend.</p>
<p>There are two mindestting factors that help to write code that is
understandable without having to excessively comment it:</p>
<ul class="simple">
<li>From the beginning, do not write code for the computer but for
developers. Changing this attitude really helps to write
understandable code like the one above.</li>
<li>Only leave code better than it was before, never worse.</li>
</ul>
<p>There are five technical practices that - when followed - allow to
write clearly communicating code from the beginning:</p>
<ol class="arabic simple">
<li>Giving classes, variables and methods good names. This is a
no-brainer but few people seem to follow it anyways.</li>
<li>Following the object-oriented <strong>Single Responsibility Principle</strong>
by never giving a class more than one responsibility. Macros
example seems to follow this one.</li>
<li>Methods should never switch in the level of detail. Micro-work at
the datastructure level should never be mixed with macro level
delegation to executing large chunks of code. Macros code
violates this by mixing the path building micro-level work with
the macro-level work of rendering the XSLT template. The path
building code can be hidden behind a method to communicate intend
more clearly.</li>
<li>Exchange if conditions with private methods that explain the
condition being checked for. In Marcos example this is not really
necessary, because file_exists already is quite a good
description to the condition. But in cases of logical
combinations of conditions the method extracting is a superior
way to explain the conditions intend without having to write a
comment.</li>
<li><strong>Seperate Query and Command</strong>: A method never should do a query
which returns the state of an object and a command which executes
a set of rules on the state.</li>
</ol>
<p>These practices sum up to one guideline: Make code explicit. This
obviously requires less commenting since a comment of explicit code
would be duplication and duplication is bad. What if you have a
project that does not follow this guidelines? Then of course
comments should be used to explain code, but in the long run this
should be refactored to self-explaining code. Additionally every new
feature should be programmed explicitly to follow the “leave code
better than before” principle.</p>
<p>In my opinion two refactoring tools are missing that would greatly
help PHP programmers write nice to read code: Extract method and
Replace magic value with constant. Can someone integrate them into
NetBeans please?</p>
<p><strong>Update:</strong> Fixed a creepy copy-paste code bug, thanks to azeroth
for pointing out. Moved methods around a bit to be more reading
friendly.</p>
</div></blockquote>


            <div class="tags">
                More about: 
                
            </div>

            <div class="metadata">
        <p>
            <small>
                Posted on May 01, 2009
                
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2009/06/16/using-a-dependency-injection-container-with-zend-application.html">Using a Dependency Injection Container with Zend_Application</a></h1>
<p>Much has been written on Dependency Injection lately, mostly by Padraic
Brady
(<a class="reference external" href="http://blog.astrumfutura.com/archives/394-The-Case-For-Dependency-Injection-Part-1.html">1</a>,
<a class="reference external" href="http://blog.astrumfutura.com/archives/395-The-Case-For-Dependency-Injection-Part-2.html">2</a>)
and Fabien Potencier
(<a class="reference external" href="http://fabien.potencier.org/article/11/what-is-dependency-injection">1</a>,
<a class="reference external" href="http://fabien.potencier.org/article/12/do-you-need-a-dependency-injection-container">2</a>,
<a class="reference external" href="http://fabien.potencier.org/article/13/introduction-to-the-symfony-service-container">3</a>,
<a class="reference external" href="http://fabien.potencier.org/article/14/symfony-service-container-using-a-builder-to-create-services">4</a>,
<a class="reference external" href="http://github.com/fabpot/Pimple/tree/master">5</a>). My subjective
feeling tells me there are now more PHP DI containers out there than CMS
or ORMs implemented in PHP, including two written by myself (an
<a class="reference external" href="http://www.beberlei.de/sphicy/">overengineered</a> and <a class="reference external" href="http://github.com/beberlei/yadif/tree/master">a useful
one</a>). Its an awesome
pattern if used on a larger scale and can (re-) wire a complex business
application according to a clients needs without having to change much
of the domain code. It aims at a complete separation of object
instantiation and dependency tracking from the business logic.</p>
<p>Beginning with version 1.8 Zend Framework is able to integrate any of
these DI containers into its <strong>Zend_Application</strong> component easily. The
Application component initializes a set of common resources and pushes
them into the MVC stack as additional Front Controller parameters.
Technically a <strong>Zend_Registry</strong> instance holds all these resources with
their respective resource names as keys. The resources are accessible
inside the Front Controller and the Action Controller classes. Assume
the resource ‘Db’ is initialized in your application, you can access it
with:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre>$front = Zend_Controller_Front::getInstance();
$container = $front-&gt;getParam('bootstrap')-&gt;getContainer();
$db = $container-&gt;db;

// or:
class FooController extends Zend_Controller_Action {
    public function barAction()
    {
        $container = $this-&gt;getInvokeArg('bootstrap')-&gt;getContainer();
        $db = $container-&gt;db;
    }
}
</pre></div>
</div>
</div></blockquote>
<p>This is pretty much dependency injection already, but the default
registry approach suffers from two serious problem: New instances can
only be added to the Container by implementing new Zend_Application
resources and these instances cannot be lazy loaded. All resources used
by Zend_Application are always loaded on every request. But the
application container implementation was developed with Dependency
Injection in mind and is not tied to the use of Zend_Registry. Only
three magic methods are required by any container that wants to be
Zend_Application compliant: __get(), __set() and __isset(). Each
instantiated resource is pushed via __set() into the container. If
required by another resource, __isset() is used to check whether a
resource with the given name exists inside the container and __get()
is used to retrieve the instances from the container.</p>
<p>Some month ago I extended
<a class="reference external" href="http://github.com/beberlei/yadif/tree/master">Yadif</a>, a lightweight
PicoContainer-like DI container for PHP written by Thomas McKelvey, with
several features that make it a very powerful DI container in my
opinion. It has a detailed documentation and examples on the GitHub Page
if you want to check it out. I extended Yadif to be Zend_Application
compliant in a way that the application-wide Zend_Application resources
can be used as dependencies for objects that are lazy-loaded from the
container. Skipping the tech-talk, here is an example. First we have to
replace the default Container with Yadif:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre>$objects = new Zend_Config_Xml(APPLICATION_PATH."/config/objects.xml");
$container = new Yadif_Container($objects);

$application = new Zend_Application(
    APPLICATION_ENV,
    APPLICATION_PATH . '/config/application.xml'
);
// Set Yadif as Container
$application-&gt;getBootstrap()-&gt;setContainer($container);
$application-&gt;bootstrap()
            -&gt;run();
</pre></div>
</div>
</div></blockquote>
<p>Assume you run Zend_Application with a “Db” and a “Cache” resource.
These resources are loaded on every request. The objects configured in
Yadif however are not instantiated until they are requested for the
first time from the container. We can merge these two worlds and make
use of the Application resources inside the Yadif Configuration
“objects.xml”, which looks like:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre>&lt;?xml version="1.0" ?&gt;
&lt;objects&gt;
    &lt;myModel&gt;
        &lt;class&gt;MyModel&lt;/class&gt;
        &lt;arguments arg1="db" arg2="cache" /&gt;
    &lt;/myModel&gt;
&lt;/objects&gt;
</pre></div>
</div>
<p>Instantiating a <strong>myModel</strong> class inside the Action Controller uses
the the Database and Cache resources as constructor arguments:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre>class FooController extends Zend_Controller_Action {
    public function barAction()
    {
        $container = $this-&gt;getInvokeArg('bootstrap')-&gt;getContainer();
        $myModel = $container-&gt;myModel;
    }
}
</pre></div>
</div>
</div></blockquote>
<p>Given the possibilites by the Yadif_Container you are now empowered
to use Dependency Injection for all your application objects and
make use of Zend_Applications resource system. Furthermore any
other dependency injection container, simple or complex, can also be
integrated easily.</p>
</div></blockquote>


            <div class="tags">
                More about: 
                
            </div>

            <div class="metadata">
        <p>
            <small>
                Posted on June 16, 2009
                
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2009/11/14/netbeans-php-codesniffer-plugin-now-with-options-dialog.html">Netbeans PHP CodeSniffer Plugin: Now with Options Dialog</a></h1>
<p>Just two days before the <a class="reference external" href="http://www.phpconference.de">International PHP Conference
09</a> will start I got an email from
<a class="reference external" href="http://github.com/alexandrehaguiar">alexandrehaguiar</a> that he forked
my Netbeans PHP CodeSniffer plugin and added the long awaited Options
screen. This is just awesome! This way I don’t have to ask the Netbeans
guys at IPC all the questions about how to implement it. I merged the
changes back into my branch and released a new version which also fixed
another small bug. For me it works with both Netbeans 6.7.1 and 6.8
Beta. I want to thank alexandre very much for this awesome contribution.</p>
<p>What you can do now is chose the Coding Standard you want to use in an
Options Dialog under the “Miscellaneous” button. You can choose from a
list of pre-defined standards, or even enter your own if you use one.
Additionally you can disable that warning are shown, so that with any
given coding standard you only see the errors.</p>
<p><a class="reference external" href="http://cloud.github.com/downloads/beberlei/netbeans-php-enhancements/phpcsoptions.png">|image0|</a></p>
<p>You can download the new version from the <a class="reference external" href="http://github.com/beberlei/netbeans-php-enhancements/downloads/">Github Project Downloads
page</a>.</p>


            <div class="tags">
                More about: 
                
            </div>

            <div class="metadata">
        <p>
            <small>
                Posted on November 14, 2009
                 by beberlei <kontakt@beberlei.de>
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2009/08/31/enums-in-php.html">Enums in PHP</a></h1>
<p><a class="reference external" href="http://blog.tobias-olry.de">A colleague of mine</a> complained about the
missing support for Enums in PHP and how one often wants to have a
variable that is constant and has one of several specific values. We
came up with an elegant solution that we want to share, maybe its even
helpful to you.
If you want to implement Enum behaviour with a simple string or int
value you end up with having to validate the values at several different
locations in the code rather than being able to strictly enforce the
Enum structure by using typehints.</p>
<p>We discussed several approaches to this problem that all seemed a bit
ugly in one or another way. For example the <strong>SplEnum</strong> class is a step
in the right direction, however you can only use a type hint for
“SplEnum” or add another inheritance layer. Also you have to implement
different classes for each enum type, which requires you to implement a
factory method for your enum to help with creation of the different
types.</p>
<p>We came up with a very simple Enum concept. It uses reflection in the
constructor to check if the given value is a valid Enum value by
checking it against all the defined constants of the implementing class
and throws an Exception if it is not. The __toString() magic method is
implemented to allow for simple checks of the enums value. Strict
type-checks are not possible with this construct, however in our opinion
it is a very elegant solution to enforce a limited set of specific
values throughout your code-base.</p>
<p>Here is the code plus a small example:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre>abstract class MyEnum
{
    final public function __construct($value)
    {
        $c = new ReflectionClass($this);
        if(!in_array($value, $c-&gt;getConstants())) {
            throw IllegalArgumentException();
        }
        $this-&gt;value = $value;
    }

    final public function __toString()
    {
        return $this-&gt;value;
    }
}

class Foo extends MyEnum
{
    const FOO = "foo";
    const BAR = "bar";
}

$a = new Foo(Foo::FOO);
$b = new Foo(Foo::BAR);
$c = new Foo(Foo::BAR);

if($a == Foo::FOO) {
    echo "My value is Foo::FOO\n";
} else {
    echo "I dont match!\n";
}

if($a == $b) {
    echo "a value equals b value!\n";
}
if($b == $c) {
    echo "b value equals c value!\n";
}
</pre></div>
</div>
</div></blockquote>
<p>Now you could nice things such as:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre>function doStuff(Foo $foo) {
    switch($foo) {
        case Foo::FOO:
            echo "do more here!\n";
            break;
        case Foo::BAR;
            echo "evil stop!\n";
            break;
    }
}

doStuff($a);
</pre></div>
</div>
</div></blockquote>
<p>What are your thoughts?</p>


            <div class="tags">
                More about: 
                
            </div>

            <div class="metadata">
        <p>
            <small>
                Posted on August 31, 2009
                
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2009/01/23/zend-form-and-the-model-yet-another-perspective-using-a-mediator.html">Zend_Form and the Model: Yet another perspective using a Mediator</a></h1>
<p><a class="reference external" href="http://weierophinney.net/matthew/">Matthew Weier O’Phinney</a> of the
Zend Framework Devteam <a class="reference external" href="http://weierophinney.net/matthew/archives/200-Using-Zend_Form-in-Your-Models.html">wrote a controversial post on integrating
Zend_Form and the Model last
month</a>.
He separated concerns of view and model that communicate via a Form, by
calling just thee validation functions on the Form inside the mode. On
request you could retrieve the model to the controller and view layers.
I already wrote into his comments that I didn’t like the solution
because it relies on implicit rules for the developers to use the Form
component correctly in all layers. Additionally the building of the form
using this approach would be performed inside the model, although
strictly speaking this is responsibility of the View Layer. Another
negative point is duplication of input filtering code that has to be
performed to use certain variables inside the controller or when
different forms talk with the same model.</p>
<p><a class="reference external" href="http://codeutopia.net">Jani</a> took it up and <a class="reference external" href="http://codeutopia.net/blog/2009/01/07/another-idea-for-using-models-with-forms/">proposed writing
validators for forms and attaching them to the
Form</a>
as sort of a mediator. I am not a fan of this approach either, because
the validator would have to include domain logic but is not really a
part of the domain logic anymore but just a validator. Developers might
forget using the validator inside the model for all their actions or
there would be duplication of code in some places. In a perfect world,
only functions of the models public interface should be called for
validation.</p>
<p>My personal favorite for Form and Model integration is a <strong>mediator</strong>
object between the two layers. Your model will have to include an
additional interface with one function <strong>acceptFormRequest($values);</strong>
which accepts an array of validated Zend Form field values. It then
tries to apply the validated data into a record. Additional required
validations of the model can take place in this function, which
separates the concerns of Form validation and Model data validation.
Still the mediator merges those differences together: You can throw an
Exception and it will be attached as a custom error message to the Form.
The following very short code will show the required interface and the
mediator code. This code is very simple and might produce maintenance
overhead fast, but I propose some refactoring enhancements later in the
discussion.</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre>interface WW_Model_AcceptFormRequest
{
    /**
     * Acceept a form request
     * @param array $values
     * @return WW_Record_Interface
     */
    public function acceptFormRequest($values);
}
class WW_Model_FormMediator
{
    /**
     * Try to push the form request to the model
     *
     * @param Zend_Form $form
     * @param WW_Model_AcceptFormRequest $model
     * @return WW_Record_Interface
     */
    public function pushFormToModel(Zend_Form $form, WW_Model_AcceptFormRequest $model)
    {
        if(!$form-&gt;isValid()) {
            throw new Exception("Form not valid!");
        } else {
            $values = $form-&gt;getValues();
            try {
                $record = $model-&gt;acceptFormRequest($values);
            } catch(Exception $e) {
                // This exception message comes from the model, because validation failed
                $form-&gt;addErrorMessage($e-&gt;getMessage());
                throw new Exception("Form request not accepted by model!");
            }
        }
        return $record;
    }
}
</pre></div>
</div>
</div></blockquote>
<p>You can see the mediator has two different stages where errors can
occur: When the form is not valid or the model is not valid. Both exits
can be catched inside the controller and are the indicator that the form
has to be displayed again for further input corrections. When successful
the model returns a valid record that applies to the form and model
requirements and can be displayed. If this record should be persistent
this would have been done inside the <strong>acceptFormRequest</strong> function
already. An example using a very simple Model using the a BankAccount
example. We have a form that validates all the incoming request data for
a withdrawal of money, though does not validate it against the models
internal state. Our BankAccountModel implements the
<strong>WW_Model_AcceptFormRequest</strong> interface and returns a valid
BankAccount. If found the given amount is withdrawn.</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre>class BankAccountModel implements WW_Model_AcceptFormRequest {
    public function acceptFormRequest($values)
    {
        $bankAccount = $this-&gt;getBankAccountBy($values['bankAccountNumber'], $values['pin']);
        if($values['action'] == "withdraw") {
            $bankAccount-&gt;withdraw($values['amount']);
            $this-&gt;save($bankAccount);
        } else {
            // unknown action...
        }
    }
    public function getBankAccountBy($key, $password) {
        // Find by Primary Key returning 'BankAccount' instance or exception if not found.
    }
    public function save(BankAccount $ba) {
        // Sql for saving the Bank Account
    }
}

class BankAccount
{
    public function withdraw($amount)
    {
        if( ($this-&gt;getBalance()-$amount) &lt; 0 ) {
            throw new Exception("You cannot withdraw more money than your bank account holds!");
        }
        $this-&gt;balance -= $amount;
    }
}
</pre></div>
</div>
</div></blockquote>
<p>Two exceptions might be thrown in this case: The Bank Account number
does not exist or the password is wrong. Or you are not allowed to
withdraw the given amount of money. If any of those exceptions is thrown
the Model does not accept the form data and the form will have to be
displayed again for the client showing the new error message that was
returned from the model. The controller handling this process would look
like this:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre>class BankAccountController extends Zend_Controller_Action {
    public function performWithdrawlAction() {
        $form = new BankAccountWithdrawlForm(); // extends Zend_Form and builds the form

        if($this-&gt;getRequest()-&gt;isPost()) {
            $mediator         = new WW_Model_FormMediator();
            $bankAccountModel = new BankAccountModel();
            try {
                $bankAccount = $mediator-&gt;pushFormToModel($form, $bankAccountModel);

                $this-&gt;view-&gt;assign('bankAccount', $bankAccount); // Show new balance in view!
            } catch(Exception $e) {
                $this-&gt;view-&gt;assign('withdrawlForm', $form);
                $this-&gt;_redirect('showWithdrawl');
            }
        } else {
            $this-&gt;view-&gt;assign('withdrawlForm', $form);
            $this-&gt;_redirect('showWithdrawl');
        }
    }
}
</pre></div>
</div>
</div></blockquote>
<p>You can see the mediator tightly integrates Form and Model without both
components knowing too much of each other. Still you can add error
messages received from the model into the Form and redisplay it. One
negative point of this approach is the fact that you only have one
method for accepting form data, which could result in variable checking
and redispatching in the case of many different operations that can be
performed on the same model. For this case you might want to either:</p>
<ol class="arabic simple">
<li>Rewrite the mediator to accept a specific model class (not the
interface) and call the required custom method that matches the forms
request. (Best approach for separation concerns)</li>
<li>Rewrite the mediator to also pass the <strong>get_class($form);</strong> value to
the model for decision making (Faster approach)</li>
</ol>
<p>There is still some overhead on using the mediator. Since its generic
you could build an Action Helper for it and use the direct call
mechanism to save some lines of code.</p>


            <div class="tags">
                More about: 
                
            </div>

            <div class="metadata">
        <p>
            <small>
                Posted on January 23, 2009
                
            </small>
        </p>
    </div>
        </div><div class="archive_link">
        <a href="archive.html">Archive</a>
    </div></article></div> <!-- #main -->
				</div>
			</div></div> <!-- #main-container -->

        <div class="footer-container" role="contentinfo">
			<div class="container">
				<div class="col-md-8 col-md-offset-2">
					<div class="footer">
						<small>© Copyright 2008-2017, Benjamin Eberlei.</small>

						<script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script>
					</div>
				</div>
			</div>
        </div> <!-- footer-container -->
      </div> <!--! end of #container --><script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->
    </body>
</html>