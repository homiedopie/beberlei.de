<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="Blog of Benjamin Eberlei, covering a wide range of programming, bootstrapping and entrepreneurial topics">
        <meta name="viewport" content="width=device-width">
        <meta name="google-site-verification" content="mycr8JCbLYq9QcOyh4Ub1esAdN-awH9ut6nyTKUTgE4">
        <title>Home &mdash; beberlei.de</title>
            <link rel="stylesheet" href="/_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="/_static/css/bootstrap.min.css" type="text/css" />
            <link rel="stylesheet" href="/_static/blog.css" type="text/css" />
            <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" />
        <link rel="shortcut icon" href="_static/tinkerer.ico" /><!-- Load modernizr and JQuery -->
        <script src="_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="_static/plugins.js"></script>
        <script src="_static/main.js"></script>
        <link rel="next" title="Older" href="page2.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        SOURCELINK_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="_static/underscore.js"></script><script type="text/javascript" src="_static/doctools.js"></script><script type="text/javascript" src="_static/disqus.js"></script></head>
    <body role="document">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><nav class="navbar navbar-dark">
		  <div class="container">
			  <div class="navbar-header">
				  <a class="navbar-brand" href="https://beberlei.de">Benjamin Eberlei</a>
			  </div>

			  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				  <ul class="nav navbar-nav navbar-right">
						<li><a href="#">Home</a></li>
						<li><a href="pages/about.html">About</a></li>
						<li><a href="/archive.html">Archive</a></li>
					  <li><a href="/rss.xml">RSS</a></li>
				  </ul>
			  </div>
		  </div>
		</nav><div class="main-container" role="main"><div class="container">
				<div class="row">
					<div class="col-md-8 col-md-offset-2 col-sm-12"><article role="article">
							<div class="section">
            <h1><a href="2017/03/12/explicit_global_state_with_context_objects.html">Explicit Global State with Context Objects</a></h1>
<p>Global State is considered bad for maintainability of software. Side effects on
global state can cause a very nasty class of bugs. Context objects are one
flavour of global state. For example, I remember that Symfony1 had a
particularly nasty context object that was a global singleton containing
references to very many services of the framework.</p>
<p>As with every concept in programming, there are no absolute truths though and
there are many use-cases where context objects make sense. This blog posts
tries to explain my reasons for using context objects.</p>
<div class="section" id="what-is-a-context">
<h2>What is a Context?</h2>
<p>Context is defined as all the information and circumstances in which
something can be <em>fully</em> understood. In daily programming this is mostly
related to the state of variables and databases. Some examples in the world
of PHP include the superglobals <span class="docutils literal"><span class="pre">$_GET</span></span> and <span class="docutils literal"><span class="pre">$_POST</span></span>.</p>
<p>Any piece of code is always running in some context and the question is how much
of it is explicit in the code and how much is hidden.</p>
<p>A context object is a way to make the existing context explicit for your code.</p>
</div>
<div class="section" id="context-objects">
<h2>Context Objects</h2>
<p>Lets take a look at the Definition of a context object</p>
<blockquote>
<div>A context object encapsulates the references/pointers to services and
configuration information used/needed by other objects. It allows the objects
living within a context to see the outside world. Objects living in a different
context see a different view of the outside world.</div></blockquote>
<p>Besides the obvious use of encapsulating services and config variables, this
definition mentions two important properties:</p>
<ol class="arabic simple">
<li>Allows to see the outside world, which does <em>not</em> mean it can change it.
In my opinion it is essential that context objects are immutable,
to avoid side effects.</li>
<li>The possibility of objects living in different contexts, seeing
different context objects suggets that a context object
should never be a singleton.</li>
</ol>
<p>By using objects instead of global variables for context, we can use
encapsulation to achieve immutability.</p>
<p>Context already exists in PHP through the existance of superglobals. Frameworks
usually wrap them to achieve the properties mentioned above: Immutability and
Not-Singleton.</p>
<p>The Symfony Request object is one good example, where these properties (almost)
hold. Wrapping the superglobals with this object even allowed creating
Subrequests inside PHP requests.</p>
</div>
<div class="section" id="application-context">
<h2>Application Context</h2>
<p>Now that we have defined context we should make use of context objects in your
applications.</p>
<p>Anything that is an important global information in your application is
relevant for the context:</p>
<ol class="arabic simple">
<li>Building a wiki? I actually have the idea for this approach from
<a class="reference external" href="http://www.fitnesse.org/">Fitnesse</a>, a testing tool based on the wiki idea maintained by Uncle Bob
and his team. Their <a class="reference external" href="https://github.com/unclebob/fitnesse/blob/master/src/fitnesse/FitNesseContext.java">context object</a> provides access to the current and the
root page nodes.</li>
<li>Building a shop? The users basket id, selected language/locale, current
campaign (newsletter, google, social media?) can be information that should
be available all the time.</li>
<li>Building an analytics software? The currently selected date/time-range is
probably important for all queries.</li>
<li>Building a CMS/blog? The current page/post-id, the root page id, user
language/locale seem to be good candidates for an application context.
Wordpress does this although their context is global and encapsulated in an
object.</li>
<li>Building a multi-tenant app? The tenant-id and configuration for this
tentant (selected product plan, activated features, ...) are
good candidates for the context.</li>
</ol>
</div>
<div class="section" id="real-world-example-context-in-tideways">
<h2>Real World Example: Context in Tideways</h2>
<p>How to introduce such a context? We could create an object in our application,
for example how we did it in <a class="reference external" href="https://tideways.io">Tideways</a>
with selected tenant (organization), application, date-range and server environment:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">PageContext</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @var \Xhprof\Bundle\OrganizationBundle\Entity\Organization</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$organization</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var \Xhprof\Bundle\OrganizationBundle\Entity\Application</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$application</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var \Xhprof\Common\Date\DateRange</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$selectedDateRange</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var \Xhprof\Bundle\ProfilerBundle\View\EnvironmentView</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$selectedEnvironment</span><span class="p">;</span>

    <span class="c1">// constructor and getters</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This object is created during request boot, in my case with a framework
listener. The listener checks for access rights and security constraints,
showing the 403/access denied page when necessary. This make 90% of access
control checks unneeded that are usually cluttering the controller.</p>
<p>The context is then made available for the application by using a Symfony
<a class="reference external" href="https://www.beberlei.de/2013/02/19/extending_symfony2__paramconverter.html">parameter converter</a>, every controller-action can get access to the context
by type-hinting for it:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">ApplicationController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">showAction</span><span class="p">(</span><span class="nx">PageContext</span> <span class="nv">$pageContext</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s1">'application'</span> <span class="o">=&gt;</span> <span class="nv">$pageContext</span><span class="o">-&gt;</span><span class="na">getApplication</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The beauty of this approach is avoiding global state and passing
the context around in a non-singleton way. Depending on the framework
you use, it might be hard to achieve this kind of context injection.</p>
<p>Now when I build <a class="reference external" href="https://www.beberlei.de/2014/10/14/lightweight_symfony2_controllers.html">lightweight Symfony2 controllers</a>
in my applications, using a context object allows me to use even less services
and move repetitive find and access control code outside of the controllers.</p>
<p>I have also written a Twig extension that gives me access to the context
object, so I don’t have to return it from every controller and created
a wrapper for the URL Generation that appends context information
to every URL (current date range + environment):</p>
<div class="highlight-jinja2"><div class="highlight"><pre>&lt;h1&gt;{{ pageContext.application.name }}&lt;/h1&gt;

&lt;a href="{{ page_path("some_route") }}"&gt;Link with Context query arguments&lt;/a&gt;
</pre></div>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>A context object can help you make global state explicit and control access to
it. Good requirements for a context object are immutability and not being a
singleton.</p>
<p>When used correctly this pattern can save you alot of redundant code and
simplify both controllers and views massively.</p>
<p>The pattern has its drawbacks: You have to be careful not put too powerful
objects into the context and if you can modify the context, then you will
probably introduce nasty side effets at some point. Additionally if you don’t
make sure that creating the context is a very fast operation then you will
suffer from performance hits, because the context is created on every request,
maybe fetching expensive data that isn’t even used.</p>
</div>


            
            <div class="tags">
                More about: 
                <a href="tags/symfony.html">Symfony</a>
                 / 
                <a href="tags/designpatterns.html">DesignPatterns</a>
                 / 
                <a href="tags/applicationdesign.html">ApplicationDesign</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on March 12, 2017
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2016/05/28/composer_monorepo_plugin_previously_called_fiddler.html">Composer Monorepo Plugin (previously called Fiddler)</a></h1>
<p>I have <a class="reference external" href="http://www.whitewashing.de/2015/04/11/monolithic_repositories_with_php_and_composer.html">written about monorepos</a>
in this blog before, <a class="reference external" href="https://qafoo.com/resources/presentations/symfony_live_berlin_2015/monorepos.html">presented a talk</a>
about this topic and released a standalone tool called “Fiddler” that helps
integrating Composer with a monolithic repository.</p>
<p>At the beginning of the year, somebody in <span class="docutils literal"><span class="pre">#composer-dev</span></span> IRC channel on
Freenode pointed me in the direction of Composer plugins to use with Fiddler
and it was an easy change to do so.</p>
<p>With the help of a new Composer v1.1 feature to add custom commands from a
plugin, Fiddler is now “gone” and I renamed the repository to the practical
<strong>beberlei/composer-monorepo-plugin</strong> package name on <a class="reference external" href="https://github.com/beberlei/composer-monorepo-plugin">Github</a>. After you install
this plugin, you have the possibility to maintain subpackages and their
dependencies in a single repository.</p>
<div class="highlight-python"><div class="highlight"><pre>$ composer require beberlei/composer-monorepo-plugin
</pre></div>
</div>
<p>To use the plugin add <strong>monorepo.json</strong> files into each directory of a
subpackage and use a format similar to the <strong>composer.json</strong> to add
dependencies to a.) external composer packages that you have listed in your
global Composer file b.) other subpackages in the current monorepo.
See this example for a demonstration:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">"deps"</span><span class="p">:</span> <span class="p">[</span>
        <span class="s2">"vendor/symfony/http-foundation"</span><span class="p">,</span>
        <span class="s2">"components/Foo"</span>
    <span class="p">],</span>
    <span class="s2">"autoload"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"psr-0"</span><span class="p">:</span> <span class="p">{</span><span class="s2">"Bar"</span><span class="p">:</span> <span class="s2">"src/"</span><span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This subpackage here defined in a hypothetical file
<strong>components/Bar/monorepo.json</strong> has dependencies to Symfony HTTP foundation
and another subpackage Foo with its own <strong>components/Foo/monnorepo.json</strong>.
Notice how we don’t need to specify versions (they are implicit) and import
other dependencies using the relative path from the global composer.json.</p>
<p>The monorepo plugin is integrated with Composer, so every time you perform install,
update or dump-autoload commands, the subpackages will be updated as well and
each get their own autoloader that can be included from <span class="docutils literal"><span class="pre">vendor/autoload.php</span></span>
relative to the subpackages root directory as usual.</p>


            
            <div class="tags">
                More about: 
                <a href="tags/monorepos.html">Monorepos</a>
                 / 
                <a href="tags/composer.html">Composer</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on May 28, 2016
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2016/02/21/how_i_use_wordpress_with_git_and_composer.html">How I use Wordpress with Git and Composer</a></h1>
<p>I maintain two Wordpress blogs for my wife and wanted to find a workflow to
develop, update, version-contol and maintain them with Git and Composer, like I
am used to with everything else that I am working on.</p>
<p>The resulting process is a combination of several blog posts and my own
additions, worthy of writing about for the next person interested in this
topic.</p>
<p>It turns out this is quite simple if you re-arrange the Wordpress directory
layout a little bit and use some fantastic open-source projects to combine
Wordpress and Composer.</p>
<div class="section" id="initialize-repository">
<h2>Initialize Repository</h2>
<p>As a first step, create a new directory and git repository for your blog:</p>
<div class="highlight-python"><div class="highlight"><pre>$ mkdir myblog
$ cd myblog
$ git init
</pre></div>
</div>
<p>Create a docroot directory that is publicly available for the webserver:</p>
<div class="highlight-python"><div class="highlight"><pre>$ mkdir htdocs
</pre></div>
</div>
<p>Place the index.php file in it that delegates to Wordpress (installed later):</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// htdocs/index.php</span>
<span class="c1">// Front to the WordPress application. This file doesn't do anything, but loads</span>
<span class="c1">// wp-blog-header.php which does and tells WordPress to load the theme.</span>

<span class="nb">define</span><span class="p">(</span><span class="s1">'WP_USE_THEMES'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
<span class="k">require</span><span class="p">(</span> <span class="nb">dirname</span><span class="p">(</span> <span class="k">__FILE__</span> <span class="p">)</span> <span class="o">.</span> <span class="s1">'/wordpress/wp-blog-header.php'</span> <span class="p">);</span>
</pre></div>
</div>
<p>Create the wp-content directory inside the docroot, it will be configured to
live <em>outside</em> the Wordpress installation.</p>
<div class="highlight-python"><div class="highlight"><pre>$ mkdir htdocs/wp-content -p
</pre></div>
</div>
<p>And then create a <cite>.gitignore</cite> file with the following ignore paths:</p>
<div class="highlight-python"><div class="highlight"><pre>/htdocs/wordpress/
/htdocs/wp-content/uploads
/htdocs/wp-content/plugins
/htdocs/wp-content/themes
</pre></div>
</div>
<p>If you want to add a custom theme or plugin you need to use <cite>git add -f</cite> to
force the ignored path into Git.</p>
<p>Don’t forget to include the uploads directory in your backup, when deploying
this blog to production.</p>
<p>You directory tree should now look like this:</p>
<div class="highlight-python"><div class="highlight"><pre>.
├── .git
├── .gitignore
└── htdocs
    ├── index.php
    └── wp-content
</pre></div>
</div>
<p>In the next step we will use Composer to install Wordpress and plugins.</p>
</div>
<div class="section" id="setup-composer">
<h2>Setup Composer</h2>
<p>Several people have done amazing work to make Wordpress and all the plugins and
themes on Wordpress.org available through Composer. To utilize this work we
create a composer.json file inside our repository root. There the file is
outside of the webservers reach, users of your blog cannot download the
composer.json.</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">"require"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"ext-gd"</span><span class="p">:</span> <span class="s2">"*"</span><span class="p">,</span>
        <span class="s2">"wpackagist-plugin/easy-media-gallery"</span><span class="p">:</span> <span class="s2">"1.3.*"</span><span class="p">,</span>
        <span class="s2">"johnpbloch/wordpress-core-installer"</span><span class="p">:</span> <span class="s2">"^0.2.1"</span><span class="p">,</span>
        <span class="s2">"johnpbloch/wordpress"</span><span class="p">:</span> <span class="s2">"^4.4"</span>
    <span class="p">},</span>
    <span class="s2">"extra"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"installer-paths"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"htdocs/wp-content/plugins/{$name}/"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"type:wordpress-plugin"</span><span class="p">],</span>
            <span class="s2">"htdocs/wp-content/themes/{$name}/"</span><span class="p">:</span> <span class="p">[</span><span class="s2">"type:wordpress-theme"</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="s2">"wordpress-install-dir"</span><span class="p">:</span> <span class="s2">"htdocs/wordpress"</span>
    <span class="p">},</span>
    <span class="s2">"repositories"</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s2">"type"</span><span class="p">:</span> <span class="s2">"composer"</span><span class="p">,</span>
            <span class="s2">"url"</span><span class="p">:</span> <span class="s2">"http://wpackagist.org"</span>
        <span class="p">}</span>
    <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This Composer.json is using the execellent <a class="reference external" href="https://github.com/johnpbloch/wordpress-core-installer">Wordpress Core Installer</a> by <a class="reference external" href="https://johnpbloch.com/">John P. Bloch</a> and the <a class="reference external" href="http://wpackagist.org/">WPackagist</a>
project by <a class="reference external" href="http://outlandish.com/">Outlandish</a>.</p>
<p>The <span class="docutils literal"><span class="pre">extra</span></span> configuration in the file configures Composer for placing
Wordpress Core and all plugins in the correct directories. As you can see we
put core into <cite>htdocs/wordpress</cite> and plugins into <cite>htdocs/wp-content/plugins</cite>.</p>
<p>Now run the Composer install command to see the intallation output similar
to the next excerpt:</p>
<div class="highlight-python"><div class="highlight"><pre>$ composer install
Loading composer repositories with package information
Installing dependencies (including require-dev)
  - Installing composer/installers (v1.0.23)
    Loading from cache

  - Installing johnpbloch/wordpress-core-installer (0.2.1)
    Loading from cache

  - Installing wpackagist-plugin/easy-media-gallery (1.3.93)
    Loading from cache

  - Installing johnpbloch/wordpress (4.4.2)
    Loading from cache

Writing lock file
Generating autoload files
</pre></div>
</div>
<p>The next step is to get Wordpress running using the Setup Wizard.</p>
</div>
<div class="section" id="setup-wordpress">
<h2>Setup Wordpress</h2>
<p>Follow the Wordpress documentation to setup your Wordpress blog now, it
will create the neccessary database tables and give you <cite>wp-config.php</cite> file
to download. Copy this file to <cite>htdocs/wp-config.php</cite> and modify it slightly,
it is necessary to adjust the <span class="docutils literal"><span class="pre">WP_CONTENT_DIR</span></span>, <span class="docutils literal"><span class="pre">WP_CONTENT_URL</span></span> and
<span class="docutils literal"><span class="pre">ABSPATH</span></span> constants:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="c1">// generated contents of wp-config.php, salts, database and so on</span>

<span class="nb">define</span><span class="p">(</span><span class="s1">'WP_CONTENT_DIR'</span><span class="p">,</span>    <span class="nx">__DIR__</span> <span class="o">.</span> <span class="s1">'/wp-content'</span><span class="p">);</span>
<span class="nb">define</span><span class="p">(</span><span class="s1">'WP_CONTENT_URL'</span><span class="p">,</span>    <span class="nx">WP_HOME</span> <span class="o">.</span> <span class="s1">'/wp-content'</span><span class="p">);</span>

<span class="sd">/** Absolute path to the WordPress directory. */</span>
<span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nb">defined</span><span class="p">(</span><span class="s1">'ABSPATH'</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
    <span class="nb">define</span><span class="p">(</span><span class="s1">'ABSPATH'</span><span class="p">,</span> <span class="nb">dirname</span><span class="p">(</span><span class="k">__FILE__</span><span class="p">)</span> <span class="o">.</span> <span class="s1">'/wordpress'</span><span class="p">);</span>
<span class="p">}</span>

<span class="sd">/** Sets up WordPress vars and included files. */</span>
<span class="k">require_once</span><span class="p">(</span><span class="nx">ABSPATH</span> <span class="o">.</span> <span class="s1">'wp-settings.php'</span><span class="p">);</span>
</pre></div>
</div>
<p>Voila. You have Wordpress running from a Git repository and maintain
the Wordpress Core and Plugins through Composer.</p>
</div>
<div class="section" id="different-development-and-production-environments">
<h2>Different Development and Production Environments</h2>
<p>The next step is introducing different environments, to allow using
the same codebase in production and development, where the base urls are
different, without having to change <span class="docutils literal"><span class="pre">wp-config.php</span></span> or the database.</p>
<p>Wordpress relies on the
<span class="docutils literal"><span class="pre">SITEURL</span></span> and <span class="docutils literal"><span class="pre">HOME</span></span> configuration variables from the
<span class="docutils literal"><span class="pre">wp_options</span></span> database table by default, this means its not easily possible to
use the blog under <span class="docutils literal"><span class="pre">http://myblog.local</span></span> (development) and
<cite>https://myblog.com`</cite> (production).</p>
<p>But working on the blog I want to copy the database from production and have
this running on my local development machine without anything more than
exporting and importing a MySQL dump.</p>
<p>Luckily there is an easy workaround that allows this: You can overwrite the
<span class="docutils literal"><span class="pre">SITEURL</span></span> and <span class="docutils literal"><span class="pre">HOME</span></span> variables using constants in <span class="docutils literal"><span class="pre">wp-config.php</span></span>.</p>
<p>For development I rely on the built-in PHP Webserver that is available since
PHP 5.4 with a custom router-script (I found this on a blog a long time ago,
but cannot find the source anymore):</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">//htdocs/router.php</span>

<span class="nv">$root</span> <span class="o">=</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'DOCUMENT_ROOT'</span><span class="p">];</span>
<span class="nb">chdir</span><span class="p">(</span><span class="nv">$root</span><span class="p">);</span>
<span class="nv">$path</span> <span class="o">=</span> <span class="s1">'/'</span><span class="o">.</span><span class="nb">ltrim</span><span class="p">(</span><span class="nb">parse_url</span><span class="p">(</span><span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'REQUEST_URI'</span><span class="p">])[</span><span class="s1">'path'</span><span class="p">],</span><span class="s1">'/'</span><span class="p">);</span>
<span class="nb">set_include_path</span><span class="p">(</span><span class="nb">get_include_path</span><span class="p">()</span><span class="o">.</span><span class="s1">':'</span><span class="o">.</span><span class="nx">__DIR__</span><span class="p">);</span>

<span class="k">if</span><span class="p">(</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$root</span><span class="o">.</span><span class="nv">$path</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">if</span><span class="p">(</span><span class="nb">is_dir</span><span class="p">(</span><span class="nv">$root</span><span class="o">.</span><span class="nv">$path</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$path</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!==</span> <span class="s1">'/'</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$path</span> <span class="o">=</span> <span class="nb">rtrim</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span><span class="s1">'/'</span><span class="p">)</span><span class="o">.</span><span class="s1">'/index.php'</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="nb">strpos</span><span class="p">(</span><span class="nv">$path</span><span class="p">,</span><span class="s1">'.php'</span><span class="p">)</span> <span class="o">===</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">chdir</span><span class="p">(</span><span class="nb">dirname</span><span class="p">(</span><span class="nv">$root</span><span class="o">.</span><span class="nv">$path</span><span class="p">));</span>
        <span class="k">require_once</span> <span class="nv">$root</span><span class="o">.</span><span class="nv">$path</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="k">include_once</span> <span class="s1">'index.php'</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>To make your blog run flawlessly on your dev machine, open up
<span class="docutils literal"><span class="pre">htdocs/wp-config.php</span></span> and add the following if statement to rewrite
<span class="docutils literal"><span class="pre">SITEURL</span></span> and <span class="docutils literal"><span class="pre">HOME</span></span> config variables:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// htdocs/wp-config.php</span>

<span class="c1">// ... salts, DB user, password etc.</span>

<span class="k">if</span> <span class="p">(</span><span class="nb">php_sapi_name</span><span class="p">()</span> <span class="o">===</span> <span class="s1">'cli-server'</span> <span class="o">||</span> <span class="nb">php_sapi_name</span><span class="p">()</span> <span class="o">===</span> <span class="s1">'srv'</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">define</span><span class="p">(</span><span class="s1">'WP_ENV'</span><span class="p">,</span>        <span class="s1">'development'</span><span class="p">);</span>
    <span class="nb">define</span><span class="p">(</span><span class="s1">'WP_SITEURL'</span><span class="p">,</span>    <span class="s1">'http://localhost:8000/wordpress'</span><span class="p">);</span>
    <span class="nb">define</span><span class="p">(</span><span class="s1">'WP_HOME'</span><span class="p">,</span>       <span class="s1">'http://localhost:8000'</span><span class="p">);</span>
<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="nb">define</span><span class="p">(</span><span class="s1">'WP_ENV'</span><span class="p">,</span>        <span class="s1">'production'</span><span class="p">);</span>
    <span class="nb">define</span><span class="p">(</span><span class="s1">'WP_SITEURL'</span><span class="p">,</span>    <span class="s1">'http://'</span> <span class="o">.</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'SERVER_NAME'</span><span class="p">]</span> <span class="o">.</span> <span class="s1">'/wordpress'</span><span class="p">);</span>
    <span class="nb">define</span><span class="p">(</span><span class="s1">'WP_HOME'</span><span class="p">,</span>       <span class="s1">'http://'</span> <span class="o">.</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'SERVER_NAME'</span><span class="p">]);</span>
<span class="p">}</span>

<span class="nb">define</span><span class="p">(</span><span class="s1">'WP_DEBUG'</span><span class="p">,</span> <span class="nx">WP_ENV</span> <span class="o">===</span> <span class="s1">'development'</span><span class="p">);</span>
</pre></div>
</div>
<p>You can now run your Wordpress blog locally using the following command-line
arguments:</p>
<div class="highlight-python"><div class="highlight"><pre>$ php -S localhost:8000 -t htdocs/ htdocs/router.php
</pre></div>
</div>
<p>Keep this command running and visit <cite>localhost:8000</cite>.</p>
</div>


            
            <div class="tags">
                More about: 
                <a href="tags/wordpress.html">Wordpress</a>
                 / 
                <a href="tags/deployment.html">Deployment</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on February 21, 2016
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2015/08/08/monolithic_repositories_with_composer_and_relative_autoloading.html">Monolithic Repositories with Composer and Relative Autoloading</a></h1>
<p>Just was <a class="reference external" href="https://twitter.com/samuelroze/status/630037676654206976">reminded on Twitter by Samuel</a> that there
is a way for monolithic PHP repositories with multiple components
that I haven’t mentioned in my <a class="reference external" href="http://www.whitewashing.de/2015/04/11/monolithic_repositories_with_php_and_composer.html">previous post</a>.</p>
<p>It relies on a new composer.json for each component and uses
the autoloading capabilities of Composer in a hackish way.</p>
<p>Assume we have two components located in <span class="docutils literal"><span class="pre">components/foo</span></span> and
<span class="docutils literal"><span class="pre">components/bar</span></span>, then if bar depends on foo, it could define
its <span class="docutils literal"><span class="pre">components/bar/composer.json</span></span> file as:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="s2">"autoload"</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">"psr-0"</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">"Foo"</span><span class="p">:</span> <span class="s2">"../foo/src/"</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This approach is very simple to start with, however it has some downsides
you must take into account:</p>
<ul class="simple">
<li>you have to redefine dependencies in every composer.json that relies
on another component.</li>
<li>if foo and bar depend on different versions of some third library <span class="docutils literal"><span class="pre">baz</span></span>
that are not compatible, then composer will not realize this and your
code will break at runtime.</li>
<li>if you want to generate deployable units (tarballs, debs, ..) then
you will have a hard time to collect all the implicit dependencies
by traversing the autoloader for relative definitions.</li>
<li>A full checkout has multiple vendor directories with a lot of duplicated
code.</li>
</ul>
<p>I think this approach is ok, if you are only sharing a small number of
components that don’t define their own dependencies. The <a class="reference external" href="https://github.com/beberlei/fiddler">Fiddler</a> approach however solves all these
problems by forcing to rely on the same dependencies in a project globally and
only once.</p>


            
            <div class="tags">
                More about: 
                <a href="tags/monorepos.html">Monorepos</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on August 08, 2015
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2015/06/12/the_containertest.html">The ContainerTest</a></h1>
<p>This is a short post before the weekend about testing in applications with
dependency injection container (DIC). This solution helps me with a problem
that I occasionally trip over in environments with large amounts of services
connected through a DIC.</p>
<p>The problem is forgetting to adjust the DIC configuration when you add a new or
remove a dependency to a service. This can easily slip through into production
if you rely on your functional- and unit-tests to catch the problem.</p>
<p>I can avoid this problem by adding a functional test in my application that
instantiate all the various services and checks if they are created correctly.
The first time I saw this pattern was during development of some of the early
Symfony2 bundles, most notably DoctrineBundle.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Acme</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">ContainerTest</span> <span class="k">extends</span> <span class="nx">\PHPUnit_Framework_TestCase</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">SymfonySetup</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">dataServices</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">'AcmeDemoBundle.FooService'</span><span class="p">,</span> <span class="s1">'Acme\DemoBundle\Service\FooService'</span><span class="p">),</span>
            <span class="k">array</span><span class="p">(</span><span class="s1">'AcmeDemoBundle.BarController'</span><span class="p">,</span> <span class="s1">'Acme\DemoBundle\Controller\BarController'</span><span class="p">),</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @test</span>
<span class="sd">     * @dataProvider dataServices</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">it_creates_service</span><span class="p">(</span><span class="nv">$id</span><span class="p">,</span> <span class="nv">$class</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$service</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getContainer</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="nv">$id</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertInstanceOf</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="nv">$service</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Whenever you create or modify a service check the ContainerTest if its already
guarded by a test. Add a test if necesary and then make the change. It’s as
easy as that.</p>
<p>The <span class="docutils literal"><span class="pre">SymfonySetup</span></span> trait provides access to the Symfony DIC using
<span class="docutils literal"><span class="pre">getContainer()</span></span> as you can see in the test method. See <a class="reference external" href="http://www.whitewashing.de/2015/02/14/phpunit_before_annotations_and_traits_for_code_reuse.html">my blog post</a>
on traits in tests for more information.</p>


            
            <div class="tags">
                More about: 
                <a href="tags/symfony.html">Symfony</a>
                 / 
                <a href="tags/testing.html">Testing</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on June 12, 2015
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="archive_link">
        <a href="archive.html">Archive</a>
    </div></article></div> <!-- #main -->
				</div>
			</div></div> <!-- #main-container -->

        <div class="footer-container" role="contentinfo">
			<div class="container">
				<div class="col-md-8 col-md-offset-2">
					<div class="footer">
						<small>© Copyright 2008-2017, Benjamin Eberlei.</small>

						<script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script>
					</div>
				</div>
			</div>
        </div> <!-- footer-container -->
      </div> <!--! end of #container --><script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->
    </body>
</html>