





<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Home &mdash; Whitewashing</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '1.0.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/disqus.js"></script>
    <script type="text/javascript" src="_static/ga.js"></script>
    <link rel="shortcut icon" href="_static/tinkerer.ico"/>
    
    <link rel="top" title="Whitewashing" href="#" />
    <link rel="next" title="Older" href="page1.html" />
    <link rel="alternate" type="application/rss+xml" title="RSS" href="rss.html" /> 
  </head>
  <body>
<div class="container">
    <div id="header" class="span-8">
        <a href="#"><img src="_static/logo.jpg" alt="Whitewashing.de" /></a>
    </div>
    <div class="span-11" id="about">
        <p>
            Whitewashing is the blog of Benjamin Eberlei and covers topics in software-development and object-oriented-design. Benjamin works
            for <a href="http://qafoo.com/" target="_blank">Qafoo</a> and you can book him for consulting and trainings.
        </p>
    </div>
    <div class="span-5 last">
        <p class="buttons" style="text-align: right">
            <a href="https://twitter.com/beberlei"><img src="_static/twitter-logo.png" alt="Follow me on twitter" height="50" /></a>
            <a href="http://www.whitewashing.de/rss.xml"><img src="_static/rss2.png" alt="Subscribe to RSS" height="50" /></a>
            <a href="https://github.com/beberlei"><img src="_static/github-logo.png" alt="My Github Profile" height="50" /></a>
        </p>
    </div>
</div>



    <div class="document">
<div class="container">
    
    <div class="span-24 content">
      <div>
        <div>
          <div id="index">
            
            
    
    <div class="related">
        <ul>
            <li class="right">
                <a href="page1.html">Older</a> &raquo; 
            </li>
        </ul>
    </div>
        
        <div class="timestamp postmeta">
            <span>November 19, 2013</span> 
        </div>
        <div class="section" id="setting-up-development-machines-ansible-edition">
<h1><a href="2013/11/19/setting_up_development_machines_ansible_edition.html">Setting up development machines: Ansible edition</a></h1>
<p>A little over a year ago I posted on using <a class="reference external" href="http://www.whitewashing.de/2012/06/03/setting_up_development_machines_with_puppet.html">Puppet for setting up development
machines</a>.
This approach prooved useful as during that time I did setup a new machine
several times and benefited from the mostly automatic installation with Puppet.
Github is thinking the same on a bigger scale. Earlier this year they
introduced <a class="reference external" href="https://github.com/blog/1345-introducing-boxen">Boxen</a> which is
using Puppet to setup mac-development machines.</p>
<p>The space of deployment- and configuration management tools
is exploding these last years and it is not always feasible to evaluate all of
them. The benefit of Puppet over all these tools is its huge userbase and
online resources. However the steep learning curve can be a huge pain coupled
with the fact that most of the modules online are not reusable at all and
mostly serve a documentation for “how not to work with Puppet”. On top of that
Puppet is only for configuration management and not suitable for deployment
of applications.</p>
<div class="section" id="introduction-to-ansible">
<h2>Introduction to Ansible</h2>
<p>I came across a <a class="reference external" href="http://labs.qandidate.com/blog/2013/11/15/first-steps-with-ansible/">blog post on Ansible</a> by the
awesome guys at Qandidate.com which lead me to investigate <a class="reference external" href="http://ansibleworks.com">Ansible</a>. It is essentially a hybrid between Capistrano and Puppet,
solving both the deployment and configuration management problems with a focus
on simplicity. In fact the learning curve of Ansible is much more flat than
that of Puppet and you can read the whole documentation and understand even the
advanced concepts in a few hours.</p>
<p>Ansible is used from a developer- or continuous-integration-machine, which
executes tasks on hosts from an inventory. You only need SSH servers running
and private keys to connect to them to get it working. With the inventory of
hosts to operate on, you can chose to execute ad-oc commands using the
<cite>ansible</cite> command or playbooks using the <cite>ansible-playbook</cite> command. Playbooks
are files written in YAML.</p>
<p><a class="reference external" href="http://labs.qandidate.com/blog/2013/11/15/first-steps-with-ansible">Read Sanders post on the Qandidate blog</a> to get an introduction to Ansible.</p>
</div>
<div class="section" id="development-machine-setup">
<h2>Development-Machine Setup</h2>
<p>Using Ansible to setup a development machine is a bit pointless, given that
Ansible excels at remote task execution and distribution. The benefit in
development-machine setup over Puppet is the simplicity of configuration
compared to Puppet modules + DSL.</p>
<p>For demonstration I have converted the puppet examples from my blog post on
Puppet to Ansible.  To start we have to create a folder and create a new file
<cite>inventory</cite> in it containing our local machine:</p>
<blockquote>
<div>localhost   ansible_connection=local</div></blockquote>
<p>This is necessary to convince the remote task execution part of Ansible that
localhost exists and there is no SSH necessary to get into that machine.</p>
<p>Now I can create playbooks for the different tools I might want to install and
setup, such as Vim in a <cite>vim.yml</cite>:</p>
<blockquote>
<div><p>—
- hosts: localhost</p>
<blockquote>
<div><dl class="docutils">
<dt>tasks:</dt>
<dd><ul class="first last">
<li><p class="first">name: Install VIM
apt: pkg=vim state=present
sudo: yes</p>
</li>
<li><p class="first">name: Install Dotfiles
git: &gt;</p>
<blockquote>
<div><p><a class="reference external" href="mailto:repo=git%40github.com/beberlei/vim-dotfiles.git">repo=git<span>@</span>github<span>.</span>com/beberlei/vim-dotfiles<span>.</span>git</a>
dest=/home/${ansible_user_id}/.vim</p>
</div></blockquote>
</li>
<li><p class="first">name: Create .vimrc Symlink
file: &gt;</p>
<blockquote>
<div><p>src=/home/${ansible_user_id}/.vim/vimrc
dest=/home/${ansible_user_id}/.vimrc
state=symlink</p>
</div></blockquote>
</li>
<li><p class="first">name: Compile and Install Command-T plugin
command: &gt;</p>
<blockquote>
<div><p>rake make
chdir=/home/${ansible_user_id}/.vim/bundle/Command-T
creates=/home/${ansible_uesr_id}/.vim/bundle/Command-T/command-t.recipe</p>
</div></blockquote>
</li>
</ul>
</dd>
</dl>
</div></blockquote>
</div></blockquote>
<p>You can see here, tasks are a list of commands to execute. They are always
executed in order and stop when the first task in the chain fails. Like in
puppet you try to make those tasks idempotent through flags such as <cite>creates</cite>,
signaling when a task needs to be or was already executed. I can optionally
use sudo to run commands such as installing packages.</p>
<p>To execute the playbook I call:</p>
<blockquote>
<div>$&gt; ansible-playbook -K -i inventory vim.yml</div></blockquote>
<p>With the <tt class="docutils literal"><span class="pre">-i</span></tt> flag I define the pool of hosts to run on, in our case the
local machine and the playbook applies the <cite>hosts</cite> filter to that inventory.
The <cite>-K</cite> parameter prompts me to enter the sudo password for my Ubuntu machine,
otherwise the tasks will fail.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Compared to Puppet, the configuration management of Ansible simplifies a lot of
the assumptions for example on ordering and reusability of tasks. For a
part-time “devop” like me this is great news, as I don’t need to understand a
complex tool and can focus on solving problems.</p>
<p>On top of that the deployment features of Ansible with parallel remote
execution over SSH make Ansible a powerful tool that I hope to use much more in
the future.</p>
</div>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        <div class="categories">
            <span>
                Filed under:
                
                    <a href="categories/devops.html">Devops</a>
                
            </span>
        </div>
        
        <div class="tags">
            <span>
                Tags:
                
                    <a href="tags/ansible.html">Ansible</a>
                
            </span>
        </div>
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2013/11/19/setting_up_development_machines_ansible_edition.html#disqus_thread" data-disqus-identifier="2013/11/19/setting_up_development_machines_ansible_edition">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>September 04, 2013</span> 
        </div>
        <div class="section" id="decoupling-from-symfony-security-and-fosuserbundle">
<h1><a href="2013/09/04/decoupling_from_symfony_security_and_fosuserbundle.html">Decoupling from Symfony Security and FOSUserBundle</a></h1>
<p>In this blog post I will show how to decouple your core application
from the Symfony Security component and User bundles such as the FOSUserBundle.</p>
<p>In my opinion a framework has to be evaluated by how much it allows you to hide
it from your actual application. This blog post will add another perspective on
how to achieve decoupling from Symfony user and security with a very simple
approach. With this puzzle piece and others I wrote about before (<a class="reference external" href="http://whitewashing.de/2013/06/27/extending_symfony2__controller_utilities.html">Controllers
as Service</a>,
<a class="reference external" href="http://whitewashing.de/2013/02/19/extending_symfony2__paramconverter.html">Param Converters</a>)
and other pieces I still need to write about, I would classify Symfony2 as a
good framework.</p>
<p>A number of other authors have written blog posts on decoupling Symfony and your model
code as well, such as William Durand <a class="reference external" href="http://williamdurand.fr/2013/08/07/ddd-with-symfony2-folder-structure-and-code-first/">on project structure</a>
, Matthias Verraes <a class="reference external" href="http://verraes.net/2011/10/code-folder-structure/">on project structure as well</a>
and on <a class="reference external" href="http://verraes.net/2013/04/decoupling-symfony2-forms-from-entities/">Decoupling Forms from Entities</a>.</p>
<p>User management breaks the isolation of your business model open,
by introducing the <tt class="docutils literal"><span class="pre">UserInterface</span></tt> from the Security component into your
code base. In combination with the <em>FOSUserBundle</em> this can cause a dependency
on quite a bit of code already because I wouldn’t call the <tt class="docutils literal"><span class="pre">FOS\UserBundle\Model\User</span></tt> object
leightweight. However this and other FriendsOfSymfony bundles
are very helpful to get annoying features of your application done in a matter
of hours.</p>
<p>You can decouple the <em>FOSUserBundle</em> from our own entities and code by
introducing a second object that representes the user concept in our model.
The <tt class="docutils literal"><span class="pre">UserInterface</span></tt> entities need fields for username, password, enabled and
some more. Except the username and email, the business model rarely needs other
properties.</p>
<p>Take an ecommerce system as example, where customers can register as users.
In this example we could create two entities <tt class="docutils literal"><span class="pre">MyProject\UserBundle\Entity\User</span></tt> and
<tt class="docutils literal"><span class="pre">MyProject\ShopBundle\Entity\Customer</span></tt>. Two strategies exist now:</p>
<ol class="arabic simple">
<li>Use the same table for both entities with some shared and other exclusive columns</li>
<li>Use different tables in the database</li>
</ol>
<p>I haven’t tried the first option yet, so I cannot say much about the feasibility.</p>
<p>For case two, the <tt class="docutils literal"><span class="pre">User</span></tt> entity looks like this:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/MyProject/UserBundle/Entity/User.php;</span>

<span class="k">namespace</span> <span class="nx">MyProject\UserBundle\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">FOS\UserBundle\Model\User</span> <span class="k">as</span> <span class="nx">BaseUser</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @ORM\Entity</span>
<span class="sd"> * @ORM\Table(name=&quot;fos_user&quot;)</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">User</span> <span class="k">extends</span> <span class="nx">BaseUser</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @ORM\Id</span>
<span class="sd">     * @ORM\Column(type=&quot;integer&quot;)</span>
<span class="sd">     * @ORM\GeneratedValue(strategy=&quot;AUTO&quot;)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <tt class="docutils literal"><span class="pre">Customer</span></tt> entity is a completly new object, not depending
on the <tt class="docutils literal"><span class="pre">UserInterface</span></tt> and containing some duplicated properties.</p>
<p>You can either use exactly the same ID or plant the <tt class="docutils literal"><span class="pre">$userId</span></tt> as
correlation ID in the <tt class="docutils literal"><span class="pre">Customer</span></tt> object.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="c1">// src/MyProject/ShopBundle/Entity/Customer.php</span>

<span class="k">namespace</span> <span class="nx">MyProject\ShopBundle\Entity</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @ORM\Entity</span>
<span class="sd"> * @ORM\Table(name=&quot;customer&quot;)</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">Customer</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @ORM\Id</span>
<span class="sd">     * @ORM\Column(type=&quot;integer&quot;)</span>
<span class="sd">     * @ORM\GeneratedValue(strategy=&quot;NONE&quot;)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$id</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @ORM\Column(type=&quot;string&quot;)</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="nv">$username</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now you need to extend the application to synchronize all changes from the
<tt class="docutils literal"><span class="pre">User</span></tt> entity to the <tt class="docutils literal"><span class="pre">Customer</span></tt> entity. You can
achieve this relatively easy by overwriting the <tt class="docutils literal"><span class="pre">ModelManager</span></tt> or when finally
supported by <em>FOSUserBundle</em> listening to events.  Your own code can
exclusively work with <tt class="docutils literal"><span class="pre">Customer</span></tt> objects now, void of any reference to
the Symfony Security component or the huge FOSUserBundle dependency.</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        <div class="categories">
            <span>
                Filed under:
                
                    <a href="categories/php.html">PHP</a>,
                
                    <a href="categories/symfony2.html">Symfony2</a>
                
            </span>
        </div>
        
        <div class="tags">
            <span>
                Tags:
                
                    <a href="tags/php.html">PHP</a>,
                
                    <a href="tags/symfony2.html">Symfony2</a>
                
            </span>
        </div>
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2013/09/04/decoupling_from_symfony_security_and_fosuserbundle.html#disqus_thread" data-disqus-identifier="2013/09/04/decoupling_from_symfony_security_and_fosuserbundle">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>August 19, 2013</span> 
        </div>
        <div class="section" id="speedup-symfony2-on-vagrant-boxes">
<h1><a href="2013/08/19/speedup_symfony2_on_vagrant_boxes.html">Speedup Symfony2 on Vagrant boxes</a></h1>
<ul class="simple">
<li><strong>Update:</strong> Added requirements to configure Vagrant and Virtualbox before
trying my change.</li>
<li><strong>Update 2:</strong> Added link to Virtualbox Guest Additions plugin for Vagrant,
thanks Peter Kruithof for the hint.</li>
</ul>
<p>Using Symfony2 inside a Vagrant box is considered to be very slow (<a class="reference external" href="http://stackoverflow.com/questions/12161425/why-is-my-symfony-2-0-site-running-slowly-on-vagrant-with-linux-host">here</a>,
<a class="reference external" href="https://twitter.com/spicy_sake/status/183135528567320576">here</a>), even when
using NFS. I can confirm the experience and know many others that reported the
same.</p>
<p>Before doing this changes make sure:</p>
<ul class="simple">
<li>You are using Vagrant 1.2 (not sure that makes a difference though)</li>
<li>You are using NFS with Vagrant (<a class="reference external" href="http://docs.vagrantup.com/v2/synced-folders/nfs.html">More</a>). If you are on
Windows then this can already be the problem (Virtualbox FS is slow with
Symfony, because of the large number of files.)</li>
<li>You have the Vbox Guest Additions on the guest that match your system (<a class="reference external" href="https://github.com/dotless-de/vagrant-vbguest">Vagrant Plugin</a>, <a class="reference external" href="https://gist.github.com/fernandoaleman/5083680">Manual Update</a>)</li>
<li>You have an opcode cache installed, either <cite>apc</cite> or <cite>opcache</cite>.</li>
<li>You disable <cite>xdebug</cite> or <cite>xhprof</cite>.</li>
</ul>
<p>Without looking at an actual benchmark (mistake!) I always considered the problem to be
related to the huge number of files that a Symfony project normally ships with
and the I/O that is generated from <tt class="docutils literal"><span class="pre">filemtime</span></tt> calls to check if the
configuration files have changed.</p>
<p>This is just a small part, there are other bottlenecks that I have found after
finally doing some benchmarking with <a class="reference external" href="https://github.com/facebook/xhprof">XHProf</a>, leading to a simple fix:</p>
<ol class="arabic simple">
<li>Monolog logs to the NFS share and the huge number <tt class="docutils literal"><span class="pre">fwrite</span></tt> take their toll.</li>
<li>Writing compiled Twig templates to the NFS share using <tt class="docutils literal"><span class="pre">file_put_contents</span></tt>.</li>
<li>Assetic: Scanning for stylesheets and javascripts within templates is very
slow, causing lots of I/O on the NFS share and CPU and changing it to using
explicit bundling in the <tt class="docutils literal"><span class="pre">app/config/config.yml</span></tt> helps alot. You can use a
cronjob deployed by Puppet/Chef that invokes the <cite>assetic:dump</cite> command with
a <cite>–watch</cite> flag in the background.</li>
<li>JMSDiExtraBundle scans for Services to check for changes on service objects.</li>
<li><tt class="docutils literal"><span class="pre">ReplaceAliasWithActualDefinitionPass</span></tt> in Symfony DIC uses a set of
recursive algorithms to replace aliases with the real services. That takes a
huge amount of time in bigger applications including amounting calls to methods
inside the pass over 100.000 times.</li>
</ol>
<p>The slowest bottlenecks listed (1-4) are I/O bound, directly related to NFS.
To fix this just change the cache <strong>AND</strong> the log directory to
<tt class="docutils literal"><span class="pre">sys_get_temp_dir()</span></tt> or shared memory (/dev/shm) instead of writing to the
NFS share. I actually tried this before, but since I forgot the log directory,
this felt equally slow and I reverted the change.</p>
<p>Here is the code you should add to your <tt class="docutils literal"><span class="pre">AppKernel</span></tt> to give you a
considerable performance boost on a Vagrant box:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">AppKernel</span> <span class="k">extends</span> <span class="nx">Kernel</span>
<span class="p">{</span>
    <span class="c1">// ...</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getCacheDir</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">environment</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'dev'</span><span class="p">,</span> <span class="s1">'test'</span><span class="p">)))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s1">'/dev/shm/appname/cache/'</span> <span class="o">.</span>  <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">environment</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">getCacheDir</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">getLogDir</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nb">in_array</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">environment</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'dev'</span><span class="p">,</span> <span class="s1">'test'</span><span class="p">)))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s1">'/dev/shm/appname/logs'</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">getLogDir</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This brings the page rendering speeds down to between 0.5 and 1.5 seconds, which
is quite normal for the development environment even outside a virtual machine.</p>
<p>This tip obviously works for any kind of application that has a I/O intensive
development environment: Don’t perform this operations on the NFS share unless
you wan’t to suffer.</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        <div class="categories">
            <span>
                Filed under:
                
                    <a href="categories/php.html">PHP</a>,
                
                    <a href="categories/symfony.html">Symfony</a>
                
            </span>
        </div>
        
        <div class="tags">
            <span>
                Tags:
                
                    <a href="tags/php.html">PHP</a>,
                
                    <a href="tags/symfony.html">Symfony</a>
                
            </span>
        </div>
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2013/08/19/speedup_symfony2_on_vagrant_boxes.html#disqus_thread" data-disqus-identifier="2013/08/19/speedup_symfony2_on_vagrant_boxes">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>August 09, 2013</span> 
        </div>
        <div class="section" id="your-service-layer-benefits-from-a-dispatcher">
<h1><a href="2013/08/09/your_service_layer_benefits_from_a_dispatcher.html">Your Service Layer benefits from a Dispatcher</a></h1>
<p>One benefit of recent applications over old 90s, early 2000 style PHP is
central dispatching of requests through one <tt class="docutils literal"><span class="pre">Application</span></tt> or <tt class="docutils literal"><span class="pre">Dispatcher</span></tt>
object. This is true for dispatching objects such as PHPs <tt class="docutils literal"><span class="pre">SoapServer</span></tt> or
<tt class="docutils literal"><span class="pre">Zend\XmlRpc\Server</span></tt> as well. Old style applications use the
webserver (Apache, Nginx) for the dispatching of routes to executed PHP
scripts.</p>
<p>Central dispatching allows developers to hook into central events during the
request processing to implement security, routing, caching, debugging, logging,
localization and many things more transparently.</p>
<p>If you check this list of features, these are all cross-cutting concerns to
the real purpose of your application and nicely abstracted from the core
of your application using central dispatching.</p>
<p>When building a future proof system focussing on the domain and starting
test-driven without dependency on a framework and UI, we often use the <a class="reference external" href="http://martinfowler.com/eaaCatalog/serviceLayer.html">Service
Layer Pattern</a> to
decouple our business logic from technical implementation details. The service
layer however is affected by cross-cutting concerns again and this blog-post
is about finding a maintainable solution to handle them.</p>
<div class="section" id="service-layer-without-dispatching">
<h2>Service Layer without Dispatching</h2>
<p>As a practical example I will pick the classical user registration example,
starting with a service-layer that implements the cross-cutting
concerns inside the service method:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">UserService</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">create</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nv">$password</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">security</span><span class="o">-&gt;</span><span class="na">assertNotLoggedInAlready</span><span class="p">();</span>

        <span class="nv">$user</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">User</span><span class="p">();</span>
        <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">setEmail</span><span class="p">(</span><span class="nv">$email</span><span class="p">);</span>
        <span class="nv">$user</span><span class="o">-&gt;</span><span class="na">encodePassword</span><span class="p">(</span><span class="nv">$password</span><span class="p">);</span>

        <span class="nv">$violations</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">validator</span><span class="o">-&gt;</span><span class="na">validate</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">count</span><span class="p">(</span><span class="nv">$violations</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nx">\IllegalArgumentException</span><span class="p">(((</span><span class="nx">string</span><span class="p">)</span><span class="nv">$violations</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span>

        <span class="nv">$message</span> <span class="o">=</span> <span class="s2">&quot;Thanks for registering! Please click here: ...&quot;</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mailer</span><span class="o">-&gt;</span><span class="na">sendMessage</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nv">$message</span><span class="p">);</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span><span class="o">-&gt;</span><span class="na">info</span><span class="p">(</span><span class="s2">&quot;New user registration: &quot;</span> <span class="o">.</span> <span class="nv">$email</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is quickly getting out of hands with the number of services needed and you
will not have fun testing this for example. This approach violates the
Single-Responsibility-Princple (SRP) doing way too much non-related operations.
Think about having to do this in every method of your service layer and you
can already see this leads to lots of spagetti-code.</p>
</div>
<div class="section" id="using-the-decorator-pattern">
<h2>Using the Decorator Pattern</h2>
<p>We could use the decorator pattern to extract some of the cross-cutting concerns
into their own services. This requires to introduce an interface for <tt class="docutils literal"><span class="pre">UserService</span></tt>
and then building decorators for the different concerns. Then the service
can be built as a decorator chain:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$userService</span> <span class="o">=</span>
    <span class="k">new</span> <span class="nx">LogUserService</span><span class="p">(</span>
        <span class="k">new</span> <span class="nx">SecurityUserService</span><span class="p">(</span>
            <span class="k">new</span> <span class="nx">DoctrineTransactionUserService</span><span class="p">(</span>
                <span class="k">new</span> <span class="nx">UserService</span><span class="p">(),</span> <span class="o">...</span>
            <span class="p">),</span> <span class="o">...</span>
        <span class="p">),</span> <span class="o">...</span>
    <span class="p">);</span>
</pre></div>
</div>
<p>The real <tt class="docutils literal"><span class="pre">UserService</span></tt> will slimmer and more closely handling just the
business logic related information. Using decorators requires us to write the
same delegation code <strong>for every</strong> method on every service, introducing many
decorators and interfaces that duplicate lots of code.  Something we want to
avoid to keep our own sanity.</p>
</div>
<div class="section" id="introducing-a-dispatcher">
<h2>Introducing a Dispatcher</h2>
<p>Lets refactor from decorator towards a dispatching approach instead, to
keep more reusable. The <tt class="docutils literal"><span class="pre">CommandDispatcher</span></tt> object accepts a service name
and method and calls it. We can wrap every call with cross-cutting
concerns.</p>
<p>Starting with a very simple dispatcher possible that just delegates the calls
to registered services, we add all the cross-cutting concerns our application
needs. Note: This is <strong>deliberatly written without further abstraction</strong>, just
to show the concept. The real thing would propably seperate the
responsibilities from each other.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">CommandDispatcher</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$services</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">registerService</span><span class="p">(</span><span class="nv">$serviceName</span><span class="p">,</span> <span class="nv">$service</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">services</span><span class="p">[</span><span class="nv">$serviceName</span><span class="p">]</span> <span class="o">=</span> <span class="nv">$service</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">execute</span><span class="p">(</span><span class="nv">$serviceName</span><span class="p">,</span> <span class="nv">$method</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$params</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$service</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">services</span><span class="p">[</span><span class="nv">$serviceName</span><span class="p">];</span> <span class="c1">// make lazy</span>
        <span class="nv">$callback</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="nv">$service</span><span class="p">,</span> <span class="nv">$method</span><span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span><span class="nv">$serviceName</span> <span class="o">===</span> <span class="s2">&quot;user&quot;</span> <span class="o">&amp;&amp;</span> <span class="nv">$method</span> <span class="o">===</span> <span class="s2">&quot;create&quot;</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertNotLoggedInAlready</span><span class="p">();</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$result</span> <span class="o">=</span> <span class="nb">call_user_func_array</span><span class="p">(</span><span class="nv">$callback</span><span class="p">,</span> <span class="nv">$params</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>

            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">mailer</span><span class="o">-&gt;</span><span class="na">sendQueuedMails</span><span class="p">();</span> <span class="c1">// &quot;deferred commit&quot; of mails</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">logger</span><span class="o">-&gt;</span><span class="na">info</span><span class="p">(</span><span class="s2">&quot;Called </span><span class="si">$serviceName</span><span class="s2">.</span><span class="si">$method</span><span class="s2">&quot;</span><span class="p">);</span>

        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entityManager</span><span class="o">-&gt;</span><span class="na">rollBack</span><span class="p">();</span>
            <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The dispatcher handles transactions around all the commands and also makes sure
that when they send emails, those only get send when the transaction was
successful. It checks if the user has the correct access
controls/authentication and performs some generic logging.</p>
<p>And using the dispatcher in your code looks like this:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$dispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CommandDispatcher</span><span class="p">();</span>
<span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">registerService</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="k">new</span> <span class="nx">UserService</span><span class="p">());</span>

<span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="s1">'create'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nv">$password</span><span class="p">));</span>
</pre></div>
</div>
<p>Like the front controller in MVC or PHPs <tt class="docutils literal"><span class="pre">SOAPServer</span></tt> you register
services/functions with the dispatcher. Registration of services can be done by
convention, via some DependencyInjection Container Service name or any other
way you prefer. The dispatcher then handles ALL commands by wrapping them
inside some generic logic.</p>
<p>Compared to the Decorator approach, you can now easily reuse this code with
many commands. Except registering new services, no new code is necessary when
adding a new method or service.</p>
</div>
<div class="section" id="a-better-api-for-the-dispatcher">
<h2>A better API for the Dispatcher</h2>
<p>So far the API of the dispatcher is tedious, so lets work a little bit on how
you actually call methods on the service-layer.</p>
<p>There are two ways to make this call nicer. The first is use magic <tt class="docutils literal"><span class="pre">__call</span></tt> and some
clever duck-typing to create an API similar to this:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$dispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CommandDispatcher</span><span class="p">();</span>
<span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">registerService</span><span class="p">(</span><span class="s1">'user'</span><span class="p">,</span> <span class="k">new</span> <span class="nx">UserService</span><span class="p">());</span>

<span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">user</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">create</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nv">$password</span><span class="p">);</span>
</pre></div>
</div>
<p>The second approach does not require magic <tt class="docutils literal"><span class="pre">__call</span></tt>, but requires you to write a class for each
command. We map the command class name to a callback:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="nv">$userService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">UserService</span><span class="p">();</span>

<span class="nv">$dispatcher</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">CommandDispatcher</span><span class="p">();</span>
<span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">registerCommand</span><span class="p">(</span><span class="s1">'CreateUserCommand'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="nv">$userService</span><span class="p">,</span> <span class="s1">'create'</span><span class="p">));</span>

<span class="nv">$dispatcher</span><span class="o">-&gt;</span><span class="na">handle</span><span class="p">(</span><span class="k">new</span> <span class="nx">CreateUserCommand</span><span class="p">(</span><span class="nv">$email</span><span class="p">,</span> <span class="nv">$password</span><span class="p">));</span>
</pre></div>
</div>
<p>The naming is very techincal here, but since the dispatcher also acts as a
facade to the application, we could give it better names like
<tt class="docutils literal"><span class="pre">PayrollApplication</span></tt>, <tt class="docutils literal"><span class="pre">Shop</span></tt>, <tt class="docutils literal"><span class="pre">TrackingSystem</span></tt>, any name the application
has inside your organization.</p>
</div>
<div class="section" id="discussion">
<h2>Discussion</h2>
<p>Now that I have shown the implementation of a dispatcher a small discussion
is necessary to evaluate it. The cross-cutting concerns could be nicely
wrapped in the dispatcher, so we achieved a considerable improvement
over the first example with all the concerns nicely seperated from each other.</p>
<p>The benefits are:</p>
<ul class="simple">
<li>Services themself don’t need access to the cross-cutting concerns anymore,
reducing the number of dependencies and increasing maintainability and
testability.</li>
<li>Handling cross-cutting concerns, that can make the service layer code very
complex otherwise, in a clean way</li>
<li>All the concerns are easily composable and the result is a SOLID approach towards them.</li>
<li>The dispatcher also allows us to add or remove concerns later at one central
location without having to change all the service layer code.</li>
<li>The framework we use can be very simple as long it fullfils the major
requirement to be easily compatible to the dispatcher approach.</li>
<li>Compared to an MVC frameworks dispatcher, our service dispatcher can tailored
to the application itself and end up being very small and easily
understandable.</li>
</ul>
<p>How do we use this dispatcher in our MVC framework though? Instead of using
controllers/actions a REST or SOAP API could just use the dispatching and
services directly and map the HTTP request to it based on convention. This
would be a real win and simplify the framework-glue code considerably.</p>
<p>In a web-application however this is not so simple. We need to send redirects,
manage session state and handle request and response data, which often requires one
specific controller-action for each command. With some experimentation
it might be possible to achieve a much higher re-use here, but it might fail as
well.</p>
<p>That brings us to the downside of the dispatcher approach:</p>
<ul class="simple">
<li>We need some additional code and extra classes, which might be too much for
small applications and the indirection of handling cross-cutting concerns
might confuse teammates.</li>
<li>Having the dispatcher object inside controllers feels strange from the MVC
point of view, it doesn’t really fit. It also still may require implementing
one action for every command, not simplifying this part of the development.</li>
<li>While other languages don’t need this because of their support for AOP and
annotations (Spring for Java for example) this is necessary in PHP only,
because we don’t have this features.</li>
<li>Unless we use the explicit command object approach, there is no
auto-completion for commands on the dispatcher in the IDEs.</li>
</ul>
<p>My conclusion from working with both kind of service layers: If you decided for
such a service layer, then my experience shows it is a mistake not to use a
dispatcher, because the benefits outweigh the downsides.</p>
</div>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2013/08/09/your_service_layer_benefits_from_a_dispatcher.html#disqus_thread" data-disqus-identifier="2013/08/09/your_service_layer_benefits_from_a_dispatcher">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>July 24, 2013</span> 
        </div>
        <div class="section" id="doctrine-and-domain-events">
<h1><a href="2013/07/24/doctrine_and_domainevents.html">Doctrine and Domain Events</a></h1>
<p>I have written about the <a class="reference external" href="/2012/08/25/decoupling_applications_with_domain_events.html">Domain Event Pattern</a> before and want
to focus on this pattern again by explaining its integration into the Doctrine
ORM on a very technical level.</p>
<p>The Domain Event Pattern allows to attach events to entities and dispatch them
to event listeners only when the transaction of the entity was successfully
executed. This has several benefits over traditional event dispatching
approaches:</p>
<ul class="simple">
<li>Puts focus on the behavior in the domain and what changes the domain
triggers.</li>
<li>Promotes decoupling in a very simple way</li>
<li>No reference to the event dispatcher and all the listeners required except in
the Doctrine UnitOfWork.</li>
<li>No need to use unexplicit Doctrine Lifecycle events that are triggered on all
update operations.</li>
</ul>
<p>This blog post will introduce a very simple implementation for Domain Events
with Doctrine2. You should be able to easily extend it to be more flexible,
reliable or optionally even asynchronuous. I skip some of the glue code in this blog post,
but you can try the full code by checking out <a class="reference external" href="https://gist.github.com/beberlei/53cd6580d87b1f5cd9ca">this Gist</a> and running
<tt class="docutils literal"><span class="pre">composer</span> <span class="pre">install</span></tt> and then <tt class="docutils literal"><span class="pre">php</span> <span class="pre">domain_events.php</span></tt>.</p>
<p>Lets look at the following entity, an <tt class="docutils literal"><span class="pre">InventoryItem</span></tt> tracking the number
we have this item in stock:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyProject\Domain</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\Mapping</span> <span class="k">as</span> <span class="nx">ORM</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">MyProject\DomainSuperTypes\AggregateRoot</span><span class="p">;</span>

<span class="sd">/**</span>
<span class="sd"> * @Entity</span>
<span class="sd"> */</span>
<span class="k">class</span> <span class="nc">InventoryItem</span> <span class="k">extends</span> <span class="nx">AggregateRoot</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @Id @GeneratedValue @Column(type=&quot;integer&quot;)</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$id</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$name</span><span class="p">;</span>
    <span class="sd">/**</span>
<span class="sd">     * @Column(type=&quot;integer&quot;)</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$name</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">name</span> <span class="o">=</span> <span class="nv">$name</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">raise</span><span class="p">(</span><span class="s1">'InventoryItemCreated'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'name'</span> <span class="o">=&gt;</span> <span class="nv">$name</span><span class="p">));</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">checkIn</span><span class="p">(</span><span class="nv">$count</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">counter</span> <span class="o">+=</span> <span class="nv">$count</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">raise</span><span class="p">(</span><span class="s1">'ItemsCheckedIntoInventory'</span><span class="p">,</span> <span class="k">array</span><span class="p">(</span><span class="s1">'count'</span> <span class="o">=&gt;</span> <span class="nv">$count</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>We want this entity to raise two domain events using the <tt class="docutils literal"><span class="pre">raise($eventName,</span>
<span class="pre">array</span> <span class="pre">$properties)</span></tt> method.  Our preferred use case for this code looks like this:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$item</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">InventoryItem</span><span class="p">(</span><span class="s1">'Cookies'</span><span class="p">);</span>
<span class="nv">$item</span><span class="o">-&gt;</span><span class="na">checkIn</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">persist</span><span class="p">(</span><span class="nv">$item</span><span class="p">);</span>
<span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">flush</span><span class="p">();</span> <span class="c1">// fire events here</span>
</pre></div>
</div>
<p>One or many listeners should react to the events being fired, for example print their contents to the screen:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">EchoInventoryListener</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">onInventoryItemCreated</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;New item created with name %s</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">onItemsCheckedIntoInventory</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nb">printf</span><span class="p">(</span><span class="s2">&quot;There were %d new items checked into inventory</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">count</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>As the first building block, we need a <a class="reference external" href="http://martinfowler.com/eaaCatalog/layerSupertype.html">Layer Supertype</a> for our entities,
called <tt class="docutils literal"><span class="pre">AggregateRoot</span></tt> adding the event raising capabilities to all entities that need it:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyProject\DomainSuperTypes</span><span class="p">;</span>

<span class="k">abstract</span> <span class="k">class</span> <span class="nc">AggregateRoot</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$events</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">popEvents</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$events</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">events</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">events</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

        <span class="k">return</span> <span class="nv">$events</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">raise</span><span class="p">(</span><span class="nv">$eventName</span><span class="p">,</span> <span class="k">array</span> <span class="nv">$properties</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">events</span><span class="p">[]</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DomainEvent</span><span class="p">(</span><span class="nv">$eventName</span><span class="p">,</span> <span class="nv">$properties</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This class allows us to add events to an entity using <tt class="docutils literal"><span class="pre">raise()</span></tt> as we have
seen in the <tt class="docutils literal"><span class="pre">InventoryItem</span></tt> entity before.</p>
<p>Now we need Doctrine to process the events during a transaction (<tt class="docutils literal"><span class="pre">flush()</span></tt>).
We do this by keeping all entities with domain events, and then triggering
the domain events after the transaction has completed. This is a vital part
of the domain events pattern, because it guarantees every listener that the
state leading to the event is already in the database.</p>
<p>Technically we implement this with a Doctrine EventListener that listeners for
the <tt class="docutils literal"><span class="pre">postFlush</span></tt>, <tt class="docutils literal"><span class="pre">postPersist</span></tt>, <tt class="docutils literal"><span class="pre">postUpdate</span></tt> and <tt class="docutils literal"><span class="pre">postRemove</span></tt> events:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">MyProject\DomainEvents</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\ORM\EntityManager</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">MyProject\DomainSuperTypes\AggregateRoot</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">DomainEventListener</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$entities</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">postPersist</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">keepAggregateRoots</span><span class="p">(</span><span class="nv">$event</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">postUpdate</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">keepAggregateRoots</span><span class="p">(</span><span class="nv">$event</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">postRemove</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">keepAggregateRoots</span><span class="p">(</span><span class="nv">$event</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">postFlush</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$entityManager</span> <span class="o">=</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getEntityManager</span><span class="p">();</span>
        <span class="nv">$evm</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">getEventManager</span><span class="p">();</span>

        <span class="k">foreach</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entities</span> <span class="k">as</span> <span class="nv">$entity</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$class</span> <span class="o">=</span> <span class="nv">$entityManager</span><span class="o">-&gt;</span><span class="na">getClassMetadata</span><span class="p">(</span><span class="nb">get_class</span><span class="p">(</span><span class="nv">$entity</span><span class="p">));</span>

            <span class="k">foreach</span> <span class="p">(</span><span class="nv">$entity</span><span class="o">-&gt;</span><span class="na">popEvents</span><span class="p">()</span> <span class="k">as</span> <span class="nv">$event</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">setAggregate</span><span class="p">(</span><span class="nv">$class</span><span class="o">-&gt;</span><span class="na">name</span><span class="p">,</span> <span class="nv">$class</span><span class="o">-&gt;</span><span class="na">getSingleIdReflectionProperty</span><span class="p">()</span><span class="o">-&gt;</span><span class="na">getValue</span><span class="p">(</span><span class="nv">$entity</span><span class="p">));</span>
                <span class="nv">$evm</span><span class="o">-&gt;</span><span class="na">dispatchEvent</span><span class="p">(</span><span class="s2">&quot;on&quot;</span> <span class="o">.</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getName</span><span class="p">(),</span> <span class="nv">$event</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entities</span> <span class="o">=</span> <span class="k">array</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">function</span> <span class="nf">keepAggregateRoots</span><span class="p">(</span><span class="nv">$event</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$entity</span> <span class="o">=</span> <span class="nv">$event</span><span class="o">-&gt;</span><span class="na">getEntity</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nv">$entity</span> <span class="nx">instanceof</span> <span class="nx">AggregateRoot</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">entities</span><span class="p">[]</span> <span class="o">=</span> <span class="nv">$entity</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now we only need to put this code together with Doctrine to get it working:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="nv">$evm</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">EventManager</span><span class="p">();</span>
<span class="nv">$evm</span><span class="o">-&gt;</span><span class="na">addEventListener</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">'postInsert'</span><span class="p">,</span> <span class="s1">'postUpdate'</span><span class="p">,</span> <span class="s1">'postRemove'</span><span class="p">,</span> <span class="s1">'postFlush'</span><span class="p">),</span>
    <span class="k">new</span> <span class="nx">DomainEventListener</span><span class="p">()</span>
<span class="p">);</span>
<span class="nv">$evm</span><span class="o">-&gt;</span><span class="na">addEventListener</span><span class="p">(</span>
    <span class="k">array</span><span class="p">(</span><span class="s1">'onInventoryItemCreated'</span><span class="p">,</span> <span class="s1">'onItemsCheckedIntoInventory'</span><span class="p">),</span>
    <span class="k">new</span> <span class="nx">EchoInventoryListener</span>
<span class="p">);</span>
<span class="nv">$conn</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span><span class="cm">/* data */</span><span class="p">);</span>
<span class="nv">$config</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Configuration</span><span class="p">();</span>
<span class="nv">$entityManager</span> <span class="o">=</span> <span class="nx">EntityManager</span><span class="o">::</span><span class="na">create</span><span class="p">(</span><span class="nv">$conn</span><span class="p">,</span> <span class="nv">$config</span><span class="p">,</span> <span class="nv">$evm</span><span class="p">);</span>
</pre></div>
</div>
<p>Now the example from above, creating and checking in inventory items
will trigger the <tt class="docutils literal"><span class="pre">EchoInventoryListener</span></tt> and print the data to the screen.</p>
<p>This example is very simple but shows how you can incorporate Domain Events into
your Doctrine projects. The following improvements can be made if necessary:</p>
<ul class="simple">
<li>Use a base EventSubscriber for the Domain Listeners, that automatically
registers all the domain event listener methods. This way you don’t have
to manually list them when calling <tt class="docutils literal"><span class="pre">$evm-&gt;addListener()</span></tt>.</li>
<li>Implement one class for every domain event, allowing to typehint the events
in listeners, with much more helpful information about the contained data.</li>
<li>If you prefer asynchroneous processing, serialize the events into a
<cite>domain_events</cite> table instead of triggering the events directly.
Add a daemon to your project that tails the table and triggers the events
in the background.</li>
</ul>
<p>I hope this blog post helps you when considering to use Domain Events Pattern with
Doctrine. Again, <a class="reference external" href="https://gist.github.com/beberlei/53cd6580d87b1f5cd9ca">see the code on this Gist</a> for a working example.</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        <div class="categories">
            <span>
                Filed under:
                
                    <a href="categories/php.html">PHP</a>
                
            </span>
        </div>
        
        <div class="tags">
            <span>
                Tags:
                
                    <a href="tags/php.html">PHP</a>,
                
                    <a href="tags/doctrine.html">Doctrine</a>,
                
                    <a href="tags/domainevents.html">DomainEvents</a>,
                
                    <a href="tags/patterns.html">Patterns</a>
                
            </span>
        </div>
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2013/07/24/doctrine_and_domainevents.html#disqus_thread" data-disqus-identifier="2013/07/24/doctrine_and_domainevents">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>June 27, 2013</span> 
        </div>
        <div class="section" id="extending-symfony2-controller-utilities">
<h1><a href="2013/06/27/extending_symfony2__controller_utilities.html">Extending Symfony2: Controller Utilities</a></h1>
<p>Controllers as a service are a heated topic in the Symfony world. Developers
mainly choose to extend the base class, because its much simpler to use and
less to write. But less to write is not necessarily true.</p>
<div class="section" id="the-problem-injecting-tons-of-services">
<h2>The problem: Injecting tons of services</h2>
<p>The Symfony controller base class uses quite a lot of services, if
you need them in your controller as a service, you have to inject them:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">UserController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">_construct</span><span class="p">(</span>
        <span class="nx">RouterInterface</span> <span class="nv">$router</span><span class="p">,</span>
        <span class="nx">EngineInterface</span> <span class="nv">$engine</span><span class="p">,</span>
        <span class="nx">HttpKernel</span> <span class="nv">$kernel</span><span class="p">,</span>
        <span class="nx">FormFactoryInterface</span> <span class="nv">$formFactory</span><span class="p">,</span>
        <span class="nx">SecurityContextInterface</span> <span class="nv">$security</span>
    <span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">router</span> <span class="o">=</span> <span class="nv">$router</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">engine</span> <span class="o">=</span> <span class="nv">$engine</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">kernel</span> <span class="o">=</span> <span class="nv">$kernel</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">formFactory</span> <span class="o">=</span> <span class="nv">$formFactory</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">security</span> <span class="o">=</span> <span class="nv">$security</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>There are some problems here:</p>
<ul class="simple">
<li>The services are not loaded lazily, we probably end up with a resource overuse here.</li>
<li>The constructor is MUCH too big, this doesn’t even include your own
application, database or mailer services.</li>
</ul>
</div>
<div class="section" id="the-quick-and-dirty-solution">
<h2>The quick and dirty solution</h2>
<p>You could as a first solution, inject the container into your controller.
But this is actually the same as just using the base controller from Symfony
or just use the <tt class="docutils literal"><span class="pre">ContainerAware</span></tt> interface in a controller of your own.</p>
</div>
<div class="section" id="the-solution-introduce-a-utilities-service">
<h2>The solution: Introduce a Utilities Service</h2>
<p>To avoid the mentioned problems with controller as a service, introduce a
controller utilities service and register it as <tt class="docutils literal"><span class="pre">controller_utils</span></tt> service:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">ControllerUtils</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$container</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">createForm</span><span class="p">(</span><span class="nv">$type</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$options</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ..</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">render</span><span class="p">(</span><span class="nv">$template</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// ..</span>
    <span class="p">}</span>
    <span class="c1">// ...</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You can implement this by just copying the over from
<tt class="docutils literal"><span class="pre">Symfony\Bundle\FrameworkBundle\Controller\Controller</span></tt> all the methods you
need.</p>
<p>Then you can simplify the controller as a service:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">UserController</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$utils</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">_construct</span><span class="p">(</span><span class="nx">ControllerUtils</span> <span class="nv">$utils</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">utils</span> <span class="o">=</span> <span class="nv">$utils</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>You don’t have to stop here. You can introduce lots of helper objects
and inject them into your controller, depending on your use-cases.
Generic handling of file uploads comes to mind for example.</p>
<p>From medium to large applications this can lead to much smaller
controllers, because they can much more easily reuse code between
each other than in the case of inheritance.</p>
</div>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        
        <div class="tags">
            <span>
                Tags:
                
                    <a href="tags/symfony.html">Symfony</a>
                
            </span>
        </div>
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2013/06/27/extending_symfony2__controller_utilities.html#disqus_thread" data-disqus-identifier="2013/06/27/extending_symfony2__controller_utilities">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>June 24, 2013</span> 
        </div>
        <div class="section" id="bounded-contexts">
<h1><a href="2013/06/24/bounded_contexts.html">Bounded Contexts</a></h1>
<p>I regularly fall into the same trap when building applications: Trying to find
the one model that unifies all the use-cases and allows to solve every problem.
From discussions with other developers I know not to be the only one making this
mistake.</p>
<p>It is propably a human trait trying to find the one line that connects
every dot. However in software design there is a case to be made for the
separation of contexts to tackle complexity. Eric Evans described this in detail with the
<a class="reference external" href="http://dddcommunity.org/uncategorized/bounded-context/">“Bounded Context”</a> pattern in his
“Domain-Driven Design” book. According to an interview with Evans I read
somewhere, he considers it one of the most important patterns in the whole book.</p>
<p>The essence of this strategic pattern is to embrance the separation of
different parts of an application and develop different models as different
domain contexts. Consistency and constraints are enforced within one context,
but don’t necessarily hold in another context.</p>
<p>The goal is simplication and freeing us from the burden of finding that one
model that fits all use cases. It is much less awkward to have some parts of
the model reimplemented for different purposes than creating God objects that
try to unify everything, and failing at this task.</p>
<p>Evans goes even further and introduces a significant amount of patterns
that describe the relationship between different bounded contexts.</p>
<div class="section" id="an-experiment">
<h2>An Experiment</h2>
<p>At the <a class="reference external" href="http://www.socrates-conference.de/">SoCraTes conference</a> in August
last year, I participated in a DDD architecture game by <a class="reference external" href="https://twitter.com/cyriux">Cyrille Martraire</a> that focused on distilling bounded contexts. We
were given a very simple domain concept “Customer” and assigned different roles
in the business.</p>
<p>Everyone described their perfect customer very differently, imagining the
Customer object that fits all these requirements was quite an eye opener. Even
if there is no such single software that operates a business, going to the
extreme and defining 10 different angles for a single concept made me clear,
that sometimes different overlapping implementations are not such a bad thing.</p>
</div>
<div class="section" id="problems-and-solutions">
<h2>Problems and Solutions</h2>
<p>One problem when applying bounded contexts is data synchronization.
Synchronization between contexts can be reached in many different ways,
three of which are:</p>
<ol class="arabic simple">
<li>The <a class="reference external" href="http://martinfowler.com/eaaDev/DomainEvent.html">Domain Event</a> pattern that integrates
nicelly into Domain-Driven Design and simplifies the synchronization with
other parts of an application.</li>
<li>Correlation Ids of the same entity into the different contexts and a clean
seperation of the data (no shared data necessary).</li>
<li>Another way are immutable read models (value objects) of the data managed in
another context (entity).</li>
</ol>
<p>In any way relying on <a class="reference external" href="http://en.wikipedia.org/wiki/Eventual_consistency">Eventual
Consistency</a> helps
solving the synchronization problem.</p>
<p>Depending on how your bounded contexts seperate from each other, duplication of
classes is necessary as well. This is something that has to be accounted for
and you should make sure that only one context is responsible for changing the
same data. Different contexts can have different behaviors on the same data.
This is actually a point where Domain-Driven Design and <a class="reference external" href="http://www.whitewashing.de/2012/08/16/oop_business_applications__data__context__interaction.html">Data, Context and
Interaction (DCI)</a>
intersect.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>Applying bounded contexts to an application or a cluster of applications helps
developers and domain experts to focus on problems in their specific context.
Sometimes each context even has its own domain-expert. The benefit for
developers is a simplified abstraction of different parts of the modelled
problem.</p>
</div>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2013/06/24/bounded_contexts.html#disqus_thread" data-disqus-identifier="2013/06/24/bounded_contexts">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>May 23, 2013</span> 
        </div>
        <div class="section" id="symfony2-on-windows-azure-websites">
<h1><a href="2013/05/23/symfony2_on_windows_azure_websites.html">Symfony2 on Windows Azure Websites</a></h1>
<p>With the Windows Azure Websites platform-as-a-service (PaaS), which was
released as a preview to a general audiance in June last year, PHP applications
can be deployed to Azure with as much as a Git push to a remote repository. At
the same time Microsoft released a new and much improved <a class="reference external" href="https://github.com/WindowsAzure/azure-sdk-for-php">PHP SDK</a>, which
integrates with all the Azure webservices.</p>
<p>I blogged about deployment with Composer on Azure Websites last November and
since then I have been working with Microsoft to improve Symfony2 support on
Windows Azure by developing and releasing the <a class="reference external" href="https://github.com/beberlei/AzureDistributionBundle">AzureDistributionBundle</a>. This is a new version
of the bundle and contains the following improvements:</p>
<ul class="simple">
<li>Full support for the PHP SDK through the DependencyInjection container</li>
<li>Installation of project dependendencies using Composer during deployment.
I will blog about the Composer support in much more detail in the next
days, because this information is not only valuable for Symfony2 projects.</li>
<li>a <a class="reference external" href="https://github.com/beberlei/symfony-azure-edition">full demo application</a> (derived from
symfony-standard) to show PHP, Symfony &amp; Azure integration</li>
<li>documentation of the Windows Azure Websites deployment process and
possiblities for PHP configuration</li>
<li>a Stream Wrapper for Azure Blob Storage, currently being reviewed for
inclusion into the Azure PHP SDK itself.</li>
</ul>
<p>You can install both the Bundle or the Demo application via Composer.
For the Demo application call:</p>
<div class="highlight-python"><pre>$ php composer.phar create-project beberlei/symfony-azure-edition</pre>
</div>
<p>The README includes more information about how to deploy the demo
to your Azure websites account.</p>
<p>The bundle can be installed using the following <tt class="docutils literal"><span class="pre">composer.json</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">{</span>
    <span class="s">&quot;require&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s">&quot;beberlei/azure-distribution-bundle&quot;</span><span class="p">:</span> <span class="s">&quot;*&quot;</span>
    <span class="p">},</span>
    <span class="s">&quot;repositories&quot;</span><span class="p">:</span> <span class="p">[</span>
        <span class="p">{</span>
            <span class="s">&quot;type&quot;</span><span class="p">:</span> <span class="s">&quot;pear&quot;</span><span class="p">,</span>
            <span class="s">&quot;url&quot;</span><span class="p">:</span> <span class="s">&quot;http://pear.php.net&quot;</span>
        <span class="p">}</span>
    <span class="p">],</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Registering PEAR is necessary, because the Azure PHP SDK depends on some PEAR
components.</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        <div class="categories">
            <span>
                Filed under:
                
                    <a href="categories/php.html">PHP</a>
                
            </span>
        </div>
        
        <div class="tags">
            <span>
                Tags:
                
                    <a href="tags/azure.html">Azure</a>
                
            </span>
        </div>
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2013/05/23/symfony2_on_windows_azure_websites.html#disqus_thread" data-disqus-identifier="2013/05/23/symfony2_on_windows_azure_websites">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>April 12, 2013</span> 
        </div>
        <div class="section" id="traits-are-static-access">
<h1><a href="2013/04/12/traits_are_static_access.html">Traits are Static Access</a></h1>
<p>In a Twitter discussion yesterday I formulated my negative opinion
about traits and Matthew asked me to clarify it:</p>
<img alt="http://www.whitewashing.de/_static/traits_are_static_access.png" src="http://www.whitewashing.de/_static/traits_are_static_access.png"/>
<p>I used to look forward to traits as a feature in PHP 5.4, but after discussions
with <a class="reference external" href="http://twitter.com/koredn">Kore</a> I came to the conclusion that traits
are nothing else than static access in disguise. They actually lead to the
exact same code smells. Familiar with the outcome of too much static use,
we should reject traits as just another way of statically coupling your code
to other classes.</p>
<p>Let’s step back and take a look at the code smells that Static code produces:</p>
<ul class="simple">
<li>Tight coupling, no way to exchange at runtime</li>
<li>Not mockable</li>
<li>Static code cannot be overwritten through inheritance</li>
<li>Global state (increases likelihood of unwanted side effects)</li>
</ul>
<p>This blog post shows that Traits actually have the first three problems
themselves and exhibit the same code smells. But they even have some additional
problems on their own:</p>
<ul class="simple">
<li>Not testable in isolation</li>
<li>Theoretically stateless, but not enforced in PHP</li>
<li>Very high impact on the code base (Code-Rank)</li>
</ul>
<p>Take the following code, which tries to implement reusable
controller code through traits:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MyController</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">Redirector</span><span class="p">;</span>

    <span class="k">protected</span> <span class="nv">$container</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">someAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">redirect</span><span class="p">(</span><span class="s2">&quot;route_xyz&quot;</span><span class="p">,</span> <span class="k">array</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="nx">trait</span> <span class="nx">Redirector</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">redirect</span><span class="p">(</span><span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">RedirectResponse</span><span class="p">(</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span><span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">generateUrl</span><span class="p">(</span><span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'router'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span>
            <span class="nv">$routeName</span><span class="p">,</span>
            <span class="nv">$parameters</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Lets spot the problems:</p>
<ol class="arabic">
<li><p class="first"><tt class="docutils literal"><span class="pre">Redirector</span></tt> is tightly coupled to <tt class="docutils literal"><span class="pre">MyController</span></tt>. There is no way to
change this during runtime, by using a different type of redirector, it has
to be exactly the trait used at compile time. This is exactly what static
access enforces as well.</p>
</li>
<li><p class="first">The trait accesses <tt class="docutils literal"><span class="pre">$this-&gt;container</span></tt> without defining it and couples itself against
the implementing classes. We can actually refactor this to include an
abstract method <tt class="docutils literal"><span class="pre">getContainer()</span></tt> in the trait. But if we have multiple
traits now, all having a <tt class="docutils literal"><span class="pre">getContainer()</span></tt> method then we run into method
class problems that cannot be solved. We could pass the container as an
argument to the method, but that actually defeats the purpose of the
abstraction here.</p>
<p>Traits using state of their “parents” usually create bidirectional
coupling between classes, something which should be avoided for good
software design.</p>
</li>
<li><p class="first">No way to overwrite subset of functionality. If I want to use only one
method of a trait and a second one slighty different, then I cannot
overwrite this function of <tt class="docutils literal"><span class="pre">Redirector</span></tt> for example in <tt class="docutils literal"><span class="pre">MyController</span></tt>.</p>
</li>
<li><p class="first">I cannot mock the traits functionality, therefore I cannot test
<tt class="docutils literal"><span class="pre">MyController</span></tt> as a unit only in combination with a trait.</p>
</li>
<li><p class="first">I cannot test the trait as a unit, I always have to create a class
that uses the trait to be able to write a test for it.
This prevents me from testing traits in isolation.</p>
</li>
<li><p class="first">Once you start using <tt class="docutils literal"><span class="pre">Redirector</span></tt> in many controllers, its impact
on your code base (see <a class="reference external" href="http://pdepend.org/documentation/software-metrics/index.html">Code Rank</a>) increases
a lot. Traits are concrete implementations and therefore violate the
Dependency Inversion SOLID principle: Changes in the trait require adoptions
in all the implementing classes.</p>
<p>With aggregation you could depend on an abstraction <tt class="docutils literal"><span class="pre">Redirector</span></tt> or
turn it into an abstraction in the moment that you need different
functionality.</p>
</li>
</ol>
<p>The discovery of this properties of traits me to the conclusion that traits are
just static access in disguise.</p>
<p>To see this argument a bit more drastically, you can “rewrite” a PHP 5.4 trait
into “pseudo” static code:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MyController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$container</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">someAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Redirector</span><span class="o">::</span><span class="na">redirect</span><span class="p">(</span><span class="s2">&quot;route_xyz&quot;</span><span class="p">,</span> <span class="k">array</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Redirector</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">redirect</span><span class="p">(</span><span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">RedirectResponse</span><span class="p">(</span>
            <span class="nx">self</span><span class="o">::</span><span class="na">generateUrl</span><span class="p">(</span><span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">generateUrl</span><span class="p">(</span><span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'router'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span>
            <span class="nv">$routeName</span><span class="p">,</span>
            <span class="nv">$parameters</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Calling dynamic methods statically actually works right now (and access to
<tt class="docutils literal"><span class="pre">$this</span></tt> of the parent class will luckily be removed in PHP 5.5). Let’s
reformulate it into something that is actually using static methods and
will work on 5.5, requires changes to the visibility of properties though:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MyController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$container</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">(</span><span class="nv">$container</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$container</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">someAction</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nx">Redirector</span><span class="o">::</span><span class="na">redirect</span><span class="p">(</span><span class="nv">$this</span><span class="p">,</span> <span class="s2">&quot;route_xyz&quot;</span><span class="p">,</span> <span class="k">array</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">Redirector</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">redirect</span><span class="p">(</span><span class="nv">$thiz</span><span class="p">,</span> <span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">RedirectResponse</span><span class="p">(</span>
            <span class="nx">self</span><span class="o">::</span><span class="na">generateUrl</span><span class="p">(</span><span class="nv">$thiz</span><span class="p">,</span> <span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
        <span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">generateUrl</span><span class="p">(</span><span class="nv">$thiz</span><span class="p">,</span> <span class="nv">$routeName</span><span class="p">,</span> <span class="nv">$parameters</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="nv">$thiz</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'router'</span><span class="p">)</span><span class="o">-&gt;</span><span class="na">generateUrl</span><span class="p">(</span>
            <span class="nv">$routeName</span><span class="p">,</span>
            <span class="nv">$parameters</span>
        <span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Can you see the familiarity? If Traits can be rewritten as calls to static methods,
how can they be any better than static methods? They exhibit the exact same
problems and produce the same code smells.</p>
<p>Conclusion: Traits should be avoided at all costs, just like static methods.</p>
<p>Rule of Thumb: If you want to use a trait, try to think how to solve the
problem with aggregation.</p>
<p>If you want to read more about problems with traits,
<a class="reference external" href="http://blog.ircmaxell.com/2011/07/are-traits-new-eval.html">Anthony</a> wrote
about them quite a while ago.</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        <div class="categories">
            <span>
                Filed under:
                
                    <a href="categories/php.html">PHP</a>
                
            </span>
        </div>
        
        <div class="tags">
            <span>
                Tags:
                
                    <a href="tags/php.html">PHP</a>
                
            </span>
        </div>
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2013/04/12/traits_are_static_access.html#disqus_thread" data-disqus-identifier="2013/04/12/traits_are_static_access">Leave a comment</a>
        </div>
    </div><div class="separator post_separator"></div>
        
        <div class="timestamp postmeta">
            <span>April 06, 2013</span> 
        </div>
        <div class="section" id="lessons-learned-a-failed-side-project">
<h1><a href="2013/04/06/a_failed_side_project.html">Lessons learned: A failed side project</a></h1>
<p>Side projects have always been an important part of how I learn new skills and
technologies. This usually ends with me dumping some prototype on <a class="reference external" href="https://github.com/beberlei?tab=repositories">Github</a>, sometimes even with an open
source project that I commit to maintain over a long time.</p>
<p>Two years ago, for the first time, I pursued a project idea which should
not be open-source but a commercial SAAS product. It grew out of the
<a class="reference external" href="http://www.doctrine-project.org">Doctrine</a> teams desire to synchronize
Github Pull Requests with our Jira instance: A workflow engine for HTTP
services. <a class="reference external" href="https://ifttt.com/">If this, then that (IFTTT)</a> already existed at
that point, but was far too limited for my use-case. I wanted something to
allow:</p>
<ul class="simple">
<li>Accept a Github Pull Request Event</li>
<li>Open a Jira Ticket</li>
<li>Comment back on the Pull Request with a link to the Pull Request</li>
<li>Optionally mention that the Pull Request should be made to master, instead of
<tt class="docutils literal"><span class="pre">$BRANCH</span></tt></li>
</ul>
<p>I started developing this in my free time based on PHP, Symfony2, CouchDB,
PostgreSQL and Backbone.js and got a prototype working early. However
instead of reaching the state where I could release the project to others I
hit some hurdles:</p>
<ol class="arabic simple">
<li>The project had a UI where you could add/remove and reconnect tasks through
a graphical workflow editor. The javascript became very messy fast, because
I didn’t understand Backbone fully and also didn’t know patterns for
decoupling and testing Javascript code.</li>
<li>I had to restart with the core domain service side code, because I based it
on the Zeta Components workflow library and it was too unflexible for my
special requirements, messing the code up.</li>
<li>I wanted to implement way too many features and had a huge backlog of
issues to implement before “beta”.</li>
</ol>
<p>Last year in July, when I finally had something remotely usable <a class="reference external" href="https://zapier.com/">Zapier</a> hit the market with a beautiful product and support
for gazillions of services. At that point my service just had support for
Github, Twitter and Jira and for generic HTTP POST requests and a UI that
could not be operated by anyone else but me. I was quite demotivated
that day I found out about Zapier.</p>
<p>Nevertheless I continued to work on the project and tried to make it even more
powerful than Zapier, by introducing more features that neither IFTTT nor
Zapier had. Adding this complexity ended up being the nail into the coffin of
the project.</p>
<p>Each week I worked less and less on the project, because I couldn’t find the
motivation. When Zapier got funded in October I was both sad and happy:
Apparently my idea was a good one, however somebody else executed this idea
much better than myself. I stopped working on the project that week.</p>
<p>Today I took the day to migrate the Doctrine Pull Request workflow to a
<a class="reference external" href="https://github.com/beberlei/githubpr_to_jira">simple hardcoded application</a>
and disabled my projects website entirely.</p>
<p>I want to use this moment to share my personal lessons learned:</p>
<ul>
<li><p class="first">Choosing a scope that allows you to finish a working prototype within 1-2 months
is an important key to success.</p>
<p>The longer it takes to get something working and useable for others, the less
motivation you have. I know from my open-source experience that people using your project
is a huge motivation boost.</p>
<p>The side projects I started since last October are much smaller in scope.</p>
</li>
<li><p class="first">You can actually get burned out by a side project: by designing its scope
way too big.</p>
</li>
<li><p class="first">You cannot compete feature-wise with startups that put their full attention into
a project from morning to night. Either make something small working better
than commercial products or quit your job and put your full time into this.</p>
</li>
<li><p class="first">Side projects are either about learning new technologies or about trying
to build something commercially successful. Don’t try to combine this or
you might get frustrated by choosing the wrong technology for the job.</p>
</li>
<li><p class="first">Never ever use an existing open-source library as the core of your
complicated business domain. If your domain is something remotely interesting
you will fail to achieve your goals with the restrictions of the library.</p>
</li>
<li><p class="first">Starting a big project alone is not a good idea. I found out that
discussing ideas with people is very valuable and at the point where I
started sharing my idea with others I was already too far into the project
to be able to take most of the advice into account.</p>
</li>
<li><p class="first">Keeping a project idea secret is completely useless. Others will come up with the
same idea regardless. People have ideas all the day, however nobody ever has
time to implement them. When they do, execution is even more important than
the idea itself.</p>
</li>
</ul>
<p>What are your lessons learned from failed side projects? I would be happy to
hear other stories.</p>
</div>
        
    <div class="postmeta">
        
        <div class="author">
            <span>Posted by Benjamin Eberlei</span>
        </div>
        
        
        
        <div class="comments">
            <a href="http://www.whitewashing.de/2013/04/06/a_failed_side_project.html#disqus_thread" data-disqus-identifier="2013/04/06/a_failed_side_project">Leave a comment</a>
        </div>
    </div>
    
    <div class="related">
        <ul>
            <li class="right">
                <a href="page1.html">Older</a> &raquo; 
            </li>
        </ul>
    </div>
    <div class="archive_link">
        <a href="archive.html"> &mdash; Blog Archive &mdash; </a>
    </div>


            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'whitewashing';
                var disqus_url = 'http://www.whitewashing.de/index.html';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
            <a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>
          </div>         
        </div>
      </div>
    </div>

    <div class="span-24 last">
        
          
        
    </div>
</div>

      <div class="clearer"></div>
    </div>
<div class="container">
    <div class="span-24 content">
        <div class="footer">
            &copy; Copyright 2008-2012, Benjamin Eberlei.
            Powered by <a href="http://www.tinkerer.me/">Tinkerer</a> and <a href="http://sphinx.pocoo.org/">Sphinx</a>.

        <script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script>
        </div>
    </div>
</div>

  </body>
</html>