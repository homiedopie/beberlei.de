<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="Blog of Benjamin Eberlei, covering a wide range of programming, bootstrapping and entrepreneurial topics">
        <meta name="viewport" content="width=device-width">
        <meta name="google-site-verification" content="mycr8JCbLYq9QcOyh4Ub1esAdN-awH9ut6nyTKUTgE4">
        <title>Explicit Global State with Context Objects &mdash; beberlei.de</title>
            <link rel="stylesheet" href="/_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="/_static/css/bootstrap.min.css" type="text/css" />
            <link rel="stylesheet" href="/_static/blog.css" type="text/css" />
            <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" />
        <link rel="shortcut icon" href="../../../_static/tinkerer.ico" /><!-- Load modernizr and JQuery -->
        <script src="../../../_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="../../../_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="../../../_static/plugins.js"></script>
        <script src="../../../_static/main.js"></script>
        <link rel="search" title="Search" href="../../../search.html" /><link rel="next" title="Composer Monorepo Plugin (previously called Fiddler)" href="../../../2016/05/28/composer_monorepo_plugin_previously_called_fiddler.html" /><link rel="prev" title="How to complete a side project and turn it into a business (Level 1)" href="../13/how_to_complete_a_side_project_and_turn_it_into_a_business_level1.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="../../../rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '1.5.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        SOURCELINK_SUFFIX: '.txt',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="../../../_static/underscore.js"></script><script type="text/javascript" src="../../../_static/doctools.js"></script><script type="text/javascript" src="../../../_static/disqus.js"></script></head>
    <body role="document">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><nav class="navbar navbar-dark">
		  <div class="container">
			  <div class="navbar-header">
				  <a class="navbar-brand" href="https://beberlei.de">Benjamin Eberlei</a>
			  </div>

			  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				  <ul class="nav navbar-nav navbar-right">
						<li><a href="../../../index.html">Home</a></li>
						<li><a href="../../../pages/about.html">About</a></li>
						<li><a href="../../../pages/debugging_php.html">Debugging</a></li>
						<li><a href="/archive.html">Archive</a></li>
					  <li><a href="/rss.xml">RSS</a></li>
				  </ul>
			  </div>
		  </div>
		</nav><div class="main-container" role="main"><div class="container">
				<div class="row">
					<div class="col-md-8 col-md-offset-2 col-sm-12"><article role="article">
							<div class="blog-post">
        <div class="section" id="explicit-global-state-with-context-objects">
<h1>Explicit Global State with Context Objects</h1>
<p>Global State is considered bad for maintainability of software. Side effects on
global state can cause a very nasty class of bugs. Context objects are one
flavour of global state. For example, I remember that Symfony1 had a
particularly nasty context object that was a global singleton containing
references to very many services of the framework.</p>
<p>As with every concept in programming, there are no absolute truths though and
there are many use-cases where context objects make sense. This blog posts
tries to explain my reasons for using context objects.</p>
<div class="section" id="what-is-a-context">
<h2>What is a Context?</h2>
<p>Context is defined as all the information and circumstances in which
something can be <em>fully</em> understood. In daily programming this is mostly
related to the state of variables and databases. Some examples in the world
of PHP include the superglobals <span class="docutils literal"><span class="pre">$_GET</span></span> and <span class="docutils literal"><span class="pre">$_POST</span></span>.</p>
<p>Any piece of code is always running in some context and the question is how much
of it is explicit in the code and how much is hidden.</p>
<p>A context object is a way to make the existing context explicit for your code.</p>
</div>
<div class="section" id="context-objects">
<h2>Context Objects</h2>
<p>Lets take a look at the Definition of a context object</p>
<blockquote>
<div>A context object encapsulates the references/pointers to services and
configuration information used/needed by other objects. It allows the objects
living within a context to see the outside world. Objects living in a different
context see a different view of the outside world.</div></blockquote>
<p>Besides the obvious use of encapsulating services and config variables, this
definition mentions two important properties:</p>
<ol class="arabic simple">
<li>Allows to see the outside world, which does <em>not</em> mean it can change it.
In my opinion it is essential that context objects are immutable,
to avoid side effects.</li>
<li>The possibility of objects living in different contexts, seeing
different context objects suggets that a context object
should never be a singleton.</li>
</ol>
<p>By using objects instead of global variables for context, we can use
encapsulation to achieve immutability.</p>
<p>Context already exists in PHP through the existance of superglobals. Frameworks
usually wrap them to achieve the properties mentioned above: Immutability and
Not-Singleton.</p>
<p>The Symfony Request object is one good example, where these properties (almost)
hold. Wrapping the superglobals with this object even allowed creating
Subrequests inside PHP requests.</p>
</div>
<div class="section" id="application-context">
<h2>Application Context</h2>
<p>Now that we have defined context we should make use of context objects in your
applications.</p>
<p>Anything that is an important global information in your application is
relevant for the context:</p>
<ol class="arabic simple">
<li>Building a wiki? I actually have the idea for this approach from
<a class="reference external" href="http://www.fitnesse.org/">Fitnesse</a>, a testing tool based on the wiki idea maintained by Uncle Bob
and his team. Their <a class="reference external" href="https://github.com/unclebob/fitnesse/blob/master/src/fitnesse/FitNesseContext.java">context object</a> provides access to the current and the
root page nodes.</li>
<li>Building a shop? The users basket id, selected language/locale, current
campaign (newsletter, google, social media?) can be information that should
be available all the time.</li>
<li>Building an analytics software? The currently selected date/time-range is
probably important for all queries.</li>
<li>Building a CMS/blog? The current page/post-id, the root page id, user
language/locale seem to be good candidates for an application context.
Wordpress does this although their context is global and encapsulated in an
object.</li>
<li>Building a multi-tenant app? The tenant-id and configuration for this
tentant (selected product plan, activated features, ...) are
good candidates for the context.</li>
</ol>
</div>
<div class="section" id="real-world-example-context-in-tideways">
<h2>Real World Example: Context in Tideways</h2>
<p>How to introduce such a context? We could create an object in our application,
for example how we did it in <a class="reference external" href="https://tideways.io">Tideways</a>
with selected tenant (organization), application, date-range and server environment:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">PageContext</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @var \Xhprof\Bundle\OrganizationBundle\Entity\Organization</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$organization</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var \Xhprof\Bundle\OrganizationBundle\Entity\Application</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$application</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var \Xhprof\Common\Date\DateRange</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$selectedDateRange</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @var \Xhprof\Bundle\ProfilerBundle\View\EnvironmentView</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="nv">$selectedEnvironment</span><span class="p">;</span>

    <span class="c1">// constructor and getters</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This object is created during request boot, in my case with a framework
listener. The listener checks for access rights and security constraints,
showing the 403/access denied page when necessary. This make 90% of access
control checks unneeded that are usually cluttering the controller.</p>
<p>The context is then made available for the application by using a Symfony
<a class="reference external" href="https://www.beberlei.de/2013/02/19/extending_symfony2__paramconverter.html">parameter converter</a>, every controller-action can get access to the context
by type-hinting for it:</p>
<div class="highlight-php"><div class="highlight"><pre><span></span><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">ApplicationController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">showAction</span><span class="p">(</span><span class="nx">PageContext</span> <span class="nv">$pageContext</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">array</span><span class="p">(</span><span class="s1">&#39;application&#39;</span> <span class="o">=&gt;</span> <span class="nv">$pageContext</span><span class="o">-&gt;</span><span class="na">getApplication</span><span class="p">());</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The beauty of this approach is avoiding global state and passing
the context around in a non-singleton way. Depending on the framework
you use, it might be hard to achieve this kind of context injection.</p>
<p>Now when I build <a class="reference external" href="https://www.beberlei.de/2014/10/14/lightweight_symfony2_controllers.html">lightweight Symfony2 controllers</a>
in my applications, using a context object allows me to use even less services
and move repetitive find and access control code outside of the controllers.</p>
<p>I have also written a Twig extension that gives me access to the context
object, so I don&#8217;t have to return it from every controller and created
a wrapper for the URL Generation that appends context information
to every URL (current date range + environment):</p>
<div class="highlight-jinja2"><div class="highlight"><pre><span></span>&lt;h1&gt;{{ pageContext.application.name }}&lt;/h1&gt;

&lt;a href=&quot;{{ page_path(&quot;some_route&quot;) }}&quot;&gt;Link with Context query arguments&lt;/a&gt;
</pre></div>
</div>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>A context object can help you make global state explicit and control access to
it. Good requirements for a context object are immutability and not being a
singleton.</p>
<p>When used correctly this pattern can save you alot of redundant code and
simplify both controllers and views massively.</p>
<p>The pattern has its drawbacks: You have to be careful not put too powerful
objects into the context and if you can modify the context, then you will
probably introduce nasty side effets at some point. Additionally if you don&#8217;t
make sure that creating the context is a very fast operation then you will
suffer from performance hits, because the context is created on every request,
maybe fetching expensive data that isn&#8217;t even used.</p>
</div>
</div>


        
        
        <div class="tags">
            More about: 
            <a href="../../../tags/symfony.html">Symfony</a>
             / 
            <a href="../../../tags/designpatterns.html">DesignPatterns</a>
             / 
            <a href="../../../tags/applicationdesign.html">ApplicationDesign</a>
            
            
        </div>
        

        <div class="metadata">
        <p>
            <small>
                Posted on March 12, 2017
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        <div id="disqus_thread"></div><script type="text/javascript">    var disqus_shortname = "whitewashing";    var disqus_identifier = "2017/03/12/explicit_global_state_with_context_objects";    disqus_thread();</script><noscript>Please enable JavaScript to view the    <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>

        
    </div></article></div> <!-- #main -->
				</div>
			</div></div> <!-- #main-container -->

        <div class="footer-container" role="contentinfo">
			<div class="container">
				<div class="col-md-8 col-md-offset-2">
					<div class="footer">
						<small>© Copyright 2008-2017, Benjamin Eberlei.</small>

						<script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script>
					</div>
				</div>
			</div>
        </div> <!-- footer-container -->
      </div> <!--! end of #container --><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-32146757-1', 'auto');
          ga('send', 'pageview');
        </script>

    </body>
</html>