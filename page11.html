<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="Blog of Benjamin Eberlei, covering a wide range of programming, bootstrapping and entrepreneurial topics">
        <meta name="viewport" content="width=device-width">
        <meta name="google-site-verification" content="mycr8JCbLYq9QcOyh4Ub1esAdN-awH9ut6nyTKUTgE4">
        <title>Page 11 &mdash; beberlei.de</title>
            <link rel="stylesheet" href="/_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="/_static/css/bootstrap.min.css" type="text/css" />
            <link rel="stylesheet" href="/_static/blog.css" type="text/css" />
            <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" />
        <link rel="shortcut icon" href="_static/tinkerer.ico" /><!-- Load modernizr and JQuery -->
        <script src="_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="_static/plugins.js"></script>
        <script src="_static/main.js"></script>
        <link rel="search" title="Search" href="search.html" /><link rel="next" title="Older" href="page12.html" /><link rel="prev" title="Newer" href="page10.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.5.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        SOURCELINK_SUFFIX: '.txt',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="_static/underscore.js"></script><script type="text/javascript" src="_static/doctools.js"></script></head>
    <body role="document">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><nav class="navbar navbar-dark">
		  <div class="container">
			  <div class="navbar-header">
				  <a class="navbar-brand" href="https://beberlei.de">Benjamin Eberlei</a>
			  </div>

			  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				  <ul class="nav navbar-nav navbar-right">
						<li><a href="index.html">Home</a></li>
						<li><a href="pages/about.html">About</a></li>
						<li><a href="pages/debugging_php.html">Debugging</a></li>
						<li><a href="pages/imprint.html">Imprint</a></li>
						<li><a href="/archive.html">Archive</a></li>
					  <li><a href="/rss.xml">RSS</a></li>
				  </ul>
			  </div>
		  </div>
		</nav><div class="main-container" role="main"><div class="container">
				<div class="row">
					<div class="col-md-8 col-md-offset-2 col-sm-12"><article role="article">
							<div class="section">
            <h1><a href="2012/08/11/oop_business_applications__trying_to_escape_the_mess.html">OOP Business Applications: Trying to escape the mess</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">tl;dr Version: I present a list of problems with OOP business applications from
my personal experience and then introduce 3 approaches that I was put in
contact with over the last year, DCI, EBI and CQRS. This post is an
introduction to a series about this approaches.</p>
</div>
<p>I mentally divide the world of programming into two large parts:</p>
<ol class="arabic simple">
<li>Library and system programming</li>
<li>business applications</li>
</ol>
<p>The first produces code solving technical problems, often in a beautiful and
dedicated way. The second regularly produces mess, hopefully still
serving customers by optimizing their business. This differentiation is an
exaggeration, but from my experience its far easier to run a greenfield business
project into the ground than a new library.</p>
<p>There has to be a reason why so many programmers dedicate much free time to
open source projects. It might be empirical prove, that all our business
projects don’t make us happy at the end of the day and we have to show
ourselves that we can do better.</p>
<p>I enjoy writing business applications more than libraries, but they are also
much more difficult to get right in both social and technical dimensions.  One
motivational driver of <a class="reference external" href="https://github.com/beberlei">my open source activities</a> always was to simplify the technical dimension
of OOP business applications.</p>
<div class="section" id="my-personal-list-of-annoyances">
<h2>My Personal List of Annoyances</h2>
<p>This blog post is not about blaming customers (as the usual suspect), its about
finding the problems in usual OOP code of business systems from my experience
with PHP projects. To keep things short, I will list my <em>personal</em> list of
technical annoyances in business projects in no particular order. These are
highly subjective points.</p>
<ul class="simple">
<li>Getter/Setter Madness of Objects that are used to store data into
databases. Leading to huge objects that are essentially just meaningless
stores of data.</li>
<li>Updating complex object graphs from user input.</li>
<li>Separation of model, controller and views, especially when dealing with
forms. This is very complicated to achieve.</li>
<li>Lazy Loading and Query performance problems when using an ORM. Additionally
replacing parts of the views with hand-crafted SQL is often difficult and/or
time intensive, when already using an ORM.</li>
<li>Inability to decouple code that was written with CRUD (generators and
utilities) in mind towards more domain driven code, when the requirements
change.</li>
<li>Dependency mess leading to hard to test code, generally leading to untested
applications. Too often frameworks create huge dependencies that
make your domain model messy and complex to mock in tests.</li>
<li>Focus on synchronous request/response handling makes later usage of message
queues very complicated and expensive to refactor towards.</li>
<li>Tight coupling of model against the framework code.</li>
<li>Junior developers have too much freedom, when there is not much structure in
the code, but rather just a big ball of mud. Additionally with the tight
coupling of so many components, junior developers get easily lost in the code
and produce unexpected side-effects.</li>
<li>Use-cases easily span more than 5 classes. To grasp the interaction you have
to keep lots of code in your head, especially complicated for junior
developers again. As they cannot really work on a problem in isolation.</li>
<li>Constant violations of <a class="reference external" href="http://en.wikipedia.org/wiki/SOLID_%28object-oriented_design%29">SOLID</a> principles
due to framework or persistence requirements.</li>
<li>Compared to library development, user-facing applications often have much
higher coupling between classes and namespaces. In libraries its often easy
to find different concerns, but in applications they seem hard to divide for
developers.</li>
<li>In combination with a rich javascript client, requirements to update objects
through their CRUD API produces concurrency and lost-update hell, that
dynamic server-side applications could mostly avoid before.</li>
</ul>
<p>Essentially if you work in a tight schedule, project based environment where
the decision makers sell rapid application development and prototyping, then you
often have only one, maybe one and a half attempts to get the big picture
right. From that moment on you have to build on that decision and hope for the
best.</p>
<p>We have tried not to go the RAD+CRUD tools ways in several projects, to escape
the problems listed above. But without changes in your mindest you end up with
hand written mess, compared to getting there with tools.</p>
<p>Specifically <a class="reference external" href="http://en.wikipedia.org/wiki/Domain-driven_design">Domain Driven Design</a> applied naively can make
the problem even worse. It easily leads to lasagna code, where you have layers
of layers that are very hard to understand. Personally I prefer spaghetti code
over lasagna code, because its comparatively simpler to understand.</p>
</div>
<div class="section" id="finding-new-approaches">
<h2>Finding new Approaches</h2>
<p>Rather than to embrace the suck and dive deeper into CRUD architectures, I felt
there has to be some solution to organize business models structurally to avoid
all (or most) of these problems. In the PHP world with <a class="reference external" href="http://www.symfony.com">Symfony2</a> and <a class="reference external" href="http://www.doctrine-project.org">Doctrine2</a>
you have a powerful toolbox to avoid many of the problems above, but it is
still not simple to write clean object oriented applications.</p>
<p>After years of participation in both open source projects I still feel there is
a missing puzzle piece, to reach a clean separation of all the model concerns
from framework and persistence.</p>
<p>At some point I would really like to close the gap between desired technical
state of a project and the state it is actually in. I know there is no size
fits all solution, but I fell a checklist of architectural patterns with pro
and con arguments allows me to adjust the expectations about how a system looks
in the end.</p>
<p>Thanks to <a class="reference external" href="https://twitter.com/go_oh">Gordon</a>, <a class="reference external" href="https://twitter.com/spriebsch">Stefan</a> and <a class="reference external" href="https://twitter.com/tom_noise">Thomas</a>
I was introduced to several approaches to OO application design that I
started to explore in the past last months:</p>
<ul class="simple">
<li><a class="reference external" href="http://en.wikipedia.org/wiki/Data,_context_and_interaction">Data, Context, Interaction (DCI)</a> - which Gordon
studied a lot</li>
<li><a class="reference external" href="http://alistair.cockburn.us/Hexagonal+architecture">Entity, Boundary, Interactor (EBI)</a>, also called Hexagonal
architecture or “Ports and adapters”. Gained popularity after <a class="reference external" href="http://www.confreaks.com/videos/759-rubymidwest2011-keynote-architecture-the-lost-years">Uncle Bobs talk
at Ruby Midwest</a>
last year.</li>
<li><a class="reference external" href="http://en.wikipedia.org/wiki/Command-query_separation">Command-Query-Responsibility-Segregation (CQRS)</a> well described in a
<a class="reference external" href="http://www.udidahan.com/2009/12/09/clarified-cqrs/">blog post by Udi Dahan</a> and in a hands on <a class="reference external" href="http://www.viddler.com/v/dc528842">one
day video class</a> by Greg Young.</li>
</ul>
<p>They are not new and have all been around for several years already. I would
describe all three of them as architectural design patterns, though some people
might probably disagree with this classification. All three approaches make
you think about application development beyond just “service layers” in
radically new ways. All three have helped me rethink business applications in
different ways.</p>
<p>In the next weeks I will talk about each of these approaches individually, show
some examples and then wrap up my thoughts about all of them.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Gordon and I will talk about this topic on the <a class="reference external" href="http://www.froscon.de/en/home/">Free and Open Source
Conference</a> in Sankt Augustin Germany on
25th/26th August of 2012. Feel free to drop by and discuss this topic!</p>
</div>
</div>


            
            <div class="tags">
                More about: 
                <a href="tags/applicationdesign.html">ApplicationDesign</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on August 11, 2012
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2012/06/03/setting_up_development_machines_with_puppet.html">Setting up Development Machines with Puppet</a></h1>
<p>I wrote <a class="reference external" href="/2012/05/31/virtual_machines_with_vagrant__veewee_and_puppet.html">about Vagrant</a> last week and
mentioned to talk about <a class="reference external" href="http://puppetlabs.com/puppet/what-is-puppet/">Puppet</a> in the future. Before I will
dive into Puppet in combination with Vagrant I want to share my general
experiences with Puppet (beginners level, I just played with this today).</p>
<p>Puppet is a configuration management tool. It uses a declarative language to
describe how a system should look like. Upon invocation of puppet it attempts
to get the system from its current state into the desired state by installing
packages, executing programs/scripts and creating files/directories.</p>
<p>My laptop was still on Ubuntu 10.04 this morning, but for <a class="reference external" href="http://live.symfony.com">Symfony Live</a> I needed to upgrade to 12.04. This was necessary to
run a Virtualbox VM on my laptop that I built on my 12.04 desktop. Additionally
I really like the Unity desktop and wanted to get away from the Gnome that is
in 10.04.</p>
<p>After a backup and fresh installation of Ubuntu I realized how many things I
have to install to get this machine productive:</p>
<ul class="simple">
<li>LAMP stack + a bunch of other databases and services</li>
<li>Git, Svn, Hg, ..</li>
<li>Virtualbox + Vagrant</li>
<li>Vim with my Dot-Files, including Command-T which requires compilation,
and a bunch of development tools such as tree, ack-grep.</li>
<li>PHP Tools (PHPUnit, PHPCS, Xdebug, Xhprof)</li>
<li>Git with Author Information and global ignore file</li>
<li>A bunch of .bashrc initializations</li>
<li>Some open source projects I always have around (Doctrine, ...)</li>
<li>Setup automatic backup with my cloud storage provider (<a class="reference external" href="https://www.free-hidrive.com/">Strato Hidrive</a> - they support rsync)</li>
<li>and I probably forgot a bunch of tools just thinking about this today.</li>
</ul>
<p>I realized not only virtual machines, but also their hosts (my development
machines) could be automatically setup with Puppet.</p>
<p>So instead of saving my <span class="docutils literal"><span class="pre">.bash_history</span></span> to remember the steps I automated
them using Puppet. In Puppet you define Resources of several types, for example
Files, Packages or shell commands. You group these resources together in a
<span class="docutils literal"><span class="pre">.pp</span></span> file and then invoke <span class="docutils literal"><span class="pre">puppet</span> <span class="pre">apply</span> <span class="pre">&lt;file&gt;.pp</span></span>. You can install Puppet
via <span class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">puppet</span></span> on Ubuntu.</p>
<p>The idea is to define Puppet resources in a way that they are performed once and
then the system has this resource. This means you can run puppet as often as
you want and it will only activate the missing resources.</p>
<p>I separate the installation process into two puppet files, one that has to be
run with root <span class="docutils literal"><span class="pre">~/.puppet/devmachine-root.pp</span></span> and another one that has to be run with
my own user <span class="docutils literal"><span class="pre">~/.puppet/devmachine.pp</span></span>.</p>
<p>Because every dev-machine setup is unique, I will just show some
examples of my puppet file to get the message across:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="c1"># /home/benny/.puppet/devmachine.pp</span>

<span class="c1"># VIM Dot Files</span>
<span class="n">vcsrepo</span> <span class="p">{</span> <span class="s1">'vim-dotfiles'</span><span class="p">:</span>
    <span class="n">path</span>     <span class="o">=&gt;</span> <span class="s2">"/home/$id/.vim"</span><span class="p">,</span>
    <span class="n">ensure</span>   <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
    <span class="n">provider</span> <span class="o">=&gt;</span> <span class="n">git</span><span class="p">,</span>
    <span class="n">source</span>   <span class="o">=&gt;</span> <span class="s1">'https://...'</span>
<span class="p">}</span>

<span class="n">file</span> <span class="p">{</span> <span class="s1">'vim-dotfiles-symlink'</span><span class="p">:</span>
    <span class="n">path</span>   <span class="o">=&gt;</span> <span class="s2">"/home/$id/.vimrc"</span><span class="p">,</span>
    <span class="n">ensure</span> <span class="o">=&gt;</span> <span class="n">link</span><span class="p">,</span>
    <span class="n">target</span> <span class="o">=&gt;</span> <span class="s1">'.vim/vimrc'</span><span class="p">,</span>
    <span class="n">require</span> <span class="o">=&gt;</span> <span class="n">Vcsrepo</span><span class="p">[</span><span class="s1">'vim-dotfiles'</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">exec</span> <span class="p">{</span> <span class="s1">'vim-make-command-t'</span><span class="p">:</span>
    <span class="n">command</span> <span class="o">=&gt;</span> <span class="s1">'rake make'</span><span class="p">,</span>
    <span class="n">cwd</span>     <span class="o">=&gt;</span> <span class="s2">"/home/$id/.vim/bundle/Command-T"</span><span class="p">,</span>
    <span class="n">unless</span>  <span class="o">=&gt;</span> <span class="s2">"ls -aFlh /home/$id/.vim/bundle/Command-T|grep 'command-t.recipe'"</span><span class="p">,</span>
    <span class="n">require</span> <span class="o">=&gt;</span> <span class="n">Vcsrepo</span><span class="p">[</span><span class="s1">'vim-dotfiles'</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The three keywords <span class="docutils literal"><span class="pre">vcsrepo</span></span>, <span class="docutils literal"><span class="pre">file</span></span> and <span class="docutils literal"><span class="pre">exec</span></span> are called types. They
define what functionality should be executed by puppet. Vcsrepo is a custom
type that you can grab <a class="reference external" href="https://github.com/puppetlabs/puppetlabs-vcsrepo.git">from Github</a>.</p>
<ul class="simple">
<li>The first block uses Git to make sure that in my home directory the
<span class="docutils literal"><span class="pre">~/.vim</span></span> directory is a checkout of a given remote git repository.</li>
<li>The second file block makes sure that <span class="docutils literal"><span class="pre">~/.vimrc</span></span> points to <span class="docutils literal"><span class="pre">~/.vim/vimrc</span></span>
using a symlink.</li>
<li>The third block compiles the Command-T VIM plugin. Inside the
exec block you can see the unless condition. This is necessary to prevent the
command from being executed whenever <span class="docutils literal"><span class="pre">devmachine.pp</span></span> is executed with
puppet. The require makes sure this resource is only activated after the dotfiles
were installed.</li>
</ul>
<p>Another nice example is the configuration of Git:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="c1"># Configure Git</span>
<span class="n">exec</span> <span class="p">{</span> <span class="s2">"git-author-name"</span><span class="p">:</span>
    <span class="n">command</span> <span class="o">=&gt;</span> <span class="s1">'git config --global user.name "Benjamin Eberlei"'</span><span class="p">,</span>
    <span class="n">unless</span> <span class="o">=&gt;</span> <span class="s2">"git config --global --get user.name|grep 'Benjamin Eberlei'"</span>
<span class="p">}</span>

<span class="n">exec</span> <span class="p">{</span> <span class="s2">"git-author-email"</span><span class="p">:</span>
    <span class="n">command</span> <span class="o">=&gt;</span> <span class="s1">'git config --global user.email "kontakt@beberlei.de"'</span><span class="p">,</span>
    <span class="n">unless</span> <span class="o">=&gt;</span> <span class="s2">"git config --global --get user.email|grep 'kontakt@beberlei.de'"</span>
<span class="p">}</span>

<span class="n">exec</span> <span class="p">{</span> <span class="s2">"git-global-ignore"</span><span class="p">:</span>
    <span class="n">command</span> <span class="o">=&gt;</span> <span class="s2">"git config --global core.excludesfile /home/$id/.gitignore"</span><span class="p">,</span>
    <span class="n">unless</span>  <span class="o">=&gt;</span> <span class="s1">'git config -l --global|grep excludesfile'</span>
<span class="p">}</span>

<span class="n">file</span> <span class="p">{</span> <span class="s2">"git-global-ignorefile"</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=&gt;</span> <span class="s2">"/home/$id/.gitignore"</span><span class="p">,</span>
    <span class="n">ensure</span> <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
    <span class="n">content</span> <span class="o">=&gt;</span> <span class="s2">"*.swo</span><span class="se">\n</span><span class="s2">*.swp</span><span class="se">\n</span><span class="s2">"</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here A bunch of commands is executed unless some option is already set. At last
the global .gitingore is filled with the patterns of Vim temporary files.</p>
<p>I also automated all the other steps listed above, but will spare you the
details. For the LAMP Stack + PHP I used the now defunct
dietervds/puppet-symfony2 repository as an inspiration. It ships a
set of Puppet Modules. You can just put them into your <span class="docutils literal"><span class="pre">~/.puppet/modules</span></span>
folder and they are then available in any of your puppet files.</p>
<p>I can now reuse this on the different machines: desktop at home and at work and
my laptop. Whenever I install a new tool or change some configuration of my
system I can directly put this into puppet and keep the setup synchronized on
all the machines I work with.</p>
<p>You can find more detailed resources on the PuppetLabs website:</p>
<ul class="simple">
<li><a class="reference external" href="http://docs.puppetlabs.com/learning/ral.html">Tutorial</a></li>
<li><a class="reference external" href="http://docs.puppetlabs.com/references/latest/type.html">Type Reference</a></li>
<li><a class="reference external" href="docs.puppetlabs.com/puppet_core_types_cheatsheet.pdf">Type Cheat Sheet</a></li>
</ul>


            

            <div class="metadata">
        <p>
            <small>
                Posted on June 03, 2012
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2012/05/31/virtual_machines_with_vagrant__veewee_and_puppet.html">Virtual Machines with Vagrant, Veewee and Puppet</a></h1>
<p>I have been playing with Vagrant these last days, a tool to automate Virtualbox
VM management very efficiently. Being always late to new technologies
investigating Vagrant now felt about right. I am using Virtualbox for
virtualization for about a year now but have build all my boxes manually. I
have these machines setup:</p>
<ul class="simple">
<li>Windows 7</li>
<li>Ubuntu with lots of crazy PHP builds</li>
<li>Ubuntu with Oracle, PostgreSQL for Doctrine Unit-Tests</li>
</ul>
<p>The main benefit from this is that I don’t have to clutter my main machine with
packages and dependencies that might potentially break.</p>
<p>To benefit from Virtualization on a larger scale I wanted to investigate
automation of box-building and was pointed to <a class="reference external" href="http://www.vagrantup.com">Vagrant</a>. This is a ruby tool that allows to copy and
modify virtualboxes on the fly. You define a basebox and inherit from this box
in your projects. Whenever you work on the project you start a copy of this
basebox and install more system-dependencies using Chef or Puppet.
That allows you to put the VM into a defined state just for this project. No
matter how many different and weird dependencies you need, they will always be
in this VM that is just created for the project and destroyed at the end of the
day.</p>
<p>I am using Ubuntu (currently 12.04) and tried starting with the Vagrant
example.  It fails, because their example box uses a more current Virtualbox
Guest Additions. To be able to use vagrant, you need a basebox with the
virtualbox and guest additions versions matching correctly.</p>
<p>To build your own Virtualbox you can use the Vagrant plugin <a class="reference external" href="https://github.com/jedi4ever/veewee">Veewee</a>. Install it from Github to get
all the latest VM templates:</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ git clone https://github.com/jedi4ever/veewee.git
$ <span class="nb">cd</span> veewee
$ sudo gem install bundler
$ sudo bundle install
$ <span class="nb">alias</span> <span class="nv">vagrant</span><span class="o">=</span><span class="s2">"bundle exec vagrant"</span>
</pre></div>
</div>
<p>You need Ruby and Gems installed for this to work. Veewee can be installed
using Gems, but this not necessarily gives you the version with the most recent
templates that match your own operating system version.</p>
<p>Now lets define our own basebox definition and copy from an existing template
that Veewee provides:</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ vagrant basebox define <span class="s1">'beberlei-ubuntu-12.04-i386-php'</span> <span class="s1">'ubuntu-server-12.04-i386'</span>
</pre></div>
</div>
<p>This creates a copy from the default ubuntu server template into a folder
<cite>definitions/beberlei-ubuntu-12.04-i386-php</cite>. You can start modifying the files
in there to adjust the build process of the virtual machine image. For me its
important to modify the definitions.rb and add the following, otherwise
building the VMs fails:</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>:virtualbox <span class="o">=</span>&gt; <span class="o">{</span> : <span class="nv">vm_options</span> <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"pae"</span> <span class="o">=</span>&gt; <span class="s2">"on"</span><span class="o">]}</span>,
</pre></div>
</div>
<p>You can then open up the postinstall.sh and install more packages that you need
in your personal basebox. For example a LAMP stack. Do this right after the
lines that do <cite>apt-get install -y</cite>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span/><span class="nb">export</span> <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt-get -y install php5 php5-cli php5 mysql-server-5.5 libapache2-mod-php5
</pre></div>
</div>
<p>If you are done you can start building a virtualbox image with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ vagrant basebox build
</pre></div>
</div>
<p>Make sure not to start typing in the console window that open ups. It is
automatically controlled from a ruby script and every change to the keysequence
breaks the building. This step takes a while. (Enough to write a blog post
while watching a boring football game for example).</p>
<p>When this is done, you can verify and export the VM into virtualbox/vagrant.</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ veewee vbox validate <span class="s1">'beberlei-ubuntu-12.04-i386-php'</span>
$ vagrant basebox <span class="nb">export</span> <span class="s1">'beberlei-ubuntu-12.04-i386-php'</span>
$ vagrant box add <span class="s1">'beberlei-ubuntu-12.04-i386-php'</span> <span class="s1">'beberlei-ubuntu-12.04-i386-php.box'</span>
</pre></div>
</div>
<p>Now this box is also available as Vagrant base box. For example in a project
that we want to use with vagrant, do:</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ <span class="nb">cd</span> myproject/
$ vagrant init <span class="s1">'beberlei-ubuntu-12.04-i386-php'</span>
$ vagrant up
$ vagrant ssh
</pre></div>
</div>
<p>Although the blog-title suggests it, Puppet hasn’t been used much up to this
point. The use of puppet with Vagrant will be part of a next blog post.</p>


            
            <div class="tags">
                More about: 
                <a href="tags/vagrant.html">Vagrant</a>
                 / 
                <a href="tags/automation.html">Automation</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on May 31, 2012
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2012/05/26/doctrine_goes_mit.html">Doctrine switches from LGPL to MIT</a></h1>
<blockquote>
<div>tl;dr We moved all the Doctrine PHP projects from LGPL to MIT license
successfully in roughly 4 weeks. For that we used a small web-based tool to
ask the permission of 358 authors that contributed in the last 6 years.</div></blockquote>
<p>The <a class="reference external" href="http://www.doctrine-project.org">Doctrine project</a> has been LGPL
licensed since it was started in 2006. When I first started contributing in the
project late in 2009 we were constantly asked about changing the license to a
permissive license such as <a class="reference external" href="http://en.wikipedia.org/wiki/MIT_License">MIT</a> or
New-BSD.  My subjective feeling is that there are much more libraries with
permissive licenses than 10 years ago. And there are others that <a class="reference external" href="http://news.cnet.com/8301-13556_3-20071811-61/the-open-source-license-landscape-is-changing/">back my
feeling up with facts</a>.
The fear of getting screwed when using a permissive license has probably
declined in favor of the benefits. <a class="reference external" href="http://pooteeweet.org/blog/2084">As Lukas puts it</a>:</p>
<blockquote>
<div>Maybe with enough experience you start to realize that it happens close to
never that a proprietary fork of an open source project ends up outpacing
the original project.</div></blockquote>
<p>We wanted all the benefits of permissive licenses as well.  So at the beginning
of this year we as Doctrine project first started to investigate how the task
of switching the license could be done. After a short email with the <a class="reference external" href="http://www.fsf.org">FSF</a> it was clear that we had to get the approval of every
single committer or remove their code.</p>
<p>VLC <a class="reference external" href="http://www.videolan.org/press/lgpl.html">successfully attempted a license change</a> last year from GPL to LGPL, so we
we’re hopeful to get this done. After discussing with Lukas we came up with the
idea of a tool that helps this process, so <a class="reference external" href="http://dlm.beberlei.de">I wrote it</a>. It features:</p>
<ul class="simple">
<li>Import of all commits from one or many Github projects</li>
<li>Aggregation of commits to authors based on e-mail address from Git log</li>
<li>Status approved/not-approved for every author.</li>
<li>An e-mail engine to send a request for approval to every author using
<a class="reference external" href="http://www.mailgun.net">the awesome Mailgun service</a>, who has not approved
yet. We use Mailgun for fun and to have a way to act on bounces easily.</li>
<li>Admin functionality to mark commits as “trivial or deleted”.</li>
<li>An audit trail to account for all changes and who has done them.</li>
<li>Symfony2/Doctrine2 application with debian packaging using FPM.</li>
</ul>
<p>This project is not yet open-sourced but will be when I have some time to clean
up the hardcoded passwords and write a small README on how to adjust the
templates.</p>
<p>After importing the commits of all the LGPL licensed Doctrine projects we
realized that we have 358 unique committers and about 40-50 without an e-mail
address (from the old SVN days). So we started googling for nicknames and
eventually collected all e-mail addresses except maybe 6-8 missing ones.</p>
<p>Now after 4 weeks of bi-weekly e-mail reminders, everyone except 16 committers have
accepted the license change. No single person refused the change. All commits
of the 16 people left we’re luckily not part of the code base anymore when we
completely rewrote Doctrine 2 or trivial one-line changes.</p>
<p>I am very happy to announce that Doctrine is now an MIT licensed project. Have
fun with it.</p>


            

            <div class="metadata">
        <p>
            <small>
                Posted on May 26, 2012
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2012/02/25/symfony2_controller_testing.html">Symfony2 Controller Testing without Application</a></h1>
<p>Controller testing using the WebTestCase requires a Symfony Kernel and with
that a complete application. However you can just ship your own simple kernel
with just the dependencies necessary to test your application. This way you can
easily create functional tests for bundles without the bundle requiring an
application.</p>
<div class="section" id="create-a-testkernel">
<h2>Create a TestKernel</h2>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="c1">// Tests/Controller/App/AppKernel.php</span>

<span class="k">use</span> <span class="nx">Symfony\Component\HttpKernel\Kernel</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Config\Loader\LoaderInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AppKernel</span> <span class="k">extends</span> <span class="nx">Kernel</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">registerBundles</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$bundles</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
            <span class="c1">// Dependencies</span>
            <span class="k">new</span> <span class="nx">Symfony\Bundle\FrameworkBundle\FrameworkBundle</span><span class="p">(),</span>
            <span class="k">new</span> <span class="nx">Symfony\Bundle\SecurityBundle\SecurityBundle</span><span class="p">(),</span>
            <span class="k">new</span> <span class="nx">Symfony\Bundle\MonologBundle\MonologBundle</span><span class="p">(),</span>
            <span class="k">new</span> <span class="nx">Symfony\Bundle\TwigBundle\TwigBundle</span><span class="p">(),</span>
            <span class="k">new</span> <span class="nx">Sensio\Bundle\FrameworkExtraBundle\SensioFrameworkExtraBundle</span><span class="p">(),</span>
            <span class="k">new</span> <span class="nx">JMS\SerializerBundle\JMSSerializerBundle</span><span class="p">(</span><span class="nv">$this</span><span class="p">),</span>
            <span class="k">new</span> <span class="nx">FOS\RestBundle\FOSRestBundle</span><span class="p">(),</span>
            <span class="c1">// My Bundle to test</span>
            <span class="k">new</span> <span class="nx">Beberlei\WorkflowBundle\BeberleiWorkflowBundle</span><span class="p">(),</span>
        <span class="p">);</span>

        <span class="k">return</span> <span class="nv">$bundles</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">registerContainerConfiguration</span><span class="p">(</span><span class="nx">LoaderInterface</span> <span class="nv">$loader</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// We don't need that Environment stuff, just one config</span>
        <span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="no">__DIR__</span><span class="o">.</span><span class="s1">'/config.yml'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-the-config-yml">
<h2>Creating the config.yml</h2>
<div class="highlight-yaml"><div class="highlight"><pre><span/># Tests/Controller/App/config.yml
framework:
    secret:          secret
    charset:         UTF-8
    test: ~
    router:          { resource: "%kernel.root_dir%/routing.yml" }
    form:            true
    csrf_protection: true
    validation:      { enable_annotations: true }
    templating:      { engines: ['twig'] }
    session:
        auto_start:     false
        storage_id: session.storage.filesystem

monolog:
    handlers:
        main:
            type:         fingers_crossed
            action_level: error
            handler:      nested
        nested:
            type:  stream
            path:  %kernel.logs_dir%/%kernel.environment%.log
            level: debug
</pre></div>
</div>
</div>
<div class="section" id="creating-the-routing-yml">
<h2>Creating the routing.yml</h2>
<div class="highlight-yaml"><div class="highlight"><pre><span/><span class="c1"># Tests/Controller/App/routing.yml</span>
<span class="l l-Scalar l-Scalar-Plain">BeberleiWorkflowBundle</span><span class="p p-Indicator">:</span>
    <span class="l l-Scalar l-Scalar-Plain">resource</span><span class="p p-Indicator">:</span> <span class="s">"@BeberleiWorkflowBundle/Controller/"</span>
    <span class="l l-Scalar l-Scalar-Plain">type</span><span class="p p-Indicator">:</span>     <span class="l l-Scalar l-Scalar-Plain">annotation</span>
    <span class="l l-Scalar l-Scalar-Plain">prefix</span><span class="p p-Indicator">:</span>   <span class="l l-Scalar l-Scalar-Plain">/</span>
</pre></div>
</div>
</div>
<div class="section" id="adding-a-phpunit-bootstrap">
<h2>Adding a PHPUnit bootstrap</h2>
<p>I assume the setup that Henrik described in his “<a class="reference external" href="http://henrik.bjrnskov.dk/travis-and-composer-sitting-in-a-tree/">Travis &amp; Composer sitting in a
Tree K-I-S-S-I-N-G” blog post</a>.</p>
<p>His setup is missing the spl_autoload_register() call in the bootstrap file
though.</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="c1">// Tests/bootstrap.php</span>
<span class="nv">$loader</span> <span class="o">=</span> <span class="o">@</span><span class="k">include</span> <span class="no">__DIR__</span> <span class="o">.</span> <span class="s1">'/../vendor/.composer/autoload.php'</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$loader</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">die</span><span class="p">(</span><span class="s">&lt;&lt;&lt;'</span><span class="dl">EOT</span><span class="s">'</span>
<span class="s">You must set up the project dependencies, run the following commands:</span>
<span class="s">wget http://getcomposer.org/composer.phar</span>
<span class="s">php composer.phar install</span>
<span class="dl">EOT</span>
    <span class="p">);</span>
<span class="p">}</span>
<span class="nx">\Doctrine\Common\Annotations\AnnotationRegistry</span><span class="o">::</span><span class="na">registerLoader</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$loader</span><span class="p">,</span> <span class="s1">'loadClass'</span><span class="p">));</span>

<span class="nb">spl_autoload_register</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="nv">$class</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">===</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="s1">'Beberlei\\WorkflowBundle\\'</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$path</span> <span class="o">=</span> <span class="no">__DIR__</span><span class="o">.</span><span class="s1">'/../'</span><span class="o">.</span><span class="nb">implode</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="nb">array_slice</span><span class="p">(</span><span class="nb">explode</span><span class="p">(</span><span class="s1">'\\'</span><span class="p">,</span> <span class="nv">$class</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="s1">'.php'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">stream_resolve_include_path</span><span class="p">(</span><span class="nv">$path</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">require_once</span> <span class="nv">$path</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<p>That means your bundle should have a composer.json that loads all the
dependencies.</p>
</div>
<div class="section" id="modifying-the-phpunit-xml-dist">
<h2>Modifying the phpunit.xml.dist</h2>
<p>We have to tell the WebTestCase base class where to find this kernel:</p>
<div class="highlight-xml"><div class="highlight"><pre><span/><span class="c">&lt;!-- phpunit.xml.dist --&gt;</span>
<span class="nt">&lt;phpunit</span> <span class="na">bootstrap=</span><span class="s">"Tests/bootstrap.php"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;php&gt;</span>
        <span class="nt">&lt;server</span> <span class="na">name=</span><span class="s">"KERNEL_DIR"</span> <span class="na">value=</span><span class="s">"Tests/Controller/App"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/php&gt;</span>
<span class="nt">&lt;/phpunit&gt;</span>
</pre></div>
</div>
<p>Now just run your web-test cases.</p>
<p>If you want to debug the logging happening inside the Kernel just comment out
the Monolog lines to get the log-messages printed to the screen.</p>
<p>You have to add the <cite>Tests/App/cache</cite> and <cite>Tests/App/logs</cite> to your version
control ignore files.</p>
</div>


            
            <div class="tags">
                More about: 
                <a href="tags/symfony.html">Symfony</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on February 25, 2012
                
            </small>
        </p>
    </div>
        </div><div class="archive_link">
        <a href="archive.html">Archive</a>
    </div></article></div> <!-- #main -->
				</div>
			</div></div> <!-- #main-container -->

        <div class="footer-container" role="contentinfo">
			<div class="container">
				<div class="col-md-8 col-md-offset-2">
					<div class="footer">
						<small>© Copyright 2008-2017, Benjamin Eberlei.</small>

						<script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script>
					</div>
				</div>
			</div>
        </div> <!-- footer-container -->
      </div> <!--! end of #container --><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-32146757-1', 'auto');
          ga('send', 'pageview');
        </script>

    </body>
</html>