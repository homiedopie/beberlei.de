<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="Blog of Benjamin Eberlei, covering a wide range of programming, bootstrapping and entrepreneurial topics">
        <meta name="viewport" content="width=device-width">
        <meta name="google-site-verification" content="mycr8JCbLYq9QcOyh4Ub1esAdN-awH9ut6nyTKUTgE4">
        <title>Page 11 &mdash; beberlei.de</title>
            <link rel="stylesheet" href="/_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="/_static/css/bootstrap.min.css" type="text/css" />
            <link rel="stylesheet" href="/_static/blog.css" type="text/css" />
            <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" />
        <link rel="shortcut icon" href="_static/tinkerer.ico" /><!-- Load modernizr and JQuery -->
        <script src="_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="_static/plugins.js"></script>
        <script src="_static/main.js"></script>
        <link rel="next" title="Older" href="page12.html" /><link rel="prev" title="Newer" href="page10.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.5',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        SOURCELINK_SUFFIX: '',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="_static/underscore.js"></script><script type="text/javascript" src="_static/doctools.js"></script><script type="text/javascript" src="_static/disqus.js"></script></head>
    <body role="document">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><nav class="navbar navbar-dark">
		  <div class="container">
			  <div class="navbar-header">
				  <a class="navbar-brand" href="https://beberlei.de">Benjamin Eberlei</a>
			  </div>

			  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				  <ul class="nav navbar-nav navbar-right">
						<li><a href="index.html">Home</a></li>
						<li><a href="pages/about.html">About</a></li>
						<li><a href="/archive.html">Archive</a></li>
					  <li><a href="/rss.xml">RSS</a></li>
				  </ul>
			  </div>
		  </div>
		</nav><div class="main-container" role="main"><div class="container">
				<div class="row">
					<div class="col-md-8 col-md-offset-2 col-sm-12"><article role="article">
							<div class="section">
            <h1><a href="2010/05/02/testing-database-locks-with-phpunit-and-gearman.html">Testing Database Locks with PHPUnit and Gearman</a></h1>
<p>For the Beta 2 release of <a class="reference external" href="http://www.doctrine-project.org">Doctrine
2</a> we plan to integrate pessimistic
Database-level locks across all the supported vendors (MySQL, Oracle,
PostgreSql, IBM DB2 so far). This means row-level locking as defined in
the ANSI SQL Standard using “SELECT .. FOR UPDATE” will be available
optionally in DQL Queries and Finder methods. The Implementation of this
extension to SELECT statements is rather trivial, however functional
testing of this feature is not.</p>
<p>A general approach would look like this:</p>
<ol class="arabic simple">
<li>Run Query 1 and 2 with FOR UPDATE into the background</li>
<li>Have both queries lock the row for a specified time x (using sleep)</li>
<li>Verify that one of the two processes/threads runs approximately 2*x
the lock time.</li>
</ol>
<p>Since PHP does not support process forking or threads naturally you run
into a serious problem. How do you execute two database queries in
parallel and verify that indeed one query is locking read access for the
second one?</p>
<p>Side note: There are some drawbacks to this testing approach. It could
be that one background threads finishes the lock sleep already when the
second just starts. The locking would work in these cases, however the
lock time would not nearly be 2*x seconds, producing a test-failure. We
are talking about a functional test though and I will accept a failure
from time to time just to be 99% sure that locking works.</p>
<p>Solving this problem with Gearman provides a pretty nice “real-world”
example for the Job-Server that I wanted to share. This blog post
contains a stripped down code-example from the Doctrine 2 testsuite. If
you are interested, you can see the complete Gearman Locking Tests in
<a class="reference external" href="http://github.com/beberlei/doctrine2/tree/lock-support/tests/Doctrine/Tests/ORM/Functional/Locking/">on
GitHub</a>.</p>
<p>Gearman allows to register worker processes with the job-server and
offers clients to execute jobs on those workers in parallel. After
installing the Gearman job-server and PHP pecl/gearman extension
(<a class="reference external" href="http://toys.lerdorf.com/archives/51-Playing-with-Gearman.html">Rasmus Lerdorf has a post on
installation</a>)
we can go on writing our locking tests with Gearman.</p>
<p>The first bit is the worker, a PHP script that tries to acquire a
database lock and then sleeps for a second. The return value of this
script is the total time required for acquiring the lock and sleeping.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class LockAgentWorker</span>
<span class="x">{</span>
<span class="x">    public function findWithLock($job)</span>
<span class="x">    {</span>
<span class="x">        $fixture = $this-&gt;processWorkload($job); // setup doctrine in here</span>

<span class="x">        $s = microtime(true);</span>
<span class="x">        $this-&gt;em-&gt;beginTransaction();</span>

<span class="x">        $entity = $this-&gt;em-&gt;find($fixture['entityName'], $fixture['entityId'], $fixture['lockMode']);</span>

<span class="x">        sleep(1);</span>
<span class="x">        $this-&gt;em-&gt;rollback(); // clean up doctrine</span>

<span class="x">        return (microtime(true) - $s);</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>
</div>
<p>The glue-code for the worker script contains of the registering of the
worker method with the job-server and a simple infinite loop:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">$lockAgent = new LockAgentWorker();</span>

<span class="x">$worker = new \GearmanWorker();</span>
<span class="x">$worker-&gt;addServer();</span>
<span class="x">$worker-&gt;addFunction("findWithLock", array($lockAgent, "findWithLock"));</span>

<span class="x">while($worker-&gt;work()) {</span>
<span class="x">    if ($worker-&gt;returnCode() != GEARMAN_SUCCESS) {</span>
<span class="x">        break;</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>
</div>
<p>We need two running workers for this to work, since one worker only
processes one task at a time. Just open up two terminals and launch the
php scripts. They will wait for their first task to process.</p>
<p>Now we need to write our PHPUnit TestCase, which will contain a
GearmanClient to execute two of the “findWithLock” in parallel. Our
locking assertion will work like this:</p>
<ol class="arabic simple">
<li>Register two tasks for the “findWithLock” method that access the same
database row.</li>
<li>Register a completed callback using
“GearmanClient::setCompleteCallback()” that collects the run-time of
the individual workers.</li>
<li>Execute this tasks in parallel using “GearmanClient::runTasks()”.</li>
<li>Assert that the maximum run-time is around 2 seconds (since each
worker sleeps 1 second)</li>
</ol>
<p>The code for this steps could look like:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">class GearmanLockTest extends \Doctrine\Tests\OrmFunctionalTestCase</span>
<span class="x">{</span>
<span class="x">    private $gearman = null;</span>
<span class="x">    private $maxRunTime = 0;</span>
<span class="x">    private $articleId;</span>

<span class="x">    public function testLockIsAcquired()</span>
<span class="x">    {</span>
<span class="x">        // .. write fixture data into the database</span>

<span class="x">        $gearman = new \GearmanClient();</span>
<span class="x">        $gearman-&gt;addServer();</span>
<span class="x">        $gearman-&gt;setCompleteCallback(array($this, "gearmanTaskCompleted"));</span>

<span class="x">        $workload = array(); // necessary workload data to configure workers</span>
<span class="x">        $gearman-&gt;addTask("findWithLock", serialize($workload));</span>
<span class="x">        $gearman-&gt;addTask("findWithLock", serialize($workload));</span>

<span class="x">        $gearman-&gt;runTasks();</span>

<span class="x">        $this-&gt;assertTrue($this-&gt;maxRunTime &gt;= 2);</span>
<span class="x">    }</span>

<span class="x">    public function gearmanTaskCompleted($task)</span>
<span class="x">    {</span>
<span class="x">        $this-&gt;maxRunTime = max($this-&gt;maxRunTime, $task-&gt;data());</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>
</div>
<p>Now if both workers are waiting for processing the task we can run this
test and get a green bar for a working lock support.</p>


            <div class="tags">
                More about: 
                
            </div>

            <div class="metadata">
        <p>
            <small>
                Posted on May 02, 2010
                
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2010/01/08/immutable-datetime-objects.html">Immutable DateTime Objects</a></h1>
<p>One serious drawback of <a class="reference external" href="http://de.php.net/DateTime">PHPs DateTime
extension</a> is the mutability of its
instances. It can lead to serious bugs if a DateTime instance is passed
between different functions and is modified at unexpected places.
Additionally this possibly rules out several optimizations for scripts
that make very heavy use of dates and could share references to equal
timestamps.</p>
<p><strong>Warning:</strong> All the code assumes that you work with one timezone only!</p>
<p>The following code is an immutable version of PHP’s DateTime. All setter
methods throw an exception and add(),sub() and modify() clone the
current instance, apply the operation and return the new instance.</p>
<div class="highlight-php"><div class="highlight"><pre><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">Whitewashing\DateTime</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">DateTime</span> <span class="k">extends</span> <span class="nx">\DateTime</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * To prevent infinite recursions</span>
<span class="sd">     *</span>
<span class="sd">     * @var bool</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="k">static</span> <span class="nv">$_immutable</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">add</span><span class="p">(</span><span class="nv">$interval</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$_immutable</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="o">::</span><span class="nv">$_immutable</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
            <span class="nv">$newDate</span> <span class="o">=</span> <span class="k">clone</span> <span class="nv">$this</span><span class="p">;</span>
            <span class="nv">$newDate</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$interval</span><span class="p">);</span>
            <span class="nx">self</span><span class="o">::</span><span class="nv">$_immutable</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="k">return</span> <span class="nv">$newDate</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">add</span><span class="p">(</span><span class="nv">$interval</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">modify</span><span class="p">(</span><span class="nv">$modify</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$_immutable</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="o">::</span><span class="nv">$_immutable</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
            <span class="nv">$newDate</span> <span class="o">=</span> <span class="k">clone</span> <span class="nv">$this</span><span class="p">;</span>
            <span class="nv">$newDate</span><span class="o">-&gt;</span><span class="na">modify</span><span class="p">(</span><span class="nv">$modify</span><span class="p">);</span>
            <span class="nx">self</span><span class="o">::</span><span class="nv">$_immutable</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="k">return</span> <span class="nv">$newDate</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">modify</span><span class="p">(</span><span class="nv">$modify</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">sub</span><span class="p">(</span><span class="nv">$interval</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$_immutable</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="o">::</span><span class="nv">$_immutable</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
            <span class="nv">$newDate</span> <span class="o">=</span> <span class="k">clone</span> <span class="nv">$this</span><span class="p">;</span>
            <span class="nv">$newDate</span><span class="o">-&gt;</span><span class="na">sub</span><span class="p">(</span><span class="nv">$interval</span><span class="p">);</span>
            <span class="nx">self</span><span class="o">::</span><span class="nv">$_immutable</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="k">return</span> <span class="nv">$newDate</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">sub</span><span class="p">(</span><span class="nv">$interval</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setDate</span><span class="p">(</span><span class="nv">$year</span><span class="p">,</span> <span class="nv">$month</span><span class="p">,</span> <span class="nv">$day</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">ImmutableException</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setISODate</span><span class="p">(</span><span class="nv">$year</span><span class="p">,</span> <span class="nv">$week</span><span class="p">,</span> <span class="nv">$day</span><span class="o">=</span><span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">ImmutableException</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setTime</span><span class="p">(</span><span class="nv">$hour</span><span class="p">,</span> <span class="nv">$minute</span><span class="p">,</span> <span class="nv">$second</span><span class="o">=</span><span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">ImmutableException</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setTimestamp</span><span class="p">(</span><span class="nv">$timestamp</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">ImmutableException</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setTimezone</span><span class="p">(</span><span class="nv">$timezone</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">ImmutableException</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">class</span> <span class="nc">ImmutableException</span> <span class="k">extends</span> <span class="nx">\Exception</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="s2">"Cannot modify Whitewashing\DateTime\DateTime instance, its immutable!"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Its not the prettiest code, but it works.</p>
<p>A next optimization would be a <strong>DateFactory</strong> that manages DateTime
instances by returning already existing instances for specific dates.
This is not a perfect solution, since you won’t be able to enforce a
single instance when you are using the relative descriptive dates or
when calculating with dates using add(), sub() and modify(), however for
lots of dates created from a database or other external source it might
be quite a powerful optimization depending on your use-case:</p>
<div class="highlight-php"><div class="highlight"><pre><span class="x">namespace Whitewashing\DateTime;</span>

<span class="x">class DateFactory</span>
<span class="x">{</span>
<span class="x">    static private $_dates = array();</span>

<span class="x">    static public function create($hour, $minute, $second, $month, $day, $year)</span>
<span class="x">    {</span>
<span class="x">        $ts = mktime($hour, $minute, $second, $month, $day, $year);</span>
<span class="x">        if (!isset(self::$_dates[$ts])) {</span>
<span class="x">            self::$_dates[$ts] = new DateTime('@'.$ts);</span>
<span class="x">        }</span>
<span class="x">        return self::$_dates[$ts];</span>
<span class="x">    }</span>

<span class="x">    static public function createFromMysqlDate($mysqlDate)</span>
<span class="x">    {</span>
<span class="x">        list($date, $time) = explode(" ", $mysqlDate);</span>
<span class="x">        if($time == null) {</span>
<span class="x">            $hour = $minute = $second = 0;</span>
<span class="x">        } else {</span>
<span class="x">            list($hour, $minute, $second) = explode(":", $time);</span>
<span class="x">        }</span>
<span class="x">        list($year, $month, $day) = explode("-", $mysqlDate);</span>
<span class="x">        return self::create($hour, $minute, $second, $month, $day, $year);</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>
</div>
<p>This includes some date time calculations and date creation with
mktime() and DateTimes unix timestamp capabilities to be able to work.
Otherwise the sharing of instances could not be implemented. If you need
to create shareable instances from other formats you could just create
another creation method for it and convert the format for create() to be
used.</p>


            <div class="tags">
                More about: 
                
            </div>

            <div class="metadata">
        <p>
            <small>
                Posted on January 08, 2010
                
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2010/01/10/application-lifecycle-management-and-deployment-with-pear-and-phar-revisited-update.html">Application Lifecycle Management and Deployment with PEAR and PHAR (revisited) <em>UPDATE</em></a></h1>
<p>Some weeks ago <a class="reference external" href="http://www.whitewashing.de/blog/articles/123">I posted an
article</a> on using PEAR
and PHAR for application lifecycle management and deployment. Since then
I have gotten some feedback through comments, but also discussed the
topic with colleagues. I have also optimized the approach quite
considerably and even <a class="reference external" href="http://github.com/beberlei/pearanha">made an open-source project out of parts of
it</a> and I want to share all that
is new with you. First of all, yes the presented solution was somewhat
complex, partly because it is still a proposed idea and definitely up
for optimizations. However I am still very convinced of my approach,
something I should discuss in more detail.</p>
<p>The only other two languages I have ever programmed something in with
more than 50 lines of code are Java and C#. In both languages you can
explicitly import different dependencies like libraries and frameworks
by adding them to your application, i.e. in java you would add for
example Spring as an MVC Web layer, Hibernate as an ORM and several
other things to your project and directly bundle them in your
executable. This is very easy to configure and maintain in IDEs like
Netbeans or Eclipse (C# has the same with allowing you to attach DDLs of
libraries to your project). It also makes for a much more
straightforward deployment.</p>
<p>In the PHP world this situation was quite different (up to PHP 5.3) for
several reasons:</p>
<ul class="simple">
<li>You could not package a library into a single distributable file.</li>
<li>The PEAR installer as the only tool for updating and managing
dependencies of your application by default installs into a
system/global directory. This means dependencies your application
uses are located in a completely different location than your
application code.</li>
<li>You can’t manage multiple versions of the same package with PEAR in
this system directory, making it very hard to control servers with
different applications.</li>
<li>The global directory with your application dependencies is most often
not under version control, which makes deployment of applications
with PEAR dependencies somewhat difficult.</li>
</ul>
<p>There are some solutions to this problems:</p>
<ul class="simple">
<li>Don’t use PEAR, but put all dependencies in your version control
system.</li>
<li>Don’t use PEAR, and bundle dependencies to your code in the
build/deployment process.</li>
<li>Use PEAR like in the article described, on a per project basis.</li>
</ul>
<p>The solutions that don’t use PEAR suffer from the disadvantage that you
need to keep track of all the library and framework dependencies
yourself and upgrade them yourself. This might not be such a huge
problem from a first glance, but in my opinion many PHP applications and
projects suffer from using either no framework/library or just exactly
one. There is no real cherry-picking going on the PHP world, for example
I would really like to use Zend Framework for the general application
layout, but still use Doctrine for the Modelling and HTML Purifier for
the Output Escaping. Certain tasks might then only be solvable with the
help of eZ Components, all of which are then to some extend dependencies
of my application. With <a class="reference external" href="http://pearhub.org/">PEARHUB</a> and
<a class="reference external" href="http://pearfarm.org/">PEARFARM</a> on the horizon (<a class="reference external" href="http://blog.astrumfutura.com/archives/431-The-Democratisation-Of-PEAR-By-Pearfarm-and-Pearhub-or-About-Bloody-Time!.html">Read Padraic on this
topic</a>)
even more PHP code will be distributed using PEAR channels in the near
future. My <a class="reference external" href="http://www.whitewashing.de/blog/articles/124">immutable
DateTime</a> code for
example makes for a great little open source library that could be
distributed via PEAR, as well as
<a class="reference external" href="http://github.com/beberlei/yadif">Yadif</a> - a dependency injection
container I am using extensively.</p>
<p>Question: Are you really going to manage all these dependencies
correctly manually? Is everything up to date all the time, and
upgradeable with ease?</p>
<p>The PEAR driven solution then begins to look very desirable in this
light, however it has a considerable disadvantage: The PEAR installer
itself works on a system-wide/user-centric basis, making it impossible
to manage dependencies of several applications using only one linux
user. My little <a class="reference external" href="http://github.com/beberlei/pearanha">Pearanha</a> to the
rescue: I have taken the PEAR installer code (which is distributed with
all PHP installations across all systems) and put a new CLI tool on top
of it. Its a very simple code-generator that allows to generate a
re-configured PEAR installer script which only manages a single
application in a given directory. This approach is also used by the
symfony plugin mechanism, which internally uses the PEAR installer (did
you know?).</p>
<p>Lets revisit my blog application example <a class="reference external" href="%3Ca%20href=">from my previous PEAR
post</a>, first install from
<a class="reference external" href="http://github.com/beberlei/pearanha">Github</a> and make the “pearanha”
file executable and put it in your PATH (A PEAR Server Channel will
follow any time soon).</p>
<p>Now we need to have an existing application directory somewhere, for
example <strong>/var/www/blog</strong> and then we can put Pearanha on top of it
with:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre>benny@desktop: pearanha generate-project
</pre></div>
</div>
</div></blockquote>
<p>You then need to specify the project base dir and then the project
style (for example Zend Framework or Manual) which prompts your for the
directory that should be used for as the vendor/library directory that
PEAR will install all the code in. You will also be prompted for a
binary/scripts directory which will then hold a new PHP file for you,
the file <strong>my_phpiranha</strong>.</p>
<p><strong>Pro Argument:</strong> Switching to Pearanha can be done at any point in your
application lifecycle. Just define an additional vendor directory for
all the dependencies to go in and generate the applications pear
installer and you are good to go.</p>
<p>The generated script is your new application specific PEAR installer and
you can begin to install all the required dependencies of your
application:</p>
<blockquote>
<div><div class="highlight-python"><div class="highlight"><pre>benny@desktop:~$ cd /var/www/blog
benny@desktop:/var/www/blog$ ./vendor/pear/my_pearanha channel-discover pear.zfcampus.org
benny@desktop:/var/www/blog$ ./vendor/pear/my_pearanha install zfcampus/zf-alpha
benny@desktop:/var/www/blog$ ./vendor/pear/my_pearanha channel-discover htmlpurifier.org
benny@desktop:/var/www/blog$ ./vendor/pear/my_pearanha install hp/HTMLPurifier
benny@desktop:/var/www/blog$ ./vendor/pear/my_pearanha channel-discover pear.phpdoctrine.org
benny@desktop:/var/www/blog$ ./vendor/pear/my_pearanha install pear.phpdoctrine.org/DoctrineORM-2.0.0
benny@desktop:/var/www/blog$ ./vendor/pear/my_pearanha channel-discover components.ez.no
benny@desktop:/var/www/blog$ ./vendor/pear/my_pearanha install ezc/ezcGraph
</pre></div>
</div>
</div></blockquote>
<p>All this stuff is now located in <strong>/var/www/blog/vendor</strong>. Again you can
use PEARs complete upgrade, remove and install functionality for your
application, now without the hazzle of having to create a linux user for
each project you want to manage this way, which in my opinion is a
considerable simplification. The complete application (including its
dependencies) can then be put under version control and be readily
packaged as a single executable PHAR file by your build process.</p>
<p>As a side node, I did try Pyrus instead of PEAR for the same discussed
purpose, however most of the current PEAR channels don’t validate
against Pyrus strict standards for the package.xml file. In the future
this might change and a Pyrus based application installer will then be
integrated into Pearanha.</p>
<p><strong>UPDATE:</strong> I renamed PHPiranha to Pearanha as its more appropriate.
Also after apinsteins comment on “pear config-create” I rewrote the
generate-project parts to use the config-create functionality
internally, which allowed me to throw away half of the self-written
code. Thanks!</p>


            <div class="tags">
                More about: 
                
            </div>

            <div class="metadata">
        <p>
            <small>
                Posted on January 10, 2010
                
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2010/04/27/doctrine-2-beta-1-released.html">Doctrine 2 Beta 1 released</a></h1>
<p>Today we are happy to announce that the first beta of <a class="reference external" href="http://www.doctrine-project.org/blog/doctrine-2-0-0-beta1-released">Doctrine
2</a>
has been released and we fixed 165 issues kindly reported by several
early adopters.</p>
<p>You can grab the code from the Github project:</p>
<blockquote>
<div><dl class="docutils">
<dt><a class="reference external" href="http://github.com/doctrine/doctrine2/tree/2.0.0-BETA1">http://github.com/doctrine/doctrine2/tree/2.0.0-BETA1</a></dt>
<dd>git clone git://github.com/doctrine/doctrine2.git</dd>
</dl>
</div></blockquote>
<p>Or download it from our website:</p>
<blockquote>
<div><a class="reference external" href="http://www.doctrine-project.org/download#2_0">http://www.doctrine-project.org/download#2_0</a></div></blockquote>
<p>It is our believe that Doctrine 2 brings PHP ORMs to a new level. We are
leaving behind the Active Record pattern because we think it hurts
testability, project maintainability and is not a suitable abstraction
(80/20) for models that exceed the complexity of a blog or otherwise
simple web application. Instead we implemented a pure Data Mapper
approach with help of the new Reflection functionalities of PHP 5.3, so
your Domain Objects neither have to extend a base class nor implement an
interface.</p>
<p>We also dropped most of the magical features of Doctrine 1 in favour of
a simple and standardized API that is loosely based on the <a class="reference external" href="http://en.wikipedia.org/wiki/Java_Persistence_API">Java
Persistence API</a>, a
technical standard for Object Relational Mappers. However we try not to
blindly follow the “Program PHP like Java” approach and and deviated
from JPA where applicable to make the concepts fit better into the PHP
environment, such as alternatively hydrating all results into nested
array structures for very high read performance.</p>
<p>The cornerstone of Doctrine 2 is the query language DQL. It allows to
execute queries on the object level defined by your metadata in a
similar fashion to SQL. You can even do Joins, Subselects and Aggregates
and Group Clauses in DQL, eliminating the need to circumvent ORMs for
more advanced SQL features. Nevertheless it is also possible to write
plain SQL and let Doctrine 2 hydrate the results into an object graph.</p>
<p>In the last three month since alpha 4 we have done considerable changes
and integrated lots of feedback from our users. The most notable changes
are:</p>
<ul class="simple">
<li>Allowing Constructors of your Domain Objects to have non-optional
parameters.</li>
<li>Allow to define a natural ordering of to Many Collections that is
automatically enforced trough an SQL ORDER BY statement when
retrieved from the database.</li>
<li>Shipping the Symfony Console Component to replace our own Console
Implementation</li>
<li>New DQL syntax to load objects partially, omitting potentially
expensive fields from retrieval for the current request.</li>
<li>Changes to how bi-directional have to be defined in the mapping
files.</li>
<li>Several changes to the Events API inside the ORM, to make sure many
possible extension scenarios work smoothly.</li>
<li>Enhancements to our Console Tools</li>
<li>Surpassed the 1000 unit-tests each running against Postgres, Mysql,
Sqlite and Oci8 drivers.</li>
<li>Moved from SVN to Git:
<a class="reference external" href="http://github.com/doctrine/doctrine2">http://github.com/doctrine/doctrine2</a></li>
</ul>
<p>We also did several painful backwards incompatible changes that seemed
necessary to clean up and optimize the API or allow the ORM to be even
faster than before. The beta phase beginning today will not contain any
larger BC breaks anymore, opening up this release for a broader testing
audience.</p>
<p>For the next iteration several enhancements are planned:</p>
<ul class="simple">
<li>Support for PDO IBM, IBM DB2, SqlSrv and PDO SqlSrv und MsSql drivers</li>
<li>Pessimistic Lock Support (FOR UPDATE and SHARED)</li>
<li>Support for Custom Hydration Modes</li>
<li>Support for Custom Persister Implementations</li>
<li>Support for handling very large collections of related objects
without needing an in-memory representation of the collection</li>
<li>Separation of Doctrine\Common, Doctrine\DBAL and Doctrine\ORM into
three different projects</li>
<li>Extend the documentation even further, adding quickstart tutorials,
cookbook recipes and enhancing the existing chapters.</li>
</ul>
<p>We also plan to support several extensions for the 2.0 release such as:</p>
<ul class="simple">
<li>Migrations</li>
<li>PHPUnit Database Testing Integration</li>
<li>NestedSet Support</li>
<li>Symfony 2 Support</li>
<li>Zend Framework 2 Support</li>
</ul>
<p>Please try out the new Beta release If you find the time and leave your
feedback in our <a class="reference external" href="http://www.doctrine-project.org/jira/secure/Dashboard.jspa">Issue
Tracker</a>,
the <a class="reference external" href="http://groups.google.com/group/doctrine-user">Mailing-List</a> or
come discuss with us on Doctrine 2 on Freenode #doctrine-dev.</p>


            <div class="tags">
                More about: 
                
            </div>

            <div class="metadata">
        <p>
            <small>
                Posted on April 27, 2010
                 by beberlei <kontakt@beberlei.de>
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2010/04/18/new-netbeans-php-codesniffer-plugin-version.html">New Netbeans PHP CodeSniffer Plugin Version</a></h1>
<p>This morning I took the time to merge several changes by <a class="reference external" href="http://manuel-pichler.de/">Manuel
Piechler</a> into <a class="reference external" href="http://github.com/beberlei/netbeans-php-enhancements">my Github
branch</a> of the
CodeSniffer Plugin and released a new NBM file for you to
<a class="reference external" href="http://github.com/beberlei/netbeans-php-enhancements/downloads">download</a>.
Here are the changes done by Manuel:</p>
<ul class="simple">
<li>Ability to specify the path to CodeSniffer Binary</li>
<li>Automatic Detection of all the installed Coding Standards</li>
<li>Fixed Automatic Binary Detection on Windows</li>
</ul>
<p>The only open TODO for this project is the possibility to specify
different standards on a per project basis, currently you can only
choose a global standard.</p>


            <div class="tags">
                More about: 
                
            </div>

            <div class="metadata">
        <p>
            <small>
                Posted on April 18, 2010
                 by beberlei <kontakt@beberlei.de>
            </small>
        </p>
    </div>
        </div><div class="archive_link">
        <a href="archive.html">Archive</a>
    </div></article></div> <!-- #main -->
				</div>
			</div></div> <!-- #main-container -->

        <div class="footer-container" role="contentinfo">
			<div class="container">
				<div class="col-md-8 col-md-offset-2">
					<div class="footer">
						<small>© Copyright 2008-2017, Benjamin Eberlei.</small>

						<script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script>
					</div>
				</div>
			</div>
        </div> <!-- footer-container -->
      </div> <!--! end of #container --><script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->
    </body>
</html>