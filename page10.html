<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="Blog of Benjamin Eberlei, covering a wide range of programming, bootstrapping and entrepreneurial topics">
        <meta name="viewport" content="width=device-width">
        <meta name="google-site-verification" content="mycr8JCbLYq9QcOyh4Ub1esAdN-awH9ut6nyTKUTgE4">
        <title>Page 10 &mdash; beberlei.de</title>
            <link rel="stylesheet" href="/_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="/_static/css/bootstrap.min.css" type="text/css" />
            <link rel="stylesheet" href="/_static/blog.css" type="text/css" />
            <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" />
        <link rel="shortcut icon" href="_static/tinkerer.ico" /><!-- Load modernizr and JQuery -->
        <script src="_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="_static/plugins.js"></script>
        <script src="_static/main.js"></script>
        <link rel="search" title="Search" href="search.html" /><link rel="next" title="Older" href="page11.html" /><link rel="prev" title="Newer" href="page9.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.5.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        SOURCELINK_SUFFIX: '.txt',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="_static/underscore.js"></script><script type="text/javascript" src="_static/doctools.js"></script><script type="text/javascript" src="_static/disqus.js"></script></head>
    <body role="document">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><nav class="navbar navbar-dark">
		  <div class="container">
			  <div class="navbar-header">
				  <a class="navbar-brand" href="https://beberlei.de">Benjamin Eberlei</a>
			  </div>

			  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				  <ul class="nav navbar-nav navbar-right">
						<li><a href="index.html">Home</a></li>
						<li><a href="pages/about.html">About</a></li>
						<li><a href="/archive.html">Archive</a></li>
					  <li><a href="/rss.xml">RSS</a></li>
				  </ul>
			  </div>
		  </div>
		</nav><div class="main-container" role="main"><div class="container">
				<div class="row">
					<div class="col-md-8 col-md-offset-2 col-sm-12"><article role="article">
							<div class="section">
            <h1><a href="2012/08/16/oop_business_applications__data__context__interaction.html">OOP Business Applications: Data, Context, Interaction</a></h1>
<p>Other posts in this series:</p>
<ul class="simple">
<li><a class="reference external" href="http://whitewashing.de/2012/08/11/oop_business_applications__trying_to_escape_the_mess.html">OOP Business Applications: Trying to escape the
mess</a></li>
<li><a class="reference external" href="http://whitewashing.de/2012/08/13/oop_business_applications_entity_boundary_interactor.html">OOP Business Applications: Entity, Boundary, Interactor</a></li>
</ul>
<p>The next design pattern for technical system design is called “Data, Context,
Interaction”. It’s inventors Trygve Reenskaug and James Coplien call it a new
paradigm, in the context of PHPs language constraints it can be classified as
architectural design pattern. I came across this pattern through <a class="reference external" href="https://twitter.com/go_oh">Gordon Oheim</a>. He has also invested quite some time going
through the book on DCI and trying to understand this pattern with me.</p>
<p>As in the EBI pattern, DCI separates data objects (Data) from behavior implemented
in use-cases (Context). Data objects are never directly involved in these
use-cases, but are “casted” to their respective roles that they are taking in
the use-case. This can be implemented with aggregation or traits in PHP.</p>
<p>One goal of DCI is to get object-oriented programming to a place, where you
can look at a use-case and its roles and be very sure that the program is
running correctly, because you can guarantee that there are no unexpected side
effects. It also aims at keeping the amount of code required to keep in mind
for a given use-case as small as possible, allowing developers to reason about
the code with more confidence.</p>
<div class="section" id="terminology">
<h2>Terminology</h2>
<p>In DCI, <strong>data</strong> are objects that encapsulate the state of the application.
As in EBI, they only contain logic that is true for all the possible use-cases.
These classes represent <em>what the system is</em>.</p>
<p><strong>Roles</strong> and <strong>Context</strong> represent <em>what the system does</em> and are supposed to
capture the End User’s Mental Model as close as possible.</p>
<p><strong>Roles</strong> add behavior to the data objects by either wrapping them or
acting as traits for the data objects.</p>
<p><strong>Context</strong> is the use-case and fulfils its role by making roles <strong>interact</strong> with
each other. These roles then modify the underlying data.</p>
</div>
<div class="section" id="example">
<h2>Example</h2>
<p>Starting from the bank account example of the EBI post, we can introduce DCI
quite easily by adding the missing concept of roles. In the use case of
transferring money that would be:</p>
<ul class="simple">
<li>TransferMoneySource</li>
<li>TransferMoneySink (Destination)</li>
</ul>
<p>We can do this by either introducing two interfaces and two concrete
implementations that accept the <span class="docutils literal"><span class="pre">BankAccount</span></span> as object to work on
or by building two traits. I will go down the route with traits, to show
one possible use-case for this new PHP 5.4 feature. The idea here is to
implement all the behavior necessary on a trait and then have simple dummy
objects using them in the tests for this use-case.</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">trait</span> <span class="nx">TransferMoneySource</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">transferTo</span><span class="p">(</span><span class="nv">$destination</span><span class="p">,</span> <span class="nx">Money</span> <span class="nv">$money</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$destination</span><span class="o">-&gt;</span><span class="na">transferFrom</span><span class="p">(</span><span class="nv">$destination</span><span class="p">,</span> <span class="nv">$money</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">abstract</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">withdraw</span><span class="p">(</span><span class="nx">Money</span> <span class="nv">$money</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">trait</span> <span class="nx">TransferMoneySink</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">transferFrom</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="nx">Money</span> <span class="nv">$money</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$source</span><span class="o">-&gt;</span><span class="na">withdraw</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">deposit</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">abstract</span> <span class="k">public</span> <span class="k">function</span> <span class="nf">deposit</span><span class="p">(</span><span class="nx">Money</span> <span class="nv">$money</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Any checks for balances, credit limits or other things would also happen
here. The <span class="docutils literal"><span class="pre">withdraw</span></span> and <span class="docutils literal"><span class="pre">deposit</span></span>  on the data objects should be as
dumb as possible, so that their implementation does not cause any side-effects
on the execution of this use-case.</p>
<p>The bank account would then be modified to look:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">BankAccount</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">TransferMoneySource</span><span class="p">,</span> <span class="nx">TransferMoneySink</span><span class="p">;</span>

    <span class="k">private</span> <span class="nv">$balance</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Money</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">withdraw</span><span class="p">(</span><span class="nx">Money</span> <span class="nv">$money</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span><span class="o">-&gt;</span><span class="na">subtract</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">deposit</span><span class="p">(</span><span class="nx">Money</span> <span class="nv">$money</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The use-case <span class="docutils literal"><span class="pre">TransferMoney</span></span> would then be modified to create Roles instead
of Data objects from the DAO. This can be a bit tricky when you have multiple
data objects implementing the same role and you have no way of knowing which
underlying data object to pick. The binding of data objects to roles happens
in the use-case. The use-case needs a means to retrieve objects with certain
roles, which then access underlying data sources. To avoid that your use-cases
have to know about how to bind roles to data, you could use GUIDs in your
application and fetch all objects from one data store. Another way would be to
implement data access objects for roles, that then know how to retrieve their
corresponding data.</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MoneyTransfer</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$source</span><span class="p">;</span>
    <span class="k">private</span> <span class="nv">$destination</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$moneySource</span><span class="p">,</span> <span class="nv">$moneySink</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">source</span> <span class="o">=</span> <span class="nv">$moneySource</span><span class="p">;</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">destination</span> <span class="o">=</span> <span class="nv">$moneySink</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">transferMoney</span><span class="p">(</span><span class="nx">Money</span> <span class="nv">$money</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">source</span><span class="o">-&gt;</span><span class="na">transferTo</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">destination</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The simplicity of this is appealing, however don’t forget that we have
abstracted I/O completely here. There has to be code that deals with that part
of the system somewhere. However this again is not at the heart of all the DCI
examples out there, making it difficult to reason about the actual practical
implications.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">One drawback with this example is, that PHP does not support typehinting for
traits.</p>
</div>
<p>Here is an example of how the bank application service could look like:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">BankApplicationService</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">transferMoney</span><span class="p">(</span><span class="nv">$sourceId</span><span class="p">,</span> <span class="nv">$destinationId</span><span class="p">,</span> <span class="nx">Money</span> <span class="nv">$amount</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$source</span>      <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">objectStorage</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$sourceId</span><span class="p">);</span>
        <span class="nv">$destination</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">objectStorage</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$destinationId</span><span class="p">);</span>

        <span class="nv">$useCase</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MoneyTransfer</span><span class="p">(</span><span class="nv">$source</span><span class="p">,</span> <span class="nv">$destination</span><span class="p">);</span>

        <span class="nv">$conn</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">conn</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$useCase</span><span class="o">-&gt;</span><span class="na">transferMoney</span><span class="p">(</span><span class="nv">$amount</span><span class="p">);</span>
            <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>

            <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">rollback</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <span class="docutils literal"><span class="pre">ObjectStorage</span></span> here is a service (repository) that can find any
persistent data object by a global ID. This is necessary, because it
doesn’t actually matter what data object uses the necessary traits
for this use-case.</p>
<p>Again as in EBI, in a bigger system you would need to find some abstraction
layer that does this in a more generic way.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>When Gordon started showing me this pattern we were both puzzled as how
to actually implement this in the real world. Especially the concept
of binding roles to data objects still confuses us. Most notably why the use
of traits or aggregates should actually constitute a new programming paradigm
instead of just another way to do OOP.</p>
<p>In Scala casting data objects to roles is actually possible by binding traits
to objects at runtime. This is not possible in PHP however and has to be done
statically.</p>
<p>Compared to EBI, DCI focuses drastically on transaction script domain logic, by
suggesting to implement roles for every use-case for the sake of avoiding
side-effects. This is actually is very valuable lesson from this pattern.
Finding means to decrease the complexity of software is always a good thing.
And the explicit definition of this concept as <strong>roles</strong> is actually easy to
explain to other programmers.</p>
<p>One thing that is lacking in DCI is that there is no concrete mechanism to deal
with the boundary to other parts of the system. This is actually a step back
from EBI and I suggest using EBI pattern in combination with DCI to solve this.</p>
<p>The largest benefit from DCI (and its self proclaimed goal) is the mapping from
the users/customers mental model directly into the code by using Use-Cases and
Roles. The communication with the customer about behavior can exclusively focus
on the current context and its use-case. Mapping this behavior to actual data
can then be done in a different step.</p>
<p>This simplification of use-cases and reduction of side-effects between
different parts of the system has other benefits: It can lead to easier to test
code and makes it much easier for developers to develop on small and isolated
parts of the system.</p>
</div>


            
            <div class="tags">
                More about: 
                <a href="tags/applicationdesign.html">ApplicationDesign</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on August 16, 2012
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2012/08/13/oop_business_applications_entity_boundary_interactor.html">OOP Business Applications: Entity, Boundary, Interactor</a></h1>
<p>Other posts in this series:</p>
<ul class="simple">
<li><a class="reference external" href="http://whitewashing.de/2012/08/11/oop_business_applications__trying_to_escape_the_mess.html">OOP Business Applications: Trying to escape the
mess</a></li>
</ul>
<p>Continuing the series, I will talk about Entity, Boundary and Interactor (EBI)
an architectural design pattern. I first heard about it in a keynote video of
<a class="reference external" href="https://sites.google.com/site/unclebobconsultingllc/">Uncle Bob</a> on Ruby
Midwest called <a class="reference external" href="http://www.confreaks.com/videos/759-rubymidwest2011-keynote-architecture-the-lost-years">“The lost years of architecture”</a>.
This is also described as <a class="reference external" href="http://alistair.cockburn.us/Hexagonal+architecture">Hexagonal architecture</a> or “Ports and Adapters”
by Alistair Cockburn.</p>
<p>In this pattern any client of the system talks to the model using a model
request object and receives data from the model in form of model responses objects.
Additionally when your model talks to any kind of persistence or subsystem it
should go through an adapter that is replaceable. For a model architecture
designed this way, you can replace any part of the UI oder lower layers by
writing new adapters and plug them in.</p>
<div class="section" id="terminology">
<h2>Terminology</h2>
<p>To iterate the terminology:</p>
<p><strong>Entities</strong> are objects that represent the system data of the application. They don’t contain
much logic except rules that are set in stone and are never going to change
(based on physic or mathematical laws or something).</p>
<p><strong>Interactors</strong> are use-case objects, they contain the business logic that is valid
in the current use-case and works with entities to fulfil their task.</p>
<p>The <strong>boundary</strong> is responsible for translating model request/response into a
format that the UI or actor can understand. They also mediate between model
and lower levels, for example to manage database transactions.</p>
</div>
<div class="section" id="an-example">
<h2>An example</h2>
<p>Lets start with an example in PHP code. We will keep using a common example
throughout all blog posts, the usual Bank Account/Money Transfer. The use case
is the money transfer from one bank account (source) to another one
(destination).</p>
<p>We start by implementing the entity <span class="docutils literal"><span class="pre">BankAccount</span></span>:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">BankAccount</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$balance</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Money</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">withdraw</span><span class="p">(</span><span class="nx">Money</span> <span class="nv">$money</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span><span class="o">-&gt;</span><span class="na">subtract</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">deposit</span><span class="p">(</span><span class="nx">Money</span> <span class="nv">$money</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">balance</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>It is straightforward to implement the <span class="docutils literal"><span class="pre">withdraw</span></span> and <span class="docutils literal"><span class="pre">deposit</span></span>
functionality. The Money object implementation is omitted here.</p>
<p>The Interactor handles the use-case of transferring money from the
source to the destination account:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MoneyTransferRequest</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="nv">$sourceId</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$destinationId</span><span class="p">;</span>
    <span class="k">public</span> <span class="nv">$amount</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">class</span> <span class="nc">MoneyTransferResponse</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">MoneyTransfer</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$accountDao</span><span class="p">;</span> <span class="c1">// ctor omitted</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">transferMoney</span><span class="p">(</span><span class="nx">MoneyTransferRequest</span> <span class="nv">$transfer</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$source</span>      <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">accountDao</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$transfer</span><span class="o">-&gt;</span><span class="na">sourceId</span><span class="p">);</span>
        <span class="nv">$destination</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">accountDao</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$transfer</span><span class="o">-&gt;</span><span class="na">destinationId</span><span class="p">);</span>
        <span class="nv">$money</span>       <span class="o">=</span> <span class="k">new</span> <span class="nx">Money</span><span class="p">(</span><span class="nv">$transfer</span><span class="o">-&gt;</span><span class="na">amount</span><span class="p">);</span>

        <span class="nv">$source</span><span class="o">-&gt;</span><span class="na">withdraw</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>
        <span class="nv">$destination</span><span class="o">-&gt;</span><span class="na">deposit</span><span class="p">(</span><span class="nv">$money</span><span class="p">);</span>

        <span class="k">return</span> <span class="k">new</span> <span class="nx">MoneyTransferResponse</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The <span class="docutils literal"><span class="pre">MoneyTransferRequest</span></span> and <span class="docutils literal"><span class="pre">MoneyTransferResponse</span></span> objects are dumb
php objects (so called data-transfer objects, DTO).</p>
<p>You can see in the example that we use a Data Access object to retrieve the
source and destination account entities from some storage subsystem. To follow the EBI
design pattern, we have to decouple this data access object from the model,
by offering a port (Interface):</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">interface</span> <span class="nx">AccountDaoInterface</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">find</span><span class="p">(</span><span class="nv">$accountId</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This way our business logic is storage independent.</p>
<p>An example for a boundary would be the requirement for a transaction in
the bank account sample. We need to wrap the whole MoneyTransfer use-case in
a transaction. Lets say the invocation of our Use-Case is controlled through
some kind of application boundary object:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">BankApplicationBoundary</span>
<span class="p">{</span>
    <span class="k">private</span> <span class="nv">$applicationFactory</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">transferMoney</span><span class="p">(</span><span class="nx">MoneyTransferRequest</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$connection</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">applicationFactory</span><span class="o">-&gt;</span><span class="na">createConnection</span><span class="p">();</span>
        <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">beginTransaction</span><span class="p">();</span>

        <span class="k">try</span> <span class="p">{</span>
            <span class="nv">$useCase</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MoneyTransfer</span><span class="p">(</span><span class="nv">$factory</span><span class="o">-&gt;</span><span class="na">createAccountDao</span><span class="p">());</span>
            <span class="nv">$result</span> <span class="o">=</span> <span class="nv">$useCase</span><span class="o">-&gt;</span><span class="na">transferMoney</span><span class="p">(</span><span class="nv">$request</span><span class="p">);</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">commit</span><span class="p">();</span>

            <span class="k">return</span> <span class="nv">$result</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">catch</span><span class="p">(</span><span class="nx">\Exception</span> <span class="nv">$e</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$connection</span><span class="o">-&gt;</span><span class="na">rollback</span><span class="p">();</span>
            <span class="k">throw</span> <span class="nv">$e</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is a very elaborate way to describe that calling the transfer money
use-case is wrapped in a Transaction, another port for the storage system to
manage transactions in this case. The code here is very explicit about
the actual task. In a real application you would probably find a more
generic approach to getting this job done.</p>
</div>
<div class="section" id="boundary-abstraction">
<h2>Boundary Abstraction</h2>
<p>Thinking about the boundaries I came up with a library several month ago called
<a class="reference external" href="https://github.com/beberlei/context">Context</a>, which I deprecated already
(Reason below).  It allows you to wrap calls to the model by some sort of proxy
that transforms the request and response and also handles transactions and
such. Loosely spoken this was actually some kind of AOP library, using the
limited ways that PHP provides to implement AOP (magic <span class="docutils literal"><span class="pre">__call</span></span> proxies).</p>
<p>With context you would do something like:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="nv">$context</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">getContext</span><span class="p">();</span>

<span class="c1">// 1. direct invocation</span>
<span class="nv">$myService</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">MyService</span><span class="p">();</span>
<span class="nv">$context</span><span class="o">-&gt;</span><span class="na">execute</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="s1">'service'</span> <span class="o">=&gt;</span> <span class="nv">$myService</span><span class="p">,</span> <span class="s1">'method'</span> <span class="o">=&gt;</span> <span class="s1">'doSomething'</span><span class="p">,</span> <span class="s1">'arguments'</span> <span class="o">=&gt;</span> <span class="nv">$args</span><span class="p">));</span>

<span class="c1">// 2. proxy wrapping</span>
<span class="nv">$myService</span> <span class="o">=</span> <span class="nv">$context</span><span class="o">-&gt;</span><span class="na">wrap</span><span class="p">(</span><span class="k">new</span> <span class="nx">MyService</span><span class="p">());</span>
<span class="nv">$myService</span><span class="o">-&gt;</span><span class="na">doSomething</span><span class="p">(</span><span class="nv">$args</span><span class="p">);</span>
</pre></div>
</div>
<p>The second way is obviously way more readable, but its also rather magic.</p>
<p>I deprecated this library because in the end it wasn’t really helpful that
much. Implementing an application specific proxy for services is done in
almost no time and then it solves all your specific needs. My main problem with
the library is that it tries to magically take away the need to design the
boundary of your application yourself - in a way that is not really coherent to
other developers.</p>
<p>In my own current greenfield applications I quickly went away from using it,
since a custom application proxy as shown in this
<a class="reference external" href="https://gist.github.com/3272909">Gist</a> is really much simpler to implement and
use.</p>
</div>
<div class="section" id="using-with-symfony2">
<h2>Using with Symfony2</h2>
<p>As I am currently exclusively developing Symfony2/Silex applications, applying
EBI to Symfony2 framework based applications is very important to me. The
biggest difficulty here is the Form layer, especially the request data-mapping and
validation concerns, which are normally part of the model. There are two
approaches I came up with to solve this:</p>
<ul class="simple">
<li>Build Forms for arrays or DTOs and send them through to the boundary to the model.
You have to validate the data again on the model, which is annoying, but in
this case the clean way. This is not so easy to do with complex forms though
as you need to map the request objects to your entities.</li>
<li>Create a Model Request that wraps and hides the form behind a simple data
mapping API. This way you can make it look as if you would map a DTO onto
an object, but in this case you are using the Form API as the mapper.</li>
</ul>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">class</span> <span class="nc">MyService</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">edit</span><span class="p">(</span><span class="nx">EditRequest</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$entity</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dao</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$request</span><span class="o">-&gt;</span><span class="na">id</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">dataMapper</span><span class="o">-&gt;</span><span class="na">transform</span><span class="p">(</span><span class="nv">$request</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The problem with this approach is, that you cant really unit-test these methods
anymore, because the complexity of the form layer mapping cannot be mocked with
this API. Instead your tests always need the full form layer (with validation,
depending services etc.) to allow for real-world testing. Additionally you have
to make the DataMapper throw an exception that you can catch in the controller,
rendering the appropriate response. Using exceptions for controlling executions
paths is not a very good practice though.</p>
<p>Another thing that actually helped was the SensioFrameworkExtraBundle and
ParamConverters. In my project I now have the framework building the Model
Request objects by convention from the HTTP Request, so that I only need to
pass them on and can skip the actual mapping of HTTP Request to Model Request.</p>
</div>
<div class="section" id="pros-and-cons">
<h2>Pros and Cons</h2>
<p>This design pattern very closely resembles what Fowler calls <strong>Service Layer</strong>
pattern in PoEAA. EBI is going a bit more into detail by naming individual
parts of the pattern more explicit. Without more restrictions however using
this pattern will drive you towards many of the problems described in my
previous post.</p>
<p>Clean separation from frameworks is achieved, depending on the actual usage
however only at a significant cost.  Never forget stepping back and thinking
about further abstractions, otherwise applying EBI is leading to lots of code
being manually written.</p>
<p>This already shows one particular annoyance are the data-transfer objects. You
need to invest quite some work to get a mapping working from entities to
transfer objects and back. In the process you will loose the convenience of
“Open Entity Manager in the View”, where you can lazy load any
data you want to access in the view. This is quite a painful step, because you
are loosing lots of flexibility. Much more annoying is the need to update
entities from data-transfer objects, requiring sophisticated code for merging
of partial object graphs.</p>
<p>What this design pattern improves is the testability of code and also the
execution of tests is MUCH better, when you don’t have to go through the whole
application stack to test something.</p>
<p>Implementing behavior into the use-cases also avoids lots of lasagna code
compared to a messy domain driven design. You get a very good overview of
what is actually happening just by looking at the Model Request and Interactor
classes. However depending on the use-case the classes can get very big
and might need lots of collaborators, which make the problem complex again.</p>
<p>It is important to note that aggregating the domain logic in the use-cases
actually means going to some sort of transaction script processing, away from
domain driven design. I am pretty sure that this is not necessarily the
intention of this design pattern from a POV of Uncle Bob. However depending on
the sophistication of the applications domain logic, transaction script is
actually a very good pattern for simple to medium complex use-cases and
I like to have this as a general rule for developers (“Put behavior on the
use-case”).</p>
<p>In conclusion I can partially recommend using the EBI pattern. You have to be
careful to find abstraction layers that keep your code DRY and SOLID however,
something which does not come naturally with this pattern. If you are not
careful you end up with all the “messy points” that I mentioned in my previous
blog post.</p>
<p>You should be especially careful to avoid lots of DTO &lt;-&gt; Entity Mapping code
by using some code-generation for example to do parts of this job for you. The
worst outcome with this pattern is, when you manually code layers for HTTP
Request/Form =&gt; DTO =&gt; Entity mapping and the other way around.</p>
</div>


            
            <div class="tags">
                More about: 
                <a href="tags/applicationdesign.html">ApplicationDesign</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on August 13, 2012
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2012/08/11/oop_business_applications__trying_to_escape_the_mess.html">OOP Business Applications: Trying to escape the mess</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">tl;dr Version: I present a list of problems with OOP business applications from
my personal experience and then introduce 3 approaches that I was put in
contact with over the last year, DCI, EBI and CQRS. This post is an
introduction to a series about this approaches.</p>
</div>
<p>I mentally divide the world of programming into two large parts:</p>
<ol class="arabic simple">
<li>Library and system programming</li>
<li>business applications</li>
</ol>
<p>The first produces code solving technical problems, often in a beautiful and
dedicated way. The second regularly produces mess, hopefully still
serving customers by optimizing their business. This differentiation is an
exaggeration, but from my experience its far easier to run a greenfield business
project into the ground than a new library.</p>
<p>There has to be a reason why so many programmers dedicate much free time to
open source projects. It might be empirical prove, that all our business
projects don’t make us happy at the end of the day and we have to show
ourselves that we can do better.</p>
<p>I enjoy writing business applications more than libraries, but they are also
much more difficult to get right in both social and technical dimensions.  One
motivational driver of <a class="reference external" href="https://github.com/beberlei">my open source activities</a> always was to simplify the technical dimension
of OOP business applications.</p>
<div class="section" id="my-personal-list-of-annoyances">
<h2>My Personal List of Annoyances</h2>
<p>This blog post is not about blaming customers (as the usual suspect), its about
finding the problems in usual OOP code of business systems from my experience
with PHP projects. To keep things short, I will list my <em>personal</em> list of
technical annoyances in business projects in no particular order. These are
highly subjective points.</p>
<ul class="simple">
<li>Getter/Setter Madness of Objects that are used to store data into
databases. Leading to huge objects that are essentially just meaningless
stores of data.</li>
<li>Updating complex object graphs from user input.</li>
<li>Separation of model, controller and views, especially when dealing with
forms. This is very complicated to achieve.</li>
<li>Lazy Loading and Query performance problems when using an ORM. Additionally
replacing parts of the views with hand-crafted SQL is often difficult and/or
time intensive, when already using an ORM.</li>
<li>Inability to decouple code that was written with CRUD (generators and
utilities) in mind towards more domain driven code, when the requirements
change.</li>
<li>Dependency mess leading to hard to test code, generally leading to untested
applications. Too often frameworks create huge dependencies that
make your domain model messy and complex to mock in tests.</li>
<li>Focus on synchronous request/response handling makes later usage of message
queues very complicated and expensive to refactor towards.</li>
<li>Tight coupling of model against the framework code.</li>
<li>Junior developers have too much freedom, when there is not much structure in
the code, but rather just a big ball of mud. Additionally with the tight
coupling of so many components, junior developers get easily lost in the code
and produce unexpected side-effects.</li>
<li>Use-cases easily span more than 5 classes. To grasp the interaction you have
to keep lots of code in your head, especially complicated for junior
developers again. As they cannot really work on a problem in isolation.</li>
<li>Constant violations of <a class="reference external" href="http://en.wikipedia.org/wiki/SOLID_%28object-oriented_design%29">SOLID</a> principles
due to framework or persistence requirements.</li>
<li>Compared to library development, user-facing applications often have much
higher coupling between classes and namespaces. In libraries its often easy
to find different concerns, but in applications they seem hard to divide for
developers.</li>
<li>In combination with a rich javascript client, requirements to update objects
through their CRUD API produces concurrency and lost-update hell, that
dynamic server-side applications could mostly avoid before.</li>
</ul>
<p>Essentially if you work in a tight schedule, project based environment where
the decision makers sell rapid application development and prototyping, then you
often have only one, maybe one and a half attempts to get the big picture
right. From that moment on you have to build on that decision and hope for the
best.</p>
<p>We have tried not to go the RAD+CRUD tools ways in several projects, to escape
the problems listed above. But without changes in your mindest you end up with
hand written mess, compared to getting there with tools.</p>
<p>Specifically <a class="reference external" href="http://en.wikipedia.org/wiki/Domain-driven_design">Domain Driven Design</a> applied naively can make
the problem even worse. It easily leads to lasagna code, where you have layers
of layers that are very hard to understand. Personally I prefer spaghetti code
over lasagna code, because its comparatively simpler to understand.</p>
</div>
<div class="section" id="finding-new-approaches">
<h2>Finding new Approaches</h2>
<p>Rather than to embrace the suck and dive deeper into CRUD architectures, I felt
there has to be some solution to organize business models structurally to avoid
all (or most) of these problems. In the PHP world with <a class="reference external" href="http://www.symfony.com">Symfony2</a> and <a class="reference external" href="http://www.doctrine-project.org">Doctrine2</a>
you have a powerful toolbox to avoid many of the problems above, but it is
still not simple to write clean object oriented applications.</p>
<p>After years of participation in both open source projects I still feel there is
a missing puzzle piece, to reach a clean separation of all the model concerns
from framework and persistence.</p>
<p>At some point I would really like to close the gap between desired technical
state of a project and the state it is actually in. I know there is no size
fits all solution, but I fell a checklist of architectural patterns with pro
and con arguments allows me to adjust the expectations about how a system looks
in the end.</p>
<p>Thanks to <a class="reference external" href="https://twitter.com/go_oh">Gordon</a>, <a class="reference external" href="https://twitter.com/spriebsch">Stefan</a> and <a class="reference external" href="https://twitter.com/tom_noise">Thomas</a>
I was introduced to several approaches to OO application design that I
started to explore in the past last months:</p>
<ul class="simple">
<li><a class="reference external" href="http://en.wikipedia.org/wiki/Data,_context_and_interaction">Data, Context, Interaction (DCI)</a> - which Gordon
studied a lot</li>
<li><a class="reference external" href="http://alistair.cockburn.us/Hexagonal+architecture">Entity, Boundary, Interactor (EBI)</a>, also called Hexagonal
architecture or “Ports and adapters”. Gained popularity after <a class="reference external" href="http://www.confreaks.com/videos/759-rubymidwest2011-keynote-architecture-the-lost-years">Uncle Bobs talk
at Ruby Midwest</a>
last year.</li>
<li><a class="reference external" href="http://en.wikipedia.org/wiki/Command-query_separation">Command-Query-Responsibility-Segregation (CQRS)</a> well described in a
<a class="reference external" href="http://www.udidahan.com/2009/12/09/clarified-cqrs/">blog post by Udi Dahan</a> and in a hands on <a class="reference external" href="http://www.viddler.com/v/dc528842">one
day video class</a> by Greg Young.</li>
</ul>
<p>They are not new and have all been around for several years already. I would
describe all three of them as architectural design patterns, though some people
might probably disagree with this classification. All three approaches make
you think about application development beyond just “service layers” in
radically new ways. All three have helped me rethink business applications in
different ways.</p>
<p>In the next weeks I will talk about each of these approaches individually, show
some examples and then wrap up my thoughts about all of them.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Gordon and I will talk about this topic on the <a class="reference external" href="http://www.froscon.de/en/home/">Free and Open Source
Conference</a> in Sankt Augustin Germany on
25th/26th August of 2012. Feel free to drop by and discuss this topic!</p>
</div>
</div>


            
            <div class="tags">
                More about: 
                <a href="tags/applicationdesign.html">ApplicationDesign</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on August 11, 2012
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2012/06/03/setting_up_development_machines_with_puppet.html">Setting up Development Machines with Puppet</a></h1>
<p>I wrote <a class="reference external" href="/2012/05/31/virtual_machines_with_vagrant__veewee_and_puppet.html">about Vagrant</a> last week and
mentioned to talk about <a class="reference external" href="http://puppetlabs.com/puppet/what-is-puppet/">Puppet</a> in the future. Before I will
dive into Puppet in combination with Vagrant I want to share my general
experiences with Puppet (beginners level, I just played with this today).</p>
<p>Puppet is a configuration management tool. It uses a declarative language to
describe how a system should look like. Upon invocation of puppet it attempts
to get the system from its current state into the desired state by installing
packages, executing programs/scripts and creating files/directories.</p>
<p>My laptop was still on Ubuntu 10.04 this morning, but for <a class="reference external" href="http://live.symfony.com">Symfony Live</a> I needed to upgrade to 12.04. This was necessary to
run a Virtualbox VM on my laptop that I built on my 12.04 desktop. Additionally
I really like the Unity desktop and wanted to get away from the Gnome that is
in 10.04.</p>
<p>After a backup and fresh installation of Ubuntu I realized how many things I
have to install to get this machine productive:</p>
<ul class="simple">
<li>LAMP stack + a bunch of other databases and services</li>
<li>Git, Svn, Hg, ..</li>
<li>Virtualbox + Vagrant</li>
<li>Vim with my Dot-Files, including Command-T which requires compilation,
and a bunch of development tools such as tree, ack-grep.</li>
<li>PHP Tools (PHPUnit, PHPCS, Xdebug, Xhprof)</li>
<li>Git with Author Information and global ignore file</li>
<li>A bunch of .bashrc initializations</li>
<li>Some open source projects I always have around (Doctrine, ...)</li>
<li>Setup automatic backup with my cloud storage provider (<a class="reference external" href="https://www.free-hidrive.com/">Strato Hidrive</a> - they support rsync)</li>
<li>and I probably forgot a bunch of tools just thinking about this today.</li>
</ul>
<p>I realized not only virtual machines, but also their hosts (my development
machines) could be automatically setup with Puppet.</p>
<p>So instead of saving my <span class="docutils literal"><span class="pre">.bash_history</span></span> to remember the steps I automated
them using Puppet. In Puppet you define Resources of several types, for example
Files, Packages or shell commands. You group these resources together in a
<span class="docutils literal"><span class="pre">.pp</span></span> file and then invoke <span class="docutils literal"><span class="pre">puppet</span> <span class="pre">apply</span> <span class="pre">&lt;file&gt;.pp</span></span>. You can install Puppet
via <span class="docutils literal"><span class="pre">sudo</span> <span class="pre">apt-get</span> <span class="pre">install</span> <span class="pre">puppet</span></span> on Ubuntu.</p>
<p>The idea is to define Puppet resources in a way that they are performed once and
then the system has this resource. This means you can run puppet as often as
you want and it will only activate the missing resources.</p>
<p>I separate the installation process into two puppet files, one that has to be
run with root <span class="docutils literal"><span class="pre">~/.puppet/devmachine-root.pp</span></span> and another one that has to be run with
my own user <span class="docutils literal"><span class="pre">~/.puppet/devmachine.pp</span></span>.</p>
<p>Because every dev-machine setup is unique, I will just show some
examples of my puppet file to get the message across:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="c1"># /home/benny/.puppet/devmachine.pp</span>

<span class="c1"># VIM Dot Files</span>
<span class="n">vcsrepo</span> <span class="p">{</span> <span class="s1">'vim-dotfiles'</span><span class="p">:</span>
    <span class="n">path</span>     <span class="o">=&gt;</span> <span class="s2">"/home/$id/.vim"</span><span class="p">,</span>
    <span class="n">ensure</span>   <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
    <span class="n">provider</span> <span class="o">=&gt;</span> <span class="n">git</span><span class="p">,</span>
    <span class="n">source</span>   <span class="o">=&gt;</span> <span class="s1">'https://...'</span>
<span class="p">}</span>

<span class="n">file</span> <span class="p">{</span> <span class="s1">'vim-dotfiles-symlink'</span><span class="p">:</span>
    <span class="n">path</span>   <span class="o">=&gt;</span> <span class="s2">"/home/$id/.vimrc"</span><span class="p">,</span>
    <span class="n">ensure</span> <span class="o">=&gt;</span> <span class="n">link</span><span class="p">,</span>
    <span class="n">target</span> <span class="o">=&gt;</span> <span class="s1">'.vim/vimrc'</span><span class="p">,</span>
    <span class="n">require</span> <span class="o">=&gt;</span> <span class="n">Vcsrepo</span><span class="p">[</span><span class="s1">'vim-dotfiles'</span><span class="p">]</span>
<span class="p">}</span>

<span class="n">exec</span> <span class="p">{</span> <span class="s1">'vim-make-command-t'</span><span class="p">:</span>
    <span class="n">command</span> <span class="o">=&gt;</span> <span class="s1">'rake make'</span><span class="p">,</span>
    <span class="n">cwd</span>     <span class="o">=&gt;</span> <span class="s2">"/home/$id/.vim/bundle/Command-T"</span><span class="p">,</span>
    <span class="n">unless</span>  <span class="o">=&gt;</span> <span class="s2">"ls -aFlh /home/$id/.vim/bundle/Command-T|grep 'command-t.recipe'"</span><span class="p">,</span>
    <span class="n">require</span> <span class="o">=&gt;</span> <span class="n">Vcsrepo</span><span class="p">[</span><span class="s1">'vim-dotfiles'</span><span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The three keywords <span class="docutils literal"><span class="pre">vcsrepo</span></span>, <span class="docutils literal"><span class="pre">file</span></span> and <span class="docutils literal"><span class="pre">exec</span></span> are called types. They
define what functionality should be executed by puppet. Vcsrepo is a custom
type that you can grab <a class="reference external" href="https://github.com/puppetlabs/puppetlabs-vcsrepo.git">from Github</a>.</p>
<ul class="simple">
<li>The first block uses Git to make sure that in my home directory the
<span class="docutils literal"><span class="pre">~/.vim</span></span> directory is a checkout of a given remote git repository.</li>
<li>The second file block makes sure that <span class="docutils literal"><span class="pre">~/.vimrc</span></span> points to <span class="docutils literal"><span class="pre">~/.vim/vimrc</span></span>
using a symlink.</li>
<li>The third block compiles the Command-T VIM plugin. Inside the
exec block you can see the unless condition. This is necessary to prevent the
command from being executed whenever <span class="docutils literal"><span class="pre">devmachine.pp</span></span> is executed with
puppet. The require makes sure this resource is only activated after the dotfiles
were installed.</li>
</ul>
<p>Another nice example is the configuration of Git:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="c1"># Configure Git</span>
<span class="n">exec</span> <span class="p">{</span> <span class="s2">"git-author-name"</span><span class="p">:</span>
    <span class="n">command</span> <span class="o">=&gt;</span> <span class="s1">'git config --global user.name "Benjamin Eberlei"'</span><span class="p">,</span>
    <span class="n">unless</span> <span class="o">=&gt;</span> <span class="s2">"git config --global --get user.name|grep 'Benjamin Eberlei'"</span>
<span class="p">}</span>

<span class="n">exec</span> <span class="p">{</span> <span class="s2">"git-author-email"</span><span class="p">:</span>
    <span class="n">command</span> <span class="o">=&gt;</span> <span class="s1">'git config --global user.email "kontakt@beberlei.de"'</span><span class="p">,</span>
    <span class="n">unless</span> <span class="o">=&gt;</span> <span class="s2">"git config --global --get user.email|grep 'kontakt@beberlei.de'"</span>
<span class="p">}</span>

<span class="n">exec</span> <span class="p">{</span> <span class="s2">"git-global-ignore"</span><span class="p">:</span>
    <span class="n">command</span> <span class="o">=&gt;</span> <span class="s2">"git config --global core.excludesfile /home/$id/.gitignore"</span><span class="p">,</span>
    <span class="n">unless</span>  <span class="o">=&gt;</span> <span class="s1">'git config -l --global|grep excludesfile'</span>
<span class="p">}</span>

<span class="n">file</span> <span class="p">{</span> <span class="s2">"git-global-ignorefile"</span><span class="p">:</span>
    <span class="n">path</span> <span class="o">=&gt;</span> <span class="s2">"/home/$id/.gitignore"</span><span class="p">,</span>
    <span class="n">ensure</span> <span class="o">=&gt;</span> <span class="n">present</span><span class="p">,</span>
    <span class="n">content</span> <span class="o">=&gt;</span> <span class="s2">"*.swo</span><span class="se">\n</span><span class="s2">*.swp</span><span class="se">\n</span><span class="s2">"</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Here A bunch of commands is executed unless some option is already set. At last
the global .gitingore is filled with the patterns of Vim temporary files.</p>
<p>I also automated all the other steps listed above, but will spare you the
details. For the LAMP Stack + PHP I used <a class="reference external" href="https://github.com/dietervds/puppet-symfony2">this following Github repository</a> as an inspiration. It ships a
set of Puppet Modules. You can just put them into your <span class="docutils literal"><span class="pre">~/.puppet/modules</span></span>
folder and they are then available in any of your puppet files.</p>
<p>I can now reuse this on the different machines: desktop at home and at work and
my laptop. Whenever I install a new tool or change some configuration of my
system I can directly put this into puppet and keep the setup synchronized on
all the machines I work with.</p>
<p>You can find more detailed resources on the PuppetLabs website:</p>
<ul class="simple">
<li><a class="reference external" href="http://docs.puppetlabs.com/learning/ral.html">Tutorial</a></li>
<li><a class="reference external" href="http://docs.puppetlabs.com/references/latest/type.html">Type Reference</a></li>
<li><a class="reference external" href="docs.puppetlabs.com/puppet_core_types_cheatsheet.pdf">Type Cheat Sheet</a></li>
</ul>


            

            <div class="metadata">
        <p>
            <small>
                Posted on June 03, 2012
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2012/05/31/virtual_machines_with_vagrant__veewee_and_puppet.html">Virtual Machines with Vagrant, Veewee and Puppet</a></h1>
<p>I have been playing with Vagrant these last days, a tool to automate Virtualbox
VM management very efficiently. Being always late to new technologies
investigating Vagrant now felt about right. I am using Virtualbox for
virtualization for about a year now but have build all my boxes manually. I
have these machines setup:</p>
<ul class="simple">
<li>Windows 7</li>
<li>Ubuntu with lots of crazy PHP builds</li>
<li>Ubuntu with Oracle, PostgreSQL for Doctrine Unit-Tests</li>
</ul>
<p>The main benefit from this is that I don’t have to clutter my main machine with
packages and dependencies that might potentially break.</p>
<p>To benefit from Virtualization on a larger scale I wanted to investigate
automation of box-building and was pointed to <a class="reference external" href="http://www.vagrantup.com">Vagrant</a>. This is a ruby tool that allows to copy and
modify virtualboxes on the fly. You define a basebox and inherit from this box
in your projects. Whenever you work on the project you start a copy of this
basebox and install more system-dependencies using Chef or Puppet.
That allows you to put the VM into a defined state just for this project. No
matter how many different and weird dependencies you need, they will always be
in this VM that is just created for the project and destroyed at the end of the
day.</p>
<p>I am using Ubuntu (currently 12.04) and tried starting with the Vagrant
example.  It fails, because their example box uses a more current Virtualbox
Guest Additions. To be able to use vagrant, you need a basebox with the
virtualbox and guest additions versions matching correctly.</p>
<p>To build your own Virtualbox you can use the Vagrant plugin <a class="reference external" href="https://github.com/jedi4ever/veewee">Veewee</a>. Install it from Github to get
all the latest VM templates:</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ git clone https://github.com/jedi4ever/veewee.git
$ <span class="nb">cd</span> veewee
$ sudo gem install bundler
$ sudo bundle install
$ <span class="nb">alias</span> <span class="nv">vagrant</span><span class="o">=</span><span class="s2">"bundle exec vagrant"</span>
</pre></div>
</div>
<p>You need Ruby and Gems installed for this to work. Veewee can be installed
using Gems, but this not necessarily gives you the version with the most recent
templates that match your own operating system version.</p>
<p>Now lets define our own basebox definition and copy from an existing template
that Veewee provides:</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ vagrant basebox define <span class="s1">'beberlei-ubuntu-12.04-i386-php'</span> <span class="s1">'ubuntu-server-12.04-i386'</span>
</pre></div>
</div>
<p>This creates a copy from the default ubuntu server template into a folder
<cite>definitions/beberlei-ubuntu-12.04-i386-php</cite>. You can start modifying the files
in there to adjust the build process of the virtual machine image. For me its
important to modify the definitions.rb and add the following, otherwise
building the VMs fails:</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>:virtualbox <span class="o">=</span>&gt; <span class="o">{</span> : <span class="nv">vm_options</span> <span class="o">=</span>&gt; <span class="o">[</span><span class="s2">"pae"</span> <span class="o">=</span>&gt; <span class="s2">"on"</span><span class="o">]}</span>,
</pre></div>
</div>
<p>You can then open up the postinstall.sh and install more packages that you need
in your personal basebox. For example a LAMP stack. Do this right after the
lines that do <cite>apt-get install -y</cite>:</p>
<div class="highlight-bash"><div class="highlight"><pre><span/><span class="nb">export</span> <span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive
apt-get -y install php5 php5-cli php5 mysql-server-5.5 libapache2-mod-php5
</pre></div>
</div>
<p>If you are done you can start building a virtualbox image with:</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ vagrant basebox build
</pre></div>
</div>
<p>Make sure not to start typing in the console window that open ups. It is
automatically controlled from a ruby script and every change to the keysequence
breaks the building. This step takes a while. (Enough to write a blog post
while watching a boring football game for example).</p>
<p>When this is done, you can verify and export the VM into virtualbox/vagrant.</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ veewee vbox validate <span class="s1">'beberlei-ubuntu-12.04-i386-php'</span>
$ vagrant basebox <span class="nb">export</span> <span class="s1">'beberlei-ubuntu-12.04-i386-php'</span>
$ vagrant box add <span class="s1">'beberlei-ubuntu-12.04-i386-php'</span> <span class="s1">'beberlei-ubuntu-12.04-i386-php.box'</span>
</pre></div>
</div>
<p>Now this box is also available as Vagrant base box. For example in a project
that we want to use with vagrant, do:</p>
<div class="highlight-bash"><div class="highlight"><pre><span/>$ <span class="nb">cd</span> myproject/
$ vagrant init <span class="s1">'beberlei-ubuntu-12.04-i386-php'</span>
$ vagrant up
$ vagrant ssh
</pre></div>
</div>
<p>Although the blog-title suggests it, Puppet hasn’t been used much up to this
point. The use of puppet with Vagrant will be part of a next blog post.</p>


            
            <div class="tags">
                More about: 
                <a href="tags/vagrant.html">Vagrant</a>
                 / 
                <a href="tags/automation.html">Automation</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on May 31, 2012
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="archive_link">
        <a href="archive.html">Archive</a>
    </div></article></div> <!-- #main -->
				</div>
			</div></div> <!-- #main-container -->

        <div class="footer-container" role="contentinfo">
			<div class="container">
				<div class="col-md-8 col-md-offset-2">
					<div class="footer">
						<small>© Copyright 2008-2017, Benjamin Eberlei.</small>

						<script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script>
					</div>
				</div>
			</div>
        </div> <!-- footer-container -->
      </div> <!--! end of #container --><script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-32146757-1', 'auto');
          ga('send', 'pageview');
        </script>

    </body>
</html>