<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="Blog of Benjamin Eberlei, covering a wide range of programming, bootstrapping and entrepreneurial topics">
        <meta name="viewport" content="width=device-width">
        <meta name="google-site-verification" content="mycr8JCbLYq9QcOyh4Ub1esAdN-awH9ut6nyTKUTgE4">
        <title>Page 3 &mdash; beberlei.de</title>
            <link rel="stylesheet" href="/_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="/_static/css/bootstrap.min.css" type="text/css" />
            <link rel="stylesheet" href="/_static/blog.css" type="text/css" />
            <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" />
        <link rel="shortcut icon" href="_static/tinkerer.ico" /><!-- Load modernizr and JQuery -->
        <script src="_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="_static/plugins.js"></script>
        <script src="_static/main.js"></script>
        <link rel="search" title="Search" href="search.html" /><link rel="next" title="Older" href="page4.html" /><link rel="prev" title="Newer" href="page2.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.5.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        SOURCELINK_SUFFIX: '.txt',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="_static/underscore.js"></script><script type="text/javascript" src="_static/doctools.js"></script></head>
    <body role="document">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><nav class="navbar navbar-dark">
		  <div class="container">
			  <div class="navbar-header">
				  <a class="navbar-brand" href="https://beberlei.de">Benjamin Eberlei</a>
			  </div>

			  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				  <ul class="nav navbar-nav navbar-right">
						<li><a href="index.html">Home</a></li>
						<li><a href="pages/about.html">About</a></li>
						<li><a href="pages/debugging_php.html">Debugging</a></li>
						<li><a href="pages/imprint.html">Imprint</a></li>
						<li><a href="/archive.html">Archive</a></li>
					  <li><a href="/rss.xml">RSS</a></li>
				  </ul>
			  </div>
		  </div>
		</nav><div class="main-container" role="main"><div class="container">
				<div class="row">
					<div class="col-md-8 col-md-offset-2 col-sm-12"><article role="article">
							<div class="section">
            <h1><a href="2015/02/26/integrate_symfony_and_webpack.html">Integrate Symfony and Webpack</a></h1>
<p>Asset Management in Symfony2 is handled with the PHP based library Assetic by
default, however I have never really connected to this library and at least for
me it usually wastes more time than it saves.</p>
<p>I am also not a big fan of the Node.JS based stack, because it tends to fail
alot for me as well. With teams that primarily consist of PHP developers and
web-designers the transition to use Node.JS tools should be very conservative
in my opinion. Each team member should not feel overburdend by this new
technology stack.</p>
<p>Frontend development is really not my strong suit, so these first steps
I document here may seem obvious to some readers.</p>
<p>While researching about <a class="reference external" href="https://github.com/facebook/react">React.JS</a> I came across
a tool called <a class="reference external" href="http://webpack.github.io/">Webpack</a> which you could compare
to Symfony’s Assetic. It is primarily focussing on bundling Javascript modules,
but you can also ship CSS assets with it.</p>
<p>The real benefits for Webpack however are:</p>
<ol class="arabic simple">
<li>the builtin support for AMD or CommonJS style module loaders</li>
<li>a builtin development web-server that runs on a dedicated port, serving your
combined assets.</li>
<li>a hot reloading plugin that automatically refreshes either the full page or
just selected code when the assets change.</li>
<li>module loaders that allow instant translation of JSX or other languages
with Javascript transpilers (CoffeeScript, ...)</li>
</ol>
<p>Let’s have a look at a simple example javascript application in <span class="docutils literal"><span class="pre">app.js</span></span>
requiring jQuery. The code is part of the Symfony2 document root in <span class="docutils literal"><span class="pre">web/</span></span>:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="n">web</span><span class="o">/</span>
   <span class="n">css</span><span class="o">/</span>
     <span class="n">page</span><span class="o">.</span><span class="n">css</span>
   <span class="n">js</span><span class="o">/</span>
     <span class="n">vendor</span><span class="o">/</span>
       <span class="n">jquery</span><span class="o">.</span><span class="n">js</span>
     <span class="n">app</span><span class="o">.</span><span class="n">js</span>
</pre></div>
</div>
<p>Then we can use <a class="reference external" href="https://github.com/webpack/docs/wiki/amd">AMD-style</a> modules
to resolve the dependencies in our code:</p>
<div class="highlight-js"><div class="highlight"><pre><span/><span class="c1">// app.js</span>
<span class="nx">define</span><span class="p">([</span><span class="s1">'./vendor/jquery.js'</span><span class="p">],</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
        <span class="nx">$</span><span class="p">(</span><span class="s2">"#content"</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s2">"Webpack Hello World!"</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></div>
</div>
<p>You can compare this to PHPs <span class="docutils literal"><span class="pre">require()</span></span> and autoloading functionality,
something that Javascript has historically been lacking and usually leads to
javascript files with many thousands lines of code. You can also use
<a class="reference external" href="https://github.com/webpack/docs/wiki/commonjs">CommonJS-style</a> module loading
if your prefer this approach.</p>
<p>The downside of adding this functionality is that your code <strong>always</strong> has to
run through Webpack to work on the browser. But Webpack solves this geniously
by including a web-server that does the translation for you in the background
all the time.  With a little help of a configuration file called <span class="docutils literal"><span class="pre">webpack.config.js</span></span></p>
<div class="highlight-js"><div class="highlight"><pre><span/><span class="c1">// webpack.config.js</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">entry</span>   <span class="o">:</span> <span class="s2">"./web/js/app.js"</span><span class="p">,</span>
    <span class="nx">output</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">filename</span><span class="o">:</span> <span class="s2">"bundle.js"</span><span class="p">,</span>
        <span class="nx">path</span> <span class="o">:</span> <span class="s1">'web/assets/'</span><span class="p">,</span>
        <span class="nx">publicPath</span> <span class="o">:</span> <span class="s1">'/assets/'</span><span class="p">,</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>we can start our assets development server by calling:</p>
<div class="highlight-default"><div class="highlight"><pre><span/>$ webpack-dev-server --progress --colors --port 8090 --content-base=web/
</pre></div>
</div>
<p>This will start serving the combined javascript file at
<span class="docutils literal"><span class="pre">http://localhost:8090/assets/bundle.js</span></span> as well as the asset <span class="docutils literal"><span class="pre">page.css</span></span> at
<span class="docutils literal"><span class="pre">http://localhost:8090/css/page.css</span></span> by using the <span class="docutils literal"><span class="pre">--content-base</span></span> flag.
Every change to any of the files that are part of the result will trigger a
rebuild similar to the <span class="docutils literal"><span class="pre">--watch</span></span> flag of Assetic, Grunt or Gulp.</p>
<p>Webpack can be installed globally so it is easy to get started with. I find
this a huge benefit not having to require a <span class="docutils literal"><span class="pre">package.json</span></span> and Node+npm
workflow for your PHP/Symfony project.</p>
<div class="highlight-default"><div class="highlight"><pre><span/>$ sudo npm install -g webpack
</pre></div>
</div>
<p>For integration into Symfony we make use of some Framework configuration to
change the base path used for the <span class="docutils literal"><span class="pre">{{</span> <span class="pre">asset()</span> <span class="pre">}}</span></span> twig-function:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="c1"># app/config/config.yml</span>
<span class="n">framework</span><span class="p">:</span>
  <span class="n">templating</span><span class="p">:</span>
    <span class="n">assets_base_url</span><span class="p">:</span> <span class="s2">"%assets_base_url%"</span>

<span class="c1"># app/config/parameters.yml</span>
<span class="n">parameters</span><span class="p">:</span>
  <span class="n">assets_base_url</span><span class="p">:</span> <span class="s2">"http://localhost:8090"</span>
</pre></div>
</div>
<p>This adds a base path in front of all your assets pointing to the Webpack dev
server.</p>
<p>The only thing left for integration is to load the javascript file from your
twig layout file:</p>
<div class="highlight-jinja"><div class="highlight"><pre><span/><span class="x">&lt;html&gt;</span>
<span class="x">    &lt;body&gt;</span>
<span class="x">        &lt;div id="content"&gt;&lt;/div&gt;</span>

<span class="x">        </span><span class="cp">{%</span> <span class="k">if</span> <span class="nv">app.environment</span> <span class="o">==</span> <span class="s2">"dev"</span> <span class="cp">%}</span><span class="x"/>
<span class="x">        &lt;script src="</span><span class="cp">{{</span> <span class="nv">asset</span><span class="o">(</span><span class="s1">'webpack-dev-server.js'</span><span class="o">)</span> <span class="cp">}}</span><span class="x">"&gt;&lt;/script&gt;</span>
<span class="x">        </span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span><span class="x"/>
<span class="x">        &lt;script type="text/javascript" src="</span><span class="cp">{{</span> <span class="nv">asset</span><span class="o">(</span><span class="s1">'assets/bundle.js'</span><span class="o">)</span> <span class="cp">}}</span><span class="x">"&gt;&lt;/script&gt;</span>
<span class="x">    &lt;/body&gt;</span>
<span class="x">&lt;/html&gt;</span>
</pre></div>
</div>
<p>The <span class="docutils literal"><span class="pre">webpack-dev-server.js</span></span> file loaded only in development environment
handles the <a class="reference external" href="https://webpack.js.org/concepts/hot-module-replacement/">hot module reload</a>
exchanging, adding, or removing modules while an application is running without
a page reload whenever possible.</p>
<p>For production use the <span class="docutils literal"><span class="pre">assets_base_url</span></span> parameter has to be adjusted
to your specific needs and you use the <span class="docutils literal"><span class="pre">webpack</span></span> command to generate a
minified and optimized version of your javascript code.</p>
<div class="highlight-default"><div class="highlight"><pre><span/>$ webpack
Hash: 69657874504a1a1db7cf
Version: webpack 1.6.0
Time: 329ms
    Asset   Size  Chunks             Chunk Names
bundle.js  30533       0  [emitted]  main
   [2] ./web/js/app.js 1608 {0} [built]
   [5] ./web/js/vendor/jquery.js 496 {0} [built]
</pre></div>
</div>
<p>It will be placed inside <span class="docutils literal"><span class="pre">web/assets/bundle.js</span></span> as specified by the output
configuration in the Webpack configuration. Getting started in production is as
easy as seting the assets base url to null and pushing the bundle.js to your
production server.</p>
<p>I hope this example shows you some of the benefits of using Webpack over
Assetic, Grunt or Gulp and the simplicity using it between development and
production. While the example is Symfony2 related, the concepts apply to any
kind of application.</p>
<p>Back to why I stumbled over Webpack in the first place: React.JS. I have been
circling around React for a while with the impression that is extremly
well-suited for frontend development. The problems I had with React where
purely operation/workflow based:</p>
<ol class="arabic simple">
<li>React encourages modular design of applications, something that you
have to get working first using require.js for example.</li>
<li>Differentation between development (refresh on modify) and production assets
(minified).</li>
<li>React uses a template language JSX that requires cross-compiling the
<span class="docutils literal"><span class="pre">*.jsx</span></span> files they are written in into plain javascript files.</li>
</ol>
<p>Now this blog post has already shown that Webpack solves points one and two,
but it also solves the JSX Transformation with some extra configuration
in <span class="docutils literal"><span class="pre">webpack.config.js</span></span>:</p>
<div class="highlight-js"><div class="highlight"><pre><span/><span class="c1">// webpack.config.js</span>
<span class="nx">module</span><span class="p">.</span><span class="nx">exports</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">entry</span><span class="o">:</span> <span class="s1">'./web/js/app.jsx'</span><span class="p">,</span>
    <span class="nx">output</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">filename</span><span class="o">:</span> <span class="s1">'bundle.js'</span><span class="p">,</span>
        <span class="nx">path</span><span class="o">:</span> <span class="s1">'web/assets/'</span><span class="p">,</span>
        <span class="nx">publicPath</span><span class="o">:</span> <span class="s1">'/assets'</span>
    <span class="p">},</span>
    <span class="nx">module</span><span class="o">:</span> <span class="p">{</span>
        <span class="nx">loaders</span><span class="o">:</span> <span class="p">[</span>
            <span class="p">{</span> <span class="nx">test</span><span class="o">:</span> <span class="sr">/\.jsx$/</span><span class="p">,</span> <span class="nx">loader</span><span class="o">:</span> <span class="s1">'jsx-loader?insertPragma=React.DOM&amp;harmony'</span> <span class="p">}</span>
        <span class="p">]</span>
    <span class="p">},</span>
    <span class="nx">externals</span><span class="o">:</span> <span class="p">{</span><span class="s1">'react'</span><span class="o">:</span> <span class="s1">'React'</span><span class="p">},</span>
    <span class="nx">resolve</span><span class="o">:</span> <span class="p">{</span><span class="nx">extensions</span><span class="o">:</span> <span class="p">[</span><span class="s1">''</span><span class="p">,</span> <span class="s1">'.js'</span><span class="p">,</span> <span class="s1">'.jsx'</span><span class="p">]}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Now it is trivally easy to use React, just create a file with the <span class="docutils literal"><span class="pre">*.jsx</span></span>
extension and Webpack will automatically load it through Facebooks JSX
transformer before serving it as plain javascript. The only requirement is that
you have to install the NPM package <span class="docutils literal"><span class="pre">jsx-loader</span></span>.</p>
<p>So far I have used webpack only for two playground projects, but I am very
confident integrating it into some of my production projects now.</p>


            
            <div class="tags">
                More about: 
                <a href="tags/symfony.html">Symfony</a>
                 / 
                <a href="tags/webpack.html">Webpack</a>
                 / 
                <a href="tags/javascript.html">Javascript</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on February 26, 2015
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2015/02/19/vagrant_nfs_and_npm.html">Vagrant, NFS and NPM</a></h1>
<p>I have ranted about Node.JS and NPM on Twitter before, costing me lots of time,
so I have to make up for this now and offer some solutions.</p>
<p>One problem I regularly have is the following: I have a Vagrant/Virtualbox
using NFS and want to run NPM inside of that. Running it inside the box
is necessary, because I don’t want everyone using the box have to setup the
node stack.</p>
<p>However running <span class="docutils literal"><span class="pre">npm</span> <span class="pre">install</span></span> on an NFS share doesn’t work as per <a class="reference external" href="https://github.com/npm/npm/issues/3565">issue
#3565</a> because a chmod fails and
apparently from the ticket, this is not going to be fixed.</p>
<p>I finally got it working with a <a class="reference external" href="https://gist.github.com/kevinastone/8790717">workaround script</a> by <a class="reference external" href="https://github.com/kevinastone">Kevin
Stone</a> that mimics NPM, but
moves the <span class="docutils literal"><span class="pre">package.json</span></span> to a temporary directory and then rsyncs its back:</p>
<div class="highlight-default"><div class="highlight"><pre><span/>#!/bin/bash
# roles/nodejs/files/tmpnpm.sh

BASE_DIR=${TMPDIR:-/var/tmp}
ORIG_DIR=$PWD
HASH_CMD="md5sum"

DIR_NAME=`echo $PWD | $HASH_CMD | cut -f1 -d " "`

TMP_DIR=$BASE_DIR/$DIR_NAME
mkdir -p $TMP_DIR

pushd $TMP_DIR

ln -sf $ORIG_DIR/package.json
npm $1

# Can't use archive mode cause of the permissions
rsync --recursive --links --times node_modules $ORIG_DIR

popd
</pre></div>
</div>
<p>Integrating this into my Ansible setup of the machine it looked like this:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="c1"># roles/nodejs/tasks/main.yml</span>
<span class="c1"># More tasks here before this...</span>
<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s2">"Install npm workaround"</span>
  <span class="n">copy</span><span class="p">:</span> <span class="o">&gt;</span>
      <span class="n">src</span><span class="o">=</span><span class="n">tmpnpm</span><span class="o">.</span><span class="n">sh</span>
      <span class="n">dest</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">tmpnpm</span>
      <span class="n">mode</span><span class="o">=</span><span class="s2">"0755"</span>

<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s2">"Install Global Dependencies"</span>
  <span class="n">command</span><span class="p">:</span> <span class="o">&gt;</span>
      <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">tmpnpm</span> <span class="n">install</span> <span class="o">-</span><span class="n">g</span> <span class="p">{{</span> <span class="n">item</span> <span class="p">}}</span>
  <span class="n">with_items</span><span class="p">:</span> <span class="n">global_packages</span>

<span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="s2">"Install Package Dependencies"</span>
  <span class="n">command</span><span class="p">:</span> <span class="o">&gt;</span>
      <span class="o">/</span><span class="n">usr</span><span class="o">/</span><span class="n">local</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">tmpnpm</span> <span class="n">install</span>
      <span class="n">chdir</span><span class="o">=</span><span class="p">{{</span> <span class="n">item</span> <span class="p">}}</span>
  <span class="n">with_items</span><span class="p">:</span> <span class="n">package_dirs</span>
</pre></div>
</div>
<p>Where <span class="docutils literal"><span class="pre">global_packages</span></span> and <span class="docutils literal"><span class="pre">package_dirs</span></span> are specified from the
outside when invoking the role:</p>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="c1"># deploy.yml</span>
<span class="o">---</span>
<span class="o">-</span> <span class="n">hosts</span><span class="p">:</span> <span class="nb">all</span>
  <span class="n">roles</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">name</span><span class="p">:</span> <span class="n">nodejs</span>
      <span class="n">global_packages</span><span class="p">:</span>
        <span class="o">-</span> <span class="n">grunt</span><span class="o">-</span><span class="n">cli</span>
      <span class="n">package_dirs</span><span class="p">:</span>
        <span class="o">-</span> <span class="s2">"/var/www/project"</span>
</pre></div>
</div>
<p>This way the Ansible Node.JS role is reusable in different projects.</p>


            
            <div class="tags">
                More about: 
                <a href="tags/vagrant.html">Vagrant</a>
                 / 
                <a href="tags/ansible.html">Ansible</a>
                 / 
                <a href="tags/javascript.html">Javascript</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on February 19, 2015
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2015/02/14/phpunit_before_annotations_and_traits_for_code_reuse.html">PHPunit @before Annotations and traits for code-reuse</a></h1>
<p>I have written about why I think <a class="reference external" href="http://www.whitewashing.de/2013/04/12/traits_are_static_access.html">traits should be avoided</a>. There
is a practical use-case that serves me well however: Extending PHPUnit tests.</p>
<p>The PHPUnit TestCase is not very extendable except through inheritance. This
often leads to a weird, deep inheritance hierachy in testsuites to achieve code
reuse. For example the Doctrine ORM testsuite having <span class="docutils literal"><span class="pre">OrmFunctionalTestCase</span></span>
extending from <span class="docutils literal"><span class="pre">OrmTestCase</span></span> extending from PHPUnits testcase.</p>
<p>Dependency Injection is something that is not possible easily in a PHPUnit
testcase, but could be solved using an additional listener and some
configuration in <span class="docutils literal"><span class="pre">phpunit.xml</span></span>.</p>
<p>This leaves traits as a simple mechanism that doesn’t require writing an
extension for PHPUnit and allows “multiple inheritance” to compose different
features for our test cases.</p>
<p>See this simple example that is adding some more assertions:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>

<span class="k">trait</span> <span class="nx">MyAssertions</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">assertIsNotANumber</span><span class="p">(</span><span class="nv">$value</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertTrue</span><span class="p">(</span><span class="nb">is_nan</span><span class="p">(</span><span class="nv">$value</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">MathTest</span> <span class="k">extends</span> <span class="nx">\PHPUnit_Framework_TestCase</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">MyAssertions</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testIsNotANumber</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertIsNotANumber</span><span class="p">(</span><span class="nb">acos</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>When you have more complex requirements, you might need the trait to implement
<span class="docutils literal"><span class="pre">setUp()</span></span> method. This will prevent you from using multiple traits that all
need to invoke <span class="docutils literal"><span class="pre">setUp()</span></span>. You could use the trait conflict resolution, but
then the renamed setup methods do not get called anymore.</p>
<p>Fortunately PHPUnit 3.8+ comes to the rescue with new <span class="docutils literal"><span class="pre">@before</span></span> and
<span class="docutils literal"><span class="pre">@beforeClass</span></span> annotations.</p>
<p>See this trait I use for making sure my database is using the
most current database version by invoking migrations in <span class="docutils literal"><span class="pre">@beforeClass</span></span></p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Xhprof</span><span class="p">;</span>

<span class="k">use</span> <span class="nx">Doctrine\DBAL\DriverManager</span><span class="p">;</span>

<span class="k">trait</span> <span class="nx">DatabaseSetup</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * @var bool</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="k">static</span> <span class="nv">$initialized</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @beforeClass</span>
<span class="sd">     */</span>
    <span class="k">public</span> <span class="k">static</span> <span class="k">function</span> <span class="nf">initializeDatabase</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$initialized</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="nx">self</span><span class="o">::</span><span class="nv">$initialized</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

        <span class="nv">$conn</span> <span class="o">=</span> <span class="nx">DriverManager</span><span class="o">::</span><span class="na">getConnection</span><span class="p">(</span><span class="k">array</span><span class="p">(</span>
            <span class="s1">'url'</span> <span class="o">=&gt;</span> <span class="nv">$_SERVER</span><span class="p">[</span><span class="s1">'TEST_DATABASE_DSN'</span><span class="p">]</span>
        <span class="p">));</span>

        <span class="nv">$dbDeploy</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DbDeploy</span><span class="p">(</span><span class="nv">$conn</span><span class="p">,</span> <span class="nb">realpath</span><span class="p">(</span><span class="no">__DIR__</span> <span class="o">.</span> <span class="s1">'/../../src/schema'</span><span class="p">));</span>
        <span class="nv">$dbDeploy</span><span class="o">-&gt;</span><span class="na">migrate</span><span class="p">();</span>
        <span class="nv">$conn</span><span class="o">-&gt;</span><span class="na">close</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>I could mix this with a second trait <span class="docutils literal"><span class="pre">SymfonySetup</span></span> that makes the DIC
container available for my integration tests:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>

<span class="k">namespace</span> <span class="nx">Xhprof</span><span class="p">;</span>

<span class="k">trait</span> <span class="nx">SymfonySetup</span>
<span class="p">{</span>
    <span class="k">protected</span> <span class="nv">$kernel</span><span class="p">;</span>
    <span class="k">protected</span> <span class="nv">$container</span><span class="p">;</span>

    <span class="sd">/**</span>
<span class="sd">     * @before</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">setupKernel</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">kernel</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">createKernel</span><span class="p">();</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">kernel</span><span class="o">-&gt;</span><span class="na">boot</span><span class="p">();</span>

        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">kernel</span><span class="o">-&gt;</span><span class="na">getContainer</span><span class="p">();</span>
    <span class="p">}</span>

    <span class="k">protected</span> <span class="k">function</span> <span class="nf">createKernel</span><span class="p">(</span><span class="k">array</span> <span class="nv">$options</span> <span class="o">=</span> <span class="k">array</span><span class="p">())</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="k">new</span> <span class="nx">\AppKernel</span><span class="p">(</span><span class="s1">'test'</span><span class="p">,</span> <span class="k">true</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="sd">/**</span>
<span class="sd">     * @after</span>
<span class="sd">     */</span>
    <span class="k">protected</span> <span class="k">function</span> <span class="nf">tearDownSymfonyKernel</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="k">null</span> <span class="o">!==</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">kernel</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">kernel</span><span class="o">-&gt;</span><span class="na">shutdown</span><span class="p">();</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The Symfony setup trait uses <span class="docutils literal"><span class="pre">@before</span></span> and <span class="docutils literal"><span class="pre">@after</span></span> to setup and cleanup
without clashing with the traditional PHPUnit <span class="docutils literal"><span class="pre">setUp</span></span> method.</p>
<p>Combining all this we could write a testcase like this:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">UserRepositoryTest</span> <span class="k">extends</span> <span class="nx">\PHPUnit_Framework_TestCase</span>
<span class="p">{</span>
    <span class="k">use</span> <span class="nx">DatabaseSetup</span><span class="p">;</span>
    <span class="k">use</span> <span class="nx">SymfonySetup</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setUp</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="c1">// do setup here</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">testNotFindUserReturnsNull</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$userRepository</span> <span class="o">=</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">container</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'user_repository'</span><span class="p">);</span>
        <span class="nv">$unusedId</span> <span class="o">=</span> <span class="mi">9999</span><span class="p">;</span>
        <span class="nv">$user</span> <span class="o">=</span> <span class="nv">$userRepository</span><span class="o">-&gt;</span><span class="na">find</span><span class="p">(</span><span class="nv">$unusedId</span><span class="p">);</span>
        <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">assertNull</span><span class="p">(</span><span class="nv">$user</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Sadly the <span class="docutils literal"><span class="pre">@before</span></span> calls are invoced <em>after</em> the original <span class="docutils literal"><span class="pre">setup()</span></span> method
so we cannot access the Symfony container here already. Maybe it would be more
practical to have it work the other way around. I have <a class="reference external" href="https://github.com/sebastianbergmann/phpunit/issues/1616">opened an issue on
PHPUnit</a> for that.</p>


            
            <div class="tags">
                More about: 
                <a href="tags/testing.html">Testing</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on February 14, 2015
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2015/02/10/a_case_for_weak_type_hints_only_in_php7.html">A case for weak type hints only in PHP7</a></h1>
<p>TL;DR: I was one voice for having strict type hints until I tried the current
patch. From both a library and application developer POV they don’t bring much
to the table. I think PHP would be more consistent with weak type hints only.</p>
<p>These last weeks there have been tons of discussions about <a class="reference external" href="https://wiki.php.net/rfc/scalar_type_hints">scalar type
hints</a>
in PHP following <a class="reference external" href="https://twitter.com/andreafaulds">Andrea Faulds</a> RFC
that is currently in voting. Most of them were limited to PHP Internals
mailinglist but since the voting started some days ago much has also been said
on Twitter and blogs.</p>
<p>This post is my completly subjective opinion on the issue.</p>
<p>I would have preferred strict type hints, however after trying the patch, I
think that strict type hints</p>
<ul class="simple">
<li>will cause considerable problems for application developers, forcing them to
“replicate weak type hinting” by manually casting everywhere.</li>
<li>are useless for library developers, because they have to assume the user
is in weak type mode.</li>
<li>are useless within a library because I already know the types at the public
API, weak mode would suffice for all the lower layers of my library.</li>
</ul>
<p>Neither group of developers gets a considerable benefit from the current RFCs strict mode.</p>
<p>The simple reason for this, request, console inputs and many databases provide
us with strings, casting has to happen somewhere. Having strict type hints
would not save us from this, type juggling and casting has to happen and
PHP’s current approach is one of the main benefits of the language.</p>
<div class="section" id="real-world-weak-vs-strict-code-example">
<h2>Real World Weak vs Strict Code Example</h2>
<p>Lets look at an example of everyday framework code <a class="reference external" href="https://gist.github.com/beberlei/8b23160dd0b4466fe1c5">Full
Code</a> to
support my case:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>

<span class="k">class</span> <span class="nc">UserController</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">listAction</span><span class="p">(</span><span class="nx">Request</span> <span class="nv">$request</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="nv">$status</span> <span class="o">=</span> <span class="nv">$request</span><span class="o">-&gt;</span><span class="na">get</span><span class="p">(</span><span class="s1">'status'</span><span class="p">);</span> <span class="c1">// this is a string</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="s1">'users'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="o">-&gt;</span><span class="na">fetchUsers</span><span class="p">(</span><span class="nv">$status</span><span class="p">),</span>
            <span class="s1">'total'</span> <span class="o">=&gt;</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">service</span><span class="o">-&gt;</span><span class="na">fetchTotalCount</span><span class="p">(</span><span class="nv">$status</span><span class="p">)</span>
        <span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">class</span> <span class="nc">UserService</span>
<span class="p">{</span>
    <span class="k">const</span> <span class="no">STATUS_INACTIVE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">STATUS_WAITING</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">const</span> <span class="no">STATUS_APPROVED</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

    <span class="k">private</span> <span class="nv">$connection</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">fetchUsers</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$status</span><span class="p">)</span><span class="o">:</span> <span class="k">array</span>
    <span class="p">{</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">'SELECT u.id, u.username FROM users u WHERE u.status = ? LIMIT 10'</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connection</span><span class="o">-&gt;</span><span class="na">fetchAll</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="p">[</span><span class="nv">$status</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">fetchTotalCount</span><span class="p">(</span><span class="nx">int</span> <span class="nv">$status</span><span class="p">)</span><span class="o">:</span> <span class="nx">int</span>
    <span class="p">{</span>
        <span class="nv">$sql</span> <span class="o">=</span> <span class="s1">'SELECT count(*) FROM users u WHERE u.status = ?'</span><span class="p">;</span>

        <span class="k">return</span> <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">connection</span><span class="o">-&gt;</span><span class="na">fetchColumn</span><span class="p">(</span><span class="nv">$sql</span><span class="p">,</span> <span class="p">[</span><span class="nv">$status</span><span class="p">]);</span> <span class="c1">// returns a string</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>See how the code on <span class="docutils literal"><span class="pre">UserService</span></span> is guarded by scalar typehints to enforce
having the right types inside the service:</p>
<ul class="simple">
<li><span class="docutils literal"><span class="pre">$status</span></span> is a flag to filter the result by and it is one of the integer constants, the type hint coerces an integer from the request string.</li>
<li><span class="docutils literal"><span class="pre">fetchTotalCount()</span></span> returns an integer of total number of users matching the query, the type hint coerces an integer from the database string.</li>
</ul>
<p>This code example <em>only</em> works with weak typehinting mode as described in the RFC.</p>
<p>Now lets enable strict type hinting to see how the code fails:</p>
<ul class="simple">
<li>Passing the string status from the request to UserSerice methods is rejected, we need to cast status to integer.</li>
<li>Returning the integer from <span class="docutils literal"><span class="pre">fetchTotalCount</span></span> fails because the database returns a string number. We need to cast to integer.</li>
</ul>
<div class="highlight-default"><div class="highlight"><pre><span/><span class="n">Catchable</span> <span class="n">fatal</span> <span class="n">error</span><span class="p">:</span> <span class="n">Argument</span> <span class="mi">1</span> <span class="n">passed</span> <span class="n">to</span> <span class="n">UserService</span><span class="p">::</span><span class="n">fetchUsers</span><span class="p">()</span> <span class="n">must</span>
<span class="n">be</span> <span class="n">of</span> <span class="n">the</span> <span class="nb">type</span> <span class="n">integer</span><span class="p">,</span> <span class="n">string</span> <span class="n">given</span><span class="p">,</span> <span class="n">called</span> <span class="ow">in</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">hints</span><span class="o">.</span><span class="n">php</span> <span class="n">on</span> <span class="n">line</span> <span class="mi">22</span>
<span class="ow">and</span> <span class="n">defined</span> <span class="ow">in</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">hints</span><span class="o">.</span><span class="n">php</span> <span class="n">on</span> <span class="n">line</span> <span class="mi">37</span>

<span class="n">Catchable</span> <span class="n">fatal</span> <span class="n">error</span><span class="p">:</span> <span class="n">Return</span> <span class="n">value</span> <span class="n">of</span> <span class="n">UserService</span><span class="p">::</span><span class="n">fetchTotalCount</span><span class="p">()</span> <span class="n">must</span>
<span class="n">be</span> <span class="n">of</span> <span class="n">the</span> <span class="nb">type</span> <span class="n">integer</span><span class="p">,</span> <span class="n">string</span> <span class="n">returned</span> <span class="ow">in</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">hints</span><span class="o">.</span><span class="n">php</span> <span class="n">on</span> <span class="n">line</span> <span class="mi">48</span>
</pre></div>
</div>
<p>The fix everybody would go for is casting to <span class="docutils literal"><span class="pre">(int)</span></span> manually:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="x">public function listAction(Request $request)</span>
<span class="x">{</span>
<span class="x">    $status = (int)$request-&gt;get('status'); // this is a string</span>

<span class="x">    return [</span>
<span class="x">        'users' =&gt; $this-&gt;service-&gt;fetchUsers($status),</span>
<span class="x">        'total' =&gt; $this-&gt;service-&gt;fetchTotalCount($status)</span>
<span class="x">    ];</span>
<span class="x">}</span>
</pre></div>
</div>
<p>and:</p>
<div class="highlight-php"><div class="highlight"><pre><span/><span class="x">public function fetchTotalCount(int $status): int</span>
<span class="x">{</span>
<span class="x">    $sql = 'SELECT count(*) FROM users u WHERE u.status = ?';</span>

<span class="x">    return (int)$this-&gt;connection-&gt;fetchColumn($sql, [$status]);</span>
<span class="x">}</span>
</pre></div>
</div>
<p>It feels to me that enabling strict mode completly defeats the purpose, because
now we are forced to convert manually, reimplementing weak type hinting in our
own code.</p>
<p>More important: We write code with casts already, the scalar type hints patch
is not necessary for that! Only a superficial level of additional safety is
gained, one additional check of something we already know is true!</p>
<p>Strict mode is useless for library developers, because I always have to assume
weak mode anyways.</p>
<p><strong>EDIT:</strong> I argued before that you have to check for casting strings to 0 when
using weak typehints. That is not necessary. Passing <span class="docutils literal"><span class="pre">fetchTotalCount("foo")</span></span>
will throw a catchable fatal error in weak mode already!</p>
</div>
<div class="section" id="do-we-need-strict-mode">
<h2>Do we need strict mode?</h2>
<p>In a well designed application or library, the developer can already trust the
types of his variables today, 95% of the time, without even having type hints,
using carefully designed abstractions (example Symfony Forms and Doctrine ORM): No
substantial win for her from having strict type hints.</p>
<p>In a badly designed application, the developer is uncertain about the types of
variables. Using strict mode in this scenario she needs to start casting
everywhere just to be sure. I cannot imagine the resulting code to look
anything but bad. Strict would actually be counterproductive here.</p>
<p>I also see a danger here, that writing “strict mode” code will become a best
practice and this might lead developers working on badly desigend applications
to write even crappier code just to follow best practices.</p>
<p>As a pro strict mode developer I could argue:</p>
<ul class="simple">
<li>that libraries such as Doctrine ORM and Symfony Forms already
abstract all the nitty gritty casting from request or database today. But I
don’t think that is valid: They are two of the most sophisticated PHP libraries
out there, maybe used by 1-5% of the userbase. I don’t want to force this
level of abstraction on all users. I can’t use this level myself all the
time. Also if libraries already abstract this for us, why need to duplicate
the checks again if we can trust the variables types?</li>
<li>that I might have complex (mathematical) algorithms that benefit from strict
type hinting. But that is not really true: Once the variables have passed
through the public API of my fully typehinted library I know the types and can rely
on them on all lower levels. Weak or strict type hinting doesn’t make a
difference anymore. Well designed libraries written in PHP5 already provide
this kind of trust using carefully designed value objects and guard clauses.</li>
<li>that using strict type in my library reduce the likelihood of bugs, but that
is not guaranteed.  Users of my library can always decide not to use strict
type hints and that requires me as a library author to consider this use-case
and prevent possible problems. Again using strict mode doesn’t provide a
benefit here.</li>
<li>to write parts of the code in strict and parts in weak mode. But how to
decide this? Projects usually pick only one paradigm for good reason:
<span class="docutils literal"><span class="pre">E_STRICT</span></span> compatible code yes or no for example. Switching is arbitrary
and dangerously inconsistent. As a team lead I would reject such kind of
convention because it is impractible. Code that follows this paradigm in
strict languages such as Java and C# has an aweful lot of converting methods
such as <span class="docutils literal"><span class="pre">$connection-&gt;fetchColumnAsInteger()</span></span>. I do not want to go down
that road.</li>
</ul>
</div>
<div class="section" id="would-we-benefit-from-only-strict-mode">
<h2>Would we benefit from only strict mode?</h2>
<p>Supporters of strict mode only: Make sure to understand why this will never happen!</p>
<p>Say the current RFC gets rejected, would we benefit from a strict type hinting
RFC? No, and the current RFC details the exact reasons why. Most notably
for BC reasons all the PHP API will not use the new strict type hinting.</p>
<p>This current RFC is the only chance to get any kind of strict hinting into PHP.
Yet with the limited usefullness as described before, we can agree that just
having weak mode would be more consistent and therefore better for everyone.</p>
</div>
<div class="section" id="conclusion">
<h2>Conclusion</h2>
<p>I as PHP developer using frameworks and libraries that help me write type safe
code today, strict typing appeals to me. But put to a test in real code it
proves to be impractical for many cases, and not actually much more useful
than weak type hinting in many other cases.</p>
<p>Weak types provide me with much of the type safety I need: In any given method,
using only typehinted parameters and return values, I am safe from type
juggling. As a library developer I have to assume caller uses weak mode all the
time.</p>
<p>Having strict type hints suggests that we can somehow get rid of type juggling
all together. But that is not true, because we still have to work with user
input and databases.</p>
<p>The current RFC only introduced the extra strict mode because developers had a
very negative reactions towards weak type hints. Strike me from this list, weak
type hints are everything that PHP should have. I will go as far that others
strict-typers would probably agree when actually working with the patch.</p>
<p>I would rather prefer just having weak types for now, this is already
a big change for the language and would prove to be valuable for everyone.</p>
<p>I fear Strict mode will have no greater benefit than gamification of the
language, the winner is the one with the highest percentage of strict mode
code.</p>
</div>


            
            <div class="tags">
                More about: 
                <a href="tags/php.html">PHP</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on February 10, 2015
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2015/02/01/running_hhvm_webserver.html">Running HHVM with a Webserver</a></h1>
<p>I haven’t used <a class="reference external" href="http://hhvm.com">HHVM</a> yet because the use-case for the
alternative PHP runtime didn’t came up. Today I was wondering if our <a class="reference external" href="https://qafoolabs.com">Qafoo
Profiler</a> would run out of the box with HHVM using the
<a class="reference external" href="http://docs.hhvm.com/manual/en/ref.xhprof.php">builtin XHProf extension</a>
(Answer: It does).</p>
<p>For this experiment I wanted to run the wordpress blog of my wife on HHVM
locally. It turns out this is not very easy with an existing LAMP stack,
because mod-php5 and mod-fastcgi obviously compete for the execution of <cite>.php</cite>
files.</p>
<p>Quick googling didn’t turn up a solution (there probably is one, hints in the
comments are appreciated) and I didn’t want to install a Vagrant Box just for
this. So I decided to turn this into a sunday side project. Requirements: A
simple webserver that acts as proxy in front of HHVMs Fast-CGI. Think of it as
the “builtin webserver” that HHVM is missing.</p>
<p>This turns out to be really simple with Go, a language I use a lot for small
projects in the last months.</p>
<p>The code is <a class="reference external" href="https://github.com/beberlei/hhvm-serve/blob/master/hhvm-serve.go">very simple plumbing</a>
starting with a HTTP Server that accepts client requests, translates them to FastCGI
requests, sending them to HHVM and then parsing the FastCGI Response to turn it into a
HTTP Response.</p>
<p>As a PHP developer I am amazed how Go makes it easy to write this kind of
infrastructure tooling. I prefer PHP for everything web related, but as I tried
to explain in <a class="reference external" href="https://joind.in/event/view/2564">my talk at PHPBenelux last week</a>, Go is a fantastic language to write
small, self-contained infrastructure components (or Microservices if you want a
buzzword).</p>
<p>Back to playing with HHVM, if you want to give your application a try with HHVM
instead of ZendEngine PHP it boils down to <a class="reference external" href="https://github.com/facebook/hhvm/wiki/Prebuilt-Packages-for-HHVM">installing a prebuilt HHVM package</a> and then
using my <span class="docutils literal"><span class="pre">hhvm-serve</span></span> command:</p>
<div class="highlight-default"><div class="highlight"><pre><span/>$ go get github.com/beberlei/hhvm-serve
$ hhvm-serve --document-root /var/www
Listening on http://localhost:8080
Document root is /var/www
Press Ctrl-C to quit.
</pre></div>
</div>
<p>The server passes all the necessary environment variables to HHVM so that
catch-all front-controller scripts such as Wordpress <span class="docutils literal"><span class="pre">index.php</span></span> or Symfony’s
<span class="docutils literal"><span class="pre">app.php</span></span> should just work.</p>
<p>If you don’t have a running Go Compiler setup this few lines should help you out on
Ubuntu:</p>
<div class="highlight-default"><div class="highlight"><pre><span/>$ sudo apt-get install golang
$ GOPATH=~/go
$ mkdir -p ~/go/{src,bin,pkg}
$ PATH="$GOPATH/bin:$PATH"
</pre></div>
</div>
<p>You should put the <span class="docutils literal"><span class="pre">$GOPATH</span></span> and <span class="docutils literal"><span class="pre">$PATH</span></span> changes into your bashrc to make this
a permanent solution.</p>
<p>Starting to run HHVM, a Wordpress installation is a good first candidate to
check on, as I knew from HHVM team blog posts that Wordpress works. Using a
simple siege based benchmark I was able to trigger the JIT compiler and the
Profiler charts showed a nice performance boost minute after minute as HHVM
replaces dynamic PHP with optimized (assembler?) code.</p>


            
            <div class="tags">
                More about: 
                <a href="tags/go.html">Go</a>
                 / 
                <a href="tags/hhvm.html">HHVM</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on February 01, 2015
                 by Benjamin Eberlei
            </small>
        </p>
    </div>
        </div><div class="archive_link">
        <a href="archive.html">Archive</a>
    </div></article></div> <!-- #main -->
				</div>
			</div></div> <!-- #main-container -->

        <div class="footer-container" role="contentinfo">
			<div class="container">
				<div class="col-md-8 col-md-offset-2">
					<div class="footer">
						<small>© Copyright 2008-2017, Benjamin Eberlei.</small>

						<script type="text/javascript">    var disqus_shortname = "whitewashing";    disqus_count();</script>
					</div>
				</div>
			</div>
        </div> <!-- footer-container -->
      </div> <!--! end of #container --><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-32146757-1', 'auto');
          ga('send', 'pageview');
        </script>

    </body>
</html>