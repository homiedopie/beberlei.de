<!DOCTYPE html><!--[if lt IE 7]>      <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html xmlns="http://www.w3.org/1999/xhtml"
    xmlns:og="http://ogp.me/ns#"
    xmlns:fb="https://www.facebook.com/2008/fbml" class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <meta name="description" content="Blog of Benjamin Eberlei, covering a wide range of programming, bootstrapping and entrepreneurial topics">
        <meta name="viewport" content="width=device-width">
        <meta name="google-site-verification" content="mycr8JCbLYq9QcOyh4Ub1esAdN-awH9ut6nyTKUTgE4">
        <title>Page 12 &mdash; beberlei.de</title>
            <link rel="stylesheet" href="/_static/pygments.css" type="text/css" />
            <link rel="stylesheet" href="/_static/css/bootstrap.min.css" type="text/css" />
            <link rel="stylesheet" href="/_static/blog.css" type="text/css" />
            <link href="https://fonts.googleapis.com/css?family=Raleway" rel="stylesheet" />
        <link rel="shortcut icon" href="_static/tinkerer.ico" /><!-- Load modernizr and JQuery -->
        <script src="_static/vendor/modernizr-2.6.2.min.js"></script>
        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="_static/vendor/jquery-1.8.2.min.js"><\/script>')</script>
        <script src="_static/plugins.js"></script>
        <script src="_static/main.js"></script>
        <link rel="search" title="Search" href="search.html" /><link rel="next" title="Older" href="page13.html" /><link rel="prev" title="Newer" href="page11.html" /><link rel="alternate" type="application/rss+xml" title="RSS" href="rss.html" /><script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    './',
        VERSION:     '1.7.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        SOURCELINK_SUFFIX: '.txt',
        HAS_SOURCE:  true
      };
    </script><script type="text/javascript" src="_static/underscore.js"></script><script type="text/javascript" src="_static/doctools.js"></script><script type="text/javascript" src="_static/language_data.js"></script></head>
    <body role="document">
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->

      <div id="container"><nav class="navbar navbar-dark">
		  <div class="container">
			  <div class="navbar-header">
				  <a class="navbar-brand" href="https://beberlei.de">Benjamin Eberlei</a>
			  </div>

			  <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
				  <ul class="nav navbar-nav navbar-right">
						<li><a href="index.html">Home</a></li>
						<li><a href="pages/about.html">About</a></li>
						<li><a href="pages/imprint.html">Imprint</a></li>
						<li><a href="/archive.html">Archive</a></li>
					  <li><a href="/rss.xml">RSS</a></li>
				  </ul>
			  </div>
		  </div>
		</nav><div class="main-container" role="main"><div class="container">
				<div class="row">
					<div class="col-md-8 col-md-offset-2 col-sm-12"><article role="article">
							<div class="section">
            <h1><a href="2012/02/25/symfony2_controller_testing.html">Symfony2 Controller Testing without Application</a></h1>
<p>Controller testing using the WebTestCase requires a Symfony Kernel and with
that a complete application. However you can just ship your own simple kernel
with just the dependencies necessary to test your application. This way you can
easily create functional tests for bundles without the bundle requiring an
application.</p>
<div class="section" id="create-a-testkernel">
<h2>Create a TestKernel</h2>
<div class="highlight-php notranslate"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="c1">// Tests/Controller/App/AppKernel.php</span>

<span class="k">use</span> <span class="nx">Symfony\Component\HttpKernel\Kernel</span><span class="p">;</span>
<span class="k">use</span> <span class="nx">Symfony\Component\Config\Loader\LoaderInterface</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">AppKernel</span> <span class="k">extends</span> <span class="nx">Kernel</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">registerBundles</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="nv">$bundles</span> <span class="o">=</span> <span class="k">array</span><span class="p">(</span>
            <span class="c1">// Dependencies</span>
            <span class="k">new</span> <span class="nx">Symfony\Bundle\FrameworkBundle\FrameworkBundle</span><span class="p">(),</span>
            <span class="k">new</span> <span class="nx">Symfony\Bundle\SecurityBundle\SecurityBundle</span><span class="p">(),</span>
            <span class="k">new</span> <span class="nx">Symfony\Bundle\MonologBundle\MonologBundle</span><span class="p">(),</span>
            <span class="k">new</span> <span class="nx">Symfony\Bundle\TwigBundle\TwigBundle</span><span class="p">(),</span>
            <span class="k">new</span> <span class="nx">Sensio\Bundle\FrameworkExtraBundle\SensioFrameworkExtraBundle</span><span class="p">(),</span>
            <span class="k">new</span> <span class="nx">JMS\SerializerBundle\JMSSerializerBundle</span><span class="p">(</span><span class="nv">$this</span><span class="p">),</span>
            <span class="k">new</span> <span class="nx">FOS\RestBundle\FOSRestBundle</span><span class="p">(),</span>
            <span class="c1">// My Bundle to test</span>
            <span class="k">new</span> <span class="nx">Beberlei\WorkflowBundle\BeberleiWorkflowBundle</span><span class="p">(),</span>
        <span class="p">);</span>

        <span class="k">return</span> <span class="nv">$bundles</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">registerContainerConfiguration</span><span class="p">(</span><span class="nx">LoaderInterface</span> <span class="nv">$loader</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// We don't need that Environment stuff, just one config</span>
        <span class="nv">$loader</span><span class="o">-&gt;</span><span class="na">load</span><span class="p">(</span><span class="no">__DIR__</span><span class="o">.</span><span class="s1">'/config.yml'</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="creating-the-config-yml">
<h2>Creating the config.yml</h2>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span/># Tests/Controller/App/config.yml
framework:
    secret:          secret
    charset:         UTF-8
    test: ~
    router:          { resource: "%kernel.root_dir%/routing.yml" }
    form:            true
    csrf_protection: true
    validation:      { enable_annotations: true }
    templating:      { engines: ['twig'] }
    session:
        auto_start:     false
        storage_id: session.storage.filesystem

monolog:
    handlers:
        main:
            type:         fingers_crossed
            action_level: error
            handler:      nested
        nested:
            type:  stream
            path:  %kernel.logs_dir%/%kernel.environment%.log
            level: debug
</pre></div>
</div>
</div>
<div class="section" id="creating-the-routing-yml">
<h2>Creating the routing.yml</h2>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span/><span class="c1"># Tests/Controller/App/routing.yml</span>
<span class="nt">BeberleiWorkflowBundle</span><span class="p">:</span>
    <span class="nt">resource</span><span class="p">:</span> <span class="s">"@BeberleiWorkflowBundle/Controller/"</span>
    <span class="nt">type</span><span class="p">:</span>     <span class="l l-Scalar l-Scalar-Plain">annotation</span>
    <span class="nt">prefix</span><span class="p">:</span>   <span class="l l-Scalar l-Scalar-Plain">/</span>
</pre></div>
</div>
</div>
<div class="section" id="adding-a-phpunit-bootstrap">
<h2>Adding a PHPUnit bootstrap</h2>
<p>I assume the setup that Henrik described in his “<a class="reference external" href="http://henrik.bjrnskov.dk/travis-and-composer-sitting-in-a-tree/">Travis &amp; Composer sitting in a
Tree K-I-S-S-I-N-G” blog post</a>.</p>
<p>His setup is missing the spl_autoload_register() call in the bootstrap file
though.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="c1">// Tests/bootstrap.php</span>
<span class="nv">$loader</span> <span class="o">=</span> <span class="o">@</span><span class="k">include</span> <span class="no">__DIR__</span> <span class="o">.</span> <span class="s1">'/../vendor/.composer/autoload.php'</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nv">$loader</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">die</span><span class="p">(</span><span class="s">&lt;&lt;&lt;'</span><span class="dl">EOT</span><span class="s">'</span>
<span class="s">You must set up the project dependencies, run the following commands:</span>
<span class="s">wget http://getcomposer.org/composer.phar</span>
<span class="s">php composer.phar install</span>
<span class="dl">EOT</span>
    <span class="p">);</span>
<span class="p">}</span>
<span class="nx">\Doctrine\Common\Annotations\AnnotationRegistry</span><span class="o">::</span><span class="na">registerLoader</span><span class="p">(</span><span class="k">array</span><span class="p">(</span><span class="nv">$loader</span><span class="p">,</span> <span class="s1">'loadClass'</span><span class="p">));</span>

<span class="nb">spl_autoload_register</span><span class="p">(</span><span class="k">function</span><span class="p">(</span><span class="nv">$class</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">===</span> <span class="nb">strpos</span><span class="p">(</span><span class="nv">$class</span><span class="p">,</span> <span class="s1">'Beberlei\\WorkflowBundle\\'</span><span class="p">))</span> <span class="p">{</span>
        <span class="nv">$path</span> <span class="o">=</span> <span class="no">__DIR__</span><span class="o">.</span><span class="s1">'/../'</span><span class="o">.</span><span class="nb">implode</span><span class="p">(</span><span class="s1">'/'</span><span class="p">,</span> <span class="nb">array_slice</span><span class="p">(</span><span class="nb">explode</span><span class="p">(</span><span class="s1">'\\'</span><span class="p">,</span> <span class="nv">$class</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span><span class="o">.</span><span class="s1">'.php'</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nb">stream_resolve_include_path</span><span class="p">(</span><span class="nv">$path</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">false</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">require_once</span> <span class="nv">$path</span><span class="p">;</span>
        <span class="k">return</span> <span class="k">true</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">});</span>
</pre></div>
</div>
<p>That means your bundle should have a composer.json that loads all the
dependencies.</p>
</div>
<div class="section" id="modifying-the-phpunit-xml-dist">
<h2>Modifying the phpunit.xml.dist</h2>
<p>We have to tell the WebTestCase base class where to find this kernel:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span/><span class="c">&lt;!-- phpunit.xml.dist --&gt;</span>
<span class="nt">&lt;phpunit</span> <span class="na">bootstrap=</span><span class="s">"Tests/bootstrap.php"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;php&gt;</span>
        <span class="nt">&lt;server</span> <span class="na">name=</span><span class="s">"KERNEL_DIR"</span> <span class="na">value=</span><span class="s">"Tests/Controller/App"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/php&gt;</span>
<span class="nt">&lt;/phpunit&gt;</span>
</pre></div>
</div>
<p>Now just run your web-test cases.</p>
<p>If you want to debug the logging happening inside the Kernel just comment out
the Monolog lines to get the log-messages printed to the screen.</p>
<p>You have to add the <cite>Tests/App/cache</cite> and <cite>Tests/App/logs</cite> to your version
control ignore files.</p>
</div>


            
            <div class="tags">
                More about: 
                <a href="tags/symfony.html">Symfony</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on February 25, 2012
                
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2010/02/07/resources-for-a-php-and-hudson-ci-integration.html">Resources for a PHP and Hudson CI Integration</a></h1>
<p>Yesterday I finally had the time to setup my first continuous integration
environment. Possible solutions for CI are phpUnderControl, Hudson (now
Jenkins CI) or Arbit. Although phpUnderControl is the
most wide-spread, but from I heard complex to setup/maintain, solution
[STRIKEOUT:supposedly a hack] and Arbit just in an early Alpha I decided
to give Hudson a shoot. Another reason for this decision, I heard it has
a simple plugin architecture and is easy to install and use.
Additionally Hudson is easily integrated into
<a class="reference external" href="http://www.netbeans.org">Netbeans</a> and
<a class="reference external" href="http://www.redmine.org">Redmine</a>, and I use both tools regularly in
development.</p>
<p>My motivation to dive into CI is easily explained. I just never felt it
was necessary to add a continuous integration environment to my projects,
since I had one or two simple bash scripts that did the job. In general
this is rather annoying, because they mostly only run PHPUnit and have
to be done using a cronjob or manually, without any real process of
notification. Additionally you have no way to navigate the test-results,
code-coverage and no history of the last builds. For projects like
<a class="reference external" href="http://www.doctrine-project.org">Doctrine 2</a> we have the additional
requirement to support 4 different database platforms, i.e. 4 different
PHPUnit configurations. Currently that is solved by me using a Bash
script that iterates over the configuration file names and invokes
PHPUnit.</p>
<p>There are already some awesome sources how to get Hudson and PHP
working. I’ll list them here:</p>
<ul class="simple">
<li><a class="reference external" href="http://www.flickr.com/photos/sebastian_bergmann/sets/72157622541690849/">Sebastian Bergmann’s Howto in
Screenshots</a></li>
<li><a class="reference external" href="http://luhman.org/blog/2009/12/16/installing-hudson-phing-phpunit-and-git-ubuntu">David Luhman’s series on PHP and
Hudson</a></li>
<li><a class="reference external" href="http://blog.jepamedia.org/2009/10/28/continuous-integration-for-php-with-hudson/">Justin Palmers Guide to install PHP and Hudson (With
Screenshots)</a></li>
</ul>
<p>All those guides are already awesome and I would recommend choosing one
of those to install Hudson, I think i can’t add anything new to those. I
have used Sebastians Howto, however i also like the third one. David
Luhmans guide adds lots of details that are important to get the
different parts of a build process to work.</p>
<p>Now what these tutorials all do is that they use a bash command to
execute the build process or specify an Ant Build file. However there
is also a Phing Build process plugin for Hudson that allows to specify
the build.xml targets to execute in the process. From the “Available
Plugins” list you can choose the “Phing plugin”.</p>
<p>After installation you have to configure the Phing install. The <a class="reference external" href="http://wiki.hudson-ci.org/display/HUDSON/Phing+Plugin">Phing
Plugin Wiki
Page</a> shows how
to do this. You have to go to “Manage Hudson” =&gt; “Configure System” and
look for Phing. There you find the dialog to configure your phing
installations.</p>
<p>In the context of choosing a build script for your project you can now
choose “Phing” instead of Ant:</p>
<div class="figure align-center">
<img alt="" src="https://www.flickr.com/photos/sebastian_bergmann/4046549930/in/set-72157622541690849"/>
</div>
<p>You can enter the targets to build, for example on my local Hudson
instance I only execute “test” for Doctrine 2, since I am not interested
in the building and deployment onto the PEAR channel at this development
stage.</p>
<p>From inside Netbeans you can then start builds by pointing to the Hudson
instance. See this tutorial by one of the <a class="reference external" href="http://blogs.sun.com/joshis/entry/hudson_integration_in_netbeans_6">Hudson + Netbeans
Developers</a>.
You can then start all the builds from inside Netbeans and be notified
of the success or failure.</p>


            
            <div class="tags">
                More about: 
                <a href="tags/continouosintegration.html">ContinouosIntegration</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on February 07, 2010
                
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2010/05/02/testing-database-locks-with-phpunit-and-gearman.html">Testing Database Locks with PHPUnit and Gearman</a></h1>
<p>For the Beta 2 release of <a class="reference external" href="http://www.doctrine-project.org">Doctrine
2</a> we plan to integrate pessimistic
Database-level locks across all the supported vendors (MySQL, Oracle,
PostgreSql, IBM DB2 so far). This means row-level locking as defined in
the ANSI SQL Standard using “SELECT .. FOR UPDATE” will be available
optionally in DQL Queries and Finder methods. The Implementation of this
extension to SELECT statements is rather trivial, however functional
testing of this feature is not.</p>
<p>A general approach would look like this:</p>
<ol class="arabic simple">
<li>Run Query 1 and 2 with FOR UPDATE into the background</li>
<li>Have both queries lock the row for a specified time x (using sleep)</li>
<li>Verify that one of the two processes/threads runs approximately 2*x
the lock time.</li>
</ol>
<p>Since PHP does not support process forking or threads naturally you run
into a serious problem. How do you execute two database queries in
parallel and verify that indeed one query is locking read access for the
second one?</p>
<p>Side note: There are some drawbacks to this testing approach. It could
be that one background threads finishes the lock sleep already when the
second just starts. The locking would work in these cases, however the
lock time would not nearly be 2*x seconds, producing a test-failure. We
are talking about a functional test though and I will accept a failure
from time to time just to be 99% sure that locking works.</p>
<p>Solving this problem with Gearman provides a pretty nice “real-world”
example for the Job-Server that I wanted to share. This blog post
contains a stripped down code-example from the Doctrine 2 testsuite. If
you are interested, you can see the complete Gearman Locking Tests in
<a class="reference external" href="http://github.com/beberlei/doctrine2/tree/lock-support/tests/Doctrine/Tests/ORM/Functional/Locking/">on
GitHub</a>.</p>
<p>Gearman allows to register worker processes with the job-server and
offers clients to execute jobs on those workers in parallel. After
installing the Gearman job-server and PHP pecl/gearman extension
(<a class="reference external" href="http://toys.lerdorf.com/archives/51-Playing-with-Gearman.html">Rasmus Lerdorf has a post on
installation</a>)
we can go on writing our locking tests with Gearman.</p>
<p>The first bit is the worker, a PHP script that tries to acquire a
database lock and then sleeps for a second. The return value of this
script is the total time required for acquiring the lock and sleeping.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span/><span class="x">class LockAgentWorker</span>
<span class="x">{</span>
<span class="x">    public function findWithLock($job)</span>
<span class="x">    {</span>
<span class="x">        $fixture = $this-&gt;processWorkload($job); // setup doctrine in here</span>

<span class="x">        $s = microtime(true);</span>
<span class="x">        $this-&gt;em-&gt;beginTransaction();</span>

<span class="x">        $entity = $this-&gt;em-&gt;find($fixture['entityName'], $fixture['entityId'], $fixture['lockMode']);</span>

<span class="x">        sleep(1);</span>
<span class="x">        $this-&gt;em-&gt;rollback(); // clean up doctrine</span>

<span class="x">        return (microtime(true) - $s);</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>
</div>
<p>The glue-code for the worker script contains of the registering of the
worker method with the job-server and a simple infinite loop:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span/><span class="x">$lockAgent = new LockAgentWorker();</span>

<span class="x">$worker = new \GearmanWorker();</span>
<span class="x">$worker-&gt;addServer();</span>
<span class="x">$worker-&gt;addFunction("findWithLock", array($lockAgent, "findWithLock"));</span>

<span class="x">while($worker-&gt;work()) {</span>
<span class="x">    if ($worker-&gt;returnCode() != GEARMAN_SUCCESS) {</span>
<span class="x">        break;</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>
</div>
<p>We need two running workers for this to work, since one worker only
processes one task at a time. Just open up two terminals and launch the
php scripts. They will wait for their first task to process.</p>
<p>Now we need to write our PHPUnit TestCase, which will contain a
GearmanClient to execute two of the “findWithLock” in parallel. Our
locking assertion will work like this:</p>
<ol class="arabic simple">
<li>Register two tasks for the “findWithLock” method that access the same
database row.</li>
<li>Register a completed callback using
“GearmanClient::setCompleteCallback()” that collects the run-time of
the individual workers.</li>
<li>Execute this tasks in parallel using “GearmanClient::runTasks()”.</li>
<li>Assert that the maximum run-time is around 2 seconds (since each
worker sleeps 1 second)</li>
</ol>
<p>The code for this steps could look like:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span/><span class="x">class GearmanLockTest extends \Doctrine\Tests\OrmFunctionalTestCase</span>
<span class="x">{</span>
<span class="x">    private $gearman = null;</span>
<span class="x">    private $maxRunTime = 0;</span>
<span class="x">    private $articleId;</span>

<span class="x">    public function testLockIsAcquired()</span>
<span class="x">    {</span>
<span class="x">        // .. write fixture data into the database</span>

<span class="x">        $gearman = new \GearmanClient();</span>
<span class="x">        $gearman-&gt;addServer();</span>
<span class="x">        $gearman-&gt;setCompleteCallback(array($this, "gearmanTaskCompleted"));</span>

<span class="x">        $workload = array(); // necessary workload data to configure workers</span>
<span class="x">        $gearman-&gt;addTask("findWithLock", serialize($workload));</span>
<span class="x">        $gearman-&gt;addTask("findWithLock", serialize($workload));</span>

<span class="x">        $gearman-&gt;runTasks();</span>

<span class="x">        $this-&gt;assertTrue($this-&gt;maxRunTime &gt;= 2);</span>
<span class="x">    }</span>

<span class="x">    public function gearmanTaskCompleted($task)</span>
<span class="x">    {</span>
<span class="x">        $this-&gt;maxRunTime = max($this-&gt;maxRunTime, $task-&gt;data());</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>
</div>
<p>Now if both workers are waiting for processing the task we can run this
test and get a green bar for a working lock support.</p>


            
            <div class="tags">
                More about: 
                <a href="tags/testing.html">Testing</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on May 02, 2010
                
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2010/01/08/immutable-datetime-objects.html">Immutable DateTime Objects</a></h1>
<p>One serious drawback of <a class="reference external" href="http://de.php.net/DateTime">PHPs DateTime
extension</a> is the mutability of its
instances. It can lead to serious bugs if a DateTime instance is passed
between different functions and is modified at unexpected places.
Additionally this possibly rules out several optimizations for scripts
that make very heavy use of dates and could share references to equal
timestamps.</p>
<p><strong>Warning:</strong> All the code assumes that you work with one timezone only!</p>
<p>The following code is an immutable version of PHP’s DateTime. All setter
methods throw an exception and add(),sub() and modify() clone the
current instance, apply the operation and return the new instance.</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span/><span class="cp">&lt;?php</span>
<span class="k">namespace</span> <span class="nx">Whitewashing\DateTime</span><span class="p">;</span>

<span class="k">class</span> <span class="nc">DateTime</span> <span class="k">extends</span> <span class="nx">\DateTime</span>
<span class="p">{</span>
    <span class="sd">/**</span>
<span class="sd">     * To prevent infinite recursions</span>
<span class="sd">     *</span>
<span class="sd">     * @var bool</span>
<span class="sd">     */</span>
    <span class="k">private</span> <span class="k">static</span> <span class="nv">$_immutable</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">add</span><span class="p">(</span><span class="nv">$interval</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$_immutable</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="o">::</span><span class="nv">$_immutable</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
            <span class="nv">$newDate</span> <span class="o">=</span> <span class="k">clone</span> <span class="nv">$this</span><span class="p">;</span>
            <span class="nv">$newDate</span><span class="o">-&gt;</span><span class="na">add</span><span class="p">(</span><span class="nv">$interval</span><span class="p">);</span>
            <span class="nx">self</span><span class="o">::</span><span class="nv">$_immutable</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="k">return</span> <span class="nv">$newDate</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">add</span><span class="p">(</span><span class="nv">$interval</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">modify</span><span class="p">(</span><span class="nv">$modify</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$_immutable</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="o">::</span><span class="nv">$_immutable</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
            <span class="nv">$newDate</span> <span class="o">=</span> <span class="k">clone</span> <span class="nv">$this</span><span class="p">;</span>
            <span class="nv">$newDate</span><span class="o">-&gt;</span><span class="na">modify</span><span class="p">(</span><span class="nv">$modify</span><span class="p">);</span>
            <span class="nx">self</span><span class="o">::</span><span class="nv">$_immutable</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="k">return</span> <span class="nv">$newDate</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">modify</span><span class="p">(</span><span class="nv">$modify</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">sub</span><span class="p">(</span><span class="nv">$interval</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="nx">self</span><span class="o">::</span><span class="nv">$_immutable</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">self</span><span class="o">::</span><span class="nv">$_immutable</span> <span class="o">=</span> <span class="k">false</span><span class="p">;</span>
            <span class="nv">$newDate</span> <span class="o">=</span> <span class="k">clone</span> <span class="nv">$this</span><span class="p">;</span>
            <span class="nv">$newDate</span><span class="o">-&gt;</span><span class="na">sub</span><span class="p">(</span><span class="nv">$interval</span><span class="p">);</span>
            <span class="nx">self</span><span class="o">::</span><span class="nv">$_immutable</span> <span class="o">=</span> <span class="k">true</span><span class="p">;</span>
            <span class="k">return</span> <span class="nv">$newDate</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">parent</span><span class="o">::</span><span class="na">sub</span><span class="p">(</span><span class="nv">$interval</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">public</span> <span class="k">function</span> <span class="nf">setDate</span><span class="p">(</span><span class="nv">$year</span><span class="p">,</span> <span class="nv">$month</span><span class="p">,</span> <span class="nv">$day</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">ImmutableException</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setISODate</span><span class="p">(</span><span class="nv">$year</span><span class="p">,</span> <span class="nv">$week</span><span class="p">,</span> <span class="nv">$day</span><span class="o">=</span><span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">ImmutableException</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setTime</span><span class="p">(</span><span class="nv">$hour</span><span class="p">,</span> <span class="nv">$minute</span><span class="p">,</span> <span class="nv">$second</span><span class="o">=</span><span class="k">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">ImmutableException</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setTimestamp</span><span class="p">(</span><span class="nv">$timestamp</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">ImmutableException</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">public</span> <span class="k">function</span> <span class="nf">setTimezone</span><span class="p">(</span><span class="nv">$timezone</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nx">ImmutableException</span><span class="p">();</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="k">class</span> <span class="nc">ImmutableException</span> <span class="k">extends</span> <span class="nx">\Exception</span>
<span class="p">{</span>
    <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">parent</span><span class="o">::</span><span class="na">__construct</span><span class="p">(</span><span class="s2">"Cannot modify Whitewashing\DateTime\DateTime instance, its immutable!"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Its not the prettiest code, but it works.</p>
<p>A next optimization would be a <strong>DateFactory</strong> that manages DateTime
instances by returning already existing instances for specific dates.
This is not a perfect solution, since you won’t be able to enforce a
single instance when you are using the relative descriptive dates or
when calculating with dates using add(), sub() and modify(), however for
lots of dates created from a database or other external source it might
be quite a powerful optimization depending on your use-case:</p>
<div class="highlight-php notranslate"><div class="highlight"><pre><span/><span class="x">namespace Whitewashing\DateTime;</span>

<span class="x">class DateFactory</span>
<span class="x">{</span>
<span class="x">    static private $_dates = array();</span>

<span class="x">    static public function create($hour, $minute, $second, $month, $day, $year)</span>
<span class="x">    {</span>
<span class="x">        $ts = mktime($hour, $minute, $second, $month, $day, $year);</span>
<span class="x">        if (!isset(self::$_dates[$ts])) {</span>
<span class="x">            self::$_dates[$ts] = new DateTime('@'.$ts);</span>
<span class="x">        }</span>
<span class="x">        return self::$_dates[$ts];</span>
<span class="x">    }</span>

<span class="x">    static public function createFromMysqlDate($mysqlDate)</span>
<span class="x">    {</span>
<span class="x">        list($date, $time) = explode(" ", $mysqlDate);</span>
<span class="x">        if($time == null) {</span>
<span class="x">            $hour = $minute = $second = 0;</span>
<span class="x">        } else {</span>
<span class="x">            list($hour, $minute, $second) = explode(":", $time);</span>
<span class="x">        }</span>
<span class="x">        list($year, $month, $day) = explode("-", $mysqlDate);</span>
<span class="x">        return self::create($hour, $minute, $second, $month, $day, $year);</span>
<span class="x">    }</span>
<span class="x">}</span>
</pre></div>
</div>
<p>This includes some date time calculations and date creation with
mktime() and DateTimes unix timestamp capabilities to be able to work.
Otherwise the sharing of instances could not be implemented. If you need
to create shareable instances from other formats you could just create
another creation method for it and convert the format for create() to be
used.</p>


            
            <div class="tags">
                More about: 
                <a href="tags/applicationdesign.html">ApplicationDesign</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on January 08, 2010
                
            </small>
        </p>
    </div>
        </div><div class="separator post_separator"></div><div class="section">
            <h1><a href="2010/01/10/application-lifecycle-management-and-deployment-with-pear-and-phar-revisited-update.html">Application Lifecycle Management and Deployment with PEAR and PHAR (revisited) <em>UPDATE</em></a></h1>
<p>Some weeks ago <a class="reference external" href="https://beberlei.de/2009/12/19/trying-a-two-step-pear-phar-approach-to-develop-and-deploy.html">I posted an
article</a> on using PEAR
and PHAR for application lifecycle management and deployment. Since then
I have gotten some feedback through comments, but also discussed the
topic with colleagues. I have also optimized the approach quite
considerably and even <a class="reference external" href="http://github.com/beberlei/pearanha">made an open-source project out of parts of
it</a> and I want to share all that
is new with you. First of all, yes the presented solution was somewhat
complex, partly because it is still a proposed idea and definitely up
for optimizations. However I am still very convinced of my approach,
something I should discuss in more detail.</p>
<p>The only other two languages I have ever programmed something in with
more than 50 lines of code are Java and C#. In both languages you can
explicitly import different dependencies like libraries and frameworks
by adding them to your application, i.e. in java you would add for
example Spring as an MVC Web layer, Hibernate as an ORM and several
other things to your project and directly bundle them in your
executable. This is very easy to configure and maintain in IDEs like
Netbeans or Eclipse (C# has the same with allowing you to attach DDLs of
libraries to your project). It also makes for a much more
straightforward deployment.</p>
<p>In the PHP world this situation was quite different (up to PHP 5.3) for
several reasons:</p>
<ul class="simple">
<li>You could not package a library into a single distributable file.</li>
<li>The PEAR installer as the only tool for updating and managing
dependencies of your application by default installs into a
system/global directory. This means dependencies your application
uses are located in a completely different location than your
application code.</li>
<li>You can’t manage multiple versions of the same package with PEAR in
this system directory, making it very hard to control servers with
different applications.</li>
<li>The global directory with your application dependencies is most often
not under version control, which makes deployment of applications
with PEAR dependencies somewhat difficult.</li>
</ul>
<p>There are some solutions to this problems:</p>
<ul class="simple">
<li>Don’t use PEAR, but put all dependencies in your version control
system.</li>
<li>Don’t use PEAR, and bundle dependencies to your code in the
build/deployment process.</li>
<li>Use PEAR like in the article described, on a per project basis.</li>
</ul>
<p>The solutions that don’t use PEAR suffer from the disadvantage that you
need to keep track of all the library and framework dependencies
yourself and upgrade them yourself. This might not be such a huge
problem from a first glance, but in my opinion many PHP applications and
projects suffer from using either no framework/library or just exactly
one. There is no real cherry-picking going on the PHP world, for example
I would really like to use Zend Framework for the general application
layout, but still use Doctrine for the Modelling and HTML Purifier for
the Output Escaping. Certain tasks might then only be solvable with the
help of eZ Components, all of which are then to some extend dependencies
of my application. With PEARHUB (defunct) and
PEARFARM (defunct) on the horizon Read Padraic on this topic even more PHP code
will be distributed using PEAR channels in the near future. My <a class="reference external" href="https://beberlei.de/2010/01/08/immutable-datetime-objects.html">immutable
DateTime</a>
code for example makes for a great little open source library that could be
distributed via PEAR, as well as Yadif - a dependency injection container I am
using extensively.</p>
<p>Question: Are you really going to manage all these dependencies
correctly manually? Is everything up to date all the time, and
upgradeable with ease?</p>
<p>The PEAR driven solution then begins to look very desirable in this
light, however it has a considerable disadvantage: The PEAR installer
itself works on a system-wide/user-centric basis, making it impossible
to manage dependencies of several applications using only one linux
user. My little Pearanha to the rescue: I have taken the PEAR installer code
(which is distributed with all PHP installations across all systems) and put a
new CLI tool on top
of it. Its a very simple code-generator that allows to generate a
re-configured PEAR installer script which only manages a single
application in a given directory. This approach is also used by the
symfony plugin mechanism, which internally uses the PEAR installer (did
you know?).</p>
<p>Lets revisit my blog application example from my previous PEAR post, first
install from Github and make the “pearanha” file executable and put it in your
PATH (A PEAR Server Channel will follow any time soon).</p>
<p>Now we need to have an existing application directory somewhere, for
example <strong>/var/www/blog</strong> and then we can put Pearanha on top of it
with:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span/><span class="n">benny</span><span class="nd">@desktop</span><span class="p">:</span> <span class="n">pearanha</span> <span class="n">generate</span><span class="o">-</span><span class="n">project</span>
</pre></div>
</div>
</div></blockquote>
<p>You then need to specify the project base dir and then the project
style (for example Zend Framework or Manual) which prompts your for the
directory that should be used for as the vendor/library directory that
PEAR will install all the code in. You will also be prompted for a
binary/scripts directory which will then hold a new PHP file for you,
the file <strong>my_phpiranha</strong>.</p>
<p><strong>Pro Argument:</strong> Switching to Pearanha can be done at any point in your
application lifecycle. Just define an additional vendor directory for
all the dependencies to go in and generate the applications pear
installer and you are good to go.</p>
<p>The generated script is your new application specific PEAR installer and
you can begin to install all the required dependencies of your
application:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span/>benny@desktop:~$ cd /var/www/blog
benny@desktop:/var/www/blog$ ./vendor/pear/my_pearanha channel-discover pear.zfcampus.org
benny@desktop:/var/www/blog$ ./vendor/pear/my_pearanha install zfcampus/zf-alpha
benny@desktop:/var/www/blog$ ./vendor/pear/my_pearanha channel-discover htmlpurifier.org
benny@desktop:/var/www/blog$ ./vendor/pear/my_pearanha install hp/HTMLPurifier
benny@desktop:/var/www/blog$ ./vendor/pear/my_pearanha channel-discover pear.phpdoctrine.org
benny@desktop:/var/www/blog$ ./vendor/pear/my_pearanha install pear.phpdoctrine.org/DoctrineORM-2.0.0
benny@desktop:/var/www/blog$ ./vendor/pear/my_pearanha channel-discover components.ez.no
benny@desktop:/var/www/blog$ ./vendor/pear/my_pearanha install ezc/ezcGraph
</pre></div>
</div>
</div></blockquote>
<p>All this stuff is now located in <strong>/var/www/blog/vendor</strong>. Again you can
use PEARs complete upgrade, remove and install functionality for your
application, now without the hazzle of having to create a linux user for
each project you want to manage this way, which in my opinion is a
considerable simplification. The complete application (including its
dependencies) can then be put under version control and be readily
packaged as a single executable PHAR file by your build process.</p>
<p>As a side node, I did try Pyrus instead of PEAR for the same discussed
purpose, however most of the current PEAR channels don’t validate
against Pyrus strict standards for the package.xml file. In the future
this might change and a Pyrus based application installer will then be
integrated into Pearanha.</p>
<p><strong>UPDATE:</strong> I renamed PHPiranha to Pearanha as its more appropriate.
Also after apinsteins comment on “pear config-create” I rewrote the
generate-project parts to use the config-create functionality
internally, which allowed me to throw away half of the self-written
code. Thanks!</p>


            
            <div class="tags">
                More about: 
                <a href="tags/deployment.html">Deployment</a>
                
                
            </div>
            

            <div class="metadata">
        <p>
            <small>
                Posted on January 10, 2010
                
            </small>
        </p>
    </div>
        </div><div class="archive_link">
        <a href="archive.html">Archive</a>
    </div></article></div> <!-- #main -->
				</div>
			</div></div> <!-- #main-container -->

        <div class="footer-container" role="contentinfo">
			<div class="container">
				<div class="col-md-8 col-md-offset-2">
					<div class="footer">
						<small>© Copyright 2008-2018, Benjamin Eberlei.</small>
					</div>
				</div>
			</div>
        </div> <!-- footer-container -->
      </div> <!--! end of #container --><!--[if lt IE 7 ]>
          <script src="//ajax.googleapis.com/ajax/libs/chrome-frame/1.0.3/CFInstall.min.js"></script>
          <script>window.attachEvent('onload',function(){CFInstall.check({mode:'overlay'})})</script>
        <![endif]-->

        <script>
          (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
          (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
          })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

          ga('create', 'UA-32146757-1', 'auto');
          ga('send', 'pageview');
        </script>

    </body>
</html>